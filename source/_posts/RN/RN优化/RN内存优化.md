---
title: RN内存优化
date: 2019-04-19 14:28:26
categories:
	- Android
tags:
	- RN
---

# 目的

减少内存占用

# ListView 内存没有复用

0.43 引入了一个新的FlatList组件，完全解决了ListView的内存回收问题

强烈建议升级版本

不升级的话，自己实现这套机制

# 图片

在Android上问题会相对多一些

## Fresco重复初始化

RN的底层图片框架库用的是Fresco，而我们主App中用的也是Fresco底层库，这里就会重复初始化。

当主App中的Fresco进行初始化之后，如果RN中也进行一次初始化，实际上之前那部分内存并没有被释放，会出现内存泄漏。

## 图片编码方式

RN框架采用的图片编解码用的是ARGB_8888，但实际上大部分情况下可以采用RGB_565编码，图片在内存当中的大小可以减少50%。

不过有些业务可能也真的需要一些透明的背景，需要Alpha通道，所以也提供了一些API来针对特殊图片，让它采用ARGB_8888进行编解码。

这样既解决内存问题，也满足了业务的需求。

## 图片内存回收

RN页面退出之前，建议强制调用Fresco框架的**clearMemoryCach**e方法，通知Fresco清除内存缓存。可以保证GC及时地把这些图片内存给回收掉，避免整个APP的内存占用过高，经过实践验证这也很有效地解决了内存问题。

# so内存无法回收

{% asset_img 手Q优化.jpg %}

手Q对内存要求比较严格，在界面退出的时候所有连带内存必须清理干净。那rn在这方面其实做的并没有那么好，有部分so层的内存一直占用着。那我们解决方案只能是将JNI拆分为独立进程并且在界面退出时，直接退出dalvik，回收所有内存。当然，这里就有些老技巧了，无非是进程预加载和延迟销毁。

# 参考&扩展

- [RN框架在京东无线端的实践](https://www.jqhtml.com/34513.html)
- [【腾讯Bugly干货分享】React Native项目实战总结](https://segmentfault.com/a/1190000005908366)定制编译源码，性能优化，so内存无法回收问题