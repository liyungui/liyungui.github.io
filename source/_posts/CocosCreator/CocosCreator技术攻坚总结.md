---
title: CocosCreator技术攻坚总结
date: 2019-10-31 14:30:53
tags: 
	- CocosCreator
categories:
	- 游戏
---

# 背景

cocos Creator 游戏打包成H5，用webview 加载；

问题：

- 性能。低端机帧率低
- 兼容性。部分老机型，不支持x5内核

于是决定把游戏编译成原生

# 挑战

## 平台兼容性

部分特性只支持H5；比如 `window.location`、`axios`(基于 promise 的 HTTP 库)只支持浏览器环境

这部分需要改造，为了跨端，使用c++ HttpClient

## 以View的形式渲染游戏

项目中游戏只是直播间的一部分；玩游戏时还需要直播和互动

官方demo是Activity形式

分析源码，发现是用动态创建GlSurfaceView添加到Activity来展示游戏。

封装成view即可满足项目需求

## 结束游戏

官方demo直接杀死进程，退出游戏。好暴力

项目中不能杀死进程，游戏结束需要维持直播和互动

官方文档提供了js方法结束游戏，分析源码发现最终调用的c++代码

封装并使用jni技术提供方法给java层使用即可

## 多次运行游戏

因为结束游戏没有退出进程，游戏引擎官方架构是不支持重入的；

由易到难的方案。团队信心，时间因素

### 热更新方案

官方提供了一个热更新重新开始游戏的方案，可以支持多次运行

卡点：官方demo是大厅+子游戏模式；只有一个入口。项目是通过不同路径进入独立的子游戏模式，重新开始游戏永远是上一次运行的游戏

应该是加载资源有问题；跟踪发现是搜索文件成功后回缓存文件完整路径。不同游戏的入口文件名一致。添加新搜索路径时，清空缓存即可

### 完全回收引擎方案

分析游戏启动流程，渲染原理，jsb原理。解决野指针，状态异常等问题

## 启动黑屏优化

# 沉淀

## 使用git记录引擎修改记录

## 原理分析，总结文档

## 团队分享，侧重解决问题的方法论

