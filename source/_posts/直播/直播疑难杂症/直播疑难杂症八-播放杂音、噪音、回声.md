---
title: 直播疑难杂症八-播放杂音、噪音、回声
date: 2019-09-03 15:10:14
categories:
  - 直播
tags:
  - 直播
---

相比于视频而言，音频要敏感得多，视频画面有噪点、马赛克都还是可以勉强被接受，而声音一旦有任何瑕疵，人耳都会特别容易感觉到，而且难以忍受。

# 表现

- 电流音，爆音，滋滋声或者嘟嘟声

- 声音断断续续，听不清楚

- 回声，同一个声音能听到两遍

# 原因

## 参数配置问题

音频是一个特别敏感的东西，涉及到许多参数配置，一旦配置不太匹配，就会导致声音听起来非常诡异（比如：采样率是 32000Hz 的音频，给播放器配置为 8000Hz 或者 44100Hz，就明显会出现音频慢放或者快放的效果）。

我们只需要注意的是，无论是采集和播放，都要给系统的 API 以及第三方的库配置正确的参数，如：采样率、位宽、声道数等等。

## 代码层面

### 音频 buffer 大小不匹配

一段 1024 bytes 的音频，放到了 2048 bytes 的数组，导致尾部有随机数

### 重采样的算法问题

音频 resample 重采样的算法问题，导致采样出来的数据出了问题

### Android 的 ByteBuffer 取出数组

不能直接用 .array() 方法的，而需要用 .get() 方法

### iOS 的 AudioSession采样率被更改

iOS 系统，其他 app 通过系统 API 更改了 AudioSession 采样率的配置

### 混音越界

音频的 PCM 数据，通常用 short 数组来存放，当我们做一些多路音频的混音功能的时候，如果不注意处理 short 类型的大小越界，则往往带来爆音的问题。下面是一段参考 webrtc 的混音代码，专门针对混音越界做了简单处理，可以参考参考：

{% asset_img webrtc混音防越界代码.png %}

## 网络宽带不足

视频是一帧一帧连续的图像构成的，在播放过程中，如果无法按时渲染，则会出现卡顿的效果；如果丢失几帧画面，则会出现快进效果。

而音频是流式的，虽然也被切分为了一个个音频帧，但如果无法按时播放或者连续丢失较多的音频帧，则会明显听到断断续续的声音出现。特别是在弱网、丢包率高等不稳定网络环境下，很容易出现这种情况。

表现为 帧缓冲区为空

复现的网速阈值：差不多是最低网速需求的40%-50%；

比如，当前直播的最低网速要求是112 kBps；将手机网络模拟为 500 kbps；

## 设备性能不足

设备性能不足的情况下，容易出现虽然帧缓冲区数据充足，但是解码不及时，导致无法播放，也会听到断断续续的声音出现

表现为 显示缓冲区为空

复现的CPU阈值：CPU使用率80%

## 解码失败

## 音频丢帧

## 回声

回声一般出现在同时有音频的采集和播放的场景，比如：连麦互动、混音返听等等，采集到的音频通过扬声器又播放出来了，同时又被采集了进去，从而产生了回声或者啸叫声。

这样的场景下，一般需要通过系统的回声消除 API，或者第三方回声消除库（如：speexdsp，webrtc 等）进行处理。

注意：很多 Android 机型硬件自带的回声消除效果并不是很好。

# 参考&扩展

- [《直播疑难杂症排查》系列之八：播放杂音、噪音、回声](https://blog.qiniu.com/archives/8524)