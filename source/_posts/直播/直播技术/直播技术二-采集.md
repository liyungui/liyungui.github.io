---
title: 直播技术二-采集
date: 2019-08-01 16:52:14
categories:
  - 直播
tags:
  - 直播
---

# 采集内容

视频的采集涉及两方面数据的采集：**音频采集和图像采集**，它们分别对应两种完全不同的输入源和数据格式。

## 音频采集

音频数据既能与图像结合组合成视频数据，也能以纯音频的方式采集播放

音频的采集过程主要通过设备将环境中的模拟信号采集成 **PCM** (脉冲编码调制 - Pulse Code Modulation)编码的原始数据，然后编码压缩成 MP3 等格式的数据分发出去。

### 常见的音频压缩格式

有：MP3，AAC，HE-AAC，Opus，FLAC，Vorbis (Ogg)，Speex 和 AMR等。

### 挑战

音频采集和编码主要面临的挑战在于：延时敏感、卡顿敏感、噪声消除（Denoise）、回声消除（AEC）、静音检测（VAD）和各种混音算法等。

### 主要技术参数

在音频采集阶段，参考的主要技术参数有 ：

#### 采样率/采样频率（samplerate）

采样就是把模拟信号数字化的过程

采样频率越高，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。

- 每秒的采样次数
	- 单位 Hz。Hz 是频率的单位。即每秒的周期次数(周期/秒)。电，磁，声波和机械振动周期循环时频率的单位。
	- 声卡一般提供11.025kHz、22.05kHz和44.1kHz等不同的采样频率。

#### 位宽/采样位数

- 每次采样值数值大小的位数。
	- 采样样本幅度量化，也可以说是声卡的分辨率。
	- 单位 bit
	- 常用的有8bits或16bits两种
		- 8bits只能将振幅划分成 256 个等级;
		- 16bits可以细到 65536 个数,  CD 标准
	- 采样位数越大，所能记录声音的变化度就越细腻，相应的数据量就越大。

#### 声道数（channels）

由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。声道数为 1 和 2 分别称为单声道和双声道(立体声，左右耳听到差异的声音)，是比较常见的声道参数。

#### 音频帧（frame）

音频跟视频很不一样，视频每一帧就是一张图像，而音频数据是流式的，本身没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5ms~60ms 为单位的数据量为一帧音频。这个时间被称之为“采样时间”，其长度没有特别的标准，它是根据编解码器和具体应用的需求来决定的。

### 音频存储空间计算

`音频大小(bit/秒) = 采样频率(Hz,次数/秒) × 采样位数(bit) × 声道数`

`音频帧大小(bit) = 每秒音频大小(bit/秒) x 音频帧采样时长(秒)`

假设某音频信号是采样率为 8kHz、双通道、位宽为 16bit，20ms 一帧

每秒音频size = 8000 x 2 x 16bit = 256000 bit = 32000 byte = 31.25 Kb

音频帧size = 32000 byte/s x 0.02s = 640 byte

注意： 实际上，音频采集完都会编码压缩。不同音频格式，所采用的压缩编码方式皆不相同，因此在计算音频对应比特率时，还应乘以压缩的倍率，如0.2等。

## 图像采集

图像采集的图片组合成一组连续播放的动画，即构成视频中可肉眼观看的内容。

图像的采集过程主要由摄像头等设备拍摄成 **YUV** 编码的原始数据，然后经过编码压缩成 H.264 等格式的数据分发出去。

YUV是一种**颜色编码**方法。常用在**图片或视频**编码时

### 常见的视频封装格式

有：MP4、3GP、AVI、MKV、WMV、MPG、VOB、FLV、SWF、MOV、RMVB 和 WebM 等。

### 挑战

图像由于其直观感受最强并且体积也比较大，构成了一个视频内容的主要部分。图像采集和编码面临的主要挑战在于：设备兼容性差、延时敏感、卡顿敏感以及各种对图像的处理操作如美颜和水印等。

### 主要技术参数

在图像采集阶段，参考的主要技术参数有：

#### 图像传输格式

通用影像传输格式（Common Intermediate Format）是视讯会议（video conference）中常使用的影像传输格式。

#### 图像格式

通常采用 YUV 格式存储原始数据信息

- Y代表明亮度(luminance;luma;brightness)
- U存储色度(chrominance;color)
- V表示浓度或饱和度

其中包含用 8 位表示的黑白图像灰度值，以及可由 RGB 三种色彩组合成的彩色图像。

#### 传输通道

正常情况下视频的拍摄只需 1 路通道，随着 VR 和 AR 技术的日渐成熟，为了拍摄一个完整的 360° 视频，可能需要通过不同角度拍摄，然后经过多通道传输后合成。

#### 分辨率

随着设备屏幕尺寸的日益增多，视频采集过程中原始视频分辨率起着越来越重要的作用，后续处理环节中使用的所有视频分辨率的定义都以原始视频分辨率为基础。视频采集卡能支持的最大点阵反映了其分辨率的性能。

#### 采样频率

采样频率反映了采集卡处理图像的速度和能力。在进行高度图像采集时，需要注意采集卡的采样频率是否满足要求。采样率越高，图像质量越高，同时保存这些图像信息的数据量也越大。

### 视频图像存储空间计算

#### 1080P、720P 像素

1080P的实际像素是 1920*1280, 相乘结果是 2073600，即有2073600个像素点， 也就是常说的 **1080P为200万像素**

720P实际像素是1280×720， 相乘结果921600，即有921600个像素点，也就是常说的 **720P为100万像素**

#### 视频图像存储空间

视频图像码率 = 像素宽 * 像素高 * 位深度 * 帧率

1080P 50帧/秒 位宽(每个像素点位数)8bit。

`每秒视频图像size = 1920*1280*8*50/1024/1024 = 937.5 Mb`

#### 视频存储空间

未压缩的视频码率 = 音频码率 + 视频图像码率；

由于当前视频均采用编码压缩，因此还需要乘以倍率

计算出的视频码率只能大约得估算出真正的视频码率，因为其中还有一些其他的影响参数。

# 采集源

## 摄像头采集

对于视频内容的采集，目前摄像头采集是社交直播中最常见的采集方式，比如主播使用手机的前置和后置摄像头拍摄。在现场直播场景中，也有专业的摄影、摄像设备用来采集。安防监控场景中也有专业的摄像头进行监控采集。

## 屏幕录制

手机屏幕录制采集的方式在手机游戏直播场景中非常常见，Android实现屏幕录制的功能比较简单。而 iOS 则由于系统本身没有开放屏幕录制的权限而没法直接操作，但对于 iOS 9 以上的版本，是有个取巧的办法，可以通过模拟一个 AirPlay 镜像连接到（当前 App）自身，这样就可以在软件上捕获到屏幕上的任何操作，达到录制屏幕的效果。

在教育直播或者会场演讲场合，经常需要录制电脑桌面上 PPT，针对这种场景，目前市面上比较方便的方案是使用开源的桌面推流工具 [OBS：Open Broadcaster Software](https://obsproject.com/) 来进行屏幕录制和推流

## 从视频文件推流

除了从硬件设备采集视频进行推流之外，我们也可能需要将一个视频或者音频文件以直播流的形式实时传输给观众，比如在线电台或者电视节目，它们的输入可能直接来自于一些已经录制剪辑好的视频内容。

# 开放式设计

为了支持市场上所有采集源的接入，SDK 应该采用开放式的设计，只要采集源实现方遵循相应的接口，即可支持任意的采集源。

{% asset_img source.jpeg %}

图中我们把采集的内容分为图像和音频，其中图像的采集源包含摄像头、屏幕录制或者本地的视频文件，甚至是其它需要重新定义和实现的采集源。而音频的采集源包含麦克风、系统声音或者本地音频文件，当然也可以为它定义别的输入源。

这样设计最大的好处在于，可以以轻量的设计方式支持丰富的采集源，而采集源的具体实现也可以交给使用者。

# 参考&扩展

- [《视频直播技术详解》系列之二：采集](https://blog.qiniu.com/archives/6713)
- [音视频码率的计算](https://juejin.im/post/6844903894011609102)