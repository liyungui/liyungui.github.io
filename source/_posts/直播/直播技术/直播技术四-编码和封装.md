---
title: 直播技术四-编码和封装
date: 2019-08-02 10:26:14
categories:
  - 直播
tags:
  - 直播
---

**编码性能、编码速度和编码压缩比**会直接影响整个流媒体传输的用户体验和传输成本。

编码完成后需要把内容按照一定标准封装到一个多媒体容器

# 视频编码的意义

原始视频数据存储空间大，一个 1080P 50帧/秒 位宽(每个像素点位数)8bit 视频的码率为需要 937.5 Mbps，需要千兆上行宽带才能满足实时传输需求。而经过 H.264 编码压缩之后，视频码率只有 809 Kbps ,1 Mbps 的上行带宽就可以满足实时传输需求。所以从视频采集传感器采集来的原始视频势必要经过视频编码。


# 视频编码原理

## 编码原理

核心思想就是**去除冗余信息**

**空间冗余**：图像相邻像素之间有较强的相关性

**时间冗余**：视频序列的相邻图像之间内容相似

**编码冗余**：不同像素值出现的概率不同

**视觉冗余**：人的视觉系统对某些细节不敏感

**知识冗余**：规律性的结构可由先验知识和背景知识得到

## 帧内编码

**帧内编码**：对每一帧图片进行压缩编码

{% asset_img 帧内编码.png %}

 **MJPEG** 编码就是这种编码方式，这种编码方式只有帧内编码，利用**空间上的取样预测**来编码。去除 **空间冗余**
 
如图，绿色的部分就是当前待编码的区域，灰色就是尚未编码的区域，绿色区域可以根据已经编码的部分进行预测
 
## 帧间编码

**帧间编码**：帧和帧之间有时间的相关性，通过搜索算法选定了帧上的某些区域，然后通过计算当前帧和前后参考帧的向量差进行编码

{% asset_img 帧间编码.png %}

通过上面两个图 连续帧我们可以看到，滑雪的同学是向前位移的，但实际上是**雪景在向后位移**，P 帧通过参考帧（I 或其他 P 帧）就可以进行编码了，编码之后的大小非常小，压缩比非常高

上面两张图片的生成方式：

- 生成带有移动矢量的视频
- 把每一帧都输出成图片

```
ffmpeg  -flags2 +export_mvs -i tutu.mp4 -vf codecview=mv=pf+bf+bb tutudebug2.mp4

ffmpeg -i tutudebug2.mp4 'tutunormal-%03d.bmp'
```
## 编码流程

{% asset_img 编码流程.png %}

编码流程是把帧内编码和帧间编码结合在一起

我们通常说的 I 帧和 P 帧就是分别采用了帧内编码和帧间编码

# 编码器的选择

## H.264/AVC

### 特性

AVC（Advanced Video Coding）高级视频编码

H.264/AVC **低成本实现**在**更低带宽**下提供优质视频（只有 MPEG-2，H.263 或 MPEG-4 第 2 部分的一半带宽或更少）

- 不增加太多设计复杂度使得无法实现或实现成本过高
- 提供足够的灵活性，以在各种应用、网络及系统中使用

这样的技术基础让 H.264 成为包括 YouTube 在内的在线视频公司采用它作为主要的编解码器。

### 专利许可

理论上讲使用 H.264 需要交纳不菲的专利费用。

### 开源实现

OpenH264、x264

#### OpenH264

思科实现的开源 H.264 编码，思科把 OpenH264 实现的年度专利费交满后，OpenH264 事实上就可以免费自由的使用了。

#### x264

采用 GPL 授权的视频编码自由软件。x264 的主要功能在于进行 H.264/MPEG-4 AVC 的视频编码，而不是作为解码器（decoder）之用。

#### 比较

OpenH264 CPU 的占用相对 x264低很多

OpenH264 只支持 baseline profile，x264 支持更多 profile

## HEVC/H.265

### 特性

高效率视频编码（High Efficiency Video Coding，简称 HEVC）是 ITU-T H.264/MPEG-4 AVC 标准的**继任者**。

- 提升视频质量
- 同时能达到 H.264/MPEG-4 AVC **两倍压缩率**（等同于同样画面质量下比特率减少了 50%）
- 可支持 **4K** 分辨率，最高分辨率可达到 8192×4320（8K 分辨率）。

### 专利许可

要求所有使用 H.265 技术的支付专利使用费。包括

- 内容制造商。
	- 上缴内容收入的 0.5%作为技术使用费
	- 包括苹果、YouTube、Netflix、Facebook、亚马逊等
	- 整个流媒体市场每年达到约 1000 亿美元的规模，且不断增长中，
- 设备制造商。
	- 按每台设备收费
	- 电视厂商、移动设备厂商、蓝光设备播放器、游戏机、录像机
	- 之前已经发售的产品依然要追缴费用


### 开源实现

libde265、x265

#### libde265 HEVC

struktur 公司以开源许可证 GNU LesserGeneral Public License (LGPL) 提供，观众可以较慢的网速下欣赏到最高品质的影像。可以减少 50%流媒体播放所需要的带宽。高清或者 4K/8K 超高清流媒体播放，低延迟/低带宽视频会议，以及完整的移动设备覆盖。具有「拥塞感知」视频编码的稳定性，十分适合应用在 3/4G 和 LTE 网络。

#### x265 

MulticoreWare 开发，并开源。采用 GPL 协议，但是资助这个项目的几个公司组成了联盟可以在非 GPL 协议下使用这个软件。

## VP8

### 特性

VP8 是一个开放的视频压缩格式，最早由 On2 Technologies 开发，随后由 Google 发布。

目前支持 VP8 的网页浏览器有 Opera、Firefox 和 Chrome。

### 专利许可

Google 获取 VP8 以及其之前的 VPx 等编码所可能侵犯的专利授权，然后无偿再次授权相关专利给 VP8 的用户。

### 开源实现

#### libvpx

libvpx 是 VP8 的唯一开源实现，由 On2 Technologies 开发，Google 收购后将其开放源码，License 非常宽松可以自由使用。

## VP9

### 特性

同画质下，比 VP8 编码减少 50% 的文件大小，在编码效率上超越 HEVC 编码。

目前支持 VP8 的网页浏览器有 Chromium、Chrome、Firefox 

### 专利许可

VP9 是一个开放格式、无权利金的视频编码格式。

### 开源实现

#### libvpx

libvpx是 VP9 的唯一开源实现，由 Google 开发维护，里面有部分代码是 VP8 和 VP9 公用的，其余分别是 VP8 和 VP9 的编解码实现。

# FFmpeg

[FFmpeg](https://ffmpeg.org/download.html) 是一个自由软件，可以运行音频和视频多种格式的录影、转换、流功能.包含了 libavcodec -这是一个用于多个项目中音频和视频的解码器库，以及 libavformat -一个音频与视频格式转换库。

FF 指的是 Fast Forward

FFmpeg 是个优秀的工具，可以通过它完成很多日常的工作和实验，但是距离提供真正可用的流媒体服务、直播服务还有非常多的工作要做

# 封装

封装就是把**编码内容**（视频，音频，字幕，章节信息等）按照一定**标准**封装一个容器。

- 播放简单
- 为媒体内容提供索引。可拖动

## 封装格式

常见封装格式和音视频编码的组合方式

|封装容器|视频流编码格式|音频流编码格式|说明|优点|缺点|
|---|---|---|---|---|---|
|AVI (.avi)|Xvid 或 Divx|MP3|Audio Video Interleaved 音频视频交错格式|图像质量好，可以保持alpha通道|体积过大，压缩标准不统一|
|DV-AVI (.avi)|Xvid 或 Divx|MP3|DV 是 Digital Video Format，数码摄像机使用这种格式|||
|Matroska (.mkv)|Xvid|MP3|可把多种不同编码的视频及 16 条或以上不同格式的音频和语言不同的字幕封装到一个 Matroska Media 档内|提供非常好的交互功能||
|Matroska (.mkv)|Xvid|AAC||||
|Matroska (.mkv)|H264|AAC|mkv最常用组合，体积最小，清晰度最高|||
|MP4|Xvid|MP3||||
|MP4|H.264|AAC||||
|3GP|H.263|AAC||||
|QuickTime File Format (.mov)|||苹果开发，默认的播放器是苹果的 QuickTime|较高压缩比 较完美清晰度 可以保存 alpha 通道||
|MPEG (.mpg .mpeg .mpe .dat .vob .asf .3gp .mp4等)|||Moving Picture Experts Group 运动图像专家组格式|MPEG－4 小体积 高质量||
|WMV 格式 (.wmv .asf)|||Windows Media Video 微软推出|本地或网络播放,丰富的流间关系以及扩展性|网站播放需要安装 Windows Media Player|
|Real Video (.rm .rmvb)|||用户可以使用 RealPlayer 根据不同的网络传输速率制定出不同的压缩比率。rmvb是升级版|低速网络实时播放||
|Flash Video (.flv)|||Adobe Flash 延伸出来的的一种流行网络视频封装格式|||
|MPEG2-TS (.ts)|||Transport Stream「传输流」；又称 MTS、TS。用于数字电视广播系统|传输和存储包含音效、视频与通信协议各种数据。Media Player Classic、VLC 等软件可以直接播放|||

目前，在流媒体传输，尤其是直播中主要采用的就是 FLV 和 MPEG2-TS 格式，分别用于 RTMP/HTTP-FLV 和 HLS 协议

# 参考&扩展

- [《视频直播技术详解》之（四）：编码和封装](https://blog.qiniu.com/archives/6816)
- [常见视频文件的编码方式和封装格式](https://blog.csdn.net/wishfly/article/details/50921712)