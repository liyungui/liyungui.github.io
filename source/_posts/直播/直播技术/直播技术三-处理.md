---
title: 直播技术三-处理
date: 2019-08-01 18:02:14
categories:
  - 直播
tags:
  - 直播
---

# 开放式设计 

{% asset_img 处理.png %}

如上图所示，处理环节中分为**音频和视频处理**

音频处理中具体包含混音(声音混淆)、降噪和声音特效等处理。在主播和观众**连麦**场景中，主播需要和某个或者多个观众进行对话，并将对话结果实时分享给其他所有观众，连麦的处理也有部分工作在推流端完成

视频处理中包含美颜、水印、以及各种自定义滤镜等处理。

除了要提供这些「标准」处理功能之外，我们还需要将该模块设计成可自由接入自定义处理功能的方式

# 常见视频处理功能

## 美颜

美颜的主要原理是通过「磨皮+美白」来达到整体美颜的效果。

磨皮的技术术语是「去噪」，也即对图像中的噪点进行去除或者模糊化处理，常见的去噪算法有均值模糊、高斯模糊和中值滤波等。对整张图像进行「去噪」处理的时候不需要将眼睛也去掉，因此这个环节中也涉及到人脸和皮肤检测技术。

## 视频水印

用于简单是版权保护，或者进行广告设置。出于监管需求，相关部门也规定视频直播过程中必须打上水印，同时直播的视频必须录制存储下来保存一定的时间，并在录制的视频上打上水印。

视频水印包括**播放器水印和视频内嵌水印**两种方式可供选择。综合考虑云端录制对于水印的需求，一般会选择「视频内嵌水印」的方式打水印。

## 滤镜

iOS 端可以考虑使用 [GPUImage](https://github.com/BradLarson/GPUImage)，这是一个开源的基于GPU的图片或视频的处理框架，内置了多达120多种常见的滤镜效果。添加实时的滤镜只需要简单地添加几行代码，还可以基于这个库自己写算法实现更丰富端效果。

Android 有 GPUImage 这个库的[移植](https://github.com/CyberAgent/android-gpuimage)。Google 官方也开源了一个伟大的库 [grafika](https://github.com/google/grafika)，覆盖了 Android 上面很多多媒体和图形图像相关的处理

## 连麦

{% asset_img 连麦.png %}

连麦是互动直播中常见的需求，其流程如上图所示。主播和部分观众之间可以进行实时互动，然后将互动结果实时播放给其他观众观看。

基于以上业务需求，我们很容易想到基于单向直播原理，在主播端和连麦观众端进行**双向推流和双向播流**的方式互动，然后在**服务端**将两路推流**合成**一路推送给其他观众。但 RTMP 带来的延迟决定了这种方式无法做到用户可接受的互动直播。

### 互动直播的主要技术难点

#### 低延迟互动

保证主播和互动观众之间能够实时互动，两者之间就像电话沟通，因此必须保证两者能在**秒级**以内听到对方的声音，看到对方的视频；

#### 音画同步

互动直播中对音画同步的需求比单向直播中更高，必须保证在音视频秒级传输情况下的**秒级**同步。

#### 音视频实时合成

其他观众需要实时观看到对话结果，因此需要在客户端或者服务端将画面和声音实时合成，然后以低成本高品质的方式传输观众端。

### 互动直播的解决方案

#### 思科或者 WebEx

在视频和电话会议领域，目前比较成熟的方案是使用**思科或者 WebEx** 的方案，但这些商用的方案**一不开源，二比较封闭，三成本比较高**。

#### WebRTC

对于互动人数比较少的互动直播，目前市场上比较成熟的方案是使用基于 **WebRTC** 的实时通讯方案。

基于该方案可以轻松实现多人（**14 人以下**）的多方实时通信

{% asset_img webrtc.png %}

上图是一个基于 WebRTC 协议实现多方实时通讯的示意图，本地用户（主播）和远程用户（连麦观众）之间的连接通过 RTCPeerConnection API 管理，这个 API 包装了底层流管理和信令控制相关的细节。

基于该方案的多方实时通信，如下图所示：

{% asset_img webrtc-network.png %}

在通信人数少的情况下，其复杂度相对简单。如 2 人情况下，直接连接。人数增多至 4 人之后，其可选的网络结构就增多了，如上图所示，可以每个点之间形成**自组织网络**的方式通信，也可以以 1 人为中心形成**星型**通信网络，还可以让大家都通过一个**集中式的服务端**进行通信。

为了提供 **高性能、可伸缩**的直播基础服务，七牛直播云经过评估选择了**以主播为中心形成星形通信网络**。同时，为了降低传输延迟，这里采用经过**改造的 UDP 协议传输**传输合成后的音视频实时传输到其他观众端

{% asset_img 互动直播连麦.png %}

# 参考&扩展

- [《视频直播技术详解》系列之三：处理](https://blog.qiniu.com/archives/6795)