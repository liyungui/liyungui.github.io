---
title: 直播技术五-推流和传输
date: 2019-08-03 15:02:14
categories:
  - 直播
tags:
  - 直播
---

推流是直播的第一公里，直播的推流对整个直播链路影响非常大，如果推流的网络不稳定，无论我们如何做优化，观众的体验都会很糟糕。所以也是我们**排查问题的第一步**，如何系统地解决这类问题需要我们对相关理论有基础的认识。

# 推送协议

|协议|传输协议|视频封装格式|延时|数据分段|HTML 5|
|---|---|---|---|---|---|
|RTMP|TCP|flv tag|1-3s|连续流|不支持|
|HTTP-FLV|HTTP-TCP|flv|1-3s|连续流|支持|
|HLS|HTTP-TCP|m3u8/ts|10s+|切片|支持|
|WebRTC|UDP||||支持|
|基于 UDP 的私有协议|UDP||||||

**HLS慢**的原因是**等数据**，缩短ts间隔与个数，HLS也能做到4秒+的延迟

|协议|全称|说明|优点|缺点|
|---|---|---|---|---|---|---|---|---|---|
|RTMP|Real Time Messaging Protocol <br>实时消息传输协议|Adobe公司推出。<br>1. 用来进行实时数据通信的网络协议。<br>2. 目前主流的流媒体传输协议<br> 3. 广泛用于直播领域，绝大多数的直播产品都采用这个协议|1. CDN支持良好，主流的 CDN 厂商都支持。<br>2. 协议简单，在各平台上实现容易|1. 基于TCP，传输成本高，弱网环境丢包率高的情况下问题显著。<br>2. 非公共端口，可能会被防火墙阻拦。<br>3. 不支持浏览器推送。<br>4. Adobe 私有协议，Adobe 已经不再更新|
|HTTP-FLV||Adobe公司推出。将流媒体数据封装成 FLV 格式，通过 HTTP 协议传输给客户端|1. 依靠 MIME 的特性，根据协议中的 Content-Type 来选择相应的程序去处理。<br>2. 基于 HTTP/80 传输, 穿透防火墙。<br>3. 可以通过 HTTP 302 跳转灵活调度/负载均衡。<br>4.支持使用 HTTPS 加密传输|缓存流媒体资源在本地客户端，保密性不够好|
|HLS|HTTP Live Streaming|苹果推出的。<br>服务器端将流媒体数据切割成连续的时长较短的 ts 小文件，并通过 M3U8 索引文件按序访问 ts 文件|1. 在 HTML5 页面上实现播放非常简单。<br>2. 穿透防火墙。基于 HTTP/80 传输<br> 3. 性能高,自带多码率自适应|1. 实时性差，延迟高。慢的原因是等数据，缩短ts间隔与个数，HLS也能做到4秒+的延迟<br>2. 文件碎片。ts 切片较小，会造成海量小文件，对存储和缓存都有一定的挑战|
|WebRTC|Web Real-Time Communication <br>网页即时通信|1. 支持网页浏览器进行实时语音对话或视频对话的 API。<br>2. 主要应用于视频会议和连麦中|1. W3C 标准，主流浏览器支持程度高。<br>2. Google 在背后支撑，并在各平台有参考实现。<br>3.基于 SRTP 和 UDP，弱网情况优化空间大。<br>4.可以实现点对点通信，通信双方延时低|底层依赖ICE,STUN,TURN 传统 CDN 没有类似的服务提供|
|基于 UDP 的私有协议||有些直播应用会使用 UDP 做为底层协议开发自己的私有协议|基于UDP自研，弱网情况优化空间更大|1. 开发成本高。<br>2. 需要自建 CDN 或者和 CDN 达成协议。 <br>3. 独立作战，无法和社区一起演进|

## webrtc协议分层

{% asset_img webrtc协议分层.jpg %}

# 传输网络

推送出去的流媒体需要传输到观众，整个链路就是传输网络

这个成本巨高，直播服务提供商才自建传输网络。

# 参考&扩展

- [《视频直播技术详解》系列之五：推流和传输](https://blog.qiniu.com/archives/6914)