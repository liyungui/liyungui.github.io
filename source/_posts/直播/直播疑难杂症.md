---
title: 直播疑难杂症
date: 2019-07-31 14:52:14
categories:
  - 直播
tags:
  - 直播
---

# 问题

- 播放失败
- 卡顿
- 首开慢
- 延时高
- 音画不同步
- 马赛克严重
- 黑屏、花屏、绿屏
- 杂音、噪音、回声
- 点播拖动不准
- 发热

# 卡顿

## 表现

包括但不限于以下这些：

- 频繁出现缓冲

- 播放不够流畅，画面声音一卡一卡的

从代码层面来说，**帧率太低**

## 原因

通常可能有如下几大类

### 网络带宽不足

一个完整的直播应用，简单来说数据流是这样的：`主播 -> CDN -> 观众`

因此，直播出现卡顿，三个端都可能是问题的源头：

- 主播端的网络不好，导致推流上行不稳定
- 服务端的线路质量不好，导致分发不稳定
- 观众端的网络不好，导致拉流下行不稳定

#### 如何判断网络不好

- 宽度测速。是否低于推流码率所需宽带
- 宽带稳定性。丢包率，延时
- SDK回调。推流/拉流 码率 帧率

### 播放设备性能不足

设备性能不足，导致解码播放的帧率远小于视频码流的实际帧率，从而产生卡顿。

解决方案：

- 优先硬解，充分利用 GPU 加速
- 低端机上优先选择非高清码流。越高清的码率，对解码的要求越高
- 增大缓冲区，缓解卡顿

### 视频流时间戳问题

播放器一般是严格根据码流中的音视频的时间戳来做音画同步的，因此，如果码流中的音视频时间戳出现错误，肯定会影响到播放画面的渲染时机

播放器一般 master 主时钟是单调递增的，当后来的视频帧小于了当前的主时钟，播放器就会做丢帧处理，从而导致播放的视频帧率远低于实际码流中的视频帧率，从而产生卡顿现象。

{% asset_img stream_time.jpeg %}

排查这个问题，可以把读取到的每一帧音频、视频的时间戳打印出来看看

# 参考&扩展

- [《直播疑难杂症排查》之二：播放卡顿](https://blog.qiniu.com/archives/8405)