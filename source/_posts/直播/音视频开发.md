---
title: 音视频开发
date: 2020-04-02 14:52:14
categories:
  - 直播
tags:
  - 直播
---

# 音视频采集流程

{% asset_img 音视频采集流程.png %}

{% asset_img 音视频采集流程2.png %}

# 音频采集

Android SDK对于音频采集提供两套API：MediaRecorder和AudioRecorder。

## MediaRecorder

- 输出编码压缩后的音视频数据
- 可以直接播放器播放
- 无法实时处理音频数据

## AudioRecord

- 输出PCM语音数据(Pulse Code Modulation 脉冲编码调制)
	- 未经压缩的音频采样数据裸流
- 不能够被播放器播放，必须先编码以及压缩(amr MP3 AAC)
	- AudioTrack可播放
- 可以实时处理音频(边录边播，变声，降噪，直播)

# 视频采集

Camera是以前老的 API ，从 Android 5.0(21)之后就已经放弃了。如今主要使用 Camera2 进行视频的采集。

和音频一样，Android SDK对于视频采集提供两套API：MediaRecorder和MediaCodec。 

## MediaRecorder

## MediaCodec

- 输出原始视频帧数据
- 不能够被播放器播放，必须先编码以及压缩
- 可以实时处理(滤镜，特效)

# 视频处理

滤镜和特效 大部分都是通过 **OpenGL** 进行处理的

Android 中有 GLSurfaceView，这个类似于 SurfaceView，不过可以利用 Renderer 对其进行渲染。通过 OpenGL 可以生成纹理，通过纹理的 Id 可以生成 SurfaceTexture，而 SurfaceTexture 可以交给 Camera，最后通过纹理就将摄像头预览画面和 OpenGL 建立了联系，从而可以通过 OpenGL 进行一系列的操作。

美颜的整个过程无非是根据 Camera 预览的纹理通过 OpenGL 中 FBO 技术生成一个新的纹理，然后在 Renderer 中的onDrawFrame() 使用新的纹理进行绘制。添加水印也就是先将一张图片转换为纹理，然后利用 OpenGL 进行绘制。添加动态挂件特效则比较复杂，先要根据当前的预览图片进行算法分析识别人脸部相应部位，然后在各个相应部位上绘制相应的图像，整个过程的实现有一定的难度，人脸识别技术目前有 OpenCV、Dlib、MTCNN 等。

# 音视频编码和封装

## 为何要编码

压缩即编码，方便保存和传输

## 硬编码和软件编码

软编码：使用CPU进行编码，实现直接、简单，参数调整方便，升级易，但CPU负载重，性能较硬编码低，低码率下质量通常比硬编码要好一点。

硬编码：使用非CPU进行编码，如显卡GPU、专用的DSP、FPGA、ASIC
芯片等，性能高，低码率下通常质量低于软编码器，但部分产品在GPU硬
件平台移植了优秀的软编码算法（如X264）的，质量基本等同于
软编码。


软解码，指利用CPU的计算能力来解码，通常如果CPU的能力不是很强的时候，一则解码速度会比较慢，二则手机可能出现发热现象。优点是，由于使用统一的算法，兼容性会很好。

硬解码，指的是利用手机上专门的解码芯片来加速解码。通常硬解码的解码速度会快很多，但是由于硬解码由各个厂家实现，质量参差不齐，非常容易出现兼容性问题。

在Android4.1及以上版本可以使用MediaCodec来访问底层的媒体编解码器从而支持硬编码/硬解码。之前的版本基本都是软编解码(比如FFMpeg)

推荐安卓4.1以上使用硬编码，以下使用软编码，而iOS使用全部硬编码。安卓和iOS都优先使用硬解码方案，兼容性出错情况下切换到软解码保证正常播放

## 编码封装方案

### FFMpeg

- **功能全面**：编解码、视频滤镜、流媒体推流、音频各种特效等等
- 学习门槛：低
- 效率：中等。2017年5月以后最新版整合了MediaCodec
- 稳定性：稳定
- 打包占用空间：10MB+

EpMedia，基于FFMpeg的软解开源方案

### MediaCodec

- 功能：编解码
	- 滤镜、字幕、拼接等功能的话，需要自己配合OpenGL ES 来实现
	- 音视频拼接的话，要考虑到不同音频采样率的重采样问题，音频重采用问题，需要懂得傅立叶变换相关的离散信号变换方法，如果要实现音频特效，如变声、均衡器的话，也需要懂得上述信号变换方法
- 学习门槛：高
- 效率：最快。硬编
- 稳定性：稳定
- 打包占用空间：几百KB设置几十KB

**兼容性**：依赖于硬件设备，安卓设备硬件差异很大，需要自行提供兼容性上的支持

m4m，videotranscoder，基于MediaCodec的开源方案，表面看上去功能很强大，实际使用的时候会遇到不少坑，只适用于对MediaCodec的原理进行研究。

### mp4praser

- 功能：编解码及编辑
- 学习门槛：低
- 效率：最慢。软编
- 稳定性：低配机器可能出现卡顿
- 打包占用空间：小

# 参考&扩展

- [音视频开发总结之二Android平台相关](https://www.jianshu.com/p/a1ce4418e2b5)采集流程、采集方案对比、编码方案对比、播放方案对比、滤镜特效
- [Android短视频中如何实现720P磨皮美颜录制](https://blog.csdn.net/xiaoying5558/article/details/80132276)网易云短视频SDK