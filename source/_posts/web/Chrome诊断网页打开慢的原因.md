---
title: Chrome诊断网页打开慢的原因
date: 2019-08-20 09:05:14
categories:
  - web
tags:
  - web
---

# 流程

- 打开目标网页
- 打开开发者模式
- 右键浏览器的刷新按钮，选择 `清空缓存并硬性重新加载`
	- 正常重新加载 Ctrl+R：正常重新加载。 
	- 硬性重新加载：Ctrl+Shift+R:浅层次的清除历史记录，但不一定缓存完全清除。(Ctrl+F5)同理。 
	- 清空缓存并硬性重新加载：可以深层次的清除所有的缓存。(建议用这个) 

# 诊断

上面流程加载完成后，开发者工具 `network` 标签如下

{% asset_img chrome-network.png %} 

## 重要指标

底部展示了几个重要的指标

- 请求成功数量/请求总数量
- 网页加载成功体积/网页总体积
- 资源加载成功体积/资源总体积
- 耗时

## 时间线-详细耗时信息

网记请求列表，默认是按时间顺序排序(waterfall瀑布)

找到耗时最长的几个请求

鼠标悬停某个请求的waterfall会弹窗展示耗时的详细信息，如下

{% asset_img time-detail.png %} 

{% asset_img time-detail-2.png %} 

## 时间线各阶段指标

### Queueing(排队时间)

如果某个请求正在排队，则指示：

- 请求已被渲染引擎推迟
	- 因为该请求的优先级被视为低于关键资源（例如脚本/样式）的优先级。 
	- 图像经常发生这种情况。
- 请求已被暂停，以等待可复用的TCP连接。
	- 因为在 HTTP 1 上，浏览器仅允许每个源拥有六个 TCP 连接。
- 生成磁盘缓存条目所用的时间（通常非常迅速）


### Stalled/Blocking

浏览器得到要发出这个请求的指令，到请求可以发出的**等待时间**

可以是等待 Queueing 中介绍的任何一个原因。 

此外，此时间包含代理协商所用的时间。

不包括DNS查询、建立TCP连接等时间。

### Proxy Negotiation

与代理服务器连接协商所用的时间。

### DNS lookup

DNS解析所耗费的时间。

### Initial connection

用户建立连接的时间，包括TCP握手以及多次尝试握手，以及处理SSL的时间。

### SSL

完成SSL握手的时间。

### Request_sent

请求第一个字节发出到最后一个字节发出的时间，请求发出时间(一般可以忽略，否则即为浏览器本身或者本地网络问题)。

Waitting(TTFB)：请求发出后，到收到响应的第一个字节所花费的时间(Time To First Byte)，即请求从客户端发送给服务端时间+服务器处理请求的时间。

### Content Download

接收到响应的第一个字节，到接收完最后一个字节的时间，就是下载响应所耗费的时间。

## 诊断问题

### 队列时间过长

#### 原因

从单个网域检索太多的资源，即**单个网域的请求数量过多**

在 HTTP 1.0/1.1 连接上，Chrome 会将每个主机强制设置为最多六个 TCP 连接。如果您一次请求十二个条目，前六个将开始，而后六个将被加入队列。

#### 解决方案

##### HTTP 1

- 合并 图片、css、js等一些可以合并的文件，来减少http的请求数
- 设置 `keep-alive` 可以在一定的时间内保证连接的可复用性，减少连接时间
- 实现域分片。也就是在您的应用上设置多个子域，以便提供资源。然后，在子域之间平均分配正在提供的资源。
	- 在浏览器最大并行下载数跟dns查找(也有耗时)之间做权衡。根据雅虎的研究，最好将主机名控制在2-4个内

##### HTTP 2

请不要对您的资源进行域分片

在 HTTP 2 中，到服务器的单个 TCP 连接作为多路复用连接。这消除了 HTTP 1 中的六个连接限制，并且可以通过单个连接同时传输多个资源。

### 第一字节等待时间过长

又称：大片绿色

将此值控制在 200 毫秒以下

#### 原因

1. 客户端与服务器之间的网络条件较差
2. **服务器应用的响应慢**

#### 解决方案

将应用托管在本地，然后查看 TTFB 真实的响应速度。如果仍然很长，则需要优化应用的响应速度。可以是优化数据库查询、为特定部分的内容实现缓存，或者修改您的网络服务器配置。

### 内容下载时间过长

又称：大片蓝色。决定服务器吞吐能力

#### 原因

**内容体积过大**

#### 解决方案

- 减少发送的字节数
- 压缩文件
- 启用本地缓存。把网站里面更新频率比较低的静态资源缓存在浏览器中
- 启用CDN加速。本质也是缓存，把内容缓存在离用户近的主机

# 参考&扩展

- [使用chrome浏览器排查网页打开慢的方法](https://help.aliyun.com/knowledge_detail/36453.html)
- [Chrome Dev Tool 中时间线各阶段代表的意义](https://blog.csdn.net/shan1991fei/article/details/80690220)
- [了解资源耗时 | Chrome F12 network](https://www.liulanqi.com/239.html)



