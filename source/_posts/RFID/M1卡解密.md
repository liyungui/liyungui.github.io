---
title: M1卡解密
date: 2017-07-22 14:39:23
tags:
	- RFID
---

# ID卡

ID卡，大家常说的低频卡

一般大部分情况下作为门禁卡或者饭卡

一般为厚一些的卡，是只读的，卡里面只保存有一串唯一的数字序号ID，读卡器只能读到ID号，然后通过跟后台数据库进行匹配，实际上操作的是对应ID号相关的数据库中的数据。

ID卡本身不存在任何其他数据，常见的攻击方法是ID卡复制，ID卡除了复制也没有其他研究的了，毕竟太简单了。

淘宝有卖的工具，两节7号电池，按读卡按钮读要复制的卡的ID，然后再按写卡按钮，把读到的ID号写入到空白卡中，即完成了卡复制工作。很多大街上配门禁卡的都拿着这种工具

# M1卡和CPU卡

{% asset_image m1cpu.png %}

Mifare 1K卡，也就是M1卡，非接触智能卡。

正版是菲利浦下属子公司恩智浦出品的芯片，但是我们现在用的卡大部分都是中国山寨的

自从2008年M1卡被德国人破解了安全算法之后，CPU卡在逐渐替代M1卡

# M1卡数据结构

## 1K卡和4K卡

目前能看到的有2种M1卡,分别为S50 S70,其实就是容量不一样, S50为1Kbyte  S70为4Kbyte

主要介绍S50 即1K卡   4K卡很少见

## 1K卡数据结构

S50容量1Kbyte，16个扇区(Sector),每个扇区4块（Block）（块0～3），共64块，按块号编址为0～63。

每个扇区有独立的一组密码及访问控制。

各扇区的块0、块1、块2为数据块，用于存贮数据；块3为控制块，存放密码A、存取控制、密码B。

其中第0扇区的块0（即绝对地址0块）用于存放厂商代码，已经固化，不可更改。

# 特殊卡

## UID卡

第0扇区的所有块都可以更改。

而且该型卡有后门,可以绕过密码,直接读取数据,这卡的密码就是装饰,没用!

## FUID 

一次性可写ID号的卡

空白的时候可以写入一次ID,以后就不能改了.

这是对付读卡器有防复制功能的一种办法,也有叫穿透防火墙...

## CUID

ID号可以做到反复擦写使用，再也不用担心用一次之后报废掉的问题

## 空白卡

差不多类似 CUID

# 数据安全

## 安全手段

- 明码
- 加密
- 校验位
- 滚动码。刷一次卡,卡里的特定区块数据就变化一次,数据有的有规律,有的毫无规律...
- 系统带黑名单功能。数据验证无法通过,将卡列到黑名单中,通过物业也许可恢复

## 实例

明码10进制。17年7月7日到期

{% asset_image 明码10进制.png %}

明码16进制。14年12月18日到期

{% asset_image 明码16进制.png %}

# 暴力破解

两个漏洞攻击方法

## nested authentication 攻击（验证漏洞攻击）

工具：mfoc
这一个要求是16个扇区中有默认密码存在，先探测出默认密码，然后利用默认密码跟卡建立通讯（如果密码不对读卡器无法与tag建立通讯），虽然读卡器不知道tag它在说什么，但是从tag的话中分析加暴力出它的加密方法（就是其他扇区密码）。其根本上还是猜解，但是从“只言片语”中分析可以使猜解时间变短。

## darkside 攻击
工具：mfcuk（注意后面不是fuck……）
如果所有扇区都被加密，没有默认密码怎么办？后来发现加密算法还有一个漏洞：当读卡器发送的加密数据中的某8bit全部正确的时候tag会给读卡器发送一个加密的4bit的数据回复NACK（否定应答），其他任何情况下tag都会直接停止交互。然后我们再利用这4bit的加密的NACK分析，解出key，如果一个扇区的key破解出来，就可以再使用nested authentication 攻击破解其他扇区密码。

由于破解算法的原理本身就不是100%成功的，所以如果长时间破解不出来，就停了，重新选个时间破解(每次都会重新换个nt)，跟运气也有些关系

### MFCUK

欺诈性密码恢复工具

给出很多可能的密码

同一个密码只要出现三次以上，就可以把这个密码记下来。然后在MFOC.BAT里编辑加入这个密码进行尝试


### Libnfc工具

目前用的比较多的是radiowar网站的nfcgui，就是给nfc-list  nfc-mfsetuid  nfc-mfclassic  这三个工具写了个gui界面，也可以使用命令行模式

### PM3的darkside攻击

Proxmark3

# 监听读卡器和卡通讯

工具：PM3

监控授权读卡器和tag间的**加密数据**交换，然后通过“XOR效验与算Key”程序算出密码来。

一般是内部人员把读卡器中的SAM偷出来，SAM实际上就是保存读卡器中密码的一个模块，然后通过另外的读卡器插入SAM，用正常的授权的卡刷卡，然后监控交换数据，从而算出密码。


# 监听读卡器和电脑通讯

读卡器跟电脑通讯是明文传输(电脑中肯定没有加密芯片)

在某种环境中，比如通过电脑程序导入密码到读卡器的时候，通过监控USB口（串口）数据通信，抓到的明文数据，包含了导入到读卡器中的密码明文

参考&扩展

- [IC卡解密从零开始学2 版本更新! 解密工具PN532-mfoc-mfcuk-GUI V2.1 By:lookyour](https://www.cnblogs.com/cneseu/p/6828023.html) M1结构和流程工具
- [Mifare 1K卡破解乱谈（二）](http://blog.sina.com.cn/s/blog_751ba6c30102uy9j.html) 两大漏洞攻击方法
- [RFID破解三两事](https://www.freebuf.com/articles/wireless/8792.html)


