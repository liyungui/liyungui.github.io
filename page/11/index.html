<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/11/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/直播/ijkplayer/ijkplayer系列五-视频解码与播放/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/直播/ijkplayer/ijkplayer系列五-视频解码与播放/" itemprop="url">ijkplayer系列五-视频解码与播放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-08T10:22:14+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="解码线程"><a href="#解码线程" class="headerlink" title="解码线程"></a>解码线程</h1><p>从数据读取线程分析那篇文章我们可以看到，ijkplayer的视频解码线程的入口函数是<code>video_thread()/ff_ffplayer.c</code></p>
<h2 id="video-thread"><a href="#video-thread" class="headerlink" title="video_thread"></a><code>video_thread</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">video_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FFPlayer *ffp = (FFPlayer *)arg;</span><br><span class="line">    <span class="keyword">int</span>       ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;node_vdec) &#123;</span><br><span class="line">        ret = ffpipenode_run_sync(ffp-&gt;node_vdec);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ffpipenode_run_sync()/ff_ffpipenode.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffpipenode_run_sync</span><span class="params">(IJKFF_Pipenode *node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;func_run_sync(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用的实际是 <code>ffp-&gt;node_vdec-&gt;func_run_sync(node);</code></p>
<p>又是直接运行的ffplayer结构体里面的函数，肯定和音频播放一样，在之前初始化的时候给这个函数指针赋值过，那么我们回过头看看到底在哪里为它赋值的:</p>
<p>我们还是看到之前初始化的<code>ijkmp_android_create()</code>调用<code>ffpipeline_create_from_android()</code>，然后里面有一句:</p>
<p><code>pipeline-&gt;func_open_video_decoder = func_open_video_decoder;</code></p>
<p>然后我们再返回看到在<code>stream_component_open()/ff_ffplayer.c</code>里面有一句:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">decoder_init(&amp;is-&gt;viddec, avctx, &amp;is-&gt;videoq, is-&gt;continue_read_thread);</span><br><span class="line">ffp-&gt;node_vdec = ffpipeline_open_video_decoder(ffp-&gt;pipeline, ffp);</span><br></pre></td></tr></table></figure>
<p>点进去<code>ffpipeline_open_video_decoder(ffp-&gt;pipeline, ffp);</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IJKFF_Pipenode* <span class="title">ffpipeline_open_video_decoder</span><span class="params">(IJKFF_Pipeline *pipeline, FFPlayer *ffp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pipeline-&gt;func_open_video_decoder(pipeline, ffp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合上面的分析，在<code>stream_component_open()/ff_ffplayer.c</code>里面其实运行了<code>func_open_video_decoder()/ffpipeline_android.c</code>，然后把返回值赋值给<code>ffp-&gt;node_vdec</code>;继续跟着流程到<code>func_open_video_decoder()</code>。由于这里跳转比较麻烦，我就直接上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func_open_video_decoder()</span><br><span class="line">&#123;</span><br><span class="line">        |(调用)</span><br><span class="line">    <span class="comment">//(这里其实有个判断，是用硬解码还是软解，我们只分析硬解码)</span></span><br><span class="line">    node = ffpipenode_create_video_decoder_from_android_mediacodec(ffp, pipeline, opaque-&gt;weak_vout);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">        |(执行)</span><br><span class="line">    <span class="comment">//alloc一个IJKFF_Pipenode </span></span><br><span class="line">    IJKFF_Pipenode *node =  ffpipenode_alloc(<span class="keyword">sizeof</span>(IJKFF_Pipenode_Opaque));</span><br><span class="line">    node-&gt;func_destroy  = func_destroy;</span><br><span class="line">    node-&gt;func_run_sync = func_run_sync;</span><br><span class="line">    node-&gt;func_flush    = func_flush;</span><br><span class="line">    reutnr node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终 <code>ffp-&gt;node_vdec =node</code></p>
<p>现在终于找到赋值的地方了，前面调用的<code>ffp-&gt;node_vdec-&gt;func_run_sync(node);</code>现在看来就是调用的<code>func_run_sync()</code>函数</p>
<h3 id="func-run-sync"><a href="#func-run-sync" class="headerlink" title="func_run_sync"></a><code>func_run_sync</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">func_run_sync</span><span class="params">(IJKFF_Pipenode *node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IJKFF_Pipenode_Opaque *opaque   = node-&gt;opaque;</span><br><span class="line">    FFPlayer              *ffp      = opaque-&gt;ffp;</span><br><span class="line">    VideoState            *is       = ffp-&gt;is;</span><br><span class="line">    Decoder               *d        = &amp;is-&gt;viddec;</span><br><span class="line">    PacketQueue           *q        = d-&gt;<span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    opaque-&gt;enqueue_thread = SDL_CreateThreadEx(&amp;opaque-&gt;_enqueue_thread, enqueue_thread_func, node, <span class="string">"amediacodec_input_thread"</span>);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (!q-&gt;abort_request) &#123;</span><br><span class="line">      	<span class="comment">//...</span></span><br><span class="line">        ret = drain_output_buffer(env, node, timeUs, &amp;dequeue_count, frame, &amp;got_frame);</span><br><span class="line">  		<span class="comment">//...</span></span><br><span class="line">		ret = ffp_queue_picture(ffp, frame, pts, duration, av_frame_get_pkt_pos(frame), is-&gt;viddec.pkt_serial);</span><br><span class="line">     <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">	fail:</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="线程enqueue-thread-func"><a href="#线程enqueue-thread-func" class="headerlink" title="线程enqueue_thread_func"></a>线程<code>enqueue_thread_func</code></h4><p>在视频解码流程里面又创建了一个线程:</p>
<p><code>opaque-&gt;enqueue_thread = SDL_CreateThreadEx(&amp;opaque-&gt;_enqueue_thread, enqueue_thread_func, node, &quot;amediacodec_input_thread&quot;);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">从命名来看，是一个input_thread，我们先来看看这个线程:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">enqueue_thread_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IJKFF_Pipenode        *node     = arg;</span><br><span class="line">    IJKFF_Pipenode_Opaque *opaque   = node-&gt;opaque;</span><br><span class="line">    FFPlayer              *ffp      = opaque-&gt;ffp;</span><br><span class="line">    VideoState            *is       = ffp-&gt;is;</span><br><span class="line">    Decoder               *d        = &amp;is-&gt;viddec;</span><br><span class="line">    PacketQueue           *q        = d-&gt;<span class="built_in">queue</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (!q-&gt;abort_request) &#123;</span><br><span class="line">        ret = feed_input_buffer(env, node, AMC_INPUT_TIMEOUT_US, &amp;dequeue_count);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点进去<code>feed_input_buffer()/ffpipenode_android_mediacodec_vdec.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">staticint <span class="title">feed_input_buffer</span><span class="params">(JNIEnv *env, IJKFF_Pipenode *node, <span class="keyword">int64_t</span> timeUs, <span class="keyword">int</span>*enqueue_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ffp_packet_queue_get_or_buffering(ffp, d-&gt;<span class="built_in">queue</span>, &amp;pkt,&amp;d-&gt;pkt_serial, &amp;d-&gt;finished) &lt; <span class="number">0</span>) &#123; <span class="comment">//取得数据包</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        input_buffer_ptr= SDL_AMediaCodec_getInputBuffer(opaque-&gt;acodec, input_buffer_index,&amp;input_buffer_size); <span class="comment">//得到硬解码应该输入的buffer的地址</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="built_in">memcpy</span>(input_buffer_ptr,d-&gt;pkt_temp.data, copy_size);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        amc_ret= SDL_AMediaCodec_queueInputBuffer(opaque-&gt;acodec, input_buffer_index, <span class="number">0</span>,copy_size, time_stamp, <span class="number">0</span>); </span><br><span class="line"><span class="comment">//送到AMediaCodec解码器</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，这一步原来就是用硬解码器解码。这个<code>input_thread</code>也就只是把每一帧数据送到解码器去解码而已。</p>
<h4 id="drain-output-buffer-l"><a href="#drain-output-buffer-l" class="headerlink" title="drain_output_buffer_l"></a><code>drain_output_buffer_l</code></h4><p>从硬解码器中获得解码后的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">drain_output_buffer_l</span><span class="params">(JNIEnv *env, IJKFF_Pipenode *node, <span class="keyword">int64_t</span> timeUs,<span class="keyword">int</span> *dequeue_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//从硬解码器中获得解码后的数据</span></span><br><span class="line">	output_buffer_index= SDL_AMediaCodec_dequeueOutputBuffer(opaque-&gt;acodec, &amp;bufferInfo,timeUs); </span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ffp-queue-picture"><a href="#ffp-queue-picture" class="headerlink" title="ffp_queue_picture"></a><code>ffp_queue_picture</code></h4><p>把数据插入到显示队列 <code>ijkplayer-&gt;ffplayer-&gt;is-&gt;pictq</code> 中</p>
<h1 id="显示线程"><a href="#显示线程" class="headerlink" title="显示线程"></a>显示线程</h1><p>显示线程从 <code>is-&gt;pictq</code> 读取数据，然后直接推送给硬件设备，完成渲染。</p>
<p>前面关于启动流程的分析我们知道，IjkMediaPlayer.prepareAsync <code>stream_open</code>中创建了视频显示进程</p>
<p><code>is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, &quot;ff_vout&quot;);</code></p>
<h2 id="video-refresh-thread-ff-ffplayer-c"><a href="#video-refresh-thread-ff-ffplayer-c" class="headerlink" title="video_refresh_thread()/ff_ffplayer.c"></a><code>video_refresh_thread()/ff_ffplayer.c</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">video_refresh_thread(<span class="keyword">void</span> *arg)</span><br><span class="line">              |(调用)</span><br><span class="line">video_refresh(ffp, &amp;remaining_time);</span><br><span class="line">              |(调用)</span><br><span class="line"> video_display2(ffp);</span><br><span class="line">              |(调用)</span><br><span class="line">video_image_display2(ffp);</span><br></pre></td></tr></table></figure>
<h3 id="video-image-display2"><a href="#video-image-display2" class="headerlink" title="video_image_display2"></a><code>video_image_display2</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">video_image_display2</span><span class="params">(FFPlayer *ffp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    Frame *vp;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//从队列中取出数据</span></span><br><span class="line">	<span class="comment">//然后调用SDL_VoutDisplayYUVOverlay()完成渲染。</span></span><br><span class="line">    vp = frame_queue_peek(&amp;is-&gt;pictq);</span><br><span class="line">    <span class="keyword">if</span> (vp-&gt;bmp) &#123;</span><br><span class="line">        SDL_VoutDisplayYUVOverlay(ffp-&gt;vout, vp-&gt;bmp);</span><br><span class="line">        ffp-&gt;stat.vfps = SDL_SpeedSamplerAdd(&amp;ffp-&gt;vfps_sampler, FFP_SHOW_VFPS_FFPLAY, <span class="string">"vfps[ffplay]"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ffp-&gt;first_video_frame_rendered) &#123;</span><br><span class="line">            ffp-&gt;first_video_frame_rendered = <span class="number">1</span>;</span><br><span class="line">            ffp_notify_msg1(ffp, FFP_MSG_VIDEO_RENDERING_START);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SDL-VoutDisplayYUVOverlay"><a href="#SDL-VoutDisplayYUVOverlay" class="headerlink" title="SDL_VoutDisplayYUVOverlay"></a><code>SDL_VoutDisplayYUVOverlay</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SDL_VoutDisplayYUVOverlay</span><span class="params">(SDL_Vout *vout, SDL_VoutOverlay *overlay)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (vout &amp;&amp; overlay &amp;&amp; vout-&gt;display_overlay)</span><br><span class="line">        <span class="keyword">return</span> vout-&gt;display_overlay(vout, overlay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在初始化的时候，在 <code>ijkmp_android_create()</code>里面调用的<code>SDL_VoutAndroid_CreateForAndroidSurface();</code> 赋值的：</p>
<p><code>vout-&gt;display_overlay = func_display_overlay;</code></p>
<p>所以其实调用了 <code>func_display_overlay()</code> 完成渲染。从pictq列表中获取视频frame数据，然后再写入nativewindows的视频缓冲中进行渲染。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/07/编程思想/DIP IOC DI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/07/编程思想/DIP IOC DI/" itemprop="url">DIP IOC DI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-07T10:58:53+08:00">
                2019-08-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程思想/" itemprop="url" rel="index">
                    <span itemprop="name">编程思想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DIP-依赖倒置原则"><a href="#DIP-依赖倒置原则" class="headerlink" title="DIP 依赖倒置原则"></a>DIP 依赖倒置原则</h1><p>Dependence Inversion Principle</p>
<p>实际开发，经常出现高层模块(复杂业务模块；调用者)依赖底层模块(基本原子操作；被调用者)，高层模块往往复杂而多变，改动带来新风险。</p>
<p>这类问题的解决方案就是 <strong>依赖倒置原则</strong></p>
<ul>
<li>高层模块不应该直接依赖底层模块,两者都应该依赖抽象.</li>
<li>抽象不应依赖细节.</li>
<li>细节应该依赖抽象.</li>
</ul>
<p><strong>本质</strong> 就是在高层模块(调用者)定义一个 <strong>中间件(抽象层)</strong>，底层模块(被调用者) 实现中间件(实现了依赖倒置)；也就是我们常说的 <strong>面向抽象(接口)编程</strong> </p>
<h1 id="IOC和DI-控制反转和依赖注入"><a href="#IOC和DI-控制反转和依赖注入" class="headerlink" title="IOC和DI 控制反转和依赖注入"></a>IOC和DI 控制反转和依赖注入</h1><p>Inversion of Control</p>
<p>Dependency Injection</p>
<p>示例：用户注册模块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span></span>&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//存储的具体实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">storeUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="title">implments</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userDao=<span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">storeUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//用户信息校验通过</span></span><br><span class="line">        userDao.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码已经尽可能的遵循DIP原则</p>
<p>在UserServiceImpl中,通过new来创建UserDao对象(即 UserDao对象的控制权实际在UserServiceImpl中，两者耦合)</p>
<p>解决方案：增加一个中间件(容器)，负责创建和存储所有注册对象(控制权转移，解耦)，运行时按需从容器中取对象</p>
<p><strong>控制反转是DIP原则的升级</strong>,旨在解决对象依赖问题</p>
<p>控制反转是一种思维方式的变化,<strong>依赖注入</strong>则是该思想的<strong>具体实践</strong>.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>控制反转和依赖倒置皆提现了<strong>常规线性思维的转变</strong></p>
<p>倒置”一词其实反映的是逆常规思维(从抽象到具体)。常规思维是线性的,人认识事物的本质是从具体到抽象。即:将类与类直接打交道改编为抽象与抽象打交道,也就是所谓的面向抽象(抽象类或接口)编程.</p>
<p><strong>控制反转是DIP原则的升级</strong>,旨在解决对象依赖这问题</p>
<p>控制反转是一种思维方式的变化,<strong>依赖注入</strong>则是该思想的<strong>具体实践</strong>.</p>
<p>实现控制反转通常有<strong>两种方式</strong>:依赖查找和依赖注入.</p>
<ul>
<li><strong>依赖查找</strong>:容器提供回调接口和上下文给组件,需要组件自己实现查找合适的对象的过程,此类以<strong>EJB</strong>为代表.</li>
<li><strong>依赖注入</strong>:组件不做任何定位查询,只需向容器提供普通的java方法,然后容器根据这些方法自行决定依赖关系.此类以<strong>Spring</strong>为代表.<ul>
<li>自动注入,更为自动和简单</li>
<li>基本能够实现对原有代码的无侵入</li>
</ul>
</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/c899300f98fa" target="_blank" rel="noopener">白话设计——浅谈DIP和IOC</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/07/直播/ijkplayer/ijkplayer系列四-音频解码与播放/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/07/直播/ijkplayer/ijkplayer系列四-音频解码与播放/" itemprop="url">ijkplayer系列四-音频解码与播放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-07T10:22:14+08:00">
                2019-08-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/2019/08/07/直播/ijkplayer/ijkplayer系列四-音频解码与播放/播放器基本框图.png">
<p>播放器必然是通过<strong>多线程</strong>同时进行解封装、解码、视频渲染等工作的</p>
<h1 id="解码线程"><a href="#解码线程" class="headerlink" title="解码线程"></a>解码线程</h1><p>从数据读取线程分析那篇文章我们可以看到，ijkplayer的音频解码线程的入口函数是<code>audio_thread()/ff_ffplayer.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">audio_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ffp_audio_statistic_l(ffp);</span><br><span class="line">        <span class="comment">//解码帧存放到frame中</span></span><br><span class="line">        <span class="comment">//里面是调用传进去的codec的codec-&gt;decode()方法解码</span></span><br><span class="line">        <span class="keyword">if</span> ((got_frame = decoder_decode_frame(ffp, &amp;is-&gt;auddec, frame, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> the_end;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">while</span> ((ret = av_buffersink_get_frame_flags(is-&gt;out_audio_filter, frame, <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">				<span class="comment">//能否把解码的frame写入音频解码帧列表is-&gt;sampq中(播放线程从这里面读取数据播放)</span></span><br><span class="line">				<span class="comment">//里面会判断sampq队列是否满了</span></span><br><span class="line">				如果没位置放我们的frame的话，会调用pthread_cond_wait()方法阻塞队列</span><br><span class="line">				<span class="comment">//如果有位置放frame的话，就会返回frame应该放置的位置的地址的指针</span></span><br><span class="line">                <span class="keyword">if</span> (!(af = frame_queue_peek_writable(&amp;is-&gt;sampq)))</span><br><span class="line">                    <span class="keyword">goto</span> the_end;</span><br><span class="line"></span><br><span class="line">        		<span class="comment">//...</span></span><br><span class="line">        		<span class="comment">//把frame放入到sampq相应位置</span></span><br><span class="line">        		av_frame_move_ref(af-&gt;frame, frame);</span><br><span class="line">        		<span class="comment">//唤醒线程(音频播放线程因为sampq队列为空而阻塞，这里可以唤醒它)</span></span><br><span class="line">        		rame_queue_push(&amp;is-&gt;sampq);</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ret &gt;= <span class="number">0</span> || ret == AVERROR(EAGAIN) || ret == AVERROR_EOF);</span><br><span class="line"> the_end:</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    av_frame_free(&amp;frame);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="播放流程"><a href="#播放流程" class="headerlink" title="播放流程"></a>播放流程</h1><p>在初始化的时候，有个方法没有跟进去分析，那就是在 <code>native_setup</code>–&gt; <code>ijkmp_android_create()/ijkplayer_android.c</code> –&gt; <code>ffpipeline_create_from_android()/ijkplayer_android.c</code>：</p>
<p>该方法里面一句</p>
<pre><code>pipeline-&gt;func_open_audio_output  = func_open_audio_output;
</code></pre><p><code>func_open_audio_output()/ffpipeline_android.c:</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> SDL_Aout *<span class="title">func_open_audio_output</span><span class="params">(IJKFF_Pipeline *pipeline, FFPlayer *ffp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SDL_Aout *aout = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;opensles) &#123;</span><br><span class="line">        aout = SDL_AoutAndroid_CreateForOpenSLES();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        aout = SDL_AoutAndroid_CreateForAudioTrack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (aout)</span><br><span class="line">        SDL_AoutSetStereoVolume(aout, pipeline-&gt;opaque-&gt;left_volume, pipeline-&gt;opaque-&gt;right_volume);</span><br><span class="line">    <span class="keyword">return</span> aout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出，音频播放也分为:<code>opensles,audiotrack</code>,然后我们就来看看<code>audiotrack</code>吧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SDL_Aout *<span class="title">SDL_AoutAndroid_CreateForAudioTrack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SDL_Aout *aout = SDL_Aout_CreateInternal(<span class="keyword">sizeof</span>(SDL_Aout_Opaque));</span><br><span class="line">    <span class="keyword">if</span> (!aout)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    SDL_Aout_Opaque *opaque = aout-&gt;opaque;</span><br><span class="line">    opaque-&gt;wakeup_cond  = SDL_CreateCond();</span><br><span class="line">    opaque-&gt;wakeup_mutex = SDL_CreateMutex();</span><br><span class="line">    opaque-&gt;speed        = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    aout-&gt;opaque_class = &amp;g_audiotrack_class;</span><br><span class="line">    aout-&gt;free_l       = aout_free_l;</span><br><span class="line">    aout-&gt;open_audio   = aout_open_audio;</span><br><span class="line">    aout-&gt;pause_audio  = aout_pause_audio;</span><br><span class="line">    aout-&gt;flush_audio  = aout_flush_audio;</span><br><span class="line">    aout-&gt;set_volume   = aout_set_volume;</span><br><span class="line">    aout-&gt;close_audio  = aout_close_audio;</span><br><span class="line">    aout-&gt;func_get_audio_session_id = aout_get_audio_session_id;</span><br><span class="line">    aout-&gt;func_set_playback_rate    = func_set_playback_rate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> aout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上一篇数据读取线程我们分析到了在<code>stream_component_open()</code>里面会调用<code>aout-&gt;open_audio(aout, pause_on);</code></p>
<p>再看现在初始化:</p>
<pre><code>aout-&gt;open_audio   = aout_open_audio;    
</code></pre><p>所以 <code>stream_component_open()</code>里面相当于直接调用了<code>aout_open_audio()/ijksdl_aout_android_audiotrack.c</code></p>
<p><code>aout_open_audio()</code> –&gt; <code>aout_open_audio_n()</code> –&gt; 创建音频播放线程</p>
<pre><code>SDL_CreateThreadEx(&amp;opaque-&gt;_audio_tid, aout_thread, aout, &quot;ff_aout_android&quot;);
</code></pre><h2 id="aout-thread"><a href="#aout-thread" class="headerlink" title="aout_thread"></a>aout_thread</h2><p>在这个函数内部会调用 <code>aout_thread_n()/ijksdl_aout_android_audiotrack.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">aout_thread_n</span><span class="params">(JNIEnv *env, SDL_Aout *aout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SDL_Aout_Opaque *opaque = aout-&gt;opaque;</span><br><span class="line">    SDL_Android_AudioTrack *atrack = opaque-&gt;atrack;</span><br><span class="line">    SDL_AudioCallback audio_cblk = opaque-&gt;spec.callback;</span><br><span class="line">    <span class="keyword">void</span> *userdata = opaque-&gt;spec.userdata;</span><br><span class="line">    <span class="keyword">uint8_t</span> *buffer = opaque-&gt;buffer;</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (!opaque-&gt;abort_request &amp;&amp; !opaque-&gt;pause_on)</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!opaque-&gt;abort_request) &#123;</span><br><span class="line">        <span class="comment">//...省略了一堆设置播放器相关的配置(播放速度，音量）</span></span><br><span class="line">        <span class="comment">//...SDL_Android_AudioTrack_set_xxx()</span></span><br><span class="line">        audio_cblk(userdata, buffer, copy_size);</span><br><span class="line">        <span class="keyword">if</span> (opaque-&gt;need_flush) &#123;</span><br><span class="line">            SDL_Android_AudioTrack_flush(env, atrack);</span><br><span class="line">            opaque-&gt;need_flush = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (opaque-&gt;need_flush) &#123;</span><br><span class="line">            opaque-&gt;need_flush = <span class="number">0</span>;</span><br><span class="line">            SDL_Android_AudioTrack_flush(env, atrack);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> written = SDL_Android_AudioTrack_write(env, atrack, buffer, copy_size);</span><br><span class="line">            <span class="keyword">if</span> (written != copy_size) &#123;</span><br><span class="line">                ALOGW(<span class="string">"AudioTrack: not all data copied %d/%d"</span>, (<span class="keyword">int</span>)written, (<span class="keyword">int</span>)copy_size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 1 if callback return -1 or 0</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="audio-cblk"><a href="#audio-cblk" class="headerlink" title="audio_cblk()"></a><code>audio_cblk()</code></h3><p><code>audio_cblk()</code> 实际上就是调用的 <code>opaque-&gt;spec.callback</code>(上面初始化赋值的)</p>
<p>上一篇 <code>stream_component_open()</code> 里面调用的 <code>audio_open()</code>，有这么一句代码:</p>
<p><code>wanted_spec.callback = sdl_audio_callback;</code></p>
<p>其实就是调用到sdl_audio_callback()这个函数来了。</p>
<h3 id="sdl-audio-callback"><a href="#sdl-audio-callback" class="headerlink" title="sdl_audio_callback"></a><code>sdl_audio_callback</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sdl_audio_callback</span><span class="params">(<span class="keyword">void</span> *opaque, Uint8 *stream, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;audio_buf_index &gt;= is-&gt;audio_buf_size) &#123;</span><br><span class="line">        	<span class="comment">//解码音频帧</span></span><br><span class="line">           audio_size = audio_decode_frame(is);</span><br><span class="line">           <span class="keyword">if</span> (audio_size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* 发生错误，就输出silence */</span></span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (is-&gt;show_mode != SHOW_MODE_VIDEO)</span><br><span class="line">                   update_sample_display(is, (<span class="keyword">int16_t</span> *)is-&gt;audio_buf, audio_size);</span><br><span class="line">               is-&gt;audio_buf_size = audio_size;</span><br><span class="line">           &#125;</span><br><span class="line">           is-&gt;audio_buf_index = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        len1 = is-&gt;audio_buf_size - is-&gt;audio_buf_index;</span><br><span class="line">        <span class="keyword">if</span> (len1 &gt; len)</span><br><span class="line">            len1 = len;</span><br><span class="line">        <span class="keyword">if</span> (!is-&gt;muted &amp;&amp; is-&gt;audio_buf &amp;&amp; is-&gt;audio_volume == SDL_MIX_MAXVOLUME)</span><br><span class="line">        	<span class="comment">//拷贝解码的音频帧</span></span><br><span class="line">            <span class="built_in">memcpy</span>(stream, (<span class="keyword">uint8_t</span> *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        len -= len1;</span><br><span class="line">        stream += len1;</span><br><span class="line">        is-&gt;audio_buf_index += len1;</span><br><span class="line">    &#125;</span><br><span class="line">    is-&gt;audio_write_buf_size = is-&gt;audio_buf_size - is-&gt;audio_buf_index;</span><br><span class="line">    <span class="comment">/* Let's assume the audio driver that is used by SDL has two periods. */</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="audio-decode-frame"><a href="#audio-decode-frame" class="headerlink" title="audio_decode_frame"></a><code>audio_decode_frame</code></h4><p>解码音频帧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decode one audio frame and return its uncompressed size.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The processed audio frame is decoded, converted if required, and</span></span><br><span class="line"><span class="comment"> * stored in is-&gt;audio_buf, with size in bytes given by the return</span></span><br><span class="line"><span class="comment"> * value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">static int audio_decode_frame(FFPlayer *ffp)｛</span><br><span class="line">    af = frame_queue_peek_readable(&amp;is-&gt;sampq)</span><br><span class="line">    is-&gt;audio_buf = af-&gt;frame-&gt;data[<span class="number">0</span>];</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>判断解码后的is-&gt;sampq是否为空，如果为空，就阻塞(上面解码的时候，每向is-&gt;sampq放入一frame，就唤醒线程)；否则把队列的第一个frame赋值给ffp-&gt;is-&gt;audio_buf</p>
<h4 id="拷贝解码的音频帧"><a href="#拷贝解码的音频帧" class="headerlink" title="拷贝解码的音频帧"></a>拷贝解码的音频帧</h4><p><code>memcpy(stream, (uint8_t *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);</code></p>
<p>copy到stream中，stream从命名来看是一个流，流的另外一头在哪里呢？</p>
<p>再返回到 <code>aout_thread_n()</code> 中：</p>
<p><code>SDL_Android_AudioTrack_write(env, atrack, buffer, copy_size);</code></p>
<p>buffer就是刚刚的stream,该函数继续调用:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> (*env)-&gt;SetByteArrayRegion(env, atrack-&gt;byte_buffer, <span class="number">0</span>, (<span class="keyword">int</span>)size_in_byte, (jbyte*) data);</span><br><span class="line">J4AC_AudioTrack__write(env, atrack-&gt;thiz, atrack-&gt;byte_buffer, <span class="number">0</span>, (<span class="keyword">int</span>)size_in_byte);</span><br></pre></td></tr></table></figure>
<p>把data拷贝到数组中，进行转换。为了下一笔把这个数组，也就是音频帧传递给java</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">J4AC_android_media_AudioTrack__write</span><span class="params">(JNIEnv *env, jobject thiz, jbyteArray audioData, jint offsetInBytes, jint sizeInBytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;CallIntMethod(env, thiz, class_J4AC_android_media_AudioTrack.method_write, audioData, offsetInBytes, sizeInBytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了java层的 <code>AudioTrack.java</code>中的 <code>write()</code> 函数</p>
<p>这里又用到了bilibili另外一个开源项目:<a href="https://link.jianshu.com/?t=https://github.com/Bilibili/jni4android" target="_blank" rel="noopener">jni4android</a>。这个项目可以直接在c里面生成一个java的装饰类。这里用到的java就是<code>AudioTrack.java</code>，生成的文件就是<code>AudioTrack.h</code>和<code>AudioTrack.c</code></p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/06/直播/ijkplayer/ijkplayer系列三-数据读取线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/06/直播/ijkplayer/ijkplayer系列三-数据读取线程/" itemprop="url">ijkplayer系列三-数据读取线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-06T15:22:14+08:00">
                2019-08-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ijkplayer播放器的初始化流程(上一篇)，在IjkMediaPlayer.prepareAsync 中调用 <code>ff_ffplayer.c</code> <code>stream_open()</code> 创建了几个线程：</p>
<ul>
<li>视频显示线程</li>
<li>数据读取线程 <code>read_thread</code></li>
<li>消息循环处理线程</li>
</ul>
<img src="/2019/08/06/直播/ijkplayer/ijkplayer系列三-数据读取线程/线程.jpg">
<h1 id="数据读取线程"><a href="#数据读取线程" class="headerlink" title="数据读取线程"></a>数据读取线程</h1><img src="/2019/08/06/直播/ijkplayer/ijkplayer系列三-数据读取线程/数据读取流程图.png">
<pre><code>1. 调用avformat_alloc_context
    1. 创建AVFormatContext对象，主要为函数指针赋值，确定默认打开文件的函数，以及关闭文件的函数
2. 调用avformat_open_input
    1. 调用init_input：打开文件，探测视频格式
    2. 调用avio_skip：跳过初始化的字节
    3. 调用ff_id3v2_read_dict：判断是否有id3v2格式的字段
    4. 调用s-&gt;iformat-&gt;read_header：从buffer里面读取视频头，确定解码器
    5. 调用ff_id3v2_parse_chapters：解析id3v2中的章节、描述等信息
3. 调用avformat_find_stream_info：解析视频中的各个流的信息，如video、audio流
4. 调用avformat_seek_file：判断是否有seek操作，需要seek文件
5. 调用avformat_match_stream_specifier：分离audio，video流信息，判断当前流的类型
6. 调用av_find_best_stream：根据当前ffplayer找到video，audio，subtitle的流（一般的视频各个流都只有一个）
7. 调用stream_component_open：打开audio，video的流信息，根据流信息找到decoder，然后开启各自的线程进行解码
8. 调用ffp_notify_msg1发送FFP_MSG_PREPARED消息
9. 进入无限循环，从解析流的线程中获取Packet，同步到video_refresh_thread线程中，进行时钟同步，开始播放
    1. 判断是否有seek操作is-&gt;seek_req，若有则调用avformat_seek_file
    2. 判断是否当前video、audio、subtitle的PacketQueue已满，如果已经满了，则直接进入下一次循环
    3. 判断当前视频是否暂停或者播放完成，判断是否为循环播放，以及循环播放次数，重新seek到start_time的位置，若未设置，默认为0
    4. 调用av_read_frame读取packet帧
    5. 将对应的packet放到对应的video、audio、subtitle的PacketQueue中
    6. 判断ffp-&gt;packet_buffering，如果是的话，则调用ffp_check_buffering检查Buffer
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">// Utils.c。探测数据源的格式。</span></span><br><span class="line">	<span class="comment">//内部实现是调用id3v2_parse()读取网络数据包头信息</span></span><br><span class="line">	<span class="comment">//ff_id3v2_parse_apic()/id3v2.c</span></span><br><span class="line">	<span class="comment">//更改ic的AVFormatContext型的参数</span></span><br><span class="line">   err = avformat_open_input(&amp;ic, is-&gt;filename, is-&gt;iformat, &amp;ffp-&gt;format_opts);</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">  	<span class="comment">//解析流并找到相应解码器</span></span><br><span class="line">  	<span class="comment">//注册解码器是在初始化时，JNI_Load() --&gt;ijkmp_global_init() --&gt; avcodec_register_all();</span></span><br><span class="line">  	err = avformat_find_stream_info(ic, opts);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">   <span class="comment">/* open the streams */</span></span><br><span class="line">   <span class="comment">//音视频读取和解码</span></span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        stream_component_open(ffp, st_index[AVMEDIA_TYPE_AUDIO]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_VIDEO] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ret = stream_component_open(ffp, st_index[AVMEDIA_TYPE_VIDEO]);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//循环读取数据，然后把数据放入相应的audio队列或者video队列中</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="comment">//省略...判断是否队列已满，停止读取数据</span></span><br><span class="line">		<span class="comment">//判断是否需要响应用户操作拖动进度条</span></span><br><span class="line">	   <span class="keyword">if</span> (is-&gt;seek_req) &#123;</span><br><span class="line">          avformat_seek_file();</span><br><span class="line">      &#125; </span><br><span class="line">	   ret = av_read_frame(ic, pkt);</span><br><span class="line">	   packet_queue_put(&amp;is-&gt;audioq, pkt); </span><br><span class="line">	   <span class="comment">//如果是视频的话 </span></span><br><span class="line">	   <span class="comment">//packet_queue_put(&amp;is-&gt;videoq, pkt);  </span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="音视频读取和解码"><a href="#音视频读取和解码" class="headerlink" title="音视频读取和解码"></a>音视频读取和解码</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stream_component_open</span><span class="params">(FFPlayer *ffp, <span class="keyword">int</span> stream_index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">    codec = avcodec_find_decoder(avctx-&gt;codec_id);</span><br><span class="line">    <span class="keyword">switch</span> (avctx-&gt;codec_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> AVMEDIA_TYPE_AUDIO   : is-&gt;last_audio_stream    = stream_index; forced_codec_name = ffp-&gt;audio_codec_name; <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// FFP_MERGE: case AVMEDIA_TYPE_SUBTITLE:</span></span><br><span class="line">        <span class="keyword">case</span> AVMEDIA_TYPE_VIDEO   : is-&gt;last_video_stream    = stream_index; forced_codec_name = ffp-&gt;video_codec_name; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">switch</span> (avctx-&gt;codec_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> AVMEDIA_TYPE_AUDIO:</span><br><span class="line">        <span class="comment">/* prepare audio output */</span></span><br><span class="line">        <span class="comment">//audio_open调用aout-&gt;open_audio(aout, pause_on);</span></span><br><span class="line">        <span class="comment">//最终会调用aout_open_audio_n()</span></span><br><span class="line">        <span class="comment">//最后创建音频播放线程 SDL_CreateThreadEx(&amp;opaque-&gt;_audio_tid, aout_thread);</span></span><br><span class="line">        <span class="comment">//aout_thread线程从解码好的音频帧队列sampq中，循环取数据推入AudioTrack中播放。</span></span><br><span class="line">        <span class="keyword">if</span> ((ret = audio_open(ffp, channel_layout, nb_channels, sample_rate, &amp;is-&gt;audio_tgt)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">      	<span class="comment">//...</span></span><br><span class="line">        decoder_init(&amp;is-&gt;auddec, avctx, &amp;is-&gt;audioq, is-&gt;continue_read_thread);</span><br><span class="line">      	<span class="comment">//...</span></span><br><span class="line">     	<span class="comment">//decoder_start();创建音频解码线程 SDL_CreateThreadEx(&amp;is-&gt;_audio_tid, audio_thread, ffp, "ff_audio_dec");</span></span><br><span class="line">     	<span class="comment">//audio_thread 线程从audioq队列中获取音频包，解码并加入sampq音频帧列表中 </span></span><br><span class="line">        <span class="keyword">if</span> ((ret = decoder_start(&amp;is-&gt;auddec, audio_thread, ffp, <span class="string">"ff_audio_dec"</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        SDL_AoutPauseAudio(ffp-&gt;aout, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVMEDIA_TYPE_VIDEO:</span><br><span class="line">   		<span class="comment">//...</span></span><br><span class="line">        decoder_init(&amp;is-&gt;viddec, avctx, &amp;is-&gt;videoq, is-&gt;continue_read_thread);</span><br><span class="line">        ffp-&gt;node_vdec = ffpipeline_open_video_decoder(ffp-&gt;pipeline, ffp);</span><br><span class="line">   		<span class="comment">//...</span></span><br><span class="line">   		<span class="comment">//decoder_start();创建视频解码线程 SDL_CreateThreadEx(&amp;is-&gt;_video_tid, video_thread, ffp, "ff_video_dec");</span></span><br><span class="line">   		<span class="comment">//video_thread 线程从videoq队列中获取视频包，解码并放入pictq列表中</span></span><br><span class="line">        <span class="keyword">if</span> ((ret = decoder_start(&amp;is-&gt;viddec, video_thread, ffp, <span class="string">"ff_video_dec"</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">       	<span class="comment">//...</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">fail:</span><br><span class="line">    av_dict_free(&amp;opts);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>读取数据的时候，当queue满了的时候，会delay。然而并不会断开连接。</li>
<li>在读取的时候，有很多操作，这些操作都是受java层界面的影响，比如pause和resume操作，seek操作等。如果界面按了暂停什么的，都会反馈到这里，然后这里无限for循环的时候会相应作出各种操作。</li>
<li><code>read_thread</code> 线程里面会创建两个解码线程，一个音频播放线程。</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
<li><a href="https://blog.csdn.net/Guofengpu/article/details/85060662" target="_blank" rel="noopener">ijkplayer read_thread命令简单解析</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/" itemprop="url">ijkplayer系列二-初始化流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-05T16:22:14+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>实例：用ijkplayer播放CCTV1</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># required, enough for most devices.</span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-java:0.8.8'</span></span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-armv7a:0.8.8'</span></span><br><span class="line"></span><br><span class="line"># Other ABIs: optional</span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-armv5:0.8.8'</span></span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-arm64:0.8.8'</span></span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-x86:0.8.8'</span></span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-x86_64:0.8.8'</span></span><br><span class="line"></span><br><span class="line"># ExoPlayer as IMediaPlayer: optional, experimental</span><br><span class="line">compile <span class="string">'tv.danmaku.ijk.media:ijkplayer-exo:0.8.8'</span></span><br></pre></td></tr></table></figure>
<p>导入官方demo目录下的这些文件：</p>
<img src="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/使用.png">
<p>开始播放</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init player</span></span><br><span class="line">videoView.setVideoURI(Uri.parse(<span class="string">"http://106.36.45.36/live.aishang.ctlcdn.com/00000110240001_1/encoder/1/playlist.m3u8"</span>));</span><br><span class="line"></span><br><span class="line">videoView.setOnPreparedListener(<span class="keyword">new</span> IMediaPlayer.OnPreparedListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer mp)</span> </span>&#123;</span><br><span class="line">        videoView.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="IjkMediaPlayer和Native交互"><a href="#IjkMediaPlayer和Native交互" class="headerlink" title="IjkMediaPlayer和Native交互"></a>IjkMediaPlayer和Native交互</h1><p><strong>播放控制</strong>相关的 <code>start、pause、stop</code> 等，调用 对应的 native 方法</p>
<p><strong>底层状态信息的上报(比如底层的播放状态回调)</strong>相关的 <code>postEventFromNative</code> 等，这些方法由底层主动调用(有<code>@CalledByNative</code> 注解)</p>
<img src="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/IjkMediaPlayer和Native交互.png">
<h1 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h1><p>在播放过程中，某些行为的完成或者变化，如prepare完成，开始渲染等，需要以事件形式通知到外部，以便上层作出具体的业务处理。</p>
<p>播放器底层上报事件时，实际上就是将待发送的消息放入消息队列，另外有一个线程会不断从队列中取出消息，上报给外部</p>
<h1 id="初始化IjkVideoView"><a href="#初始化IjkVideoView" class="headerlink" title="初始化IjkVideoView"></a>初始化IjkVideoView</h1><img src="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/初始化序列图.png">
<img src="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/ijkplayer音视频播放.jpg">
<h2 id="setVideoURI-amp-openVideo"><a href="#setVideoURI-amp-openVideo" class="headerlink" title="setVideoURI &amp; openVideo"></a>setVideoURI &amp; openVideo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkVideoView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">MediaController</span>.<span class="title">MediaPlayerControl</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setVideoURI</span><span class="params">(Uri uri, Map&lt;String, String&gt; headers)</span> </span>&#123;</span><br><span class="line">        mUri = uri;</span><br><span class="line">        mHeaders = headers;</span><br><span class="line">        mSeekWhenPrepared = <span class="number">0</span>;</span><br><span class="line">        openVideo();</span><br><span class="line">        requestLayout();</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openVideo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mUri == <span class="keyword">null</span> || mSurfaceHolder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// not ready for playback just yet, will try again later</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// we shouldn't clear the target state, because somebody might have</span></span><br><span class="line">    <span class="comment">// called start() previously</span></span><br><span class="line">    release(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    AudioManager am = (AudioManager) mAppContext.getSystemService(Context.AUDIO_SERVICE);</span><br><span class="line">    am.requestAudioFocus(<span class="keyword">null</span>, AudioManager.STREAM_MUSIC, AudioManager.AUDIOFOCUS_GAIN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mMediaPlayer = createPlayer(mSettings.getPlayer());</span><br><span class="line">        mMediaPlayer.setOnPreparedListener(mPreparedListener);</span><br><span class="line">        <span class="comment">//这里省略一大波setListener......</span></span><br><span class="line">        mCurrentBufferPercentage = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        String scheme = mUri.getScheme();</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M &amp;&amp;</span><br><span class="line">                mSettings.getUsingMediaDataSource() &amp;&amp;</span><br><span class="line">                (TextUtils.isEmpty(scheme) || scheme.equalsIgnoreCase(<span class="string">"file"</span>))) &#123;</span><br><span class="line">            IMediaDataSource dataSource = <span class="keyword">new</span> FileMediaDataSource(<span class="keyword">new</span> File(mUri.toString()));</span><br><span class="line">            mMediaPlayer.setDataSource(dataSource);</span><br><span class="line">        &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</span><br><span class="line">            mMediaPlayer.setDataSource(mAppContext, mUri, mHeaders);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mMediaPlayer.setDataSource(mUri.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        bindSurfaceHolder(mMediaPlayer, mSurfaceHolder);</span><br><span class="line">        mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</span><br><span class="line">        mMediaPlayer.setScreenOnWhilePlaying(<span class="keyword">true</span>);</span><br><span class="line">        mPrepareStartTime = System.currentTimeMillis();</span><br><span class="line">        mMediaPlayer.prepareAsync();</span><br><span class="line">        <span class="keyword">if</span> (mHudViewHolder != <span class="keyword">null</span>)</span><br><span class="line">            mHudViewHolder.setMediaPlayer(mMediaPlayer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// REMOVED: mPendingSubtitleTracks</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// we don't set the target state here either, but preserve the</span></span><br><span class="line">        <span class="comment">// target state that was there before.</span></span><br><span class="line">        mCurrentState = STATE_PREPARING;</span><br><span class="line">        attachMediaController();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</span><br><span class="line">        mCurrentState = STATE_ERROR;</span><br><span class="line">        mTargetState = STATE_ERROR;</span><br><span class="line">        mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</span><br><span class="line">        mCurrentState = STATE_ERROR;</span><br><span class="line">        mTargetState = STATE_ERROR;</span><br><span class="line">        mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// REMOVED: mPendingSubtitleTracks.clear();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里， 做了下面几件事：</p>
<ul>
<li>获得AudioManager</li>
<li>通过setting获取player的类型</li>
<li>初始化IMediaPlayer (createPlayer()函数)</li>
<li>然后调用setDataSource(String)</li>
<li>屏幕常亮等</li>
<li>设置MediaController</li>
<li>mMediaPlayer.prepareAsync()   </li>
</ul>
<h3 id="createPlayer"><a href="#createPlayer" class="headerlink" title="createPlayer"></a>createPlayer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IMediaPlayer <span class="title">createPlayer</span><span class="params">(<span class="keyword">int</span> playerType)</span> </span>&#123;</span><br><span class="line">    IMediaPlayer mediaPlayer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (playerType) &#123;</span><br><span class="line">        <span class="keyword">case</span> Settings.PV_PLAYER__IjkExoMediaPlayer: &#123;</span><br><span class="line">            IjkExoMediaPlayer IjkExoMediaPlayer = <span class="keyword">new</span> IjkExoMediaPlayer(mAppContext);</span><br><span class="line">            mediaPlayer = IjkExoMediaPlayer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Settings.PV_PLAYER__AndroidMediaPlayer: &#123;</span><br><span class="line">            AndroidMediaPlayer androidMediaPlayer = <span class="keyword">new</span> AndroidMediaPlayer();</span><br><span class="line">            mediaPlayer = androidMediaPlayer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Settings.PV_PLAYER__IjkMediaPlayer:</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            IjkMediaPlayer ijkMediaPlayer = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (mUri != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ijkMediaPlayer = <span class="keyword">new</span> IjkMediaPlayer();</span><br><span class="line">                <span class="comment">//各种设置；ijkMediaPlayer.setOption()</span></span><br><span class="line">                mediaPlayer = ijkMediaPlayer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSettings.getEnableDetachedSurfaceTextureView()) &#123;</span><br><span class="line">        mediaPlayer = <span class="keyword">new</span> TextureMediaPlayer(mediaPlayer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaPlayer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="IjkMediaPlayer-setOption-配置"><a href="#IjkMediaPlayer-setOption-配置" class="headerlink" title="IjkMediaPlayer.setOption 配置"></a>IjkMediaPlayer.setOption 配置</h4><p>初始化后 IjkMediaPlayer 后，可以对其进行一系列配置，例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置硬解码</span></span><br><span class="line">mIjkMediaPlayer.setOption(IjkMediaPlayer.OPT_CATEGORY_PLAYER, <span class="string">"mediacodec"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 opensles 方式输出音频</span></span><br><span class="line">mIjkMediaPlayer.setOption(IjkMediaPlayer.OPT_CATEGORY_PLAYER, <span class="string">"opensles"</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>setOption() 会调用到底层 ff_ffplay.c 的 ffp_set_option() 方法</p>
<h5 id="软硬解码选择"><a href="#软硬解码选择" class="headerlink" title="软硬解码选择"></a>软硬解码选择</h5><p>跟踪 <code>pipeline/ffpipeline_android.c</code> 的 <code>ffpipeline_create_from_android</code> 方法</p>
<p>发现是 用函数指针记录 类 IjkMediaPlayer.setOption() 设置的属性</p>
<h3 id="IjkMediaPlayer-setDataSource-amp-setDataSource"><a href="#IjkMediaPlayer-setDataSource-amp-setDataSource" class="headerlink" title="IjkMediaPlayer.setDataSource &amp; _setDataSource"></a>IjkMediaPlayer.setDataSource &amp; _setDataSource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(String path, Map&lt;String, String&gt; headers)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, IllegalArgumentException, SecurityException, IllegalStateException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (headers != <span class="keyword">null</span> &amp;&amp; !headers.isEmpty()) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry: headers.entrySet()) &#123;</span><br><span class="line">            sb.append(entry.getKey());</span><br><span class="line">            sb.append(<span class="string">":"</span>);</span><br><span class="line">            String value = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(value))</span><br><span class="line">                sb.append(entry.getValue());</span><br><span class="line">            sb.append(<span class="string">"\r\n"</span>);</span><br><span class="line">            setOption(OPT_CATEGORY_FORMAT, <span class="string">"headers"</span>, sb.toString());</span><br><span class="line">            setOption(IjkMediaPlayer.OPT_CATEGORY_FORMAT, <span class="string">"protocol_whitelist"</span>, <span class="string">"async,cache,crypto,file,http,https,ijkhttphook,ijkinject,ijklivehook,ijklongurl,ijksegment,ijktcphook,pipe,rtp,tcp,tls,udp,ijkurlhook,data"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    setDataSource(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">_setDataSource</span><span class="params">(String path, String[] keys, String[] values)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, IllegalArgumentException, SecurityException, IllegalStateException</span>;</span><br></pre></td></tr></table></figure>
<p><code>ijkplayer_jni.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_setDataSourceAndHeaders(</span><br><span class="line">    JNIEnv *env, jobject thiz, jstring path,</span><br><span class="line">    jobjectArray keys, jobjectArray values)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *c_path = <span class="literal">NULL</span>;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(path, env, <span class="string">"java/lang/IllegalArgumentException"</span>, <span class="string">"mpjni: setDataSource: null path"</span>, LABEL_RETURN);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: setDataSource: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    c_path = (*env)-&gt;GetStringUTFChars(env, path, <span class="literal">NULL</span> );</span><br><span class="line">    JNI_CHECK_GOTO(c_path, env, <span class="string">"java/lang/OutOfMemoryError"</span>, <span class="string">"mpjni: setDataSource: path.string oom"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"setDataSource: path %s"</span>, c_path);</span><br><span class="line">    retval = ijkmp_set_data_source(mp, c_path);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, path, c_path);</span><br><span class="line"></span><br><span class="line">    IJK_CHECK_MPRET_GOTO(retval, env, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IjkMediaPlayer-prepareAsync-amp-prepareAsync"><a href="#IjkMediaPlayer-prepareAsync-amp-prepareAsync" class="headerlink" title="IjkMediaPlayer.prepareAsync &amp; _prepareAsync"></a>IjkMediaPlayer.prepareAsync &amp; _prepareAsync</h3><p>最终调用到 <code>ijkmp_prepare_async_l</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">    _prepareAsync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">_prepareAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>
<p><code>ijkplayer_jni.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_prepareAsync(JNIEnv *env, jobject thiz)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: prepareAsync: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    retval = ijkmp_prepare_async(mp);</span><br><span class="line">    IJK_CHECK_MPRET_GOTO(retval, env, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ijkplayer.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ijkmp_prepare_async</span><span class="params">(IjkMediaPlayer *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line">    MPTRACE(<span class="string">"ijkmp_prepare_async()\n"</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;mp-&gt;mutex);</span><br><span class="line">    <span class="keyword">int</span> retval = ijkmp_prepare_async_l(mp);</span><br><span class="line">    pthread_mutex_unlock(&amp;mp-&gt;mutex);</span><br><span class="line">    MPTRACE(<span class="string">"ijkmp_prepare_async()=%d\n"</span>, retval);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ijkmp_prepare_async_l</span><span class="params">(IjkMediaPlayer *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//状态判断，符合直接返回</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_IDLE);</span><br><span class="line">    <span class="comment">// MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_INITIALIZED);</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ASYNC_PREPARING);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PREPARED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STARTED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PAUSED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_COMPLETED);</span><br><span class="line">    <span class="comment">// MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STOPPED);</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ERROR);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_END);</span><br><span class="line"></span><br><span class="line">    assert(mp-&gt;data_source);</span><br><span class="line"></span><br><span class="line">    ijkmp_change_state_l(mp, MP_STATE_ASYNC_PREPARING);</span><br><span class="line"></span><br><span class="line">    msg_queue_start(&amp;mp-&gt;ffplayer-&gt;msg_queue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// released in msg_loop</span></span><br><span class="line">    ijkmp_inc_ref(mp);</span><br><span class="line">    mp-&gt;msg_thread = SDL_CreateThreadEx(&amp;mp-&gt;_msg_thread, ijkmp_msg_loop, mp, <span class="string">"ff_msg_loop"</span>);</span><br><span class="line">    <span class="comment">// msg_thread is detached inside msg_loop</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 9 release weak_thiz if pthread_create() failed;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> retval = ffp_prepare_async_l(mp-&gt;ffplayer, mp-&gt;data_source);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ijkmp_change_state_l(mp, MP_STATE_ERROR);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要做了一下几件事：</p>
<ul>
<li><code>ijkmp_change_state_l()</code><ul>
<li>向<code>msg_queue</code>发送一个<code>FFP_MSG_PLAYBACK_STATE_CHANGED</code>消息</li>
</ul>
</li>
<li><code>msg_queue_start()</code><ul>
<li>向<code>msg_queue</code>发送一个<code>FFP_MSG_FLUSH</code>消息</li>
</ul>
</li>
<li>创建消息循环线程，线程入口为<code>ijkmp_msg_loop</code><ul>
<li>处理<code>msg_queue</code>发送的消息</li>
</ul>
</li>
<li><code>ffp_prepare_async_l()</code><ul>
<li>打开读取线程和视频解码播放进程 </li>
</ul>
</li>
</ul>
<h4 id="ijkmp-change-state-l"><a href="#ijkmp-change-state-l" class="headerlink" title="ijkmp_change_state_l"></a><code>ijkmp_change_state_l</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ijkmp_change_state_l</span><span class="params">(IjkMediaPlayer *mp, <span class="keyword">int</span> new_state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mp-&gt;mp_state = new_state;</span><br><span class="line">    ffp_notify_msg1(mp-&gt;ffplayer, FFP_MSG_PLAYBACK_STATE_CHANGED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="msg-queue-start"><a href="#msg-queue-start" class="headerlink" title="msg_queue_start"></a><code>msg_queue_start</code></h4><p><code>ff_ffmsg_queue.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">msg_queue_start</span><span class="params">(MessageQueue *q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SDL_LockMutex(q-&gt;mutex);</span><br><span class="line">    q-&gt;abort_request = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    AVMessage msg;</span><br><span class="line">    msg_init_msg(&amp;msg);</span><br><span class="line">    msg.what = FFP_MSG_FLUSH;</span><br><span class="line">    msg_queue_put_private(q, &amp;msg);</span><br><span class="line">    SDL_UnlockMutex(q-&gt;mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建消息循环线程"><a href="#创建消息循环线程" class="headerlink" title="创建消息循环线程"></a>创建消息循环线程</h4><h4 id="ffp-prepare-async-l"><a href="#ffp-prepare-async-l" class="headerlink" title="ffp_prepare_async_l"></a><code>ffp_prepare_async_l</code></h4><p><code>ijkmedia/ijkplayer/ff_ffplay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffp_prepare_async_l</span><span class="params">(FFPlayer *ffp, <span class="keyword">const</span> <span class="keyword">char</span> *file_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//log信息，打印FFmpeg相关信息</span></span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===== versions =====\n"</span>);</span><br><span class="line">    ffp_show_version_str(ffp, <span class="string">"ijkplayer"</span>,      ijk_version_info());</span><br><span class="line">    ffp_show_version_str(ffp, <span class="string">"FFmpeg"</span>,         av_version_info());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavutil"</span>,      avutil_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavcodec"</span>,     avcodec_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavformat"</span>,    avformat_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libswscale"</span>,     swscale_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libswresample"</span>,  swresample_version());</span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===== options =====\n"</span>);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"player-opts"</span>, ffp-&gt;player_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"format-opts"</span>, ffp-&gt;format_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"codec-opts "</span>, ffp-&gt;codec_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"sws-opts   "</span>, ffp-&gt;sws_dict);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"swr-opts   "</span>, ffp-&gt;swr_opts);</span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===================\n"</span>);</span><br><span class="line">    </span><br><span class="line">    VideoState *is = stream_open(ffp, file_name, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!is) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING, <span class="string">"ffp_prepare_async_l: stream_open failed OOM"</span>);</span><br><span class="line">        <span class="keyword">return</span> EIJK_OUT_OF_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ffp-&gt;is = is;</span><br><span class="line">    ffp-&gt;input_filename = av_strdup(file_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做了以下几件事：</p>
<ul>
<li>logcat打印FFmpeg相关信息</li>
<li><code>stream_open()</code> </li>
</ul>
<h5 id="stream-open"><a href="#stream-open" class="headerlink" title="stream_open"></a><code>stream_open</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> VideoState *<span class="title">stream_open</span><span class="params">(FFPlayer *ffp, <span class="keyword">const</span> <span class="keyword">char</span> *filename, AVInputFormat *iformat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* start video display */</span></span><br><span class="line">    <span class="comment">//初始化队列 frame_queue_init()</span></span><br><span class="line">    <span class="comment">//第一个参数是解码出来的队列,第二个参数是未解码的队列</span></span><br><span class="line">    <span class="comment">//有三个队列：音频，视频，字幕</span></span><br><span class="line">    <span class="keyword">if</span> (frame_queue_init(&amp;is-&gt;pictq, &amp;is-&gt;videoq, ffp-&gt;pictq_size, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    <span class="keyword">if</span> (frame_queue_init(&amp;is-&gt;subpq, &amp;is-&gt;subtitleq, SUBPICTURE_QUEUE_SIZE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    <span class="keyword">if</span> (frame_queue_init(&amp;is-&gt;sampq, &amp;is-&gt;audioq, SAMPLE_QUEUE_SIZE, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packet_queue_init(&amp;is-&gt;videoq) &lt; <span class="number">0</span> ||</span><br><span class="line">        packet_queue_init(&amp;is-&gt;audioq) &lt; <span class="number">0</span> ||</span><br><span class="line">        packet_queue_init(&amp;is-&gt;subtitleq) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建video_refresh_thread视频显示进程(视频渲染，音视频同步）</span></span><br><span class="line">    is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, <span class="string">"ff_vout"</span>);</span><br><span class="line">    <span class="comment">//创建read_thread数据读取线程</span></span><br><span class="line">    is-&gt;read_tid = SDL_CreateThreadEx(&amp;is-&gt;_read_tid, read_thread, ffp, <span class="string">"ff_read"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2019/08/05/直播/ijkplayer/ijkplayer系列二-初始化流程/stream_open方法.png">
<p>主要做了三件事：</p>
<ul>
<li><code>frame_queue_init()</code>开始视频展示</li>
<li>创建<code>video_refresh_thread</code>视频显示进程</li>
<li>创建<code>read_thread</code>数据读取线程</li>
</ul>
<p>在<code>read_thread</code>里面向<code>msg_queue</code>发送了一个消息<code>ffp_notify_msg1(ffp, FFP_MSG_PREPARED)</code>;，消息循环线程收到这个消息后，会调用java层的handler发送<code>MEDIA_PREPARED</code>消息，然后在handler的handleMessage函数里面会处理这个消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MEDIA_PREPARED:</span><br><span class="line">    player.notifyOnPrepared();</span><br><span class="line">    <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>最终调用到我们设置的 <code>IMediaPlayer.OnPreparedListener</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">videoView.setOnPreparedListener(<span class="keyword">new</span> IMediaPlayer.OnPreparedListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer mp)</span> </span>&#123;</span><br><span class="line">        videoView.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="初始化IjkMediaPlayer"><a href="#初始化IjkMediaPlayer" class="headerlink" title="初始化IjkMediaPlayer"></a>初始化IjkMediaPlayer</h1><h2 id="构造函数-amp-initPlayer"><a href="#构造函数-amp-initPlayer" class="headerlink" title="构造函数 &amp; initPlayer"></a>构造函数 &amp; initPlayer</h2><p>构造函数在上面的 <code>IjkVideoView.createPlayer(int playerType)</code> 中被调用</p>
<p>这里只讲一下IjkMediaPlayer，其实我们除了使用IjkMediaPlayer，还可以使用IjkExoMediaPlayer或者AndroidMediaPlayer。只需要修改一下createPlayer(int playerType)的参数就行了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">IjkMediaPlayer</span><span class="params">(IjkLibLoader libLoader)</span> </span>&#123;</span><br><span class="line">        initPlayer(libLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPlayer</span><span class="params">(IjkLibLoader libLoader)</span> </span>&#123;</span><br><span class="line">    loadLibrariesOnce(libLoader);</span><br><span class="line">    initNativeOnce();</span><br><span class="line"></span><br><span class="line">    Looper looper;</span><br><span class="line">    <span class="keyword">if</span> ((looper = Looper.myLooper()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mEventHandler = <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>, looper);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((looper = Looper.getMainLooper()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mEventHandler = <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>, looper);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mEventHandler = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Native setup requires a weak reference to our object. It's easier to</span></span><br><span class="line"><span class="comment">     * create it here than in C++.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    native_setup(<span class="keyword">new</span> WeakReference&lt;IjkMediaPlayer&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>initPlayer</code> 方法，共做了四件事：</p>
<ul>
<li>loadLibrariesOnce() 加载 so 库</li>
<li>initNativeOnce() 静态初始化底层，其实什么都没做</li>
<li>创建 EventHandler，用来处理底层状态信息的上报</li>
<li><code>native_setup()</code> 初始化底层创建播放器</li>
</ul>
<h3 id="loadLibrariesOnce-加载-so-库"><a href="#loadLibrariesOnce-加载-so-库" class="headerlink" title="loadLibrariesOnce 加载 so 库"></a>loadLibrariesOnce 加载 so 库</h3><h4 id="加载-so-库"><a href="#加载-so-库" class="headerlink" title="加载 so 库"></a>加载 so 库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libLoader.loadLibrary(<span class="string">"ijkffmpeg"</span>);</span><br><span class="line">libLoader.loadLibrary(<span class="string">"ijksdl"</span>);</span><br><span class="line">libLoader.loadLibrary(<span class="string">"ijkplayer"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="JNI-OnLoad"><a href="#JNI-OnLoad" class="headerlink" title="JNI_OnLoad"></a>JNI_OnLoad</h4><p>加载so,虚拟机先自动执行JNI_OnLoad；</p>
<p>卸载so,虚拟机先自动执行JNI_UnLoad；</p>
<p><code>ijkplayer_jni.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    g_jvm = vm;</span><br><span class="line">    <span class="keyword">if</span> ((*vm)-&gt;GetEnv(vm, (<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(env != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;g_clazz.mutex, <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FindClass returns LocalReference</span></span><br><span class="line">    IJK_FIND_JAVA_CLASS(env, g_clazz.clazz, JNI_CLASS_IJKPLAYER);</span><br><span class="line">    (*env)-&gt;RegisterNatives(env, g_clazz.clazz, g_methods, NELEM(g_methods) );</span><br><span class="line"></span><br><span class="line">    ijkmp_global_init();</span><br><span class="line">    ijkmp_global_set_inject_callback(inject_callback);</span><br><span class="line"></span><br><span class="line">    FFmpegApi_global_init(env);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要做了以下几件事：</p>
<ul>
<li>RegisterNatives()注册native方法<code>_start</code>(系列播放器控制API)</li>
<li><code>ijkmp_global_init</code> 初始化ffmpeg</li>
<li><code>FFmpegApi_global_init</code> 注册native方法<code>av_base64_encode</code></li>
</ul>
<h5 id="RegisterNatives-注册native方法"><a href="#RegisterNatives-注册native方法" class="headerlink" title="RegisterNatives()注册native方法"></a>RegisterNatives()注册native方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"_setDataSource"</span>,</span><br><span class="line">        <span class="string">"(Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/String;)V"</span>,</span><br><span class="line">        (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceAndHeaders</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSourceFd"</span>,       <span class="string">"(I)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceFd &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSource"</span>,         <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IMediaDataSource;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setDataSourceCallback &#125;,</span><br><span class="line">    &#123; <span class="string">"_setAndroidIOCallback"</span>,  <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IAndroidIO;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setAndroidIOCallback &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setVideoSurface"</span>,       <span class="string">"(Landroid/view/Surface;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setVideoSurface &#125;,</span><br><span class="line">    &#123; <span class="string">"_prepareAsync"</span>,          <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_prepareAsync &#125;,</span><br><span class="line">    &#123; <span class="string">"_start"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_start &#125;,</span><br><span class="line">    &#123; <span class="string">"_stop"</span>,                  <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_stop &#125;,</span><br><span class="line">    &#123; <span class="string">"seekTo"</span>,                 <span class="string">"(J)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_seekTo &#125;,</span><br><span class="line">    &#123; <span class="string">"_pause"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_pause &#125;,</span><br><span class="line">    &#123; <span class="string">"isPlaying"</span>,              <span class="string">"()Z"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_isPlaying &#125;,</span><br><span class="line">    &#123; <span class="string">"getCurrentPosition"</span>,     <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getCurrentPosition &#125;,</span><br><span class="line">    &#123; <span class="string">"getDuration"</span>,            <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getDuration &#125;,</span><br><span class="line">    &#123; <span class="string">"_release"</span>,               <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_release &#125;,</span><br><span class="line">    &#123; <span class="string">"_reset"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_reset &#125;,</span><br><span class="line">    &#123; <span class="string">"setVolume"</span>,              <span class="string">"(FF)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_setVolume &#125;,</span><br><span class="line">    &#123; <span class="string">"getAudioSessionId"</span>,      <span class="string">"()I"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioSessionId &#125;,</span><br><span class="line">    &#123; <span class="string">"native_init"</span>,            <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_init &#125;,</span><br><span class="line">    &#123; <span class="string">"native_setup"</span>,           <span class="string">"(Ljava/lang/Object;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_native_setup &#125;,</span><br><span class="line">    &#123; <span class="string">"native_finalize"</span>,        <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_finalize &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setOption &#125;,</span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;J)V"</span>,                  (<span class="keyword">void</span> *) IjkMediaPlayer_setOptionLong &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_getColorFormatName"</span>,    <span class="string">"(I)Ljava/lang/String;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getColorFormatName &#125;,</span><br><span class="line">    &#123; <span class="string">"_getVideoCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getVideoCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getAudioCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getMediaMeta"</span>,          <span class="string">"()Landroid/os/Bundle;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getMediaMeta &#125;,</span><br><span class="line">    &#123; <span class="string">"_setLoopCount"</span>,          <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_setLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getLoopCount"</span>,          <span class="string">"()I"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_getLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyFloat"</span>,      <span class="string">"(IF)F"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyFloat"</span>,      <span class="string">"(IF)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyLong"</span>,       <span class="string">"(IJ)J"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyLong"</span>,       <span class="string">"(IJ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setStreamSelected"</span>,     <span class="string">"(IZ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setStreamSelected &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_profileBegin"</span>,    <span class="string">"(Ljava/lang/String;)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileBegin &#125;,</span><br><span class="line">    &#123; <span class="string">"native_profileEnd"</span>,      <span class="string">"()V"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileEnd &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_setLogLevel"</span>,     <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_native_setLogLevel &#125;,</span><br><span class="line">    &#123; <span class="string">"_setFrameAtTime"</span>,        <span class="string">"(Ljava/lang/String;JJII)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setFrameAtTime &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="ijkmp-global-init初始化ffmpeg"><a href="#ijkmp-global-init初始化ffmpeg" class="headerlink" title="ijkmp_global_init初始化ffmpeg"></a><code>ijkmp_global_init</code>初始化ffmpeg</h5><p>ffmpeg的初始化工作, ijkplayer是基于ffmpeg。最终调用了 <code>ffp_global_init()</code></p>
<p><code>ijkplayer.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ijkmp_global_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ffp_global_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ff_ffplay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ffp_global_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_ffmpeg_global_inited)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"ijkmediaplayer version : %s"</span>, ijkmp_version());</span><br><span class="line">    <span class="comment">/* register all codecs, demux and protocols */</span></span><br><span class="line">    avcodec_register_all();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_AVDEVICE</span></span><br><span class="line">    avdevice_register_all();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_AVFILTER</span></span><br><span class="line">    avfilter_register_all();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    av_register_all();</span><br><span class="line"></span><br><span class="line">    ijkav_register_all();</span><br><span class="line"></span><br><span class="line">    avformat_network_init();</span><br><span class="line"></span><br><span class="line">    av_lockmgr_register(lockmgr);</span><br><span class="line">    av_log_set_callback(ffp_log_callback_brief);</span><br><span class="line"></span><br><span class="line">    av_init_packet(&amp;flush_pkt);</span><br><span class="line">    flush_pkt.data = (<span class="keyword">uint8_t</span> *)&amp;flush_pkt;</span><br><span class="line"></span><br><span class="line">    g_ffmpeg_global_inited = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="FFmpegApi-global-init"><a href="#FFmpegApi-global-init" class="headerlink" title="FFmpegApi_global_init"></a><code>FFmpegApi_global_init</code></h5><p>动态注册 <code>av_base64_encode</code> 函数</p>
<p><code>/Users/liyungui/StudioProjects/ijkplayer/android/ijkplayer/ijkplayer-armv7a/src/main/jni/ijkmedia/ijkplayer/android/ffmpeg_api_jni.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FFmpegApi_global_init</span><span class="params">(JNIEnv *env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    IJK_FIND_JAVA_CLASS(env, g_clazz.clazz, JNI_CLASS_FFMPEG_API);</span><br><span class="line">    (*env)-&gt;RegisterNatives(env, g_clazz.clazz, g_methods, NELEM(g_methods));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">"av_base64_encode"</span>, <span class="string">"([B)Ljava/lang/String;"</span>, (<span class="keyword">void</span> *) FFmpegApi_av_base64_encode&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="initNativeOnce-静态初始化底层"><a href="#initNativeOnce-静态初始化底层" class="headerlink" title="initNativeOnce 静态初始化底层"></a>initNativeOnce 静态初始化底层</h3><p>最终调用了 <code>native_init</code> native方法，其实什么都没做</p>
<p><code>ijkplayer_jni.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_native_init(JNIEnv *env)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建-EventHandler，用来处理底层状态信息的上报"><a href="#创建-EventHandler，用来处理底层状态信息的上报" class="headerlink" title="创建 EventHandler，用来处理底层状态信息的上报"></a>创建 EventHandler，用来处理底层状态信息的上报</h3><p>初始化一个handler，在c层通过调用java的方法来post message，处理底层状态信息的上报。</p>
<h3 id="native-setup-初始化底层创建播放器"><a href="#native-setup-初始化底层创建播放器" class="headerlink" title="native_setup 初始化底层创建播放器"></a>native_setup 初始化底层创建播放器</h3><p>最终调用了 <code>ijkmp_android_create</code>创建播放器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">native_setup</span><span class="params">(Object IjkMediaPlayer_this)</span></span>;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">`ijkplayer_jni.c`</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_native_setup(JNIEnv *env, jobject thiz, jobject weak_this)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    IjkMediaPlayer *mp = ijkmp_android_create(message_loop);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/OutOfMemoryError"</span>, <span class="string">"mpjni: native_setup: ijkmp_create() failed"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    jni_set_media_player(env, thiz, mp);</span><br><span class="line">    ijkmp_set_weak_thiz(mp, (*env)-&gt;NewGlobalRef(env, weak_this));</span><br><span class="line">    ijkmp_set_inject_opaque(mp, ijkmp_get_weak_thiz(mp));</span><br><span class="line">    ijkmp_set_ijkio_inject_opaque(mp, ijkmp_get_weak_thiz(mp));</span><br><span class="line">    ijkmp_android_set_mediacodec_select_callback(mp, mediacodec_select_callback, ijkmp_get_weak_thiz(mp));</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ijkplayer_android.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer *ijkmp_android_create(int(*msg_loop)(void*))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 创建底层播放器对象，设置消息处理函数</span></span><br><span class="line">    IjkMediaPlayer *mp = ijkmp_create(msg_loop);</span><br><span class="line">    <span class="keyword">if</span> (!mp)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建图像渲染对象</span></span><br><span class="line">    mp-&gt;ffplayer-&gt;vout = SDL_VoutAndroid_CreateForAndroidSurface();</span><br><span class="line">    <span class="keyword">if</span> (!mp-&gt;ffplayer-&gt;vout)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化视频解码器（软/硬）、音频输出设备（opensles/audioTrack）</span></span><br><span class="line">    mp-&gt;ffplayer-&gt;pipeline = ffpipeline_create_from_android(mp-&gt;ffplayer);</span><br><span class="line">    <span class="keyword">if</span> (!mp-&gt;ffplayer-&gt;pipeline)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    ffpipeline_set_vout(mp-&gt;ffplayer-&gt;pipeline, mp-&gt;ffplayer-&gt;vout);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mp;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ijkplayer.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer *ijkmp_create(int (*msg_loop)(void*))</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = (IjkMediaPlayer *) mallocz(<span class="keyword">sizeof</span>(IjkMediaPlayer));</span><br><span class="line">    <span class="keyword">if</span> (!mp)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;ffplayer = ffp_create();</span><br><span class="line">    <span class="keyword">if</span> (!mp-&gt;ffplayer)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;msg_loop = msg_loop;</span><br><span class="line"></span><br><span class="line">    ijkmp_inc_ref(mp);</span><br><span class="line">    pthread_mutex_init(&amp;mp-&gt;mutex, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mp;</span><br><span class="line"></span><br><span class="line">    fail:</span><br><span class="line">    ijkmp_destroy_p(&amp;mp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要做了以下几件事：</p>
<ul>
<li><code>ijkmp_android_create</code> 创建播放器<ul>
<li><code>ijkmp_create</code>创建IJKMediaPlayer<ul>
<li>创建 IjkMediaPlayer 结构体 </li>
<li>设置IJKMediaPlayer结构体<ul>
<li>设置 mp-&gt;ffplayer<ul>
<li>ffplayer，通过 <code>ffp_create()</code>创建</li>
</ul>
</li>
<li>设置 mp-&gt;msg_loop    </li>
</ul>
</li>
</ul>
</li>
<li>设置 mp-&gt;ffplayer-&gt;vout。<ul>
<li>输出设备vout，通过 <code>SDL_VoutAndroid_CreateForAndroidSurface()</code>创建</li>
</ul>
</li>
<li>设置 mp-&gt;ffplayer-&gt;pipeline</li>
</ul>
</li>
<li>jni_set_media_player</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/05/直播/ijkplayer/ijkplayer系列一-开篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/05/直播/ijkplayer/ijkplayer系列一-开篇/" itemprop="url">ijkplayer系列一-开篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-05T15:22:14+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>ijkplayer 是一款比较出众的开源 Android/IOS 跨平台播放器，基于 ffplay，API 易于集成，可定制编译控制体积。</p>
<p>本系列基于 <strong>0.8.8</strong> 版本(目前<strong>最新</strong>版本)的 ijkplayer ，对其源码进行剖析，涉及到不同平台下的封装接口或处理方式时，均以 <strong>Android</strong> 为例。</p>
<p>ijkplayer android 集成了三种播放器实现：</p>
<ul>
<li><strong>AndroidMediaPlayer</strong>：即安卓系统自带的播放器 <strong>MediaPlayer</strong>，基于 MediaCodec、AudioTrack 等安卓系统 API.</li>
<li><strong>IjkExoMediaPlayer</strong>：即谷歌新推出的 <strong>ExoPlayer</strong>，同样是基于 MediaCodec、AudioTrack 等安卓系统 API，但相比 MediaPlayer 具有支持 DASH、高级 HLS、自定义扩展等优点。</li>
<li><strong>IjkMediaPlayer</strong>：基于 FFmpeg 的 <strong>ffplay</strong>，集成了 MediaCodec 硬解码器、Opengl 渲染方式等。</li>
</ul>
<p>一般而言， ijkplayer 就是指 <strong>IjkMediaPlayer</strong>，本文分析的对象就是 IjkMediaPlayer.</p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ijkplayer（项目文件夹）</span><br><span class="line">	├──tools  - 初始化项目工程脚本</span><br><span class="line">	├──config - 编译ffmpeg使用的配置文件</span><br><span class="line">	├──extra - 存放编译ijkplayer所需的依赖源文件, 如ffmpeg、openssl等</span><br><span class="line">	├──ijkmedia - 核心代码</span><br><span class="line">		├──ijkplayer - 播放器数据下载及解码相关</span><br><span class="line">		├──ijksdl - 音视频数据渲染相关</span><br><span class="line">	├──android -  android平台上的上层接口封装以及平台相关方法</span><br><span class="line">	├──ios - iOS平台上的上层接口封装以及平台相关方法</span><br></pre></td></tr></table></figure>
<h1 id="功能实现的平台差异"><a href="#功能实现的平台差异" class="headerlink" title="功能实现的平台差异"></a>功能实现的平台差异</h1><p>iOS和Android平台的差异主要表现在</p>
<ul>
<li>视频硬件解码</li>
<li>音频渲染</li>
<li>视频渲染</li>
</ul>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Hardware Codec</th>
<th>Video Render</th>
<th>Video Output</th>
<th>Audio Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>Android</td>
<td>MediaCodec</td>
<td>OpenGL ES、MediaCodec</td>
<td>NativeWindow、OpenGL ES</td>
<td>OpenSL ES、AudioTrack</td>
</tr>
<tr>
<td>iOS</td>
<td>VideoToolBox</td>
<td>OpenGL ES</td>
<td></td>
<td>AudioQueue</td>
</tr>
</tbody>
</table>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/05/直播/ijkplayer/ijkplayer编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/05/直播/ijkplayer/ijkplayer编译/" itemprop="url">ijkplayer编译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-05T15:22:14+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="install-homebrew-git-yasm"><a href="#install-homebrew-git-yasm" class="headerlink" title="install homebrew, git, yasm"></a>install homebrew, git, yasm</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span><br><span class="line">brew install git</span><br><span class="line">brew install yasm</span><br></pre></td></tr></table></figure>
<h1 id="配置sdk和ndk"><a href="#配置sdk和ndk" class="headerlink" title="配置sdk和ndk"></a>配置sdk和ndk</h1><ul>
<li>nkd只支持r11到r14。<a href="https://developer.android.google.cn/ndk/downloads/" target="_blank" rel="noopener">ndk历史版本下载地址</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># add these lines to your ~/.bash_profile or ~/.profile</span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"># 添加 export ANDROID_SDK=&lt;your sdk path&gt;</span><br><span class="line"># 添加 export ANDROID_NDK=&lt;your ndk path&gt;</span><br><span class="line"></span><br><span class="line"># 使 ~/.bash_profile 生效</span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>
<h2 id="ndk版本检查"><a href="#ndk版本检查" class="headerlink" title="ndk版本检查"></a>ndk版本检查</h2><p>检查NDK版本，支持11 12 13 14版本，然而AS默认提供的NDK下载支持一般都比较新（18），不匹配报 <code>You need the NDKr10e or later</code></p>
<p> <code>ijkplayer/android/contrib/tools/do-detect-env.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">IJK_NDK_REL=$(grep -o &apos;^Pkg\.Revision.*=[0-9]*.*&apos; $ANDROID_NDK/source.properties 2&gt;/dev/null | sed &apos;s/[[:space:]]*//g&apos; | cut -d &quot;=&quot; -f 2)</span><br><span class="line">echo &quot;IJK_NDK_REL=$IJK_NDK_REL&quot;</span><br><span class="line">case &quot;$IJK_NDK_REL&quot; in</span><br><span class="line">    11*|12*|13*|14*)</span><br><span class="line">        if test -d $&#123;ANDROID_NDK&#125;/toolchains/arm-linux-androideabi-4.9</span><br><span class="line">        then</span><br><span class="line">            echo &quot;NDKr$IJK_NDK_REL detected&quot;</span><br><span class="line">        else</span><br><span class="line">            echo &quot;You need the NDKr10e or later&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;You need the NDKr10e or later&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    ;;</span><br><span class="line">```    </span><br><span class="line"># 克隆项目</span><br><span class="line"></span><br><span class="line">`git clone https://github.com/Bilibili/ijkplayer.git ijkplayer-android`</span><br><span class="line"></span><br><span class="line"># 下载并编译ffmpeg</span><br><span class="line"></span><br><span class="line">- 需要翻墙</span><br></pre></td></tr></table></figure>
<h1 id="进入ijkplay-android目录"><a href="#进入ijkplay-android目录" class="headerlink" title="进入ijkplay-android目录"></a>进入ijkplay-android目录</h1><p>cd ijkplayer-android </p>
<h1 id="下载安装ffmpeg"><a href="#下载安装ffmpeg" class="headerlink" title="下载安装ffmpeg"></a>下载安装ffmpeg</h1><h1 id="此处需要翻墙，下载时长较长。下载目录位于extra"><a href="#此处需要翻墙，下载时长较长。下载目录位于extra" class="headerlink" title="此处需要翻墙，下载时长较长。下载目录位于extra"></a>此处需要翻墙，下载时长较长。下载目录位于extra</h1><p>./init-android.sh</p>
<h1 id="配置编译选项"><a href="#配置编译选项" class="headerlink" title="配置编译选项"></a>配置编译选项</h1><h1 id="进入config文件夹"><a href="#进入config文件夹" class="headerlink" title="进入config文件夹"></a>进入config文件夹</h1><p>cd config</p>
<h1 id="移除默认的配置"><a href="#移除默认的配置" class="headerlink" title="移除默认的配置"></a>移除默认的配置</h1><p>rm module.sh</p>
<p>#软链接module-default.sh为module.sh<br>ln -s module-default.sh module.sh</p>
<h1 id="进入android-contrib目录"><a href="#进入android-contrib目录" class="headerlink" title="进入android/contrib目录"></a>进入android/contrib目录</h1><p>cd ..<br>cd android/contrib</p>
<h1 id="清理ffmpeg的编译产物"><a href="#清理ffmpeg的编译产物" class="headerlink" title="清理ffmpeg的编译产物"></a>清理ffmpeg的编译产物</h1><p>./compile-ffmpeg.sh clean</p>
<h1 id="编译ffmpeg的所有架构"><a href="#编译ffmpeg的所有架构" class="headerlink" title="编译ffmpeg的所有架构"></a>编译ffmpeg的所有架构</h1><p>./compile-ffmpeg.sh all<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 编译脚本支持参数</span><br></pre></td></tr></table></figure></p>
<p>echo_usage() {<br>    echo “Usage:”<br>    echo “  compile-ffmpeg.sh armv5|armv7a|arm64|x86|x86_64”<br>    echo “  compile-ffmpeg.sh all|all32”<br>    echo “  compile-ffmpeg.sh all64”<br>    echo “  compile-ffmpeg.sh clean”<br>    echo “  compile-ffmpeg.sh check”<br>    exit 1<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 编译产物</span><br><span class="line"></span><br><span class="line">编译成功 会在 `android/contrib` 相应模块生成 `libijkffmpeg.so`</span><br><span class="line"></span><br><span class="line">比如 `android/contrib/build/ffmpeg-armv5/output/libijkffmpeg.so`</span><br><span class="line"></span><br><span class="line"># 编译ijkplayer</span><br></pre></td></tr></table></figure></p>
<h1 id="进入android目录"><a href="#进入android目录" class="headerlink" title="进入android目录"></a>进入android目录</h1><p>cd ..</p>
<h1 id="编译ijkplayer所有架构"><a href="#编译ijkplayer所有架构" class="headerlink" title="编译ijkplayer所有架构"></a>编译ijkplayer所有架构</h1><p>./compile-ijk.sh all<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 编译脚本支持参数</span><br></pre></td></tr></table></figure></p>
<p>echo “Usage:”<br>echo “  compile-ijk.sh armv5|armv7a|arm64|x86|x86_64”<br>echo “  compile-ijk.sh all|all32”<br>echo “  compile-ijk.sh all64”<br>echo “  compile-ijk.sh clean”<br><code>`</code></p>
<h2 id="编译产物"><a href="#编译产物" class="headerlink" title="编译产物"></a>编译产物</h2><p>编译成功 会在等相应模块生成三个so库</p>
<ul>
<li><code>libijkffmpeg.so</code></li>
<li><code>libijkplayer.so</code></li>
<li><code>libijksdl.so</code></li>
</ul>
<p>比如 模块目录 <code>android/ijkplayer/ijkplayer-armv5/src/main/libs/armeabi-v7a</code></p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">ijkplayer</a></li>
<li><a href="https://blog.csdn.net/Android_Programmer/article/details/81774732" target="_blank" rel="noopener">ijkplayer 编译详解</a></li>
<li><a href="https://www.pianshen.com/article/390141993/" target="_blank" rel="noopener">Android Mac下编译bilibili IjkPlayer以实现支持播放rtsp协议流资源</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/05/直播/直播技术/直播技术七-现代播放器原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/05/直播/直播技术/直播技术七-现代播放器原理/" itemprop="url">直播技术七-现代播放器原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-05T13:42:14+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="播放器构成"><a href="#播放器构成" class="headerlink" title="播放器构成"></a>播放器构成</h1><p>通常来说，一个典型的播放器可以分解成三部分：UI、 多媒体引擎和解码器，如图所示：</p>
<img src="/2019/08/05/直播/直播技术/直播技术七-现代播放器原理/播放器构成.png">
<p>甚至为了在浏览器和原生播放器之间统一用户体验，可以考虑使用 React Native 来进行 UI 或者皮肤的开发，使用 Haxe 来进行业务逻辑的开发，这些优秀的库都可以在多种不同类型的设备之间共用同一套代码库。</p>
<h1 id="用户界面（UI）"><a href="#用户界面（UI）" class="headerlink" title="用户界面（UI）"></a>用户界面（UI）</h1><p>通过三部分不同的功能特性定义了终端用户的观看体验：皮肤（播放器的外观设计）、UI逻辑（所有可自定义的特性如播放列表和社交分享等）以及业务逻辑部分（特定的业务逻辑特性如广告、设备兼容性逻辑以及认证管理等）。</p>
<h2 id="皮肤"><a href="#皮肤" class="headerlink" title="皮肤"></a>皮肤</h2><p>进度控制条、按钮和动画图标等等</p>
<h2 id="UI-逻辑"><a href="#UI-逻辑" class="headerlink" title="UI 逻辑"></a>UI 逻辑</h2><p>播放过程中和用户交互方面所有可见的交互：播放列表、缩略图、播放频道的选择以及社交媒体分享等</p>
<p>UI 逻辑部分，最好的实现方式是让各种特性都以插件/模块的形式添加到 UI 核心模块中。</p>
<h2 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h2><p>虽然终端用户没法直接和这部分功能进行交互，这部分构成了你业务的独特性：认证和支付、频道和播放列表的获取，以及广告等。这里也包含一些技术相关的东西，比如用于 A/B 测试模块，以及和设备相关的配置，这些配置用于在多种不同类型的设备之间选择多个不同的媒体引擎。</p>
<h3 id="设备检测与配置逻辑"><a href="#设备检测与配置逻辑" class="headerlink" title="设备检测与配置逻辑"></a>设备检测与配置逻辑</h3><p>这是最重要的特性之一，因为它将<strong>播放和渲染剥离</strong>开来了。</p>
<p>例如，基于你浏览器的不同版本，播放器可能会自动为你选择一个基于 HTML5 MSE 的多媒体引擎 hls.js，或者为你选择一个基于 flash 的播放引擎 FlasHls 来播放 HLS 视频流。这部分的最大特点在于，无论你使用什么样的底层引擎，在上层都可以使用相同的 JavaScript 或者 CSS 来定制你的 UI 或者业务逻辑。</p>
<p>能够检测用户设备的能力允许你按需配置终端用户的体验：如果是在移动设备而非 4K 屏幕设备上播放，你可能需要从一个较低的码率开始。</p>
<h3 id="A-B-测试逻辑"><a href="#A-B-测试逻辑" class="headerlink" title="A/B 测试逻辑"></a>A/B 测试逻辑</h3><p>A/B 测试是为了能够在生产环节中灰度部分用户。</p>
<p>例如，你可能会给部分 Chrome 用户提供一个新的按钮或者新的多媒体引擎，并且还能保证它所有的工作都正常如期进行。</p>
<h3 id="广告（可选）"><a href="#广告（可选）" class="headerlink" title="广告（可选）"></a>广告（可选）</h3><p>在客户端处理广告是最复杂的业务逻辑之一。</p>
<p>它们能够帮你从广告服务器中拉取视频广告，放在视频的前期、中期和后期进行播放，且不可跳过。</p>
<h1 id="多媒体引擎"><a href="#多媒体引擎" class="headerlink" title="多媒体引擎"></a>多媒体引擎</h1><p>随着主播控制和定制播放器需求的递增，一些新的播放器中慢慢也开放了一些更为底层的 API（如 Web 上的 Media Source Extensons，Flash 上的 Netstream 以及 Android 平台的 Media Codec），并迅速吸引来了很多基于这些底层 API 的强大而健壮的多媒体引擎。</p>
<h2 id="1-声明文件解释和解析器"><a href="#1-声明文件解释和解析器" class="headerlink" title="1. 声明文件解释和解析器"></a>1. 声明文件解释和解析器</h2><p>在基于 HTTP 的视频流中，一切都是以一个描述文件开始。该声明文件包含了媒体服务器所需理解的元信息：有多少种不同类型的视频质量、语言以及字母等，它们分别是什么。解析器从 XML 文件（对于 HLS 来说则是一种特殊的 m3u8 文件）中取得描述信息，然后从这些信息中取得正确的视频信息。当然，媒体服务器的类型很多，并不是所有都正确的实现了规范，因此解析器可能需要处理一些额外的实现错误。</p>
<p>一旦提取了视频信息，解析器则会从中解析出数据，用于构建流式的视觉图像，同时知道如何获取不同的视频片段。在某些多媒体引擎中，这些视觉图像先以一副抽象多媒体图的形式出现，然后在屏幕上绘制出不同 HTTP 视频流格式的差异特征。</p>
<p>在直播流场景中，解析器也必须周期性的重新获取声明文件，以便获得最新的视频片段信息。</p>
<h2 id="2-下载器（下载声明文件、多媒体片段以及密钥）"><a href="#2-下载器（下载声明文件、多媒体片段以及密钥）" class="headerlink" title="2. 下载器（下载声明文件、多媒体片段以及密钥）"></a>2. 下载器（下载声明文件、多媒体片段以及密钥）</h2><p>下载器是一个包装了处理 HTTP 请求原生 API 的模块。它不仅用于下载多媒体文件，在必要的时候也可以用于下载声明文件和 DRM 密钥。下载器在处理网络错误和重试方面扮演着非常重要的角色，同时能够收集当前可用带宽的数据。</p>
<p>注意：下载多媒体文件可能使用 HTTP 协议，也可能使用别的协议，如点对点实时通信场景中的 WebRTC 协议。</p>
<h2 id="3-流播放引擎"><a href="#3-流播放引擎" class="headerlink" title="3. 流播放引擎"></a>3. 流播放引擎</h2><p>流播放引擎是和解码器 API 交互的中央模块，它将不同的多媒体片段导入编码器，同时处理多码率切换和播放时的差异性（如声明文件和视频切片的差异，以及卡顿时的自动跳帧）。</p>
<h2 id="4-资源质量参数预估器（带宽、CPU-和帧率等）"><a href="#4-资源质量参数预估器（带宽、CPU-和帧率等）" class="headerlink" title="4. 资源质量参数预估器（带宽、CPU 和帧率等）"></a>4. 资源质量参数预估器（带宽、CPU 和帧率等）</h2><p>预估器从各种不同的维度获取数据（块大小，每片段下载时间，以及跳帧数），并将其汇聚起来用于估算用户可用的带宽和 CPU 计算能力。这些输出用于 <strong>ABR</strong> （Adaptive Bitrate, 自适应码率）切换控制器做判断。</p>
<h2 id="5-ABR-切换控制器"><a href="#5-ABR-切换控制器" class="headerlink" title="5. ABR 切换控制器"></a>5. ABR 切换控制器</h2><p>ABR 切换器可能是多媒体引擎中最为关键的部分——通常也是大家最为忽视的部分。该控制器读取预估器输出的数据（带宽和跳帧数），使用自定义算法根据这些数据做出判断，告诉流播放引擎是否需要切换视频或者音频质量。</p>
<p>该领域有很多研究性的工作，其中最大的难点在于在再缓冲风险和切换频率（太频繁的切换可能导致糟糕的用户体验）之间找到平衡。</p>
<h2 id="6-DRM-管理器（可选组件）"><a href="#6-DRM-管理器（可选组件）" class="headerlink" title="6. DRM 管理器（可选组件）"></a>6. DRM 管理器（可选组件）</h2><p>Digital Rights Management, 数字版权管理</p>
<p>今天所有的付费视频服务都基于 DRM 管理，而 DRM 则很大程度上依赖于平台或者设备，我们将在后续讲解播放器的时候看到。</p>
<p>多媒体引擎中的 DRM 管理器是更底层<strong>解码器中内容解密 API 的包装</strong>。</p>
<p>只要有可能，它会尽量通过抽象的方式来屏蔽浏览器或者操作系统实现细节的差异性。该组件通常和流处理引擎紧密连接在一起，因为它经常和解码器层交互。</p>
<h2 id="7-格式转换复用器（可选组件）"><a href="#7-格式转换复用器（可选组件）" class="headerlink" title="7. 格式转换复用器（可选组件）"></a>7. 格式转换复用器（可选组件）</h2><p>后文中我们将看到，每个平台在封包和编码方面都有它的局限性（Flash 读的是 FLV 容器封装的 H.264/AAC 文件，MSE 读的是 ISOBMFF 容器封装的 H.264/AAC 文件）。这就导致了有些视频片段在解码之前需要进行格式转换。例如，有了 MPEG2-TS 到 ISOBMFF 的格式转换复用器之后，hls.js 就能使用 MSE 格式的内容来播放 HLS 视频流。多媒体引擎层面的格式转换复用器曾经遭受质疑；然而，随着现代 JavaScript 或者 Flash 解释权性能的提升，它带来的性能损耗几乎可以忽略不计，对用户体验也不会造成多大的影响。</p>
<h1 id="解码器和-DRM-管理器"><a href="#解码器和-DRM-管理器" class="headerlink" title="解码器和 DRM 管理器"></a>解码器和 DRM 管理器</h1><p>出于解码性能（解码器）和安全考虑（DRM），解码器和 DRM 管理器与操作<strong>系统</strong>平台密切绑定。 </p>

<h2 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h2><p>解码器处理最底层播放相关的逻辑。它将不同封装格式的视频进行<strong>解包</strong>，并将其内容<strong>解码</strong>，然后将解码后的视频帧交给操作系统进行渲染，最终让终端用户看到。</p>
<p>由于视频压缩算法变得越来越复杂，解码过程是一个需要密集计算的过程，并且为了保证解码性能和流畅的播放体验，解码过程需要强依赖于操作系统和硬件。现在的大部分解码都依赖于 <strong>GPU</strong> 加速解码的帮助（这也是为什么免费而更强大的 VP9 解码器没有赢得 H.264 市场地位的原因之一）。如果没有 GPU 的加速，解码一个 1080P 的视频就会占去 70% 左右的 CPU 计算量，并且丢帧率还可能很严重。</p>
<p>在解码和渲染视频帧的基础之上，管理器也提供了一个原生的<strong> buffer</strong>，多媒体引擎可以直接与该 buffer 进行交互，实时了解它的大小并在必要的时候刷新它。</p>
<h2 id="DRM-管理器"><a href="#DRM-管理器" class="headerlink" title="DRM 管理器"></a>DRM 管理器</h2><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在 Web 平台，得益于多媒体引擎如 dash.js、Shaka Player 和 hls.js 这些趋于成熟库的帮助， MSE 和 EME 正在成为播放的新标准，同时也越来越多有影响力的厂家使用这些播放引擎。近年来，注意力也开始伸向机顶盒和互联网电视，我们也看到越来越多这样的新设备使用 MSE 来作为其底层多媒体处理引擎。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.qiniu.com/archives/7040" target="_blank" rel="noopener">《视频直播技术详解》系列之七：现代播放器原理</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/03/直播/直播技术/直播技术六-延迟优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/03/直播/直播技术/直播技术六-延迟优化/" itemprop="url">直播技术六-延迟优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-03T15:42:14+08:00">
                2019-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>直播系统是一个复杂的工程系统，要做到非常低延迟的直播，需要复杂的系统工程优化和对各组件非常熟悉的掌握</p>
<p>优化低延迟的时候并不是只关注「低延迟」，而是在保证其它条件不影响用户体验的情况下尽量做到低延迟</p>
<h1 id="编码优化"><a href="#编码优化" class="headerlink" title="编码优化"></a>编码优化</h1><ol>
<li>确保 Codec 开启了最低延迟的设置。Codec 一般都会有低延迟优化的开关，对于 H.264 来说其效果尤其明显。很多人可能不知道 H.264 的解码器正常情况下会在显示之前缓存一定的视频帧，对于 QCIF 分辨率大小的视频（176 × 144）一般会缓存 16 帧，对于 720P 的视频则缓存 5 帧。对于第一帧的读取来说，这是一个很大的延迟。如果你的视频不是使用 H.264 来编码压缩的，确保没有使用到 B 帧，它对延迟也会有较大的影响，因为视频中 B 帧的解码依赖于前后的视频帧，会增加延迟。</li>
</ol>
<ol start="2">
<li>编码器一般都会有码控造成的延迟，一般也叫做初始化延迟或者视频缓存检验器 VBV 的缓存大小，把它当成编码器和解码器比特流之间的缓存，在不影响视频质量的情况下可以将其设置得尽可能小也可以降低延迟。</li>
</ol>
<ol start="3">
<li>如果是仅仅优化首开延迟，可以在视频帧间插入较多的关键帧，这样客户端收到视频流之后可以尽快解码。但如果需要优化传输过程中的累计延迟，尽可能少使用关键帧也就是 I 帧（GOP 变大），在保证同等视频质量的情况下，I 帧越多，码率越大，传输所需的网络带宽越多，也就意味着累计延迟可能越大。这个优化效果可能在秒级延迟的系统中不是很明显，但是在 100 ms 甚至更低延迟的系统中就会非常明显。同时，尽量使用 ACC-LC Codec 来编码音频，HE-ACC 或者 HE-ACC 2 虽然编码效率高，但是编码所需时间更长，而产生更大体积的音频造成的传输延迟对于视频流的传输来说影响更小。</li>
</ol>
<ol start="4">
<li>不要使用视频 MJPEG 的视频压缩格式，至少使用不带 B 帧的 MPEG4 视频压缩格式（Simple profile），甚至最好使用 H.264 baseline profile（X264 还有一个「-tune zerolatency」的优化开关）。这样一个简单的优化可以降低延迟，因为它能够以更低的码率编码全帧率视频。</li>
</ol>
<ol start="5">
<li>如果使用了 FFmpeg，降低「-probesize 」和「 -analyze duration」参数的值，这两个值用于视频帧信息监测和用于监测的时长，这两个值越大对编码延迟的影响越大，在直播场景下对于视频流来说 analyzeduration 参数甚至没有必要设定。</li>
</ol>
<ol start="6">
<li>固定码率编码 CBR 可以一定程度上消除网络抖动影响，如果能够使用可变码率编码 VBR 可以节省一些不必要的网络带宽，降低一定的延迟。因此建议尽量使用 VBR 进行编码。</li>
</ol>
<h1 id="传输协议优化"><a href="#传输协议优化" class="headerlink" title="传输协议优化"></a>传输协议优化</h1><ol>
<li>在服务端节点和节点之间尽量使用 RTMP 而非基于 HTTP 的 HLS 协议进行传输，这样可以降低整体的传输延迟。这个主要针对终端用户使用 HLS 进行播放的情况。</li>
</ol>
<ol start="2">
<li>如果终端用户使用 RTMP 来播放，尽量在靠近推流端的收流节点进行转码，这样传输的视频流比原始视频流更小。</li>
</ol>
<ol start="3">
<li>如果有必要，可以使用定制的 UDP 协议来替换 TCP 协议，省去弱网环节下的丢包重传可以降低延迟。它的主要缺点在于，基于 UDP 协议进行定制的协议的视频流的传输和分发不够通用，CDN 厂商支持的是标准的传输协议。另一个缺点在于可能出现丢包导致的花屏或者模糊（缺少关键帧的解码参考），这就要求协议定制方在 UDP 基础之上做好丢包控制。</li>
</ol>
<h1 id="传输网络优化"><a href="#传输网络优化" class="headerlink" title="传输网络优化"></a>传输网络优化</h1><ol>
<li>我们曾经介绍过实时流传输网络，它是一种新型的节点自组织的网状传输网络，既适合国内多运营商网络条件下的传输优化，也适合众多海外直播的需求。</li>
</ol>
<ol start="2">
<li>在服务端节点中缓存当前 GOP，配合播放器端优化视频首开时间。</li>
</ol>
<ol start="3">
<li>服务端实时记录每个视频流流向每个环节时的秒级帧率和码率，实时监控码率和帧率的波动。</li>
</ol>
<ol start="4">
<li>客户端（推流和播放）通过查询服务端准实时获取当前最优节点（5 秒一次），准实时下线当前故障节点和线路。</li>
</ol>
<h1 id="推流、播放优化"><a href="#推流、播放优化" class="headerlink" title="推流、播放优化"></a>推流、播放优化</h1><ol>
<li>考察发送端系统自带的网络 buffer 大小，系统可能在发送数据之前缓存数据，这个参数的调优也需要找到一个平衡点。</li>
</ol>
<ol start="2">
<li>播放端缓存控制对于视频的首开延迟也有较大影响，如果仅优化首开延迟，可以在 0 缓存情况下在数据到达的时候立即解码。但如果在弱网环境下为了消除网络抖动造成的影响，设置一定的缓存也有必要，因此需要在直播的稳定性和首开延迟优化上找到平衡，调整优化缓冲区大小这个值。</li>
</ol>
<ol start="3">
<li>播放端动态 buffer 策略，这是上面播放端缓存控制的改进版本。如果只是做 0 缓存和固定大小的缓存之间进行选择找到平衡，最终还是会选择一个固定大小的缓存，这对亿级的移动互联网终端用户来说并不公平，他们不同的网络状况决定了这个固定大小的缓存并不完全合适。因此，我们可以考虑一种「动态 buffer 策略」，在播放器开启的时候采用非常小甚至 0 缓存的策略，通过对下载首片视频的耗时来决定下一个时间片的缓存大小，同时在播放过程中实时监测当前网络，实时调整播放过程中缓存的大小。这样即可做到极低的首开时间，又可能够尽量消除网络抖动造成的影响。</li>
</ol>
<ol start="4">
<li>动态码率播放策略。除了动态调整 buffer 大小的策略之外，也可以利用实时监测的网络信息来动态调整播放过程中的码率，在网络带宽不足的情况下降低码率进行播放，减少延迟。</li>
</ol>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.qiniu.com/archives/6996" target="_blank" rel="noopener">《视频直播技术详解》系列之六：延迟优化</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/03/直播/直播技术/直播技术五-推流和传输/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/03/直播/直播技术/直播技术五-推流和传输/" itemprop="url">直播技术五-推流和传输</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-03T15:02:14+08:00">
                2019-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>推流是直播的第一公里，直播的推流对整个直播链路影响非常大，如果推流的网络不稳定，无论我们如何做优化，观众的体验都会很糟糕。所以也是我们<strong>排查问题的第一步</strong>，如何系统地解决这类问题需要我们对相关理论有基础的认识。</p>
<h1 id="推送协议"><a href="#推送协议" class="headerlink" title="推送协议"></a>推送协议</h1><table>
<thead>
<tr>
<th>协议</th>
<th>传输协议</th>
<th>视频封装格式</th>
<th>延时</th>
<th>数据分段</th>
<th>HTML 5</th>
</tr>
</thead>
<tbody>
<tr>
<td>RTMP</td>
<td>TCP</td>
<td>flv tag</td>
<td>1-3s</td>
<td>连续流</td>
<td>不支持</td>
</tr>
<tr>
<td>HTTP-FLV</td>
<td>HTTP-TCP</td>
<td>flv</td>
<td>1-3s</td>
<td>连续流</td>
<td>支持</td>
</tr>
<tr>
<td>HLS</td>
<td>HTTP-TCP</td>
<td>m3u8/ts</td>
<td>10s+</td>
<td>切片</td>
<td>支持</td>
</tr>
<tr>
<td>WebRTC</td>
<td>UDP</td>
<td></td>
<td></td>
<td></td>
<td>支持</td>
</tr>
<tr>
<td>基于 UDP 的私有协议</td>
<td>UDP</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>HLS慢</strong>的原因是<strong>等数据</strong>，缩短ts间隔与个数，HLS也能做到4秒+的延迟</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>全称</th>
<th>说明</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>RTMP</td>
<td>Real Time Messaging Protocol <br>实时消息传输协议</td>
<td>Adobe公司推出。<br>1. 用来进行实时数据通信的网络协议。<br>2. 目前主流的流媒体传输协议<br> 3. 广泛用于直播领域，绝大多数的直播产品都采用这个协议</td>
<td>1. CDN支持良好，主流的 CDN 厂商都支持。<br>2. 协议简单，在各平台上实现容易</td>
<td>1. 基于TCP，传输成本高，弱网环境丢包率高的情况下问题显著。<br>2. 非公共端口，可能会被防火墙阻拦。<br>3. 不支持浏览器推送。<br>4. Adobe 私有协议，Adobe 已经不再更新</td>
</tr>
<tr>
<td>HTTP-FLV</td>
<td></td>
<td>Adobe公司推出。将流媒体数据封装成 FLV 格式，通过 HTTP 协议传输给客户端</td>
<td>1. 依靠 MIME 的特性，根据协议中的 Content-Type 来选择相应的程序去处理。<br>2. 基于 HTTP/80 传输, 穿透防火墙。<br>3. 可以通过 HTTP 302 跳转灵活调度/负载均衡。<br>4.支持使用 HTTPS 加密传输</td>
<td>缓存流媒体资源在本地客户端，保密性不够好</td>
</tr>
<tr>
<td>HLS</td>
<td>HTTP Live Streaming</td>
<td>苹果推出的。<br>服务器端将流媒体数据切割成连续的时长较短的 ts 小文件，并通过 M3U8 索引文件按序访问 ts 文件</td>
<td>1. 在 HTML5 页面上实现播放非常简单。<br>2. 穿透防火墙。基于 HTTP/80 传输<br> 3. 性能高,自带多码率自适应</td>
<td>1. 实时性差，延迟高。慢的原因是等数据，缩短ts间隔与个数，HLS也能做到4秒+的延迟<br>2. 文件碎片。ts 切片较小，会造成海量小文件，对存储和缓存都有一定的挑战</td>
</tr>
<tr>
<td>WebRTC</td>
<td>Web Real-Time Communication <br>网页即时通信</td>
<td>1. 支持网页浏览器进行实时语音对话或视频对话的 API。<br>2. 主要应用于视频会议和连麦中</td>
<td>1. W3C 标准，主流浏览器支持程度高。<br>2. Google 在背后支撑，并在各平台有参考实现。<br>3.基于 SRTP 和 UDP，弱网情况优化空间大。<br>4.可以实现点对点通信，通信双方延时低</td>
<td>底层依赖ICE,STUN,TURN 传统 CDN 没有类似的服务提供</td>
</tr>
<tr>
<td>基于 UDP 的私有协议</td>
<td></td>
<td>有些直播应用会使用 UDP 做为底层协议开发自己的私有协议</td>
<td>基于UDP自研，弱网情况优化空间更大</td>
<td>1. 开发成本高。<br>2. 需要自建 CDN 或者和 CDN 达成协议。 <br>3. 独立作战，无法和社区一起演进</td>
</tr>
</tbody>
</table>
<h2 id="webrtc协议分层"><a href="#webrtc协议分层" class="headerlink" title="webrtc协议分层"></a>webrtc协议分层</h2><img src="/2019/08/03/直播/直播技术/直播技术五-推流和传输/webrtc协议分层.jpg">
<h1 id="传输网络"><a href="#传输网络" class="headerlink" title="传输网络"></a>传输网络</h1><p>推送出去的流媒体需要传输到观众，整个链路就是传输网络</p>
<p>这个成本巨高，直播服务提供商才自建传输网络。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.qiniu.com/archives/6914" target="_blank" rel="noopener">《视频直播技术详解》系列之五：推流和传输</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">318</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
