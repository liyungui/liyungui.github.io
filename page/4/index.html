<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/06/逆向/Android/动态调试/无源码调试Android dex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/06/逆向/Android/动态调试/无源码调试Android dex/" itemprop="url">无源码调试Android dex</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-06T13:41:53+08:00">
                2019-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>标 题: 【原创】阿里聚安全技术分享之APK无源码调试<br>作 者: alimobsec<br>时 间: 2014-12-18,14:42:14<br>链 接: <a href="http://bbs.pediy.com/showthread.php?t=195660" target="_blank" rel="noopener">http://bbs.pediy.com/showthread.php?t=195660</a><br>这年头，apk全都是加密啊，加壳啊，反调试啊，小伙伴们表示已经不能愉快的玩耍了。静态分析越来越不靠谱了<br>我们的目标是——“debug apk step by step”。</p>
<p>那些不靠谱的工具<br>    IDA pro<br>    触发断点，在watch view和Locals窗口都能看到内存变量的值<br>    仔细观察下，就算你勾选了“Hex display”，你还是无法看到变量的值<br>    WTF！我特么忙活了半天居然还不如直接logcat来得痛快！</p>
<pre><code>apktool+eclipse
debug窗口表示命中第30行的断点
variables窗口没有任何本地变量的值，寄存器的值也没有
单步步入、单步步过等调试按钮都是灰色的，快捷键F5678都没反应
测试失败

apktool+android studio
可以看到现在程序停在哪一行，虽然不明显
本地变量能看到，但是寄存器还是木有啊
单步按钮还有单步快捷键都能用了，看起来好多了啊
我还是想说，问题是寄存器的值还是没法直观的看到啊
测试失败
</code></pre><p>apktool+idea 正菜来了<br>    下断点<br>    新建远程调试：依次点击run-&gt; edit configuration-&gt;“＋”号-&gt;Remote，命名为mytest<br>    run-&gt;debug-&gt;mytest<br>    断下，按两次resume，apk才能跑起来<br>    测试成功</p>
<p>另外，阿呆曾经提到一篇文章用jdb远程调试android程序的文章，<br>链接为：<a href="http://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications/" target="_blank" rel="noopener">http://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications/</a></p>
<p><a href="http://www.kanxue.com/bbs/showthread.php?p=1338639" target="_blank" rel="noopener">http://www.kanxue.com/bbs/showthread.php?p=1338639</a></p>
<hr>
<p>下载<a href="http://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="noopener">最新版Apktool</a>，按照教程操作</p>
<pre><code>个人推荐下载bat。把apktool.jar和apktool.bat放到同一目录即可。
    一是不用每次都敲 java -jar apktool.jar apktool
    二是在编译回apk时，cmd会把 b 参数解析成文件名（一直报找不到文件错误）
</code></pre><p>apktool 加-d参数反编译成java文件，全部拷贝到一个空java工程src目录下<br>    其实是伪java。每一行都是a=0;然后smali作为行注释<br>    -d的作用就是编译成 debug模式（.java，不加的话是.smali）<br>    apktool d -d test.apk -o test</p>
<p>manifest 加入debuggable属性，重打包，安装<br>    android:debuggable=”true”</p>
<p>使用-d选项重打包apk，签名(其他签名工具)，安装<br>    加-d才可以调试，否则断点无效<br>    apktool b -d test -o debug.apk</p>
<p>am命令启动apk，停留在等待调试器界面<br>    adb shell am start -D -W -n com.snda.wifilocating/com.lantern.launcher.ui.MainActivity<br>        出现ddms自动附加调试的话，尝试先让app进入等待调试模式，再开idea</p>
<p>eclipse调试按钮更多，远程调试，地址local，端口调试端口，附加上就可以断点调试了。<br>    一直没成功。<br>    附加不上，<br>    附加上是把原来的等待调试的杀死，启动了新进程<br>    附加上了，断不下来</p>
<p>有文章说在入口类入口方法第一行加 等待调试器代码（有api可调），可以远程附加调试<br>    onCreate第一行（.prologue后面）<br>    invoke-static {}, Landroid/os/Debug;-&gt;waitForDebugger()V<br>    的确会等待调试器附加，但是附加上去还是无法断点调试（断不下）</p>
<p>有文章甚至说反编译为jar包，加入一个空java工程中，就可以实现远程附加断点调试<br>    尝试失败</p>
<p>后来尝试用idea，成功！！</p>
<p>必须用另一个idea打开一个Android工程（上面我们是java工程），才能在tools–Android–Android device monitor 打开ddms，查看目标程序的调试端口（8700），同时防止adb掉线</p>
<p>新建远程调试：依次点击run-&gt; edit configuration-&gt;“＋”号-&gt;Remote，host写localhost，端口写上面查到的</p>
<p>点击run-&gt;debug-&gt;unnamed，其中unnamed是第9步中新建的远程调试的名字<br>    如果adb掉线，会出现连接拒绝，重连adb即可解决。 Unable to open debugger port (localhost:8700): java.net.ConnectException “Connection refused: connect”</p>
<h1 id="Smalidea-IntelliJ-IDEA-Android-Studio无源码调试"><a href="#Smalidea-IntelliJ-IDEA-Android-Studio无源码调试" class="headerlink" title="Smalidea+IntelliJ IDEA/Android Studio无源码调试"></a><a href="https://bbs.pediy.com/thread-220743.htm" target="_blank" rel="noopener">Smalidea+IntelliJ IDEA/Android Studio无源码调试</a></h1><p><a href="https://github.com/JesusFreke/smali/wiki/smalidea" target="_blank" rel="noopener">smalidea</a>是一个IntelliJ IDEA/Android Studio smali语言插件，可实现动态调试smali代码。支持14.1或以上版本的IDEA</p>
<h2 id="一、反编译apk为smali"><a href="#一、反编译apk为smali" class="headerlink" title="一、反编译apk为smali"></a>一、反编译apk为smali</h2><ul>
<li><p>baksmail:</p>
<pre><code>java -jar baksmali-2.2.1.jar  d myapp.apk -o ~/projects/myapp/src
</code></pre></li>
<li><p>apktool:</p>
<pre><code>java -jar apktool.jar d myapp.apk -o ~/projects/myapp/src
</code></pre></li>
</ul>
<h2 id="使apk可调试"><a href="#使apk可调试" class="headerlink" title="使apk可调试"></a>使apk可调试</h2><ul>
<li>使用模拟器</li>
<li>重打包apk。修改Manifest application 属性 android:debuggable=”true”</li>
<li>编译一个debug版 的rom</li>
<li>修改测试机的 /default.prop 文件的ro.debuggable=1。需root</li>
</ul>
<h2 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h2><hr>
<p>来自 看雪 古河 使用AndBug调试Android Java Bytecode<br>    <a href="http://bbs.pediy.com/showthread.php?t=141995" target="_blank" rel="noopener">http://bbs.pediy.com/showthread.php?t=141995</a></p>
<pre><code>附参考：看雪 anbn Android动态逆向分析工具（一）——Andbug之基本操作 系列。更加详细
    http://bbs.pediy.com/showthread.php?t=183412
</code></pre><p>AndBug的主页是：<a href="https://github.com/swdunlop/AndBug" target="_blank" rel="noopener">https://github.com/swdunlop/AndBug</a></p>
<p>必须Linux环境（我是Ubuntu 14）。Python开发，需要python-dev，bottle库（Python Web Framework）</p>
<p>github下载后解压，进入根目录，开启终端，make<br>    make 报错就是没有python-dev（Ubuntu自带Python，但没有python-dev）<br>        sudo apt-get install python-dev</p>
<p>在模拟器中启动apk，在命令行下输入 adb shell ps，找到相应的进程pid，在这个例子中pid是243<br>    apk 必须debuggable，否则附加调试会出现 Connection reset by peer 错误</p>
<pre><code>Ubuntu adb 问题。
    sudo add-apt-repository ppa:nilarimogard/webupd8
    sudo apt-get update
    sudo apt-get install android-tools-adb

安卓设备连接 adb 问题
    lsusb 配合插拔usb设备，确定 USB设备。
    发现usb口是当前使用的端口：Bus 002 Devices 004：ID 230b:0100        
    ID 230b 就是idVendor ，0100就是 idProduct

    新建并编辑一个文件
    sudo vi /etc/udev/rules.d/70-android.rules
    在里面写入：
    SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;230b&quot;, ATTRS{idProduct}==&quot;0100&quot;,MODE=&quot;0666&quot;
        ID 230b 就是idVendor ，0100就是 idProduct
        其实还应该写一个OWNER项，用来指定是哪个用户有权限操作
        如果不写则是root（不是所有用户都可以访问）

    保存退出，再设置一下权限
    sudo chmod a+rx /etc/udev/rules.d/70-android.rules

    向adb_usb.ini文件写入厂商id（注意加 0x前缀）
    echo 0x230b &gt; ~/.android/adb_usb.ini
        用户根目录下，ls -a 可以发现

    重启USB服务
    sudo service udev restart
</code></pre><p>进入AndBug根目录，输入PYTHONPATH=lib ./andbug shell -p 8723，命令attach上目标进程<br>    andbug是Python脚本，andbug shell 附加调试命令<br>    adb shell ps | grep “com.yuki” 可以找到对应名字的pid</p>
<pre><code>[Errno 104] Connection reset by peer 问题
搜索了好久，包括原贴和官网上都没有解决。
我尝试去attach其它进程，发现其它进程是可以成功的，
继而我想到可能是debuggable的问题，逆向AndroidManifest添加 android:debuggable=true 成功。
</code></pre><p>classes 命令，查看apk调用了哪些类<br>    classes java.net 查看调用的包含java.net的类</p>
<p>methods 命令，查看apk调用了哪些类方法</p>
<p>break java.net.URL 断点类调用。<br>    也可断点方法调用 break 类名 方法名（类名和方法名间空格）<br>    Android4.4.2上实际操作发现断java.net.URL会在触摸屏幕触发断点<br>         com.android.okhttp.Connection.connect 这个断点效果好<br>         break com.android.okhttp.Connection connect</p>
<p>break-list命令查看断点设置情况<br>break-remove 536870916    删除已设置断点</p>
<p>操作apk，触发断点</p>
<p>navi命令，提示 server地址<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> 查看线程状态<br>    !! command not supported: “navi.”  问题<br>    这是需要 bottle库（Python Web Framework）<br>        apt-get install python-bottle</p>
<pre><code>Error: 500 Internal Server Error 问题
访问http://localhost:8080 错误。
解释说是地址，或资源问题。没有搞定（rooted红米note1 Android4.4.2）
后来过了很长一段时间，用华为 g521-L076 测试成功（rooted，Android4.3）
</code></pre><p>resume 恢复运行</p>
<p>suspend 进程暂停命令</p>
<p>help 帮助命令</p>
<p>class-trace 类跟踪命令<br>取消跟踪也可以使用break-remove命令实现。</p>
<p>method-trace 方法跟踪命令</p>
<p>列举当前线程信息<br>命令：threads 会列出函数调用的情况，参数，以及堆栈情况。</p>
<p>示指定类中的静态变量的信息<br>命令：statics com.android.internal.view.menu.MenuBuilder</p>
<p>查看对象信息<br>通过class-trace命令可以跟踪到目标函数中对象的Id信息，</p>
<p>通过对象的Id使用inspect命令，可以查处该队形的详细信息。<br>由于在break命令设置断点后，触发断点时反馈的信息，没有包含Object Id的信息，导致inspect命令用起来不是很方便。</p>
<p>19、源码关联命令<br>命令：source 与源代码关联起来，可以是smali代码。<br>命令：dump 展示指定方法的代码。</p>
<p>20、Web输出命令<br>命令：navi<br>注：为了支持navi命令，需要安**ottle库。</p>
<p>退出命令<br>命令：exit     </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/06/逆向/Android/动态调试/jswat 无源码动态调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/06/逆向/Android/动态调试/jswat 无源码动态调试/" itemprop="url">jswat无源码动态调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-06T11:51:53+08:00">
                2019-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://blog.csdn.net/douniwan5788/article/details/17657665" target="_blank" rel="noopener">Android 无源码动态调试</a> </p>
<p><a href="http://bbs.pediy.com/showthread.php?p=1277276" target="_blank" rel="noopener">jswat无源码动态调试</a> </p>
<h2 id="rooadb-jswat-AndBug-jdb"><a href="#rooadb-jswat-AndBug-jdb" class="headerlink" title="rooadb + jswat(AndBug,jdb)"></a>rooadb + jswat(AndBug,jdb)</h2><p>Android无原码动态调试无敌了！ </p>
<p>rootadb 可以以root启动adbd并使用其自带工具setpropex修改ro.debuggable = 1。（droid4x海马玩模拟器自带调试属性也可以）</p>
<p>jswat、andbug、jdb都是可以无源码调试java的debuger</p>
<ol>
<li>jswat有GUI，java写的跨平台</li>
<li>AndBug Linux下编译比较方便，Windows要自己搭建mingw环境</li>
<li><p>jdb最强大。而且是jdk的一部分，免费且跨平台。命令行操作</p>
<pre><code>gdbserver在ndk目录下的prebuilt文件夹，选择对应cpu即可
gdb是GNU开源组织发布的一个强大的UNIX下的程序调试工具。
也可以自己下载编译，同时获得gdb的客户端和服务端。
</code></pre></li>
</ol>
<p>链接</p>
<p><a href="https://github.com/poliva/rootadb" target="_blank" rel="noopener">rootadb下载</a></p>
<p><a href="https://drive.google.com/folderview?id=0B8-CbCFlTA3nOVhZREhIcXBvT2c&amp;usp=sharing" target="_blank" rel="noopener">jswat下载</a></p>
<pre><code>google 编译好的版本：如果是windows建议下exe安装版本,jar安装版好像环境变量有点问题
</code></pre><p><a href="https://github.com/swdunlop/AndBug" target="_blank" rel="noopener">AndBug下载</a></p>
<h2 id="附加进程-session–attach"><a href="#附加进程-session–attach" class="headerlink" title="附加进程 session–attach"></a>附加进程 session–attach</h2><p>附加进程有多中方式，下面是最常用的两种</p>
<ol>
<li><p>attach by socket（默认）</p>
<p> host： localhost</p>
<p> port：运行端口。千万不要写调试端口（所有app调试端口默认8700，这样就会附加到第一个找到的进程上）</p>
<pre><code>android device monitor 设备/进程为空，先打开monitor，再打开模拟器可解决
</code></pre></li>
<li><p>attach to process<br> process id填 pid。adb shell ps 可查到</p>
</li>
</ol>
<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><p>classes可以看到调用的所有类（混淆后的名字），可以直接展开在上面下类/方法断点</p>
<p>variables可以看到断点方法的变量</p>
<p>breakpoints可以查看所有断点</p>
<p>callstack 调用堆栈</p>
<p>debuggerConsole 控制台输出，包括断点、单步调用的方法过程（如果单步调试中的话）</p>
<h2 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h2><h3 id="方法断点"><a href="#方法断点" class="headerlink" title="方法断点"></a>方法断点</h3><pre><code>android.view.View.setOnClickListener(android.view.View$OnClickListener)断点
package: android.view
class: View
method: setOnClickListener
parameters: android.view.View$OnClickListener 参数不填也可以（系统补*表示任意参数类型）
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/06/逆向/Android/动态调试/快速定位关键代码的方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/06/逆向/Android/动态调试/快速定位关键代码的方法/" itemprop="url">快速定位关键代码的方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-06T11:51:53+08:00">
                2019-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>特征字符串</li>
<li>特征API</li>
<li>代码注入    <ul>
<li>logcat输出信息</li>
<li>logcat输出栈跟踪</li>
<li>Method Profiling </li>
</ul>
</li>
</ol>
<h2 id="logcat输出信息"><a href="#logcat输出信息" class="headerlink" title="logcat输出信息"></a>logcat输出信息</h2><pre><code>const-string v9, &quot;lyg&quot;
const-string v8, &quot;you message&quot;  
invoke-static {v9, v8}, Landroid/util/Log;-&gt;v(Ljava/lang/String;Ljava/lang/String;)I

const-string v3, &quot;lyg&quot;
invoke-static {v1}, Ljava/lang/Integer;-&gt;toString(I)Ljava/lang/String;
move-result-object v4
invoke-static {v3, v4}, Landroid/util/Log;-&gt;v(Ljava/lang/String;Ljava/lang/String;)I
</code></pre><p>从以上代码看出，logcat调用需要操作寄存器，更改.locals，容易出错</p>
<p>所以，应该自己写一个LogUtils反编译成smali。用的时候直接把smali拷贝到工程即可。</p>
<h2 id="logcat输出栈跟踪"><a href="#logcat输出栈跟踪" class="headerlink" title="logcat输出栈跟踪"></a>logcat输出栈跟踪</h2><pre><code>Log.e(&quot;lyg&quot;, Log.getStackTraceString(new Exception(&quot;lyg2&quot;)));

new Exception(&quot;lyg&quot;).printStackTrace(); tag是System.err 级别为Warn
</code></pre><h2 id="Method-Profiling"><a href="#Method-Profiling" class="headerlink" title="Method Profiling"></a>Method Profiling</h2><ul>
<li><p>DDMS中选中进程，点击右上角的start method Profiling，操作app，点击stop method Profiling，自动弹出traceView</p>
</li>
<li><p>手动灵活调用Method Profiling（Android SDK提供的调试支持，在android.os.Debug类）</p>
<p>  android.os.Debug.startMethodTracing(“123”); </p>
<p>  android.os.Debug.stopMethodTracing();</p>
<p>  123为trace文件名，在sd卡根目录，所以记得申请sd卡读写权限</p>
<p>  将123.trace pull 到计算机， 用Android SDK tools目录的traceview打开，跟DDMS效果一样</p>
<pre><code>traceview 123.trace
</code></pre></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/04/直播/视频/FLV解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/04/直播/视频/FLV解析/" itemprop="url">FLV解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-04T11:42:14+08:00">
                2019-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FLV封装格式"><a href="#FLV封装格式" class="headerlink" title="FLV封装格式"></a>FLV封装格式</h1><p>一个文件头（File Header）+一个文件体（File Body）。结构如下图：</p>
<img src="/2019/12/04/直播/视频/FLV解析/flv结构.png">
<h1 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> byte;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    byte Signature[<span class="number">3</span>]; <span class="comment">//文件标识，3字节；固定内容"FLV"(0x46, 0x4c, 0x4c)</span></span><br><span class="line">    byte Version; <span class="comment">//版本，目前为0x1</span></span><br><span class="line">    byte Flags; <span class="comment">//前5位保留为0；第6位标识是否存在音频tag；第7位保留为0；第8位标识是否存在视频tag；</span></span><br><span class="line">    uint DataOffset; <span class="comment">//文件体偏移，4字节；即文件头大小，版本1总为9</span></span><br><span class="line">&#125; FLV_HEADER; <span class="comment">//9字节</span></span><br></pre></td></tr></table></figure>
<img src="/2019/12/04/直播/视频/FLV解析/header实例.png">
<p>Flags 这里为5，即 00000101，表示音视频tag都有</p>
<h1 id="文件体"><a href="#文件体" class="headerlink" title="文件体"></a>文件体</h1><p>一连串的 <code>back-pointer</code>(反向指针，即指向前面的指针)和 <code>tag</code> 构成</p>
<h2 id="back-pointer"><a href="#back-pointer" class="headerlink" title="back-pointer"></a><code>back-pointer</code></h2><p>固定4个字节，表示前一个tag的size。</p>
<h2 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h2><p>分三种类型，video、audio、scripts。</p>
<p>tag由header和data两部分组成。</p>
<p>header结构相同，不同类型tag 的 data结构各不相同</p>
<h3 id="tag-header"><a href="#tag-header" class="headerlink" title="tag header"></a>tag header</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> byte;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    byte TagType; <span class="comment">//tag类型；8为Audio,9为Video,18为scripts</span></span><br><span class="line">    byte DataSize[<span class="number">3</span>]; <span class="comment">//tag data长度，3字节；</span></span><br><span class="line">    byte Timestamp[<span class="number">3</span>]; <span class="comment">//时间戳，3字节；相对毫秒值，第一个tag时间戳总是0</span></span><br><span class="line">    byte TimestampExtended; <span class="comment">//扩展时间戳，1字节，时间戳高8位，上面时间戳3位不够用的时候，将使用该字节；</span></span><br><span class="line">    byte StreamId[<span class="number">3</span>]; <span class="comment">//StreamId，3字节，总是0；</span></span><br><span class="line">&#125; TAG_HEADER; <span class="comment">//11字节</span></span><br></pre></td></tr></table></figure>
<img src="/2019/12/04/直播/视频/FLV解析/tag-header实例.png">
<p>图中红色部分是两个 <code>back-pointer</code>，都是4个字节。他们中间就是第一个TAG</p>
<p>蓝色是第一个tag的tag data长度，3个字节</p>
<p>第一个 <code>back-pointer</code> 是0x00000000，那是因为后面是第一个TAG。所以他为0。</p>
<p>第一个tag的tag data长度为0x000125=293。那么到第一个TAG结束，总共有293+24=137=0x13D。(header 9 + back-pointer 4 + tag-header 11 = 24)</p>
<p>第二个 <code>back-pointer</code> 是0x00000130=304，即第一个tag长度(293 + 11 = 304)</p>
<h3 id="脚本-tag-data"><a href="#脚本-tag-data" class="headerlink" title="脚本 tag data"></a>脚本 tag data</h3><p>又被称为 <code>MetaData Tag</code></p>
<p>存放一些关于FLV视频和音频的元信息，比如：duration、width、height等。通常该类型Tag会作为FLV文件的第一个tag，并且只有一个</p>
<p>脚本的数据类型 都是以数据类型+（数据长度）+数据的格式出现的，数据类型占1byte，数据长度看数据类型是否存在，后面才是数据。</p>
<p>一般来说，该Tag Data结构包含两个AMF包。</p>
<p>AMF（Action Message Format）是Adobe设计的一种通用数据封装格式，在Adobe的很多产品中应用，简单来说，AMF将不同类型的数据用统一的格式来描述。</p>
<p>第一个AMF包封装字符串类型数据，用来装入一个“onMetaData”标志，这个标志与Adobe的一些API调用有关。第1个字节表示AMF类型，一般为0x02，表示字符串；第2、3个字节用来标识字符长度，一般总是0x000A。后面字节为具体的字符串onMetaData。</p>
<p>第二个AMF包封装一个数组类型，这个数组中包含了音视频信息项的名称和值。第1个字节表示AMF包类型，一般总是0x08，表示数组。第2-5个字节表示数组元素个数，后面几位是各数组元素的封装，数组元素为(名称-值)组成的对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">duration 时长</span><br><span class="line">width 视频宽度</span><br><span class="line">height 视频高度</span><br><span class="line">videodatarate 视频码率</span><br><span class="line">framerate 视频帧率</span><br><span class="line">videocodecid 视频编码方式</span><br><span class="line">audiosamplerate 音频采样率</span><br><span class="line">audiosamplesize 音频采样精度</span><br><span class="line">stereo 是否为立体声</span><br><span class="line">audiocodecid 音频编码方式</span><br><span class="line">filesize 文件大小</span><br></pre></td></tr></table></figure>
<h3 id="视频-tag-data"><a href="#视频-tag-data" class="headerlink" title="视频 tag data"></a>视频 tag data</h3><img src="/2019/12/04/直播/视频/FLV解析/视频tag-data结构.png">
<p>一个字节包含了视频数据的参数信息，从第二个字节开始为视频流</p>
<p>帧类型，4bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 keyframe （for AVC，a seekable frame）</span><br><span class="line">2 inter frame （for AVC，a nonseekable frame）</span><br><span class="line">3 disposable inter frame （H.263 only）</span><br><span class="line">4 generated keyframe （reserved for server use）</span><br><span class="line">5 video info/command frame</span><br></pre></td></tr></table></figure>
<p>视频编码类型，4bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 JPEG （currently unused）</span><br><span class="line">2 Sorenson H.263</span><br><span class="line">3 Screen video</span><br><span class="line">4 On2 VP6</span><br><span class="line">5 On2 VP6 with alpha channel</span><br><span class="line">6 Screen video version 2</span><br><span class="line">7 AVC //H.264</span><br></pre></td></tr></table></figure>
<h4 id="AVC视频tag"><a href="#AVC视频tag" class="headerlink" title="AVC视频tag"></a>AVC视频tag</h4><p>视频编码类型是AVC（H.264）的话，VideoTag data 最前面4个字节表示AVCPacketType 和CompositionTime。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">byte AVCPacketType; //AVCPacketType，1字节</span><br><span class="line">byte CompositionTime [3]; //CompositionTime，3字节</span><br></pre></td></tr></table></figure>
<h4 id="AVCPacketType"><a href="#AVCPacketType" class="headerlink" title="AVCPacketType"></a>AVCPacketType</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 AVCDecoderConfigurationRecord(AVC sequence header)</span><br><span class="line">1 AVC NALU</span><br><span class="line">2 AVC end of sequence (lower level NALU sequence ender is not required or supported)</span><br></pre></td></tr></table></figure>
<p>AVCDecoderConfigurationRecord.包含着是H.264解码相关比较重要的sps和pps信息，给AVC解码器送数据流之前一定要把sps和pps信息送出，否则的话解码器不能正常解码。而且在解码器stop之后再次start之前，如seek、快进快退状态切换等，都需要重新送一遍sps和pps的信息.AVCDecoderConfigurationRecord在FLV文件中一般情况也是出现1次，也就是第一个video tag.</p>
<h4 id="CompositionTime"><a href="#CompositionTime" class="headerlink" title="CompositionTime"></a>CompositionTime</h4><p>AVCPacketType ==1 该值才有意义；其他情况下该值为0</p>
<h4 id="sps-pps"><a href="#sps-pps" class="headerlink" title="sps pps"></a>sps pps</h4><p><code>0x01+sps[1]+sps[2]+sps[3]+0xFF+0xE1+sps size(2字节)+sps+01+pps size(2字节)+pps</code></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><img src="/2019/12/04/直播/视频/FLV解析/视频tag实例.png">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---tag header---</span><br><span class="line">TagType =0x09=9。这是一个video tag。</span><br><span class="line">DataSize =0x000030=48。长度为48。</span><br><span class="line">Timestamp =0x000000。</span><br><span class="line">TimestampExtended =0x00。</span><br><span class="line">StreamId =0x000000</span><br><span class="line"></span><br><span class="line">---tag data---</span><br><span class="line">视频参数（帧类型，编码类型）= 0x17;1 = 关键帧，7 = AVC //H.264</span><br><span class="line">AVCPacketType = 0x00</span><br><span class="line">CompositionTime = 0x000000</span><br><span class="line">sps[1]=0x64</span><br><span class="line">sps[2]=00</span><br><span class="line">sps[3]=0D</span><br><span class="line">sps size=0x001B=27</span><br><span class="line">跳过sps(27个字节)后，是0x01</span><br><span class="line">pps size=0x0005</span><br><span class="line">跳过5个字节，就到了`back-pointer`=0x3B，即59(tag-header 11 + tag data 48)。</span><br></pre></td></tr></table></figure>
<h3 id="音频-tag-data"><a href="#音频-tag-data" class="headerlink" title="音频 tag data"></a>音频 tag data</h3><img src="/2019/12/04/直播/视频/FLV解析/音频tag-data结构.png">
<p>一个字节包含了音频数据的参数信息，从第二个字节开始为音频流</p>
<p>音频编码类型，4bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0 Linear PCM，platform endian</span><br><span class="line">1 ADPCM</span><br><span class="line">2 MP3</span><br><span class="line">3 Linear PCM，little endian</span><br><span class="line">4 Nellymoser 16-kHz mono</span><br><span class="line">5 Nellymoser 8-kHz mono</span><br><span class="line">6 Nellymoser</span><br><span class="line">7 G.711 A-law logarithmic PCM</span><br><span class="line">8 G.711 mu-law logarithmic PCM</span><br><span class="line">9 reserved</span><br><span class="line">10 AAC</span><br><span class="line">14 MP3 8-Khz</span><br><span class="line">15 Device-specific sound</span><br></pre></td></tr></table></figure>
<p>音频采样率，2bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 5.5kHz</span><br><span class="line">1 11KHz</span><br><span class="line">2 22 kHz</span><br><span class="line">3 44 kHz //FLV并不支持48KHz的采样率；对于AAC总是3</span><br></pre></td></tr></table></figure>
<p>音频采样精度，1bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 8bits</span><br><span class="line">1 16bits //压缩过的音频都是16bit</span><br></pre></td></tr></table></figure>
<p>音频类型，1bit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 sndMono</span><br><span class="line">1 sndStereo //对于AAC总是1</span><br></pre></td></tr></table></figure>
<h1 id="FLV解析流程"><a href="#FLV解析流程" class="headerlink" title="FLV解析流程"></a>FLV解析流程</h1><img src="/2019/12/04/直播/视频/FLV解析/FLV解析.jpg">
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/4c86b55833ca" target="_blank" rel="noopener">FLV解析</a> 文件结构 + 解析代码</li>
<li><a href="http://www.365jz.com/article/24612" target="_blank" rel="noopener">视频flv格式是什么文件 怎么打开播放</a>  周杰伦《东风破》MV文件16进制分析</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/27/逆向/Android/重打包/修改第三方aar重打包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/27/逆向/Android/重打包/修改第三方aar重打包/" itemprop="url">修改第三方aar重打包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-27T20:15:53+08:00">
                2019-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="解压aar"><a href="#解压aar" class="headerlink" title="解压aar"></a>解压aar</h1><p><code>unzip myLib.aar -d tempFolder</code></p>
<h1 id="解压classes-jar"><a href="#解压classes-jar" class="headerlink" title="解压classes.jar"></a>解压<code>classes.jar</code></h1><p>解压aar中的<code>classes.jar</code>。 </p>
<p><code>unzip classes.jar -d tempFolderClasses</code></p>
<h1 id="逆向源码"><a href="#逆向源码" class="headerlink" title="逆向源码"></a>逆向源码</h1><p>这里推荐使用 <code>jd-gui</code>，支持直接逆向aar</p>
<h1 id="修改源码"><a href="#修改源码" class="headerlink" title="修改源码"></a>修改源码</h1><ul>
<li>新建项目</li>
<li>引用原aar</li>
<li>拷贝目标类源码（包名一致）</li>
<li>修改报错<ul>
<li><code>jd-gui</code>发编译的特点：可读性高；原义性低。</li>
<li>混淆容易造成类名重复</li>
</ul>
</li>
<li>修改源码（实现自己的逻辑）</li>
<li>编译生成class文件<ul>
<li>会报错（重复类；合并失败）</li>
<li>class文件路径 <code>/build/intermediates/javac</code></li>
</ul>
</li>
</ul>
<p><code>jd-gui</code>逆向示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tencent.liteav.basic.c.a;</span><br><span class="line"><span class="keyword">import</span> com.tencent.liteav.basic.structs.a;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> a mNotifyListener;</span><br><span class="line"><span class="keyword">protected</span> a mRestartListener;</span><br></pre></td></tr></table></figure>
<p>同名类a，编译期报错。</p>
<p>修改方式：删掉一个导包，完整包名的方式来使用类</p>
<h1 id="替换class文件"><a href="#替换class文件" class="headerlink" title="替换class文件"></a>替换class文件</h1><p>替换tempFolderClasses文件夹下旧的.class文件</p>
<h1 id="打包classes-jar"><a href="#打包classes-jar" class="headerlink" title="打包classes.jar"></a>打包<code>classes.jar</code></h1><p>打包源码为jar</p>
<p><code>jar cvf classes.jar -C tempFolderClasses/ .</code>（注意斜杠后面加<code>空格与.</code>）</p>
<h1 id="打包aar"><a href="#打包aar" class="headerlink" title="打包aar"></a>打包aar</h1><p>打包所有文件(res文件、classes.jar、AndroidManifest.xml等)为aar</p>
<p><code>jar cvf newAAR.aar -C tempFolder/ .</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/25/直播/腾讯直播/SDK逆向/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/25/直播/腾讯直播/SDK逆向/" itemprop="url">SDK逆向</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-25T14:52:14+08:00">
                2019-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SDK版本"><a href="#SDK版本" class="headerlink" title="SDK版本"></a>SDK版本</h1><p>移动直播（Mobile Live Video Broadcasting，MLVB）SDK </p>
<p>LiteAVSDK_Professional_6.6.7458 </p>
<h1 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h1><img src="/2019/11/25/直播/腾讯直播/SDK逆向/类图.png">
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//音视频数据处理接口 com.tencent.liteav.network.h</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDownloaderCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPullAudio</span><span class="params">(a var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPullNAL</span><span class="params">(TXSNALPacket var1)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TXIStreamDownloader</span> </span>&#123;</span><br><span class="line">	startDownload()</span><br><span class="line">	stopDownload()</span><br><span class="line">	onRecvVideoData()</span><br><span class="line">	onRecvAudioData()</span><br><span class="line">	onRecvSEIData()</span><br><span class="line">	onRecvMetaData()</span><br><span class="line">	PushVideoFrame()</span><br><span class="line">	PushAudioFrame()</span><br><span class="line">	getCurrentTS()</span><br><span class="line">	getLastIFrameTS()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXCFLVDownloader</span> <span class="keyword">extends</span> <span class="title">TXIStreamDownloader</span> </span>&#123; </span><br><span class="line">	<span class="comment">//线程名 FlvThread</span></span><br><span class="line">	nativeInitFlvHander() 创建flvOriginThread线程</span><br><span class="line">	nativeParseData()</span><br><span class="line">	nativeCleanData()</span><br><span class="line">	nativeGetAudioBytes()</span><br><span class="line">	nativeGetVideoBytes()</span><br><span class="line">	nativeGetVideoGop()</span><br><span class="line">	nativePushAudioFrame()</span><br><span class="line">	nativePushVideoFrame()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXCRTMPDownloader</span> <span class="keyword">extends</span> <span class="title">TXIStreamDownloader</span> </span>&#123;</span><br><span class="line">	<span class="comment">//线程名 RTMPDownLoad</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//StreamRecvThread.cpp</span><br><span class="line"></span><br><span class="line">init</span><br><span class="line">writeData</span><br><span class="line">clear</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//FlvContainer.cpp</span><br><span class="line"></span><br><span class="line">threadLoop</span><br><span class="line">readTagHeader</span><br><span class="line">parseMetaData</span><br><span class="line">findIFrameOffset</span><br><span class="line">parseVideoData</span><br><span class="line">checkState</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//FlvParserInternal.cpp</span><br><span class="line"></span><br><span class="line">reallocBuffer</span><br><span class="line">copyDataTo26xCache</span><br><span class="line">parseData</span><br></pre></td></tr></table></figure>
<h2 id="解码-amp-渲染"><a href="#解码-amp-渲染" class="headerlink" title="解码&amp;渲染"></a>解码&amp;渲染</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//视频解码器接口 com.tencent.liteav.videodecoder.a</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IVideoDecoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//视频解码回调接口 com.tencent.liteav.videodecoder.c</span><br><span class="line">public interface VideoDecodeListener &#123;</span><br><span class="line">    void onDecodeFrame(TXSVideoFrame var1, int var2, int var3, long var4, long var6, int var8);</span><br><span class="line"></span><br><span class="line">    void onDecodeFailed(int var1);</span><br><span class="line"></span><br><span class="line">    void onVideoSizeChange(int var1, int var2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ffmpeg解码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXCVideoFfmpegDecoder</span> <span class="keyword">implements</span> <span class="title">IDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MediaCodecDecoder解码器 com.tencent.liteav.videodecoder.b;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaCodecDecoder</span> <span class="keyword">implements</span> <span class="title">IDecoder</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TXCVideoDecoder解码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXCVideoDecoder</span> <span class="keyword">implements</span> <span class="title">DecodeListener</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXCRenderAndDec</span> <span class="keyword">implements</span> <span class="title">DecodeListener</span></span>&#123;</span><br><span class="line">	setVideoRender(com.tencent.liteav.renderer.f var1)<span class="comment">//设置Render，开始渲染</span></span><br><span class="line">	setRenderAndDecDelegate()</span><br><span class="line">	setVideoFrameListener(com.tencent.liteav.s var1) 设置渲染TXSVideoFrame的监听</span><br><span class="line">	setConfig()</span><br><span class="line">	setDecListener()</span><br><span class="line">	enableDecoderChange()</span><br><span class="line">	start()</span><br><span class="line">	startVideo()</span><br><span class="line">	isRendering()</span><br><span class="line">	decVideo(TXSNALPacket var1)</span><br><span class="line">	startDecode()</span><br><span class="line">	switchToSoftDecoder()</span><br><span class="line">	requestKeyFrame()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//TXCVideoJitterBuffer.cpp</span><br><span class="line"></span><br><span class="line">Start</span><br><span class="line">Stop</span><br><span class="line">PushFrame</span><br><span class="line">PullFrame</span><br><span class="line">DropFrame</span><br><span class="line">getVideoDecoderSink</span><br><span class="line">OnNotifyLoadingEvent</span><br><span class="line">SetHWCacheFrameCount</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// TXCVideoDecoder.cpp</span><br><span class="line"></span><br><span class="line">Start</span><br><span class="line">Stop</span><br><span class="line">EnableDecodeChange</span><br><span class="line">OnReceiveVideoFrame</span><br><span class="line">SetStreamType</span><br><span class="line">SetID</span><br><span class="line">onDecodeDone</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//TXCAudioJitterBuffer.cpp</span><br><span class="line"></span><br><span class="line">adjustThreshold</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//TXCFFmpegAACDecoder.cpp</span><br><span class="line"></span><br><span class="line">Init</span><br><span class="line">DoDecode</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//TXCTraeAudioEngine.cpp</span><br><span class="line"></span><br><span class="line">ThreadLoop100ms</span><br><span class="line">OnQueryPcmToPlay</span><br></pre></td></tr></table></figure>
<h2 id="播放器"><a href="#播放器" class="headerlink" title="播放器"></a>播放器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">com.tencent.liteav.r 基类TXIPlayer</span><br><span class="line"></span><br><span class="line">TXLivePlayer</span><br><span class="line">com.tencent.rtmp.a <span class="comment">//TXLivePlayer的实现类的代理类</span></span><br><span class="line">com.tencent.liteav.g <span class="comment">//TXLivePlayer的实现类</span></span><br><span class="line"></span><br><span class="line">TXVodPlayer</span><br><span class="line">com.tencent.liteav.n <span class="comment">//TXVodPlayer的实现类</span></span><br><span class="line"></span><br><span class="line">TXCloudVideoView</span><br><span class="line">TXCVodVideoView</span><br></pre></td></tr></table></figure>
<h2 id="数据日志"><a href="#数据日志" class="headerlink" title="数据日志"></a>数据日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TXCEventRecorderProxy</span><br><span class="line">TXCKeyPointReportProxy</span><br><span class="line">TXCLog</span><br></pre></td></tr></table></figure>
<h1 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h1><img src="/2019/11/25/直播/腾讯直播/SDK逆向/时序图.png">
<p>StreamRecvThread.cpp writeData</p>
<h2 id="API调用过程"><a href="#API调用过程" class="headerlink" title="API调用过程"></a>API调用过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">TXLivePlayer startPlay</span><br><span class="line"></span><br><span class="line">TXLivePlayerImpDelegate a</span><br><span class="line"></span><br><span class="line">AudioEngImplTRAE a</span><br><span class="line"></span><br><span class="line">TXCTraeAudioEngine.cpp a</span><br><span class="line"></span><br><span class="line">liteav.renderer.f b(TextureView paramTextureView)</span><br><span class="line"></span><br><span class="line">TXCRenderAndDec setVideoRender((f paramf))</span><br><span class="line"></span><br><span class="line">TXCRenderAndDec start(boolean paramBoolean)</span><br><span class="line"></span><br><span class="line">TXCVideoDecoder.cpp Start</span><br><span class="line"></span><br><span class="line">TXCAudioJitterBuffer.cpp </span><br><span class="line"></span><br><span class="line">TXCFLVDownloader startDownload</span><br><span class="line"></span><br><span class="line">liteav.renderer.f b(Surface paramSurface)</span><br><span class="line"></span><br><span class="line">liteav.basic.datareport.TXCDRApi</span><br><span class="line"></span><br><span class="line">tx_dr_base.cpp RecvResponse</span><br><span class="line"></span><br><span class="line">tx_dr_base.cpp txReportDAU</span><br><span class="line"></span><br><span class="line">jni_audio_play.cpp Java_com_tencent_liteav_audio_impl_TXCJitter_nativeSetJitterListener</span><br><span class="line"></span><br><span class="line">TXCRenderAndDec setVideoFrameListener</span><br><span class="line"></span><br><span class="line">TXCVideoJitterBuffer.cpp Start</span><br><span class="line"></span><br><span class="line">TXCVideoJitterBuffer.cpp getVideoDecoderSink</span><br><span class="line"></span><br><span class="line">StreamRecvThread.cpp threadLoop flv play parse the flv tag head at 0</span><br><span class="line"></span><br><span class="line">TXCFFmpegAACDecoder.cpp Init</span><br><span class="line">TXCFFmpegAACDecoder.cpp DoDecode init soft aac decoder success sr[44100|48000] , ch[2|2]!</span><br><span class="line"></span><br><span class="line">FlvContainer.cpp parseVideoData flv parse the I Frame</span><br><span class="line"></span><br><span class="line">TXCFFmpegAACDecoder.cpp DoDecode aac soft dec first frame success with audio info : samplerate[44100|48000] , channel [2|2]</span><br><span class="line"></span><br><span class="line">TXCVideoJitterBuffer.cpp OnNotifyLoadingEvent recv loading event 0</span><br><span class="line"></span><br><span class="line">TXCVideoDecoder.cpp OnReceiveVideoFrame trtc_play:decode: push first i frame</span><br><span class="line"></span><br><span class="line">TXCVideoDecoder.cpp onDecodeDone trtc_play:decode: decode first frame success</span><br><span class="line"></span><br><span class="line">TXCTextureViewWrapper vrender: set video size:1280,720</span><br><span class="line"></span><br><span class="line">TXCVideoRender trtc_render render first frame</span><br><span class="line">TXCVideoRender play:vrender: texture available</span><br><span class="line"></span><br><span class="line">TXCTextureViewWrapper vrender: set view size:2061,1080</span><br><span class="line"></span><br><span class="line">TXCVideoRender play:vrender: start render thread</span><br><span class="line"></span><br><span class="line">TXCVideoRenderThread vrender: init egl</span><br><span class="line"></span><br><span class="line">TXCTextureViewWrapper vrender: set view size:2061,1080</span><br><span class="line">TXCTextureViewWrapper vrender: set video size:1280,720</span><br><span class="line"></span><br><span class="line">TXCYuvTextureRender frame type 0 matrix_test videoRange</span><br></pre></td></tr></table></figure>
<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><table>
<thead>
<tr>
<th>线程名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FlvThread</code>  音视频数据接收线程java</td>
<td>网络下载</td>
</tr>
<tr>
<td><code>FlvOriginThread</code> 音视频数据接收线程c</td>
<td>接收java层数据</td>
</tr>
<tr>
<td><code>video_jitter_buffer</code> 视频解码线程</td>
<td>解码和缓冲视频帧</td>
</tr>
<tr>
<td><code>TXCLogUploader</code> 日志上传线程</td>
<td>上传日志</td>
</tr>
</tbody>
</table>
<h1 id="FLV下载"><a href="#FLV下载" class="headerlink" title="FLV下载"></a>FLV下载</h1><img src="/2019/11/25/直播/腾讯直播/SDK逆向/FLVDownloader.png">
<h1 id="FLV解析"><a href="#FLV解析" class="headerlink" title="FLV解析"></a>FLV解析</h1><img src="/2019/11/25/直播/腾讯直播/SDK逆向/FLV解析.jpg">
<h1 id="音频播放"><a href="#音频播放" class="headerlink" title="音频播放"></a>音频播放</h1><p>使用ffmpeg解码aac为pcm</p>
<p>使用audiotrack播放</p>
<h1 id="ITXLivePlayListener-onNetStatus"><a href="#ITXLivePlayListener-onNetStatus" class="headerlink" title="ITXLivePlayListener.onNetStatus"></a>ITXLivePlayListener.onNetStatus</h1><p>网络状态、帧率等的通知，通知的内容（key，value）格式</p>
<p>开始播放回调一次，然后每两秒回调一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.tencent.liteav.g TXLivePlayer的实现类 TXLivePlayerImp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">a</span><span class="params">(String var1, <span class="keyword">int</span> var2)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//开始播放</span></span><br><span class="line">	<span class="keyword">this</span>.u();<span class="comment">//首次调用onNetStatus</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">u</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.L = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.h != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.h.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (g.<span class="keyword">this</span>.L) &#123;</span><br><span class="line">                    g.<span class="keyword">this</span>.w();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">2000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//构建通知的内容（key，value）格式</span></span><br><span class="line">	<span class="comment">//通过onNotifyEvent回调到onNetStatus</span></span><br><span class="line">	com.tencent.liteav.basic.util.b.a(<span class="keyword">this</span>.e, <span class="number">15001</span>, var9);</span><br><span class="line">	<span class="comment">//循环调用自身</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.h != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.L) &#123;</span><br><span class="line">        <span class="keyword">this</span>.h.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (g.<span class="keyword">this</span>.L) &#123;</span><br><span class="line">                    g.<span class="keyword">this</span>.w();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">2000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(WeakReference&lt;a&gt; var0, String var1, <span class="keyword">int</span> var2, Bundle var3)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var0 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        a var4 = (a)var0.get();</span><br><span class="line">        <span class="keyword">if</span> (var4 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var3.putString(<span class="string">"EVT_USERID"</span>, var1);</span><br><span class="line">            var4.onNotifyEvent(var2, var3);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotifyEvent</span><span class="params">(<span class="keyword">int</span> var1, Bundle var2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var1 == <span class="number">15001</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.a.setLogText(var2, (Bundle)<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.e.onNetStatus(var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/23/逆向/IDA使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/23/逆向/IDA使用/" itemprop="url">IDA使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-23T16:40:53+08:00">
                2019-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="32位和64位"><a href="#32位和64位" class="headerlink" title="32位和64位"></a>32位和64位</h1><p>根据逆向的目标文件选择对应版本。</p>
<p>比如：32位的so对应使用32位ida打开；64位的so使用64位的ida打开</p>
<h1 id="主要窗口"><a href="#主要窗口" class="headerlink" title="主要窗口"></a>主要窗口</h1><p>通过 <code>View-Open subviews-窗口名字(Disassembly等)</code> 打开窗口</p>
<p>各窗口支持搜索 <code>ctr + f</code></p>
<h2 id="IDA-View"><a href="#IDA-View" class="headerlink" title="IDA View"></a>IDA View</h2><p>汇编代码窗口</p>
<p>按 空格键 切换代码视图和流程图视图</p>
<h2 id="Functions-window"><a href="#Functions-window" class="headerlink" title="Functions window"></a>Functions window</h2><p>函数窗口</p>
<h2 id="Functions-calls"><a href="#Functions-calls" class="headerlink" title="Functions calls"></a>Functions calls</h2><p>当前函数调用的函数</p>
<h2 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h2><p>字符串</p>
<h2 id="Imports"><a href="#Imports" class="headerlink" title="Imports"></a>Imports</h2><p>导入函数</p>
<h2 id="Exports"><a href="#Exports" class="headerlink" title="Exports"></a>Exports</h2><p>导出函数</p>
<h2 id="Hex-View"><a href="#Hex-View" class="headerlink" title="Hex View"></a>Hex View</h2><p>十六进制编辑器窗口</p>
<h2 id="Structures"><a href="#Structures" class="headerlink" title="Structures"></a>Structures</h2><h2 id="Enumes"><a href="#Enumes" class="headerlink" title="Enumes"></a>Enumes</h2><h2 id="Segmentation"><a href="#Segmentation" class="headerlink" title="Segmentation"></a>Segmentation</h2><h1 id="汇编指令转C"><a href="#汇编指令转C" class="headerlink" title="汇编指令转C"></a>汇编指令转C</h1><p>在 汇编代码 窗口 ，选中 需要转换的函数名，按 F5 即可</p>
<h2 id="F5无效"><a href="#F5无效" class="headerlink" title="F5无效"></a>F5无效</h2><p>无效可能有两个原因：</p>
<ul>
<li>使用的是 ida 版本错误；32位的so对应使用32位ida打开；64位的so使用64位的ida打开</li>
<li>没有 <a href="https://github.com/REhints/HexRaysCodeXplorer" target="_blank" rel="noopener">HexRaysCodeXplorer</a> 插件。</li>
</ul>
<h2 id="无法还原JNI函数名"><a href="#无法还原JNI函数名" class="headerlink" title="无法还原JNI函数名"></a>无法还原JNI函数名</h2><h3 id="手动修改"><a href="#手动修改" class="headerlink" title="手动修改"></a>手动修改</h3><p><code>(*(_DWORD *)v5 + 676))(v5, a5, &amp;v11);</code></p>
<p>一般JNI函数方法名首先是一个指针加上一个数字，比如v5+676。然后将这个地址作为一个方法指针进行方法调用，并且第一个参数就是指针自己。这实际上就是我们在JNI里经常用到的JNIEnv方法。Ida并不会自动的对这些方法进行识别。解决方法非常简单，只需要对JNIEnv指针做一个类型转换即可。</p>
<p>我们可以选中v5变量，然后按一下y键，然后输入： JNIEnv*</p>
<p>类似的地址有：672，676，680，684，688</p>
<h3 id="手动导入jni-h"><a href="#手动导入jni-h" class="headerlink" title="手动导入jni.h"></a>手动导入<code>jni.h</code></h3><ol>
<li>点击 IDAPro 菜单项“File-&gt;Load file-&gt;Parse c header file ” 选择jni.h（<code>ndk/platforms/andoid-21/arch-arm/usr/include/jni.h</code>）</li>
<li>简单修改jni.h ,注释第27行的 <code>#include&lt;stdarg.h&gt;</code> ,将1122行的<code>#define JNIEXPORT_attribute_((visibility(&quot;default&quot;)))</code> 改成 <code>#define JNIEXPORT</code>（文件保存在 IDA tools 目录），修改完后可以成功导入    </li>
<li>导入成功后把jni.h修改的地方  改回来 防止编译NDK出错。</li>
<li>点击IDAPro 主界面上的“Structures”选项卡 然后按下Insert键打开“Create structure/union”对话框，点击界面上的”Add standard structure”按钮，在打开的结构体选择对话框中选择JNINativeInterface并点击OK返回，同理JNIInvokeInterface结构体也导入进来；（如果有报错，逐个按照错误信息修改）</li>
<li>鼠标点击参数(v5)，然后右键选中 Convert to Struct * ，选择 <code>_JNIEnv</code></li>
</ol>
<h3 id="脚本导入jni-h"><a href="#脚本导入jni-h" class="headerlink" title="脚本导入jni.h"></a>脚本导入<code>jni.h</code></h3><p>script file 导入 飞虫提供的 <code>jni.idc</code> 脚本（书籍源码包里面有）来完成 <code>jni.h</code> 的导入</p>
<p>然后执行上面的步骤4和5</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/CocosCreator/CocosCreator调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/21/CocosCreator/CocosCreator调试/" itemprop="url">CocosCreator调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-21T14:00:53+08:00">
                2019-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/游戏/" itemprop="url" rel="index">
                    <span itemprop="name">游戏</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>游戏发布后，由于运行环境不同，可能出现在浏览器浏览时无法重现的bug，特别是原生平台，这时我们就必须直接在相应平台下进行调试。</p>
<p>CocosCreator 从1.7版本开始引入JSB 2.0，可以很方便的对原生平台中的JavaScript进行远程调试</p>
<h1 id="远程调试"><a href="#远程调试" class="headerlink" title="远程调试"></a>远程调试</h1><p>默认远程调试和 Profile 是在 debug 模式中生效的，如果需要在 release 模式下也启用，需要手动修改 <code>cocos/scripting/js-bindings/jswrapper/config.hpp</code> 中的宏开关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#if defined(COCOS2D_DEBUG) &amp;&amp; COCOS2D_DEBUG &gt; 0 // 这里改为 1，强制启用调试</span><br><span class="line">#define SE_ENABLE_INSPECTOR 1</span><br><span class="line">#define SE_DEBUG 2</span><br><span class="line">#else</span><br><span class="line">#define SE_ENABLE_INSPECTOR 0</span><br><span class="line">#define SE_DEBUG 0</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h1 id="模拟器调试和真机调试"><a href="#模拟器调试和真机调试" class="headerlink" title="模拟器调试和真机调试"></a>模拟器调试和真机调试</h1><h2 id="模拟器调试"><a href="#模拟器调试" class="headerlink" title="模拟器调试"></a>模拟器调试</h2><p>一般来说，原生平台的大部分问题都能在模拟器中重现，可以先在模拟器中测试，复现问题的话直接在模拟器中调试即可。</p>
<h3 id="选择模拟器预览运行游戏"><a href="#选择模拟器预览运行游戏" class="headerlink" title="选择模拟器预览运行游戏"></a>选择模拟器预览运行游戏</h3><img src="/2019/11/21/CocosCreator/CocosCreator调试/模拟器.png">
<p>在编辑器工具栏上方，选择<code>模拟器</code>作为预览平台（默认是浏览器），然后点击编辑器的<code>运行预览</code>在模拟器中运行游戏</p>
<h2 id="真机调试"><a href="#真机调试" class="headerlink" title="真机调试"></a>真机调试</h2><p>构建 – 编译 相应平台的工程项目（编译可以选择Cocos Creator或者相应平台IDE），安装运行</p>
<h1 id="Chrome-远程调试-V8"><a href="#Chrome-远程调试-V8" class="headerlink" title="Chrome 远程调试 V8"></a>Chrome 远程调试 V8</h1><h2 id="模拟器"><a href="#模拟器" class="headerlink" title="模拟器"></a>模拟器</h2><p>选择模拟器预览运行游戏</p>
<p>用 Chrome 浏览器打开 <a href="chrome-devtools://devtools/bundled/inspector.html?v8only=true&amp;ws=127.0.0.1:5086/00010002-0003-4004-8005-000600070008" target="_blank" rel="noopener">chrome-devtools://devtools/bundled/inspector.html?v8only=true&amp;ws=127.0.0.1:5086/00010002-0003-4004-8005-000600070008</a></p>
<h2 id="安卓真机"><a href="#安卓真机" class="headerlink" title="安卓真机"></a>安卓真机</h2><p>编译，运行游戏</p>
<p>保证 Android 设备与 PC 或者 Mac 在同一个局域网中</p>
<p>用 Chrome 浏览器打开 <a href="chrome-devtools://devtools/bundled/inspector.html?v8only=true&amp;ws=xxx.xxx.xxx.xxx: 6086/00010002-0003-4004-8005-000600070008" target="_blank" rel="noopener">chrome-devtools://devtools/bundled/inspector.html?v8only=true&amp;ws=xxx.xxx.xxx.xxx: 6086/00010002-0003-4004-8005-000600070008</a>, 其中 xxx.xxx.xxx.xxx 为局域网中 Android 设备的 IP 地址。（从 v2.0.7 开始，端口由5086 改为 6086）</p>
<h1 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h1><h2 id="启动即等待调试器连接"><a href="#启动即等待调试器连接" class="headerlink" title="启动即等待调试器连接"></a>启动即等待调试器连接</h2><p>有时候我们需要调试游戏的初始化逻辑，是需要游戏启动后等待调试器连接，然后继续执行</p>
<p>只需要在打开调试开关时 <code>jsb_enable_debugger</code> 第三个参数 <code>isWaitForConnect</code> 设置为true</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AppDelegate.cpp</span></span><br><span class="line"><span class="keyword">bool</span> AppDelegate::applicationDidFinishLaunching()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Enable debugger here</span></span><br><span class="line">    jsb_enable_debugger(<span class="string">"0.0.0.0"</span>, <span class="number">6086</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">jsb_enable_debugger</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; debuggerServerAddr, <span class="keyword">uint32_t</span> port, <span class="keyword">bool</span> isWaitForConnect)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="快速修改调试js"><a href="#快速修改调试js" class="headerlink" title="快速修改调试js"></a>快速修改调试js</h2><p>正常的IDE调试流程：修改js逻辑，构建，拷贝构建生成的资源到工程项目，编译，运行，调试。</p>
<p>即使只是修改一行代码，上面的流程下来也要两分钟，严重降低生产效率</p>
<p>其实我们可以直接修改构建后的js文件。即直接修改生成的工程项目 <code>assets\src</code>  目录下的相关js文件，然后运行项目即可调试，非常的方便。</p>
<p>这个方法仅限未加密js的情况下（一般只有构建release的时候我们才会选择加密js选项）</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://docs.cocos2d-x.org/creator/manual/zh/advanced-topics/jsb/JSB2.0-learning.html#chrome-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95-v8" target="_blank" rel="noopener">Chrome 远程调试 V8</a></li>
<li><a href="https://docs.cocos2d-x.org/creator/manual/zh/advanced-topics/jsb/JSB2.0-learning.html#%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E4%B8%8E-profile" target="_blank" rel="noopener">远程调试与 Profile</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/19/Android/插件化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/19/Android/插件化/" itemprop="url">插件化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-19T17:53:53+08:00">
                2019-11-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Activity的插件化"><a href="#Activity的插件化" class="headerlink" title="Activity的插件化"></a>Activity的插件化</h1><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p>Activity的插件化解决的一个根本性问题就是插件中的Activity并没有在宿主的AndroidManifest.xml中进行注册，也就是说我们需要启动一个<strong>未注册Activity</strong> ，因此需要对Activity的启动过程有个了解。</p>
<p>启动Activity时会请求ActivityManagerService创建Activity，AMS所属的进程与宿主（发起者）不属于同一个进程，AMS位于SystemServer进程中，应用程序进程与AMS之间的通信是通过Binder来实现</p>
<p>AMS要管理所有APP的启动请求，因此我们不能在SystemServer进程中进行相应的Hook，那么我们只能在应用进程中进行相应的Hook</p>
<p>启动一个Activity，AMS会去检查AndroidManifest中是否注册了该Activity，如果未注册会报错。</p>
<p>为了让AMS验证通过，需要启动一个预先在AndroidManifest中注册的Activity（占坑Activity），在启动插件Activity时替换为占坑Activity，达到一个欺上瞒下的作用，当AMS验证通过之后，需要将启动的占坑Activity替换为插件Activity。</p>
<img src="/2019/11/19/Android/插件化/Activity插件化-1.jpg">
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Activity的插件化需要做两件事：</p>
<ul>
<li>将请求启动的插件Activity替换为占坑Activity。</li>
<li>通过AMS验证后，将占坑Activity替换为插件Activity。</li>
</ul>
<p>什么时候将插件Activity替换为占坑Activity？又是什么时候还原插件Activity？这需要我们对Activity的启动流程有个相应的认识。</p>
<h2 id="Activity启动流程"><a href="#Activity启动流程" class="headerlink" title="Activity启动流程"></a>Activity启动流程</h2><h3 id="startActivity"><a href="#startActivity" class="headerlink" title="startActivity"></a>startActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">       startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="startActivityForResult"><a href="#startActivityForResult" class="headerlink" title="startActivityForResult"></a>startActivityForResult</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//Activity启动</span></span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">        windows.</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startActivityForResult方法中通过调用mInstrumentation的execStartActivity方法来启动Activity，这个mInstrumentation是Activity的成员变量，在ActivityThread的performLaunchActivity方法中通过Activity的attach方法传入，同时Activity的创建也是在performLaunchActivity方法中创建的，通过mInstrumentation.newActivity。</p>
<h2 id="方案一：Hook-Instrumentation"><a href="#方案一：Hook-Instrumentation" class="headerlink" title="方案一：Hook Instrumentation"></a>方案一：Hook Instrumentation</h2><p>Instrumentation提供了execStartActivity方法来启动Activity，newActivity方法来创建Activity。</p>
<p>因此，第一种方案就是：将ActivityThread中的成员变量Instrumentation替换成自定义的代理Instrumentation。在代理Instrumentation的execStartActivity方法中替换为占坑Activity，在newActivity方法还原插件Activity</p>
<p>StubActivity 占坑Activity，在AndroidManifest.xml中注册</p>
<p>TargetActivity 插件Activity，未在AndroidManifest.xml中注册</p>
<p>Instrumentation代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentationProxy</span> <span class="keyword">extends</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Instrumentation mInstrumentation;</span><br><span class="line">    <span class="keyword">private</span> PackageManager mPackageManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentationProxy</span><span class="params">(Instrumentation instrumentation, PackageManager packageManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mInstrumentation = instrumentation;</span><br><span class="line">        <span class="keyword">this</span>.mPackageManager = packageManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;ResolveInfo&gt; resolveInfo = mPackageManager.queryIntentActivities(intent, PackageManager.MATCH_ALL);</span><br><span class="line">        <span class="comment">//判断启动的插件Activity是否在AndroidManifest.xml中注册过</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == resolveInfo || resolveInfo.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//保存目标插件</span></span><br><span class="line">            intent.putExtra(HookHelper.REQUEST_TARGET_INTENT_NAME, intent.getComponent().getClassName());</span><br><span class="line">            <span class="comment">//设置为占坑Activity</span></span><br><span class="line">            intent.setClassName(who, <span class="string">"com.glh.haiproject01.StubActivity"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method execStartActivity = Instrumentation.class.getDeclaredMethod(<span class="string">"execStartActivity"</span>,</span><br><span class="line">                    Context.class, IBinder.class, IBinder.class, Activity.class,</span><br><span class="line">                    Intent.class, <span class="keyword">int</span>.class, Bundle.class);</span><br><span class="line">            <span class="keyword">return</span> (ActivityResult) execStartActivity.invoke(mInstrumentation, who, contextThread, token, target, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className, Intent intent)</span> <span class="keyword">throws</span> InstantiationException,</span></span><br><span class="line"><span class="function">            IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">        String intentName=intent.getStringExtra(HookHelper.REQUEST_TARGET_INTENT_NAME);</span><br><span class="line">        <span class="keyword">if</span>(!TextUtils.isEmpty(intentName))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.newActivity(cl,intentName,intent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newActivity(cl,className,intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理类InstrumentationProxy的execStartActivity方法先判断插件Activity是否在AndroidManifest.xml中注册过，如果没有注册过就需要替换占坑的Activity，在newActivity方法中还原插件Activity。<br>代理类InstrumentationProxy写完后，需要对ActivityThread的成员变量mInstrumentation进行替换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        hookActivityThreadInstrumentation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hookActivityThreadInstrumentation</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; activityThreadClass=Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">            Field activityThreadField=activityThreadClass.getDeclaredField(<span class="string">"sCurrentActivityThread"</span>);</span><br><span class="line">            activityThreadField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//获取ActivityThread对象sCurrentActivityThread</span></span><br><span class="line">            Object activityThread=activityThreadField.get(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            Field instrumentationField=activityThreadClass.getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">            instrumentationField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//从sCurrentActivityThread中获取成员变量mInstrumentation</span></span><br><span class="line">            Instrumentation instrumentation= (Instrumentation) instrumentationField.get(activityThread);</span><br><span class="line">            <span class="comment">//创建代理对象InstrumentationProxy</span></span><br><span class="line">            InstrumentationProxy proxy=<span class="keyword">new</span> InstrumentationProxy(instrumentation,getPackageManager());</span><br><span class="line">            <span class="comment">//将sCurrentActivityThread中成员变量mInstrumentation替换成代理类InstrumentationProxy</span></span><br><span class="line">            instrumentationField.set(activityThread,proxy);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方案二：Hook-IActivityManager"><a href="#方案二：Hook-IActivityManager" class="headerlink" title="方案二：Hook IActivityManager"></a>方案二：Hook IActivityManager</h2><p>Instrumentation提供了execStartActivity方法来启动Activity，newActivity方法来创建Activity。</p>
<p>execStartActivity方法其实调用的是AMS的代理类的startActivity方法。获取IActivityManager对象的方法在各版本有差异，但都是通过单例模式获取。</p>
<p>因此，第二种方案就是：将Singleton</p>
<h3 id="Android-7-0"><a href="#Android-7-0" class="headerlink" title="Android 7.0"></a>Android 7.0</h3><p>通过 <code>ActivityManagerNative.getDefault</code> 方法获取一个IActivityManager（查看asInterface知道其实获得的是接口的实现类ActivityManagerProxy，即AMS代理类），然后调用其startActivity </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityManagerNative.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">        ...</span><br><span class="line">        IActivityManager am = asInterface(b);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查本地进程是否有IActivityManager接口的实现</span></span><br><span class="line">    IActivityManager in =</span><br><span class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本地进程没有IActivityManager接口的实现，将IBinder类型的AMS引用封装成AMP</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Android-8-0"><a href="#Android-8-0" class="headerlink" title="Android 8.0"></a>Android 8.0</h3><p>通过 <code>ActivityManager.getService</code>方法获取一个IActivityManager（去除了ActivityManagerProxy这个代理类），然后调用其startActivity </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = ActivityManager.getService()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> am;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>通过Android 7.0和Android 8.0的Activity启动流程可以得出Activity插件化的另一种方案：Hook IActivityManager，通过动态代理实现。</p>
<p>方案：动态代理IActivityManager，在调用startActivity前修改Intent为占坑Activity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义 IActivityManager 代理类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object mActivityManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IActivityManagerProxy</span><span class="params">(Object activityManager)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mActivityManager=activityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"startActivity"</span>.equals(method.getName()))&#123;</span><br><span class="line">            <span class="comment">//拦截startActivity</span></span><br><span class="line">            Intent intent=<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>,length=args.length;i&lt;length;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(args[i] <span class="keyword">instanceof</span> Intent)&#123;</span><br><span class="line">                    index=i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取插件Activity的Intent</span></span><br><span class="line">            intent= (Intent) args[index];</span><br><span class="line">            <span class="comment">//创建占坑Activity的Intent</span></span><br><span class="line">            Intent stubIntent=<span class="keyword">new</span> Intent();</span><br><span class="line">            subIntent.setClassName(<span class="string">"com.glh.haiproject01"</span>,<span class="string">"com.glh.haiproject01.StubActivity"</span>);</span><br><span class="line">            <span class="comment">//保存插件Activity的Intent</span></span><br><span class="line">            stubIntent.putExtra(HookHelper.REQUEST_TARGET_INTENT_NAME,intent);</span><br><span class="line">            <span class="comment">//替换为占坑Activity</span></span><br><span class="line">            args[index]=stubIntent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mActivityManager,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反射替换defaultSingleton中IActivityManager类型的mInstance成员变量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hookIActivityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Object defaultSingleton;</span><br><span class="line">    <span class="keyword">if</span>(Build.VERSION.SDK_INT==<span class="number">26</span>)&#123;</span><br><span class="line">        <span class="comment">//Android 8.0</span></span><br><span class="line">        defaultSingleton=getIActivityManagerSingleton();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        defaultSingleton=getDefault();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; singletonClazz=Class.forName(<span class="string">"android.util.Singleton"</span>);</span><br><span class="line">        Field instanceField=singletonClazz.getDeclaredField(<span class="string">"mInstance"</span>);</span><br><span class="line">        instanceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//获取defaultSingleton中IActivityManager类型的mInstance成员变量</span></span><br><span class="line">        Object iActivityManager=instanceField.get(defaultSingleton);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; iActivityManagerClazz=Class.forName(<span class="string">"android.app.IActivityManager"</span>);</span><br><span class="line">        Object proxy=Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class&lt;?&gt;[]&#123;iActivityManagerClazz&#125;,<span class="keyword">new</span> IActivityManagerProxy(iActivityManager));</span><br><span class="line">        <span class="comment">//替换为代理类IActivityManagerProxy</span></span><br><span class="line">        instanceField.set(defaultSingleton,proxy);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getIActivityManagerSingleton</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; activityManagerClazz=Class.forName(<span class="string">"android.app.ActivityManager"</span>);</span><br><span class="line">        Field field=activityManagerClazz.getDeclaredField(<span class="string">"IActivityManagerSingleton"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDefault</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; activityManagerClazz=Class.forName(<span class="string">"android.app.ActivityManagerNative"</span>);</span><br><span class="line">        Field field=activityManagerClazz.getDeclaredField(<span class="string">"gDefault"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://juejin.im/post/5c5100c1e51d4550f31755b6" target="_blank" rel="noopener">Activity插件化原理第一种方案：Hook Instrumentation</a></li>
<li><a href="https://juejin.im/post/5c55440c518825246b101606#heading-0" target="_blank" rel="noopener">Activity插件化原理第二种方案：Hook IActivityManager</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/14/Android/性能优化/低端机方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/14/Android/性能优化/低端机方案/" itemprop="url">低端机方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-14T16:38:53+08:00">
                2019-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景-amp-目的"><a href="#背景-amp-目的" class="headerlink" title="背景&amp;目的"></a>背景&amp;目的</h1><p>APP用户中存在大量低端设备，为了这部分用户获得稳定和良好的体验，有必要对低端设备做相应的技术专项研究</p>
<h1 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h1><p>针对低端机做性能适配，例如：关闭/调整动画效果，调整聊天消息刷新频率，屏蔽部分功能</p>
<h1 id="如何界定低端机"><a href="#如何界定低端机" class="headerlink" title="如何界定低端机"></a>如何界定低端机</h1><h2 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h2><p>区分的标准最直观的就是跑分数据。</p>
<p>现在最主流的跑分软件数据主要由4部分构成：</p>
<ul>
<li>CPU：型号、核心数、最大主频</li>
<li>GPU</li>
<li>内存（RAM）</li>
<li>IO（数据库、SD读写）</li>
</ul>
<p>其中内存、CPU、GPU性能构成主要占比，IO性能次要。内存和CPU是所有功能的根本，而GPU则是对游戏类应用影响更大些，因此在非游戏类的普通应用，更注重内存和CPU。</p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>核心数和最大主频：在同系列的CPU间这样判断是相对可靠的，但在不同系列之间单纯以此为依据就不可靠了。由于还涉及兼容性以及其他技术因素影响，不同系列的CPU之间就算以上两个参数相近的情况下，表现出来的性能也可能差别很大。</p>
<p>型号：截止2019年市面上大多安卓机型上的CPU可以分为这几个系列：高通骁龙、华为海思麒麟、联发科MTK、三星猎户座（主要面对欧美市场，可暂时忽略）。联发科MTK主打中低端市场，高端处理器对标高通、麒麟、三星有明显差距，因此重点关注的是高通骁龙和海思麒麟这两个系列。</p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p>内存的对比就很直观了，大内存优于小内存。市场上大部分的主流手机来分析，内存大致分为2G以下、3G、4G、6G以及8G这几个档位</p>
<h3 id="主流机型"><a href="#主流机型" class="headerlink" title="主流机型"></a>主流机型</h3><p><a href="https://www.antutu.com/doc/117550.htm" target="_blank" rel="noopener">安兔兔发布：2019年Q1手机用户偏好榜</a></p>
<p><a href="https://www.getui.com/reports/2019051452" target="_blank" rel="noopener">个推大数据：2019年Q1安卓智能手机报告</a></p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>同时满足以下两个条件，为低端机型：</p>
<p>CPU：骁龙或联发科系列，CPU最大主频小于等于1.8GHz。麒麟系列，CPU最大主频小于等于2.1GHz</p>
<p>内存：RAM小于等于4GB</p>
<p>注意：我们APP需要支持RAM大于等于2GB的设备，流畅使用核心功能</p>
<h1 id="体验的性能指标"><a href="#体验的性能指标" class="headerlink" title="体验的性能指标"></a>体验的性能指标</h1><p>不同类型APP的性能指标的维度和优先级各不相同视，视频直播类APP性能维度优先级排序为：流畅度（FPS）、crash、内存、流量、响应时长、功耗、CPU。</p>
<p>FPS：页面FPS 60，视频FPS 20</p>
<p>Crash：0.1%</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.csdn.net/hualusiyu/article/details/78460809" target="_blank" rel="noopener">APP性能测试的6项关键指标及测试获取手段</a></li>
<li><a href="https://www.jianshu.com/p/76d68d13c475" target="_blank" rel="noopener">如何用代码区分Android高低端机型</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">318</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
