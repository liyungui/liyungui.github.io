<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/8/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/NDK/Native崩溃捕获/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/05/NDK/Native崩溃捕获/" itemprop="url">Native崩溃捕获</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-05T11:39:14+08:00">
                2019-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="现有的方案"><a href="#现有的方案" class="headerlink" title="现有的方案"></a>现有的方案</h1><img src="/2019/09/05/NDK/Native崩溃捕获/现有方案.png">
<p>其实3个方案在Android平台的实现原理都是基本一致的，综合考虑，可以基于coffeecatch改进。</p>
<h1 id="信号机制"><a href="#信号机制" class="headerlink" title="信号机制"></a>信号机制</h1><p>在Unix-like系统中，异常发生时，CPU通过异常中断的方式，触发异常处理流程。不同的处理器，有不同的异常中断类型和中断处理方式。</p>
<p>linux把这些中断处理，统一为信号量，可以注册信号量向量进行处理。</p>
<p>信号机制是进程之间相互传递消息的一种方法，信号全称为软中断信号。</p>
<p>信号机制是进程之间相互传递消息的一种方法，信号全称为软中断信号。</p>
<img src="/2019/09/05/NDK/Native崩溃捕获/用户态内核态切换.png">
<h2 id="接收信号"><a href="#接收信号" class="headerlink" title="接收信号"></a>接收信号</h2><p>接收信号的任务是由内核代理的，当内核接收到信号后，会将其放到对应进程的信号队列中，同时向进程发送一个中断，使其陷入内核态。</p>
<p>注意，此时信号还只是在队列中，对进程来说暂时是不知道有信号到来的。</p>
<h2 id="检测信号"><a href="#检测信号" class="headerlink" title="检测信号"></a>检测信号</h2><p>进程陷入内核态后，有两种场景会对信号进行检测：</p>
<ul>
<li><p>进程从内核态返回到用户态前进行信号检测</p>
</li>
<li><p>进程在内核态中，从睡眠状态被唤醒的时候进行信号检测</p>
</li>
</ul>
<p>当发现有新信号时，便会进入下一步，处理信号。</p>
<h2 id="处理信号"><a href="#处理信号" class="headerlink" title="处理信号"></a>处理信号</h2><p>信号处理函数是运行在用户态的</p>
<p>调用处理函数前，内核会将当前内核栈的内容备份拷贝到用户栈上，并且修改指令寄存器（eip）将其指向信号处理函数。</p>
<p>接下来进程返回到用户态中，执行相应的信号处理函数。</p>
<p>信号处理函数执行完成后，还需要返回内核态，检查是否还有其它信号未处理。</p>
<p>如果所有信号都处理完成，就会将内核栈恢复（从用户栈的备份拷贝回来），同时恢复指令寄存器（eip）将其指向中断前的运行位置，最后回到用户态继续执行进程。</p>
<h1 id="信号量定义"><a href="#信号量定义" class="headerlink" title="信号量定义"></a>信号量定义</h1><p><code>kill -l</code> 可以查看所有的信号量</p>
<p><code>signal.h</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SIGHUP 1   挂起</span><br><span class="line">SIGINT 2   中断，比如命令行用户输入Ctrl+C时由终端驱动程序发送INT信号</span><br><span class="line">SIGQUIT 3  退出，默认处理是内存转储</span><br><span class="line">SIGILL 4   非法指令，损坏的可执行文件或代码区损坏</span><br><span class="line">SIGTRAP 5</span><br><span class="line">SIGABRT 6</span><br><span class="line">SIGIOT 6</span><br><span class="line">SIGBUS 7  总线错误，硬件或系统错误，如不存在的物理地址</span><br><span class="line">SIGFPE 8  浮点运算错误，如除0，余0，整形溢出</span><br><span class="line">SIGKILL 9 杀死进程</span><br><span class="line">SIGUSR1 10</span><br><span class="line">SIGSEGV 11 段错误，空指针，野指针，数组越界，栈溢出，访问不存在的地址，访问内核区，写只读空间</span><br><span class="line">SIGUSR2 12</span><br><span class="line">SIGPIPE 13 管道错误，如</span><br><span class="line">SIGALRM 14</span><br><span class="line">SIGTERM 15 终止，默认处理没有内存转储</span><br><span class="line">SIGSTKFLT 16</span><br><span class="line">SIGCHLD 17</span><br><span class="line">SIGCONT 18 继续执行，取消挂起</span><br><span class="line">SIGSTOP 19 挂起/暂停，直到收到CONT</span><br><span class="line">SIGTSTP 20 STOP信号的“软”版本，用户输入Ctrl+Z时由终端驱动程序发送的信号</span><br><span class="line">SIGTTIN 21</span><br></pre></td></tr></table></figure>
<p>程序崩溃99%都是BUS与SEGV这两个错误导<br>致的。内核对二者的默认处理是内存转储(memory dump)。进程可以捕获和封锁这两类错误。</p>
<h2 id="常见信号量"><a href="#常见信号量" class="headerlink" title="常见信号量"></a>常见信号量</h2><img src="/2019/09/05/NDK/Native崩溃捕获/常见信号量.png">
<h1 id="捕捉"><a href="#捕捉" class="headerlink" title="捕捉"></a>捕捉</h1><h2 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">legacy_signal_inlines.h</span><br><span class="line">sighandler_t signal(int s, sighandler_t f)</span><br><span class="line"></span><br><span class="line">系统也定义了一些宏 </span><br><span class="line">SIG_IGN 忽略信号</span><br><span class="line">SIG_DFL 使用默认的信号处理函数</span><br><span class="line"></span><br><span class="line">1. 进入信号处理函数之后 这个信号会被 阻塞（block）</span><br><span class="line">   直到信号处理函数 返回。</span><br><span class="line">2. 信号函数处理完之后，会将该信号处理函数恢复为默认处理函数，所以在下一次用到的时候要重新调用signal这个函数绑定</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, <span class="meta-string">"lyg"</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recvSignal</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOGD(<span class="string">"received signal %d !!!\n"</span>,sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_example_jni_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    signal(SIGTRAP,recvSignal);</span><br><span class="line">    <span class="keyword">char</span> *p = <span class="string">"123"</span>;</span><br><span class="line">    <span class="keyword">char</span> *p2;</span><br><span class="line">    <span class="built_in">strcpy</span>(p2,p);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br><span class="line">2019-12-26 16:56:18.392 29534-29534/? D/lyg: received signal 5 !!!</span><br></pre></td></tr></table></figure>
<p>错误发生后 ，系统 发送 SIGSEGV ，然后 中断了程序 跳到 recvSignal 处理函数中去 ，处理完成后 ，再跳回来错误发生的地方 ，然后继续产生错误 ，继续发送 SIGSEGV  信号</p>
<h2 id="sigaction"><a href="#sigaction" class="headerlink" title="sigaction"></a>sigaction</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct sigaction &#123;</span><br><span class="line">    void     (*sa_handler)(int);</span><br><span class="line">    void     (*sa_sigaction)(int, siginfo_t *, void *);</span><br><span class="line">    sigset_t   sa_mask;</span><br><span class="line">    int        sa_flags;</span><br><span class="line">    void     (*sa_restorer)(void);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sa_handler 信号处理函数，该函数只有一个参数</span><br><span class="line">sa_sigaction 信号处理函数，sa_flags中存在SA_SIGINFO标志时使用这个函数处理信号量</span><br><span class="line">sa_mask： 信号处理函数执行的过程中应被阻塞的信号</span><br><span class="line">sa_flags：信号处理过程行为的标志，由0个或多个标志通过or运算组合而成，比如SA_RESETHAND，SA_ONSTACK | SA_SIGINFO</span><br><span class="line">sa_restorer： 已废弃</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int sigaction(int signum,const struct sigaction *act,struct sigaction *oldact));</span><br><span class="line"></span><br><span class="line">signum：代表信号编码</span><br><span class="line">	除SIGKILL及SIGSTOP外的任何一个特定有效的信号</span><br><span class="line">	如果为这两个信号定义自己的处理函数，将导致信号安装错误。</span><br><span class="line"></span><br><span class="line">act：指向结构体sigaction的一个实例的指针</span><br><span class="line">	该实例指定了对特定信号的处理</span><br><span class="line">	如果设置为空，进程会执行默认处理。</span><br><span class="line"></span><br><span class="line">oldact：和参数act类似，只不过保存的是原来对相应信号的处理</span><br><span class="line">	也可设置为NULL。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line"></span><br><span class="line">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, &quot;lyg&quot;, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line">static void SignalHandler(int signo, siginfo_t *info, void *context) &#123;</span><br><span class="line">    LOGD(&quot;received signal %d !!!\n&quot;, signo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_example_jni_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject /* this */) &#123;</span><br><span class="line">    struct sigaction sa_old;</span><br><span class="line">    struct sigaction sa;</span><br><span class="line">    memset(&amp;sa, 0, sizeof(sa));</span><br><span class="line">    sigemptyset(&amp;sa.sa_mask);</span><br><span class="line">    sa.sa_sigaction = SignalHandler;</span><br><span class="line">    sa.sa_flags = SA_SIGINFO;</span><br><span class="line">    sigaction(SIGTRAP, &amp;sa, &amp;sa_old);</span><br><span class="line"></span><br><span class="line">    char *p = &quot;123&quot;;</span><br><span class="line">    char *p2;</span><br><span class="line">    strcpy(p2, p);</span><br><span class="line">    return env-&gt;NewStringUTF(p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题：跟signal一样，会重复打印捕获到的信号量，然后ANR；</p>
<p>自定义信号处理函数，处理完之后，调用原来注册的处理函数，处理完退出应用</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://mp.weixin.qq.com/s/g-WzYF3wWAljok1XjPoo7w?" target="_blank" rel="noopener">Android 平台 Native 代码的崩溃捕获机制及实现</a> 腾讯Bugly分享</li>
<li><a href="https://blog.csdn.net/ysdaniel/article/details/6819142" target="_blank" rel="noopener">linux的常用信号量和进程的四种状态</a></li>
<li><a href="https://blog.csdn.net/work_msh/article/details/8470277" target="_blank" rel="noopener">linux SIGSEGV 信号捕捉，保证发生段错误后程序不崩溃</a></li>
<li><a href="https://jekton.github.io/2019/04/06/native-crash-catching/" target="_blank" rel="noopener">Android native 崩溃信息捕获实践</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/NDK/使用JNI_OnLoad动态注册Native函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/05/NDK/使用JNI_OnLoad动态注册Native函数/" itemprop="url">使用JNI_OnLoad动态注册Native函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-05T11:39:14+08:00">
                2019-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="JNI-OnLoad"><a href="#JNI-OnLoad" class="headerlink" title="JNI_OnLoad"></a>JNI_OnLoad</h1><p>加载so,虚拟机先自动执行JNI_OnLoad；</p>
<p>卸载so,虚拟机先自动执行JNI_UnLoad；</p>
<h1 id="传统java-Jni方式"><a href="#传统java-Jni方式" class="headerlink" title="传统java Jni方式"></a>传统java Jni方式</h1><ol>
<li>编写带有native方法的Java类</li>
<li>使用javah命令生成.h头文件</li>
<li>编写代码实现头文件中的方法</li>
</ol>
<h1 id="RegisterNatives"><a href="#RegisterNatives" class="headerlink" title="RegisterNatives"></a>RegisterNatives</h1><p>使用RegisterNatives方法把c/c++中的方法映射到Java中的native方法</p>
<h1 id="使用RegisterNatives步骤"><a href="#使用RegisterNatives步骤" class="headerlink" title="使用RegisterNatives步骤"></a>使用RegisterNatives步骤</h1><ul>
<li><p>在c/c++文件中定义并实现对应java中声明的本地方法，方法名称随意，但是参数类型和参数个数必须一样</p>
</li>
<li><p>创建声明JNINativeMethod类型的数组，值为需要动态加载映射的本地方法</p>
</li>
<li><p>实现JNI_OnLoad方法，主要分为下面两步：</p>
<ul>
<li>通过FindClass获取所需的映射的java类</li>
<li>通过jint RegisterNatives(jclass clazz, const JNINativeMethod* methods, jint nMethods) 方法动态注册</li>
</ul>
</li>
</ul>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniOnloadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span>  <span class="title">javaAdd</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">javaSayHi</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"test-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>jniload.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOG_TAG    <span class="meta-string">"liuhang"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOGI(...)  __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint JNICALL <span class="title">cAdd</span><span class="params">(JNIEnv *env, jobject jobj, jint x, jint y)</span></span>&#123;</span><br><span class="line">    LOGI(<span class="string">"cAdd x is :%d  y is :%d"</span>, x, y);</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jstring JNICALL <span class="title">cSayHi</span><span class="params">(JNIEnv *env, jobject jobj, jint x, jint y)</span></span>&#123;</span><br><span class="line">    LOGI(<span class="string">"cSayHi runs... will return a string in c"</span>);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"hello from cSayHi"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   第一个参数：javaAdd 是java中的方法名称</span></span><br><span class="line"><span class="comment">   第二个参数：(II)I  是java中方法的签名，可以通过javap -s -p 类名.class 查看</span></span><br><span class="line"><span class="comment">   第三个参数： (jstring *)cSayHi  （返回值类型）映射到native的方法名称</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">        &#123;<span class="string">"javaAdd"</span>, <span class="string">"(II)I"</span>, (jint *)cAdd&#125;,</span><br><span class="line">        &#123;<span class="string">"javaSayHi"</span>,<span class="string">"()Ljava/lang/String;"</span>,(jstring *)cSayHi&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jclass myClass;</span><br><span class="line"><span class="comment">// 这里是java调用C的存在Native方法的类路径</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> className=<span class="string">"com/jni/test/JniOnloadTest"</span>;</span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    LOGI(<span class="string">"jni onload called"</span>);</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>; <span class="comment">//注册时在JNIEnv中实现的，所以必须首先获取它</span></span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;GetEnv((<span class="keyword">void</span> **) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123; <span class="comment">//从JavaVM获取JNIEnv，一般使用1.4的版本</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取映射的java类</span></span><br><span class="line">    myClass = env-&gt;FindClass(className);</span><br><span class="line">    <span class="keyword">if</span>(myClass == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"cannot get class:%s\n"</span>, className);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过RegisterNatives方法动态注册</span></span><br><span class="line">    <span class="keyword">if</span>(env-&gt;RegisterNatives(myClass, gMethods, <span class="keyword">sizeof</span>(gMethods)/<span class="keyword">sizeof</span>(gMethods[<span class="number">0</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"register native method failed!\n"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LOGI(<span class="string">"jni onload called end..."</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4; <span class="comment">//这里很重要，必须返回版本，否则加载会失败。</span></span><br><span class="line">&#125;    </span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line">java端调用</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">JniOnloadTest jniOnloadTest = <span class="keyword">new</span> JniOnloadTest();</span><br><span class="line">Log.d(<span class="string">"liuhang"</span>, <span class="string">"jnionload add result is :"</span>+jniOnloadTest.javaAdd(<span class="number">1</span>, <span class="number">2</span>)+<span class="string">" sayhi is :"</span>+jniOnloadTest.javaSayHi());</span><br></pre></td></tr></table></figure>
<img src="/2019/09/05/NDK/使用JNI_OnLoad动态注册Native函数/结果.png">
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/f4b4b9006742" target="_blank" rel="noopener">使用JNI_OnLoad动态注册函数</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/直播疑难杂症/直播疑难杂症八-播放杂音、噪音、回声/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/直播疑难杂症/直播疑难杂症八-播放杂音、噪音、回声/" itemprop="url">直播疑难杂症八-播放杂音、噪音、回声</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T15:10:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>相比于视频而言，音频要敏感得多，视频画面有噪点、马赛克都还是可以勉强被接受，而声音一旦有任何瑕疵，人耳都会特别容易感觉到，而且难以忍受。</p>
<h1 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h1><ul>
<li><p>电流音，爆音，滋滋声或者嘟嘟声</p>
</li>
<li><p>声音断断续续，听不清楚</p>
</li>
<li><p>回声，同一个声音能听到两遍</p>
</li>
</ul>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><h2 id="参数配置问题"><a href="#参数配置问题" class="headerlink" title="参数配置问题"></a>参数配置问题</h2><p>音频是一个特别敏感的东西，涉及到许多参数配置，一旦配置不太匹配，就会导致声音听起来非常诡异（比如：采样率是 32000Hz 的音频，给播放器配置为 8000Hz 或者 44100Hz，就明显会出现音频慢放或者快放的效果）。</p>
<p>我们只需要注意的是，无论是采集和播放，都要给系统的 API 以及第三方的库配置正确的参数，如：采样率、位宽、声道数等等。</p>
<h2 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h2><h3 id="音频-buffer-大小不匹配"><a href="#音频-buffer-大小不匹配" class="headerlink" title="音频 buffer 大小不匹配"></a>音频 buffer 大小不匹配</h3><p>一段 1024 bytes 的音频，放到了 2048 bytes 的数组，导致尾部有随机数</p>
<h3 id="重采样的算法问题"><a href="#重采样的算法问题" class="headerlink" title="重采样的算法问题"></a>重采样的算法问题</h3><p>音频 resample 重采样的算法问题，导致采样出来的数据出了问题</p>
<h3 id="Android-的-ByteBuffer-取出数组"><a href="#Android-的-ByteBuffer-取出数组" class="headerlink" title="Android 的 ByteBuffer 取出数组"></a>Android 的 ByteBuffer 取出数组</h3><p>不能直接用 .array() 方法的，而需要用 .get() 方法</p>
<h3 id="iOS-的-AudioSession采样率被更改"><a href="#iOS-的-AudioSession采样率被更改" class="headerlink" title="iOS 的 AudioSession采样率被更改"></a>iOS 的 AudioSession采样率被更改</h3><p>iOS 系统，其他 app 通过系统 API 更改了 AudioSession 采样率的配置</p>
<h3 id="混音越界"><a href="#混音越界" class="headerlink" title="混音越界"></a>混音越界</h3><p>音频的 PCM 数据，通常用 short 数组来存放，当我们做一些多路音频的混音功能的时候，如果不注意处理 short 类型的大小越界，则往往带来爆音的问题。下面是一段参考 webrtc 的混音代码，专门针对混音越界做了简单处理，可以参考参考：</p>
<img src="/2019/09/03/直播/直播疑难杂症/直播疑难杂症八-播放杂音、噪音、回声/webrtc混音防越界代码.png">
<h2 id="网络宽带不足"><a href="#网络宽带不足" class="headerlink" title="网络宽带不足"></a>网络宽带不足</h2><p>视频是一帧一帧连续的图像构成的，在播放过程中，如果无法按时渲染，则会出现卡顿的效果；如果丢失几帧画面，则会出现快进效果。</p>
<p>而音频是流式的，虽然也被切分为了一个个音频帧，但如果无法按时播放或者连续丢失较多的音频帧，则会明显听到断断续续的声音出现。特别是在弱网、丢包率高等不稳定网络环境下，很容易出现这种情况。</p>
<p>表现为 帧缓冲区为空</p>
<p>复现的网速阈值：差不多是最低网速需求的40%-50%；</p>
<p>比如，当前直播的最低网速要求是112 kBps；将手机网络模拟为 500 kbps；</p>
<h2 id="设备性能不足"><a href="#设备性能不足" class="headerlink" title="设备性能不足"></a>设备性能不足</h2><p>设备性能不足的情况下，容易出现虽然帧缓冲区数据充足，但是解码不及时，导致无法播放，也会听到断断续续的声音出现</p>
<p>表现为 显示缓冲区为空</p>
<p>复现的CPU阈值：CPU使用率80%</p>
<h2 id="解码失败"><a href="#解码失败" class="headerlink" title="解码失败"></a>解码失败</h2><h2 id="音频丢帧"><a href="#音频丢帧" class="headerlink" title="音频丢帧"></a>音频丢帧</h2><h2 id="回声"><a href="#回声" class="headerlink" title="回声"></a>回声</h2><p>回声一般出现在同时有音频的采集和播放的场景，比如：连麦互动、混音返听等等，采集到的音频通过扬声器又播放出来了，同时又被采集了进去，从而产生了回声或者啸叫声。</p>
<p>这样的场景下，一般需要通过系统的回声消除 API，或者第三方回声消除库（如：speexdsp，webrtc 等）进行处理。</p>
<p>注意：很多 Android 机型硬件自带的回声消除效果并不是很好。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.qiniu.com/archives/8524" target="_blank" rel="noopener">《直播疑难杂症排查》系列之八：播放杂音、噪音、回声</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/直播疑难杂症/直播疑难杂症二-卡顿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/直播疑难杂症/直播疑难杂症二-卡顿/" itemprop="url">直播疑难杂症二-卡顿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T15:08:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h1><p>包括但不限于以下这些：</p>
<ul>
<li><p>频繁出现缓冲</p>
</li>
<li><p>播放不够流畅，画面声音一卡一卡的</p>
</li>
</ul>
<p>从代码层面来说，<strong>帧率太低</strong></p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>通常可能有如下几大类</p>
<h2 id="网络带宽不足"><a href="#网络带宽不足" class="headerlink" title="网络带宽不足"></a>网络带宽不足</h2><p>一个完整的直播应用，简单来说数据流是这样的：<code>主播 -&gt; CDN -&gt; 观众</code></p>
<p>因此，直播出现卡顿，三个端都可能是问题的源头：</p>
<ul>
<li>主播端的网络不好，导致推流上行不稳定</li>
<li>服务端的线路质量不好，导致分发不稳定</li>
<li>观众端的网络不好，导致拉流下行不稳定</li>
</ul>
<h3 id="如何判断网络不好"><a href="#如何判断网络不好" class="headerlink" title="如何判断网络不好"></a>如何判断网络不好</h3><ul>
<li>宽度测速。是否低于推流码率所需宽带</li>
<li>宽带稳定性。丢包率，延时</li>
<li>SDK回调。推流/拉流 码率 帧率</li>
</ul>
<h2 id="播放设备性能不足"><a href="#播放设备性能不足" class="headerlink" title="播放设备性能不足"></a>播放设备性能不足</h2><p>设备性能不足，导致解码播放的帧率远小于视频码流的实际帧率，从而产生卡顿。</p>
<p>解决方案：</p>
<ul>
<li>优先硬解，充分利用 GPU 加速</li>
<li>低端机上优先选择非高清码流。越高清的码率，对解码的要求越高</li>
<li>增大缓冲区，缓解卡顿</li>
</ul>
<h2 id="视频流时间戳问题"><a href="#视频流时间戳问题" class="headerlink" title="视频流时间戳问题"></a>视频流时间戳问题</h2><p>播放器一般是严格根据码流中的音视频的时间戳来做音画同步的，因此，如果码流中的音视频时间戳出现错误，肯定会影响到播放画面的渲染时机</p>
<p>播放器一般 master 主时钟是单调递增的，当后来的视频帧小于了当前的主时钟，播放器就会做丢帧处理，从而导致播放的视频帧率远低于实际码流中的视频帧率，从而产生卡顿现象。</p>
<img src="/2019/09/03/直播/直播疑难杂症/直播疑难杂症二-卡顿/stream_time.jpeg">
<p>排查这个问题，可以把读取到的每一帧音频、视频的时间戳打印出来看看</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.qiniu.com/archives/8405" target="_blank" rel="noopener">《直播疑难杂症排查》之二：播放卡顿</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/直播疑难杂症/直播疑难杂症-开篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/直播疑难杂症/直播疑难杂症-开篇/" itemprop="url">直播疑难杂症-开篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T15:02:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="直播疑难杂症大纲"><a href="#直播疑难杂症大纲" class="headerlink" title="直播疑难杂症大纲"></a>直播疑难杂症大纲</h1><p>（一）播放失败</p>
<p>（二）直播卡顿</p>
<p>（三）首开慢</p>
<p>（四）延时高</p>
<p>（五）音画不同步</p>
<p>（六）马赛克严重</p>
<p>（七）播放黑屏、花屏、绿屏</p>
<p>（八）播放杂音、噪音、回声</p>
<p>（九）点播拖动不准</p>
<p>（十）直播发热问题</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/视频/Android视频录制app解决方案汇总/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/视频/Android视频录制app解决方案汇总/" itemprop="url">Android视频录制app解决方案汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T14:52:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.zybuluo.com/lichangadd/note/148109" target="_blank" rel="noopener">Android视频录制app解决方案汇总</a></p>
<p>现在视频App很多：蝌蚪音客、美拍、小影、还有最近火起来的小咖秀。</p>
<p>这类App的技术难点基本都是在音视频处理这一块</p>
<p>iOS对多媒体处理的支持还算比较丰富，Android差很多。</p>
<p>这里总结蝌蚪音客在多媒体处理上遇到的问题，供大家参考下。</p>
<h1 id="一、录制方视频-1：1"><a href="#一、录制方视频-1：1" class="headerlink" title="一、录制方视频(1：1)"></a>一、录制方视频(1：1)</h1><p>现在市面上的视频应用的视频尺基本全部都是1：1的，这对于Android开发者来说就是一个比较棘手的问题，Android原生Recorder类并不支持视频比例的设置。</p>
<p>所以只能想其他办法，目前常用的办法大致可以分为2种：</p>
<h2 id="a-摒弃原生接口，使用FFmpeg或OpenCV等方式进行录制"><a href="#a-摒弃原生接口，使用FFmpeg或OpenCV等方式进行录制" class="headerlink" title="a. 摒弃原生接口，使用FFmpeg或OpenCV等方式进行录制"></a>a. 摒弃原生接口，使用FFmpeg或OpenCV等方式进行录制</h2><ul>
<li><p><strong>缺点</strong></p>
<p>  对开发者技术要求较高，FFmpeg和OpenCV<strong>移植麻烦</strong>，<strong>多机型兼容复杂</strong> 并且要求开发者一定程度的<strong>C语言功底</strong></p>
</li>
<li><p><strong>最难解决的问题是性能问题</strong></p>
<p>  FFmeg和OpenCV都是开源方案，如果要真正达实用级别往往还<strong>需要优化定制</strong>，这对于熟练于做Android展现的开发者来说完全就是一个新的领域。蝌蚪音客就尝试过这种方案，结果视频的码率只能做到15fps左右，这明显是不够的。</p>
</li>
</ul>
<h2 id="b-使用原生API录制，遮罩1：1视觉效果"><a href="#b-使用原生API录制，遮罩1：1视觉效果" class="headerlink" title="b. 使用原生API录制，遮罩1：1视觉效果"></a>b. 使用原生API录制，遮罩1：1视觉效果</h2><ul>
<li><p>在录制界面使用遮罩的方式给用户一种1：1的错觉。</p>
</li>
<li><p>在预览视频时，使用FFmpeg进行视频裁剪。</p>
</li>
</ul>
<p><strong>如果团队没有驾驭FFmpeg的能力，个人建议使用这种方式。</strong></p>
<p>视频录制功能来说相对简单，而且裁剪命令优化后基本可以可以做到视频预览一遍也就基本裁剪完毕(<strong>耗时&gt;=视频时长</strong>，真心伤)。</p>
<h1 id="二、本地视频压缩"><a href="#二、本地视频压缩" class="headerlink" title="二、本地视频压缩"></a>二、本地视频压缩</h1><p><strong>本地视频压缩除了FFmpeg之外目前还没有了解到有其他方案</strong></p>
<p>但是压缩命令的优化可是一门学问，使用 <code>x264</code> 还是 <code>mpeg4</code>，<code>码率</code>，<code>分辨率</code>，<code>帧频</code>，<code>文件大小</code> 等都会影响到 <code>压缩速度</code> 而且差别相当大。</p>
<p>在android平台运行效率实在蛋疼，测试压缩一个mp4，<strong>耗时&gt;=视频时长x6</strong>。网络说在CentOS服务器上跑都是 耗时=视频时长</p>
<h1 id="三、m3u8解决方案"><a href="#三、m3u8解决方案" class="headerlink" title="三、m3u8解决方案"></a>三、m3u8解决方案</h1><p>绝对不建议创业公司<strong>自己编写播放器，绝对无底洞</strong>，还不如直接使用MP4文件格式。</p>
<p>m3u8国内比较出名的是 <strong>vitamio</strong>，还有一些韩国人的技术方案。但是vitamio的<strong>开源版本感觉很久没有更新</strong>，而且商业版本的授权动则几十万</p>
<p><strong>推荐使用百度媒体云的m3u8的解决方案</strong>，代码家的AnimeTaste使用的就是这个，完全免费，项目质量还算稳定。但是<strong>只能做成单例</strong>，如果想集成到listview中，需要费点事。</p>
<h1 id="四、视频滤镜、水印"><a href="#四、视频滤镜、水印" class="headerlink" title="四、视频滤镜、水印"></a>四、视频滤镜、水印</h1><ul>
<li><p>水印 </p>
<p>  <strong>FFmpeg</strong> 在视频处理的过程中可以并行处理水印。</p>
</li>
<li><p>视频滤镜</p>
<p>  赶紧花钱招大牛吧。</p>
<p>  据说小影的开发Leader在视频处理领域里沉浸了20多年。</p>
<p>  目前这部分笔者还是在了解阶段，目前看到的方案有使用GPUImage进行处理的，但是无奈对图像处理的知识掌握的太少，迟迟没有动手。</p>
</li>
</ul>
<h1 id="五、趣拍云"><a href="#五、趣拍云" class="headerlink" title="五、趣拍云"></a>五、<a href="https://www.qupaicloud.com/" target="_blank" rel="noopener">趣拍云</a></h1><p>阿里百川和趣拍合作推出，包括 短视频sdk 和 直播sdk。收费不便宜</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/视频/视频播放/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/视频/视频播放/" itemprop="url">视频播放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T14:52:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android视频播放器的选择"><a href="#Android视频播放器的选择" class="headerlink" title="Android视频播放器的选择"></a><a href="https://appkfz.com/2017/08/27/ijkplayer-sutdy-1/" target="_blank" rel="noopener">Android视频播放器的选择</a></h1><ul>
<li><p><strong>MediaPlayer</strong></p>
<ul>
<li>原生实现</li>
<li>只使用硬解播放，基只支持本地和HTTP协议的视频播放，扩展性很差，只适合最简单的视频播放需求</li>
</ul>
</li>
<li><p><strong>VideoView</strong></p>
<p>  将MediaPlayer，SurfaceView封装</p>
</li>
<li><p><strong><a href="https://github.com/google/ExoPlayer" target="_blank" rel="noopener">ExoPlayer</a></strong></p>
<ul>
<li>提供了更好的扩展性和定制能力</li>
<li>加入了对DASH和HLS等直播协议的支持</li>
<li>但也只支持硬码<ul>
<li>如果项目中只需要支持对H264格式的视频播放，以及流媒体协议比较常规（比如HTTP，HLS），基于ExoPlayer定制也是不错的选择。</li>
</ul>
</li>
</ul>
</li>
<li><p>ijkplayer</p>
<ul>
<li>Bilibili公司开源的播放器实现</li>
<li>整合了FFMpeg, ExoPlayer, MediaPlayer，EXOPlayer等多种实现</li>
<li>提供了类似于MediaPlayer的API</li>
<li>实现软硬解码自由切换</li>
<li>自定义TextureView实现</li>
<li>得益于FFMpeg的能力，也能支持多种流媒体协议（RTSP，RTMP，HLS等），多种视频编码格式（h264, mpeg4, mjpeg)，具有很高的灵活性，可以定制实现自己特色的播放器（比如支持视频缩放，视频翻转等）。</li>
</ul>
</li>
</ul>
<h1 id="视频旋转角度问题"><a href="#视频旋转角度问题" class="headerlink" title="视频旋转角度问题"></a>视频旋转角度问题</h1><p>视频是带有旋转角度信息的。</p>
<p>播放时，需要获取角度并相应设置播放角度，才能正常播放视频</p>
<p>获取视频元信息的开源库 - <a href="https://github.com/wseemann/FFmpegMediaMetadataRetriever" target="_blank" rel="noopener">FFmpegMediaMetadataRetriever</a></p>
<p><strong>MediaPlaer已经处理好旋转角度问题</strong></p>
<p><a href="http://blog.csdn.net/jdsjlzx/article/details/51884784" target="_blank" rel="noopener">ijkplayer没有处理，需要开发者自行处理</a> 或 <a href="https://github.com/pili-engineering/PLDroidPlayer/issues/444" target="_blank" rel="noopener">参考PLDroidPlayer issues</a></p>
<p>实际测试中（MP4格式）发现没有回调MEDIA_INFO_VIDEO_ROTATION_CHANGED</p>
<pre><code>private PLMediaPlayer.OnInfoListener mOnInfoListener = new PLMediaPlayer.OnInfoListener() {
        @Override
        public boolean onInfo(PLMediaPlayer plMediaPlayer, int what, int extra) {
            Log.d(TAG, &quot;onInfo: &quot; + what + &quot;, &quot; + extra);
            switch (what) {
                case PLMediaPlayer.MEDIA_INFO_VIDEO_ROTATION_CHANGED:
                    Log.d(TAG, &quot;MEDIA_INFO_VIDEO_ROTATION_CHANGED: &quot; + extra);
                    if(extra==90) {
                       //设置播放视频角度
                    mVideoView.setDisplayOrientation(270);
                    }
                    break;
            }
            return false;
        }
    };
</code></pre><h1 id="VideoView视频播放等比缩放"><a href="#VideoView视频播放等比缩放" class="headerlink" title="VideoView视频播放等比缩放"></a><a href="http://jingyan.baidu.com/article/9f7e7ec080ecb36f2815541d.html" target="_blank" rel="noopener">VideoView视频播放等比缩放</a></h1><p>不同分辨率下不同size的视频资源会被拉伸变形</p>
<p>解决方案：</p>
<ul>
<li><p>setOnPreparedListener获取视频宽高，根据屏幕宽高进行等比缩放</p>
<pre><code>videoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {
    @Override
    public void onPrepared(MediaPlayer mediaPlayer) {
        videoWidth = mediaPlayer.getVideoWidth();
        videoHeight = mediaPlayer.getVideoHeight();
        //根据屏幕宽高进行等比缩放
        viv.setLayoutParams(calculateVideoViewParam());
        viv.start();
    }
});
</code></pre></li>
<li><p>onConfigurationChanged监听横竖屏切换，视频进行等比缩放</p>
<pre><code>public void onConfigurationChanged(Configuration newConfig) {
    if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
        Log.e(&quot;info&quot;, &quot;横屏&quot;);
        isLandScape = true;
    } else {
        Log.e(&quot;info&quot;, &quot;竖屏&quot;);
        isLandScape = false;
    }
    RelativeLayout.LayoutParams params = calculateVideoViewParam();
    videoView.setMeasure(params.width, params.height);
    videoView.getHolder().setFixedSize(params.width, params.height);
    videoView.requestLayout();
    videoView.refreshDrawableState();
    videoView.setLayoutParams(params);
    super.onConfigurationChanged(newConfig);
}
</code></pre></li>
<li><p>自定义videoView，实现根据视频宽高等比缩放</p>
<pre><code>public void setMeasure(int width, int height) {
    this.width = width;  
    this.height = height;    
} 

protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec){        
    super.onMeasure(widthMeasureSpec, heightMeasureSpec); 
    // 默认高度，为了自动获取到focus
    int width = MeasureSpec.getSize(widthMeasureSpec);   
    int height = width;
    // 这个之前是默认的拉伸图像      
      if (this.width &gt; 0 &amp;&amp; this.height &gt; 0){          
          width = this.width;          
          height = this.height;      
      }     
       setMeasuredDimension(width, height);   
}  
</code></pre></li>
<li><p>改变videoView大小的方法不是太清楚。</p>
<pre><code>//方法一
videoView.setMeasure(params.width, params.height);
videoView.getHolder().setFixedSize(params.width, params.height);
videoView.requestLayout();

//方法二
videoView.setLayoutParams(params);
</code></pre></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/视频/跨平台视频编码参数推荐/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/视频/跨平台视频编码参数推荐/" itemprop="url">跨平台视频编码参数推荐</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T14:52:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.joyinpower.com/blog/?p=142" target="_blank" rel="noopener">清晰、小容量、跨平台视频 编码参数 推荐</a></p>
<p>假定优酷的“高清”视频的清晰度是做了详尽的用户调研的结果</p>
<p>根据开发指南提供的数据，Android和iOS同时支持并推荐使用的视频格式为 H.264 Baseline Profile。</p>
<p>Android的开发指南，提供了SD Low、SD High、HD 720p三种推荐参数</p>
<p>用QQ播放器中的转码功能，将源视频进行了转码，并在smartisan T1手机上进行了测试，结果如下：</p>
<p>源视频格式为wmv，10分55秒，495M</p>
<p>HD：265M<br>SD High Quality：63.2M<br>SD Low Quality：15.9M  太模糊</p>
<p>优酷上面，同样是10分50秒的视频，“高清”的版本只有42M</p>
<p>分析了一下优酷的视频</p>
<p>我们最终选择的是：H.264 Baseline Profile格式，码率384k，帧率15fps，分辨率480×272(16:9)，音频码率32k。这样10分钟的视频大概在35M左右。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/音频/Android声音采集降噪增益回声消除/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/音频/Android声音采集降噪增益回声消除/" itemprop="url">Android声音采集降噪增益回声消除</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T14:52:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.jianshu.com/p/2cb75a71009f" target="_blank" rel="noopener">Android手机直播（三）声音采集</a></p>
<p><a href="https://github.com/LaiFeng-Android/SopCastComponent" target="_blank" rel="noopener">项目github</a></p>
<h1 id="一、基础知识"><a href="#一、基础知识" class="headerlink" title="一、基础知识"></a>一、基础知识</h1><h2 id="麦克风降噪"><a href="#麦克风降噪" class="headerlink" title="麦克风降噪"></a>麦克风降噪</h2><p><img src="http://upload-images.jianshu.io/upload_images/924057-0c83cc87d86f846f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>底部的麦是用来提供清晰通话，而顶部的麦是用来消除噪音</p>
<p>两个麦克风所拾取的背景噪声音量是基本相同的，而记录的人声会有6dB左右的音量差。顶端麦收集噪声后，通过解码生成补偿信号后就可以用来消除噪音了</p>
<h2 id="回声消除"><a href="#回声消除" class="headerlink" title="回声消除"></a>回声消除</h2><p>回声消除就是在麦克风录制外音的时候去除掉手机自身播放出来的声音，这样就将对方的声音从采集的声音中过滤出去，从而就避免了回声的产生<br><img src="http://upload-images.jianshu.io/upload_images/924057-395c4cb4f1deb4ff.png?imageMogr2/auto-orient/strip" alt=""></p>
<h1 id="二、声音采集"><a href="#二、声音采集" class="headerlink" title="二、声音采集"></a>二、声音采集</h1><p>想要将声音用计算机语言表述，则必须将声音进行数字化。</p>
<p>将声音数字化，最常见的方式是通过脉冲编码调制PCM(Pulse Code Modulation) 。</p>
<p>抽样、量化、编码三个过程中三个参数：<strong>采样频率、采样位数和声道数</strong></p>
<h1 id="三、Android声音录制"><a href="#三、Android声音录制" class="headerlink" title="三、Android声音录制"></a>三、Android声音录制</h1><h2 id="音频源"><a href="#音频源" class="headerlink" title="音频源"></a>音频源</h2><pre><code>/** 默认声音 **/
public static final int DEFAULT = 0;

/** 麦克风声音 */
public static final int MIC = 1;

/** 通话上行声音 */
public static final int VOICE_UPLINK = 2;

/** 通话下行声音 */
public static final int VOICE_DOWNLINK = 3;

/** 通话上下行声音 */
public static final int VOICE_CALL = 4;

/** 根据摄像头转向选择麦克风*/
public static final int CAMCORDER = 5;

/** 对麦克风声音进行声音识别，然后进行录制 */
public static final int VOICE_RECOGNITION = 6;

/** 对麦克风中类似ip通话的交流声音进行识别，默认会开启回声消除和自动增益 */
public static final int VOICE_COMMUNICATION = 7;

/** 录制系统内置声音 */
public static final int REMOTE_SUBMIX = 8;
</code></pre><h2 id="采样率"><a href="#采样率" class="headerlink" title="采样率"></a>采样率</h2><p>几种常见的采样率：</p>
<pre><code>8000, 11025, 16000, 22050, 44100, 48000
</code></pre><p>Android官方文档要求所有的手机需要对44100Hz的采样率进行支持，可是国内极其少数的手机依然不支持44100Hz的采样率</p>
<p>在设置采样率之前需要对手机对设置的采样率是否支持进行<strong>检测</strong></p>
<pre><code>for (int rate : new int[] {8000, 11025, 16000, 22050, 44100}) {  // add the rates you wish to check against
    int bufferSize = AudioRecord.getMinBufferSize(rate, AudioFormat.CHANNEL_CONFIGURATION_DEFAULT, AudioFormat.ENCODING_PCM_16BIT);
    if (bufferSize &gt; 0) {
        // buffer size is valid, Sample rate supported
    }
}
</code></pre><h2 id="采样位数"><a href="#采样位数" class="headerlink" title="采样位数"></a>采样位数</h2><p><strong>ENCODING_PCM_16BIT</strong> 可以保证兼容所有Android手机。</p>
<h2 id="声道"><a href="#声道" class="headerlink" title="声道"></a>声道</h2><p><strong>AudioFormat.CHANNEL_CONFIGURATION_MONO（单声道）</strong> 可以保证兼容所有Android手机。</p>
<h1 id="四、Android回声消除"><a href="#四、Android回声消除" class="headerlink" title="四、Android回声消除"></a>四、Android回声消除</h1><p>三种方式进行处理：</p>
<ol>
<li><p>通过<strong>VOICE_COMMUNICATION</strong>模式进行录音，自动实现回声消除；<strong>效果最好，兼容性也较好</strong></p>
<ul>
<li>将AudioManager设置模式为MODE_IN_COMMUNICATION</li>
<li><p>将麦克风打开。</p>
<pre><code>AudioManager audioManager = (AudioManager)mContext.getSystemService(Context.AUDIO_SERVICE);
audioManager.setMode(AudioManager.MODE_IN_COMMUNICATION);
audioManager.setSpeakerphoneOn(true);
</code></pre></li>
<li><p>音频采样率必须设置8000或者16000</p>
</li>
<li>通道数必须设为1个</li>
</ul>
</li>
<li><p>利用Android自身带的<strong>AcousticEchoCanceler</strong>进行回声消除处理；<strong>很少手机支持</strong></p>
<ul>
<li>录制声音的时候可以通过AudioRecord得到AudioSessionId，</li>
<li>创建AudioTrack的时候也可以传入一个AudioSessionId，</li>
<li>将这个统一的AudioSessionId传入AcousticEchoCanceler，AcousticEchoCanceler进行回声消除</li>
</ul>
</li>
<li><p>使用第<strong>三方库</strong>（Speex、Webrtc）进行回声消除处理；<strong>理论上兼容性最好，但是设置合适的延时间隔很难</strong></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/直播/音频/Media Playback/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/直播/音频/Media Playback/" itemprop="url">Media Playback</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T14:52:14+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Handling-audio-focus"><a href="#Handling-audio-focus" class="headerlink" title="Handling audio focus"></a>Handling audio focus</h1><p>android 2.2(API 8) 开始引入 <code>audio focus</code>协作机制 来管理音频播放</p>
<h2 id="audio-focus协作机制"><a href="#audio-focus协作机制" class="headerlink" title="audio focus协作机制"></a><code>audio focus</code>协作机制</h2><ul>
<li>获得焦点，播放</li>
<li>失去焦点，停止/暂停播放</li>
<li>仅是建议协作，以获得更好用户体验；但非强制，有的APP可能不遵守</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><pre><code>public int AudioManager.requestAudioFocus(OnAudioFocusChangeListener listener, int streamType, int durationHint)

public interface OnAudioFocusChangeListener {
    public void onAudioFocusChange(int focusChange);
}
</code></pre><p><strong>the type of focus change</strong>, one of </p>
<ul>
<li>AUDIOFOCUS_GAIN  </li>
<li>AUDIOFOCUS_LOSS</li>
<li>AUDIOFOCUS_LOSS_TRANSIENT   短暂丢失</li>
<li>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK  短暂丢失，你可以不停止播放，而是降低音量就可以</li>
</ul>
<h1 id="Handle-Changes-in-the-Audio-Output-Hardware"><a href="#Handle-Changes-in-the-Audio-Output-Hardware" class="headerlink" title="Handle Changes in the Audio Output Hardware"></a>Handle Changes in the Audio Output Hardware</h1><h1 id="Handling-the-AUDIO-BECOMING-NOISY-Intent"><a href="#Handling-the-AUDIO-BECOMING-NOISY-Intent" class="headerlink" title="Handling the AUDIO_BECOMING_NOISY Intent"></a>Handling the AUDIO_BECOMING_NOISY Intent</h1><p>当蓝牙断开或耳机拔出，系统会自动使用扬声器播放，这在某些场景会造成噪音惊喜。万幸系统会发出 <code>ACTION_AUDIO_BECOMING_NOISY</code> 广播</p>
<pre><code>private class NoisyAudioStreamReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        if (AudioManager.ACTION_AUDIO_BECOMING_NOISY.equals(intent.getAction())) {
            // Pause the playback
        }
    }
}

private IntentFilter intentFilter = new IntentFilter(AudioManager.ACTION_AUDIO_BECOMING_NOISY);

private void startPlayback() {
    registerReceiver(myNoisyAudioStreamReceiver(), intentFilter);
}

private void stopPlayback() {
    unregisterReceiver(myNoisyAudioStreamReceiver);
}
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">318</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
