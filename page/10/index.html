<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/10/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/编程思想/Android端架构_MVP-Clean架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/编程思想/Android端架构_MVP-Clean架构/" itemprop="url">Android端架构_MVP-Clean架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-16T11:46:01+08:00">
                2019-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程思想/" itemprop="url" rel="index">
                    <span itemprop="name">编程思想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Activity跳转"><a href="#Activity跳转" class="headerlink" title="Activity跳转"></a>Activity跳转</h1><p>Activity跳转是如何实现的</p>
<p><code>BaseActivity</code> 持有 <code>Navigator</code>，Activity A 调用 Navigator 相应的跳转方法。</p>
<p>每个Activity 都需要提供启动自己的Intent，而不是由Navigator构造</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Navigator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">navigateToUserList</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Intent intentToLaunch = UserListActivity.getCallingIntent(context);</span><br><span class="line">      context.startActivity(intentToLaunch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Intent <span class="title">getCallingIntent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Intent(context, UserListActivity.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">navigator.navigateToUserList(<span class="keyword">this</span>);<span class="comment">//跳转到UserListActivity</span></span><br></pre></td></tr></table></figure>
<h1 id="完整的渲染数据过程"><a href="#完整的渲染数据过程" class="headerlink" title="完整的渲染数据过程"></a>完整的渲染数据过程</h1><p>以用户列表页为例</p>
<h2 id="presentation-表现层"><a href="#presentation-表现层" class="headerlink" title="presentation 表现层"></a>presentation 表现层</h2><h3 id="model"><a href="#model" class="headerlink" title="model"></a>model</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModel</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="view"><a href="#view" class="headerlink" title="view"></a>view</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadDataView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showLoading</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">hideLoading</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showRetry</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">hideRetry</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showError</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Context <span class="title">context</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserListView</span> <span class="keyword">extends</span> <span class="title">LoadDataView</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Render a user list in the UI.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">renderUserList</span><span class="params">(Collection&lt;UserModel&gt; userModelCollection)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//View a UserModel profile/details.</span></span><br><span class="line">  <span class="comment">//Presenter call this when click a UserModel</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">viewUser</span><span class="params">(UserModel userModel)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> <span class="keyword">implements</span> <span class="title">UserListView</span> </span>&#123;</span><br><span class="line">  UserListPresenter userListPresenter;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCreated</span><span class="params">(View view, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line">    <span class="keyword">this</span>.userListPresenter.setView(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.loadUserList();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renderUserList</span><span class="params">(Collection&lt;UserModel&gt; userModelCollection)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (userModelCollection != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.usersAdapter.setUsersCollection(userModelCollection);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">viewUser</span><span class="params">(UserModel userModel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">      mActivity.navigator.navigateToUserDetails(mActivity, userModel.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//Loads all users.</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userListPresenter.loadUserList();</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="presenter"><a href="#presenter" class="headerlink" title="presenter"></a>presenter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListPresenter</span> <span class="keyword">implements</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> UserListView viewListView;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> GetUserList getUserListUseCase;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> UserModelDataMapper userModelDataMapper;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">UserListPresenter</span><span class="params">(GetUserList getUserListUserCase,</span></span></span><br><span class="line"><span class="function"><span class="params">      UserModelDataMapper userModelDataMapper)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.getUserListUseCase = getUserListUserCase;</span><br><span class="line">    <span class="keyword">this</span>.userModelDataMapper = userModelDataMapper;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(@NonNull UserListView view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.viewListView = view;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showUsersCollectionInView</span><span class="params">(Collection&lt;User&gt; usersCollection)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Collection&lt;UserModel&gt; userModelsCollection =</span><br><span class="line">        <span class="keyword">this</span>.userModelDataMapper.transform(usersCollection);</span><br><span class="line">    <span class="keyword">this</span>.viewListView.renderUserList(userModelsCollection);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.getUserListUseCase.execute(<span class="keyword">new</span> UserListObserver(), <span class="keyword">null</span>);</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListObserver</span> <span class="keyword">extends</span> <span class="title">DefaultObserver</span>&lt;<span class="title">List</span>&lt;<span class="title">User</span>&gt;&gt; </span>&#123;<span class="comment">//DisposableObserver继承rxjava2的DisposableObserver</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      UserListPresenter.<span class="keyword">this</span>.hideViewLoading();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">      UserListPresenter.<span class="keyword">this</span>.hideViewLoading();</span><br><span class="line">      UserListPresenter.<span class="keyword">this</span>.showErrorMessage(<span class="keyword">new</span> DefaultErrorBundle((Exception) e));</span><br><span class="line">      UserListPresenter.<span class="keyword">this</span>.showViewRetry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; users)</span> </span>&#123;</span><br><span class="line">      UserListPresenter.<span class="keyword">this</span>.showUsersCollectionInView(users);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="domain-领域层"><a href="#domain-领域层" class="headerlink" title="domain 领域层"></a>domain 领域层</h2><h3 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class that represents a User in the domain layer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="interactor-use-case"><a href="#interactor-use-case" class="headerlink" title="interactor(use case)"></a>interactor(use case)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetUserListUseCase</span> <span class="keyword">extends</span> <span class="title">UseCase</span>&lt;<span class="title">List</span>&lt;<span class="title">User</span>&gt;, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">//调用 data层的UserRepository</span></span><br><span class="line">	<span class="comment">//将可观察的用户列表，发射到上面presenter指定的观察者</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="data-数据层"><a href="#data-数据层" class="headerlink" title="data 数据层"></a>data 数据层</h2><h3 id="entity-1"><a href="#entity-1" class="headerlink" title="entity"></a>entity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * User Entity used in the data layer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="repository"><a href="#repository" class="headerlink" title="repository"></a>repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface that represents a Repository for getting &#123;<span class="doctag">@link</span> User&#125; related data.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="datasource"><a href="#datasource" class="headerlink" title="datasource"></a>datasource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface that represents a data store from where data is retrieved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDataStore</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudUserDataStore</span> <span class="keyword">implements</span> <span class="title">UserDataStore</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiskUserDataStore</span> <span class="keyword">implements</span> <span class="title">UserDataStore</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory that creates different implementations of &#123;<span class="doctag">@link</span> UserDataStore&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDataStoreFactory</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An interface representing a user Cache.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserCache</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="net"><a href="#net" class="headerlink" title="net"></a>net</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RestApi for retrieving data from the network.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RestApi</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Dagger2"><a href="#Dagger2" class="headerlink" title="Dagger2"></a>Dagger2</h1><p>是否使用，这个具体问题具体分析。更多内容参考 Dagger2 文档</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/android10/Android-CleanArchitecture" target="_blank" rel="noopener">实例源码</a>by Fernando Cejas (Fernando 大神)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/电脑使用/SimpleUML使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/电脑使用/SimpleUML使用/" itemprop="url">SimpleUML使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T14:19:13+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UML/" itemprop="url" rel="index">
                    <span itemprop="name">UML</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SimpleUML-是什么"><a href="#SimpleUML-是什么" class="headerlink" title="SimpleUML 是什么"></a>SimpleUML 是什么</h1><p>可以按照包名等条件设置过滤条件，显示自己关心的部分。</p>
<p>根据源码自动生成UML 类图 包图 序列图</p>
<p>复杂结构生成后几乎不可用，全靠手动调整依赖</p>
<h1 id="AndroidStudio-中使用-SimpleUML"><a href="#AndroidStudio-中使用-SimpleUML" class="headerlink" title="AndroidStudio 中使用 SimpleUML"></a>AndroidStudio 中使用 SimpleUML</h1><ul>
<li>AndroidStudio 安装 SimpleUML 插件</li>
<li>重启</li>
<li>某个 <code>包/类</code> 上右击，选择 <code>Add to simpleUML Diagram</code></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/编程思想/UML/SimpleUML使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/编程思想/UML/SimpleUML使用/" itemprop="url">SimpleUML使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T14:19:13+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UML/" itemprop="url" rel="index">
                    <span itemprop="name">UML</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SimpleUML-是什么"><a href="#SimpleUML-是什么" class="headerlink" title="SimpleUML 是什么"></a>SimpleUML 是什么</h1><p>根据源码自动生成UML类图</p>
<h1 id="AndroidStudio-中使用-SimpleUML"><a href="#AndroidStudio-中使用-SimpleUML" class="headerlink" title="AndroidStudio 中使用 SimpleUML"></a>AndroidStudio 中使用 SimpleUML</h1><ul>
<li>AndroidStudio 安装 SimpleUML 插件</li>
<li>重启</li>
<li>某个 <code>包/类</code> 上右击，选择 <code>Add to simpleUML Diagram</code></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/编程思想/UML/UML概述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/编程思想/UML/UML概述/" itemprop="url">UML概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T14:19:13+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UML/" itemprop="url" rel="index">
                    <span itemprop="name">UML</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h1><p>UML（Unified Modeling Language）统一建模语言</p>
<h1 id="为什么用UML"><a href="#为什么用UML" class="headerlink" title="为什么用UML"></a>为什么用UML</h1><p>文不如表，表不如图，图不如实（原型图）</p>
<p>文字的缺陷：大耳朵，长鼻子，獠牙–野猪还是小象</p>
<p>图表的缺陷：长方形–一块地还是一间房</p>
<h1 id="如何学好UML"><a href="#如何学好UML" class="headerlink" title="如何学好UML"></a>如何学好UML</h1><p>和学看图说话道理一样，记住两个要素：<strong>节点和联系</strong></p>
<h1 id="UML工具"><a href="#UML工具" class="headerlink" title="UML工具"></a>UML工具</h1><h2 id="图形化操作"><a href="#图形化操作" class="headerlink" title="图形化操作"></a>图形化操作</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h4 id="starUML"><a href="#starUML" class="headerlink" title="starUML"></a>starUML</h4><p>免费开源、小巧</p>
<h4 id="rose"><a href="#rose" class="headerlink" title="rose"></a>rose</h4><p>收费破解 庞大 功能强大 漂亮 好用</p>
<h4 id="visio"><a href="#visio" class="headerlink" title="visio"></a>visio</h4><h3 id="web在线"><a href="#web在线" class="headerlink" title="web在线"></a>web在线</h3><h4 id="ProcessOn"><a href="#ProcessOn" class="headerlink" title="ProcessOn"></a>ProcessOn</h4><h2 id="专门语法"><a href="#专门语法" class="headerlink" title="专门语法"></a>专门语法</h2><h3 id="webChart"><a href="#webChart" class="headerlink" title="webChart"></a>webChart</h3><p>web在线</p>
<h3 id="PlantUML"><a href="#PlantUML" class="headerlink" title="PlantUML"></a>PlantUML</h3><p>不仅可以嵌套到各种文本编辑器，IDE，也提供在线版。</p>
<h1 id="UML的构造包含3种："><a href="#UML的构造包含3种：" class="headerlink" title="UML的构造包含3种："></a>UML的构造包含3种：</h1><ul>
<li><strong>事物</strong>（4种）：事物是对模型中最具代表性的成分的抽象<ul>
<li>结构事物</li>
<li>行为事物</li>
<li>分组事物</li>
<li>注释事物</li>
</ul>
</li>
<li><strong>关系</strong>（4种）：关系把事物结合在一起<ul>
<li>泛化关系</li>
<li>实现关系</li>
<li>依赖关系</li>
<li>关联关系</li>
</ul>
</li>
<li><strong>图</strong>（10种）：图聚集了相关的事物<ul>
<li>用例图(UseCase)。用户(管理员、版主)行为(用户管理、帖子置顶)</li>
<li>类图(Class)。类(用例图抽象成类)的结构及类间的关系</li>
<li>对象图(Object)。某一时刻的类实例对象</li>
<li>状态图(Statechart)。类实例对象的状态及状态改变的条件</li>
<li>序列图(Sequence)。时序图，循序图。类实例对象按时间顺序的交互</li>
<li>协作图(Collaboration)。类实例对象的组织关系和相互作用</li>
<li>活动图(Activity)。流程图。控制流；一个用例所要进行的活动及活动间关系(用户刷卡：用户刷卡-系统输入刷卡额度-数据库更新表-系统显示刷卡成功)</li>
<li>包图(Package)。java 中的package；可以理解为文件夹</li>
<li>组件图(Component)。系统的物理结构及相互关系</li>
<li>部署图(Deployment)。系统的物理部署(刷卡机，客户端，数据库服务器）</li>
</ul>
</li>
</ul>
<h1 id="图（10种）"><a href="#图（10种）" class="headerlink" title="图（10种）"></a>图（10种）</h1><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><table>
<thead>
<tr>
<th>图</th>
<th>结构/行为</th>
<th>角度</th>
</tr>
</thead>
<tbody>
<tr>
<td>用例图</td>
<td>行为(动态)</td>
<td>用例视图</td>
</tr>
<tr>
<td>类图</td>
<td>结构(静态)</td>
<td>设计视图</td>
</tr>
<tr>
<td>对象图</td>
<td>结构(静态)</td>
<td>设计视图</td>
</tr>
<tr>
<td>状态图</td>
<td>行为(动态)</td>
<td>进程视图</td>
</tr>
<tr>
<td>序列图</td>
<td>行为(动态)</td>
<td>进程视图</td>
</tr>
<tr>
<td>协作图</td>
<td>行为(动态)</td>
<td>进程视图</td>
</tr>
<tr>
<td>活动图</td>
<td>行为(动态)</td>
<td>进程视图</td>
</tr>
<tr>
<td>包图</td>
<td>结构(静态)</td>
<td>实现视图</td>
</tr>
<tr>
<td>组件图</td>
<td>结构(静态)</td>
<td>实现视图</td>
</tr>
<tr>
<td>部署图</td>
<td>结构(静态)</td>
<td>拓扑视图</td>
</tr>
</tbody>
</table>
<ul>
<li>结构图：描述系统结构，是静态图</li>
<li>行为图：描述系统行为，是动态图</li>
</ul>
<h2 id="序列图"><a href="#序列图" class="headerlink" title="序列图"></a>序列图</h2><p>7种元素：角色(Actor)、对象(Object)、生命线(LifeLine)、控制焦点(Activation)、消息(Message)、自关联消息、组合片段</p>
<img src="/2019/08/15/编程思想/UML/UML概述/时序图.png">
<h3 id="角色-Actor"><a href="#角色-Actor" class="headerlink" title="角色(Actor)"></a>角色(Actor)</h3><p>系统角色，可以是人或者其他系统，子系统。以一个小人图标表示。</p>
<h3 id="对象-Object"><a href="#对象-Object" class="headerlink" title="对象(Object)"></a>对象(Object)</h3><p>对象位于时序图的顶部,以一个矩形表示。对象的命名方式一般有三种：</p>
<ol>
<li>对象名和类名。例如：华为手机:手机、loginServiceObject:LoginService。</li>
<li>只显示类名，不显示对象，即为一个匿名类。例如：:手机、:LoginSservice。</li>
<li>只显示对象名，不显示类名。例如：华为手机:、loginServiceObject:。</li>
</ol>
<h3 id="生命线-LifeLine"><a href="#生命线-LifeLine" class="headerlink" title="生命线(LifeLine)"></a>生命线(LifeLine)</h3><p>时序图中每个对象和底部中心都有一条垂直的虚线，这就是对象的生命线(对象的时间线)。以一条垂直的虚线表。</p>
<h3 id="控制焦点-Activation"><a href="#控制焦点-Activation" class="headerlink" title="控制焦点(Activation)"></a>控制焦点(Activation)</h3><p>控制焦点代表时序图中在对象时间线上某段时期执行的操作。以一个很窄的矩形表示。</p>
<h3 id="消息-Message"><a href="#消息-Message" class="headerlink" title="消息(Message)"></a>消息(Message)</h3><p>表现代表对象之间发送的信息。消息分为三种类型。</p>
<ul>
<li><strong>同步消息</strong>(Synchronous Message)<br>消息的发送者把控制传递给消息的接收者，然后停止活动，等待消息的接收者放弃或者返回控制。用来表示同步的意义。以一条<strong>实线+实心箭头</strong>表示。</li>
<li><strong>异步消息</strong>(Asynchronous Message)<br>消息发送者通过消息把信号传递给消息的接收者，然后继续自己的活动，不等待接受者返回消息或者控制。异步消息的接收者和发送者是并发工作的。以一条<strong>实线+大于号</strong>表示。</li>
<li><strong>返回消息</strong>(Return Message)<br>返回消息表示从过程调用返回。以<strong>小于号+虚线</strong>表示。</li>
</ul>
<h3 id="自关联消息"><a href="#自关联消息" class="headerlink" title="自关联消息"></a>自关联消息</h3><p>表示方法的自身调用或者一个对象内的一个方法调用另外一个方法。以一个<strong>半闭合的长方形+下方实心剪头</strong>表示。</p>
<h2 id="活动图"><a href="#活动图" class="headerlink" title="活动图"></a>活动图</h2><ul>
<li>一般活动图</li>
<li>带泳道的活动图</li>
<li>带对象流的活动图<h1 id="关系（4种）"><a href="#关系（4种）" class="headerlink" title="关系（4种）"></a>关系（4种）</h1></li>
</ul>
<p>UML 中类与类, 类与接口, 接口与接口这间的关系有: </p>
<ul>
<li>泛化(generalization) 关系</li>
<li>实现(realization)关系 </li>
<li>依赖(dependency)关系</li>
<li>关联(association)关系<ul>
<li>关联</li>
<li>聚合(aggregation)</li>
<li>合成/组合(composition)</li>
</ul>
</li>
</ul>
<h2 id="泛化-generalization"><a href="#泛化-generalization" class="headerlink" title="泛化(generalization)"></a>泛化(generalization)</h2><p>在Java中此类关系通过关键字 <code>extends</code> 明确标识</p>
<img src="/2019/08/15/编程思想/UML/UML概述/101.jpg">
<h2 id="实现-realization"><a href="#实现-realization" class="headerlink" title="实现(realization)"></a>实现(realization)</h2><p>在Java中此类关系通过关键字 <code>implements</code> 明确标识</p>
<img src="/2019/08/15/编程思想/UML/UML概述/102.jpg">
<h1 id="依赖-dependency"><a href="#依赖-dependency" class="headerlink" title="依赖(dependency)"></a>依赖(dependency)</h1><p>类A使用到了类B</p>
<p>在java中依赖关系体现为: <code>局部变量, 方法中的参数, 和对静态方法的调用</code></p>
<ul>
<li>依赖关系总是单向的 </li>
<li>这种使用关系是具有偶然性的、、临时性的、非常弱的</li>
</ul>
<img src="/2019/08/15/编程思想/UML/UML概述/103.jpg">
<h2 id="关联-association"><a href="#关联-association" class="headerlink" title="关联(association)"></a>关联(association)</h2><p>类A 有 成员变量类B</p>
<p>在java中关联关系是使用 <code>实例变量</code> 实现的</p>
<ul>
<li>单箭头表示单向关联</li>
<li>双箭头或不使用箭头表示双向关联<ul>
<li>不建议使用双向关联</li>
</ul>
</li>
<li>关联两个端点可以有一个基数, 表示这个关联的类可以有几个实例<ul>
<li>常见的基数及含义: <ul>
<li>0..1:0 或1 个实例. </li>
<li>0..*: 对实例的数目没有限制. </li>
<li>1: 只能有一个实例. </li>
<li>1..*: 至少有一个实例.</li>
</ul>
</li>
</ul>
</li>
<li>一种长期性的强依赖关系        </li>
</ul>
<img src="/2019/08/15/编程思想/UML/UML概述/104.jpg">
<h2 id="聚合-aggregation"><a href="#聚合-aggregation" class="headerlink" title="聚合(aggregation)"></a>聚合(aggregation)</h2><p>整体和个体之间has-a的关系，整体与部分之间是可分离的</p>
<ul>
<li>他们可以具有各自的生命周期</li>
<li>部分可以属于多个整体对象，也可以为多个整体对象共享</li>
<li>比如计算机与CPU、公司与员工的关系等</li>
</ul>
<p>在java中关联关系是使用 <code>实例变量</code> 实现的</p>
<ul>
<li>语法上是分不出关联和聚合的，只能从语义级别来区分<ul>
<li>关联关系中两个类是处于相同的层次</li>
<li>聚合关系中两不类是处于不平等的层次, 一个表示整体, 一个表示部分.</li>
</ul>
</li>
</ul>
<img src="/2019/08/15/编程思想/UML/UML概述/105.jpg">
<h2 id="组合-合成-composition"><a href="#组合-合成-composition" class="headerlink" title="组合(合成)(composition)"></a>组合(合成)(composition)</h2><p>整体和个体之间contains-a的关系，整体与部分是不可分的</p>
<ul>
<li>整体的生命周期结束也就意味着部分的生命周期结束</li>
<li>比如你和你的大脑；合成关系不能共享. </li>
</ul>
<p>这种关系比聚合更强，也称为<strong>强聚合</strong></p>
<img src="/2019/08/15/编程思想/UML/UML概述/106.jpg">
<p>一张图快速学会UML（聚合、组合、依赖、继承、接口、类）</p>
<img src="/2019/08/15/编程思想/UML/UML概述/uml.png">
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/28200121a33d" target="_blank" rel="noopener">UML图总结</a></li>
<li><a href="https://blog.csdn.net/qq_42758288/article/details/86620768" target="_blank" rel="noopener">UML9种图的分类及运用</a></li>
<li><a href="http://justsee.iteye.com/blog/808799" target="_blank" rel="noopener">UML关系</a></li>
<li><a href="https://blog.csdn.net/fly_zxy/article/details/80911942" target="_blank" rel="noopener">UML时序图(Sequence Diagram)学习笔记</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/编程思想/UML/UML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/编程思想/UML/UML/" itemprop="url">UML关系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T10:19:13+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UML/" itemprop="url" rel="index">
                    <span itemprop="name">UML</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="UML的构造包含3种："><a href="#UML的构造包含3种：" class="headerlink" title="UML的构造包含3种："></a>UML的构造包含3种：</h1><ul>
<li>(1) 事物（4种）：事物是对模型中最具代表性的成分的抽象<ul>
<li>结构事物</li>
<li>行为事物</li>
<li>分组事物</li>
<li>注释事物</li>
</ul>
</li>
<li>(2) 关系（4种）：关系把事物结合在一起<ul>
<li>泛化关系</li>
<li>实现关系</li>
<li>依赖关系</li>
<li>关联关系</li>
</ul>
</li>
<li>(3) 图（10种）：图聚集了相关的事物<ul>
<li>用例图</li>
<li>类图</li>
<li>对象图</li>
<li>包图</li>
<li>组件图</li>
<li>部署图</li>
<li>状态图</li>
<li>活动图</li>
<li>序列图</li>
<li>协作图</li>
</ul>
</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="http://justsee.iteye.com/blog/808799" target="_blank" rel="noopener">UML关系</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/12/Android/Android热修复技术选型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/12/Android/Android热修复技术选型/" itemprop="url">Android热修复技术选型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-12T17:18:53+08:00">
                2019-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>目前Android业内，热修复技术百花齐放，各大厂都推出了自己的热修复方案，使用的技术方案也各有所异，当然各个方案也都存在各自的局限性。在面对众多的方案，希望通过梳理这些热修复方案的对比及实现原理，掌握热修复技术的本质，同时也对项目接入做好准备。</p>
<h1 id="什么是热修复技术？"><a href="#什么是热修复技术？" class="headerlink" title="什么是热修复技术？"></a>什么是热修复技术？</h1><p>简单来说，就是通过下发补丁包，让已安装的客户端动态更新，让用户可以不用重新安装APP，就能够修复软件缺陷的一种技术。</p>
<p>随着热修复技术的发展，不仅可以修复代码，同时可以修复资源文件及SO库。</p>
<h1 id="怎么选择热修复技术方案？"><a href="#怎么选择热修复技术方案？" class="headerlink" title="怎么选择热修复技术方案？"></a>怎么选择热修复技术方案？</h1><h2 id="国内主流的技术方案"><a href="#国内主流的技术方案" class="headerlink" title="国内主流的技术方案"></a>国内主流的技术方案</h2><table>
<thead>
<tr>
<th></th>
<th>Sophix 阿里</th>
<th>Tinker 腾讯</th>
<th>nuwa 大众</th>
<th>AndFix 阿里</th>
<th>Robust 美团</th>
<th>Amigo 饿了么</th>
</tr>
</thead>
<tbody>
<tr>
<td>类替换</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>So替换</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>资源替换</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>全平台支持</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>即时生效</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>性能损耗</td>
<td>较少</td>
<td>较小</td>
<td>较大</td>
<td>较小</td>
<td>较小</td>
<td>较小</td>
</tr>
<tr>
<td>接入复杂度</td>
<td>傻瓜式接入</td>
<td>复杂</td>
<td>较低</td>
<td>复杂</td>
<td>复杂</td>
<td>较低</td>
</tr>
<tr>
<td>开发透明</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>侵入式打包</td>
<td>无侵入</td>
<td>依赖侵入式</td>
<td>依赖侵入式</td>
<td>依赖侵入式</td>
<td>依赖侵入式</td>
<td>依赖侵入式</td>
</tr>
<tr>
<td>补丁包大小</td>
<td>小</td>
<td>较小</td>
<td>较大</td>
<td>一般</td>
<td>一般</td>
<td>较大</td>
</tr>
<tr>
<td>Rom体积</td>
<td>较小</td>
<td>Dalvik较大</td>
<td>较小</td>
<td>较小</td>
<td>较小</td>
<td>大</td>
</tr>
<tr>
<td>成功率</td>
<td>高</td>
<td>较高</td>
<td>较高</td>
<td>一般</td>
<td>最高</td>
<td>较高</td>
</tr>
<tr>
<td>热度</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>开源</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>收费</td>
<td>收费（设有免费阈值）</td>
<td>收费（基础版免费，但有限制）</td>
<td>免费</td>
<td>免费</td>
<td>免费</td>
<td>免费</td>
</tr>
<tr>
<td>监控</td>
<td>提供分发控制及监控</td>
<td>提供分发控制及监控</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
</tr>
</tbody>
</table>
<h2 id="Tinker"><a href="#Tinker" class="headerlink" title="Tinker"></a>Tinker</h2><p>dex合成替换</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>开源</li>
<li>补丁包小</li>
<li>功能全面</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><h4 id="接入复杂"><a href="#接入复杂" class="headerlink" title="接入复杂"></a>接入复杂</h4><p>目前最快捷的集成方式是 集成 bugly 升级sdk。</p>
<p>需要的工作</p>
<ul>
<li>代理 Application</li>
<li>接入 tinker-support 插件</li>
<li>编写tinker gradle 脚本</li>
</ul>
<h4 id="打包复杂"><a href="#打包复杂" class="headerlink" title="打包复杂"></a>打包复杂</h4><p>每次打包需要修改tinker gradle 脚本的配置</p>
<h4 id="补丁激活成功率低"><a href="#补丁激活成功率低" class="headerlink" title="补丁激活成功率低"></a>补丁激活成功率低</h4><p>测试下来发现激活成功率 大概 60%</p>
<h4 id="补丁合成dex性能消耗大"><a href="#补丁合成dex性能消耗大" class="headerlink" title="补丁合成dex性能消耗大"></a>补丁合成dex性能消耗大</h4><p>主流配置的机器，平均合成时间 1800秒</p>
<h3 id="价格"><a href="#价格" class="headerlink" title="价格"></a>价格</h3><p>基础版 免费：最大补丁大小:500k  日请求量 &lt;1万</p>
<p>专业版 399 - 2899元/月</p>
<h2 id="Sophix"><a href="#Sophix" class="headerlink" title="Sophix"></a>Sophix</h2><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul>
<li>补丁即时生效，不需要应用重启；</li>
<li>补丁包同样采用差量技术，生成的PATCH体积小；</li>
<li>对应用无侵入，几乎无性能损耗；</li>
<li>两行代码，傻瓜式接入。</li>
</ul>
<h3 id="价格-1"><a href="#价格-1" class="headerlink" title="价格"></a>价格</h3><p>免费阈值：月活设备(MAU): 5万。</p>
<p>每个月，每台设备收费0.015元。</p>
<p>计费周期：系统每日生成账单，进行结算。当月收取过的，不再进行收费。即只计算日增量设备</p>
<h2 id="Robust"><a href="#Robust" class="headerlink" title="Robust"></a>Robust</h2><p>java hook 插桩</p>
<h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><ul>
<li>无差别兼容Android2.3-8.0版本；</li>
<li>无需重启补丁实时生效，</li>
<li>补丁修补成功率高达99.9%(所有热修复方案中成功率最高的）</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>只支持方法级别的Bug修复，不支持资源及so</li>
<li>bug修复通过java hook 代码实现</li>
<li>补丁的下发和合并等需要自己实现</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果考虑付费，推荐选择阿里的Sophix，Sophix是综合优化的产物，功能完善、开发简单透明、提供分发及监控管理。</p>
<p>如果不考虑付费，只需支持方法级别的Bug修复，不支持资源及so，推荐使用Robust。补丁修补成功率高达99.9%(所有热修复方案中成功率最高的）</p>
<p>如果考虑需要同时支持资源及so，使用Tinker。不建议使用，因为实现原理是 dex合成后替换，dex合成成功率不高(60%)</p>
<p>如果公司综合实力强，可考虑自研，灵活性及可控制最强。</p>
<p>从Github上的热度及提交记录上看，nuwa、AndFix、Amigo等的提交都是2 years ago。</p>
<h1 id="内业主要热修复技术方案原理"><a href="#内业主要热修复技术方案原理" class="headerlink" title="内业主要热修复技术方案原理"></a>内业主要热修复技术方案原理</h1><img src="/2019/08/12/Android/Android热修复技术选型/热修复原理.png">
<h1 id="代码热修复方案的两个方向"><a href="#代码热修复方案的两个方向" class="headerlink" title="代码热修复方案的两个方向"></a>代码热修复方案的两个方向</h1><p><strong>底层替换和类加载(dex插入/替换)</strong></p>
<p>类加载有两种实现：dexElements和替换dex；所以又称三大流派</p>
<p>美团 Robust 这种 java方法插桩hook的，只能实现代码修复，无法实现资源和so修复；所以不在常规讨论范围内。</p>
<h2 id="底层替换方案"><a href="#底层替换方案" class="headerlink" title="底层替换方案"></a>底层替换方案</h2><p>代表：阿里系的 Andfix HotFix</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><img src="/2019/08/12/Android/Android热修复技术选型/底层替换.png">
<ul>
<li>通过Andfix提供的工具对比出新旧apk 的 <code>classes.dex</code> 文件的差异，并生成patch压缩包(jar包)</li>
<li>压缩包中比较关键的是 <code>PATCH.MF</code> (补丁类名)和 <code>diff.dex</code> (补丁方法)</li>
<li>虚拟机通过 jar包 读取 补丁类名和补丁方法</li>
<li>通过classLoader，找到要修复的bug类名及方法</li>
<li>利用hook技术，在native修改指ArtMethod针变量，使其指向补丁方法，从而完成bug修复。</li>
</ul>
<h3 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h3><p>在类加载后，动态修改native指针，修复即时生效，无需冷启动</p>
<h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>类已经被加载，内存中方法描述符(结构体)已经固定，所以<strong>只能替换，不能做新增修复</strong>。</li>
<li>在Native操作指针时，强转ArtMethod的类型是AndFix写死的，无法保证是运行时的ArtMethod结构，这会产生<strong>十分严重的兼容问题</strong><ul>
<li>实践发现Andfix <strong>修复成功率非常低</strong> ，时常出现崩溃，补丁无效的现象</li>
</ul>
</li>
</ul>
<h2 id="类加载方案"><a href="#类加载方案" class="headerlink" title="类加载方案"></a>类加载方案</h2><p>代表：腾讯系的 Qzone超级补丁(dex插入) Tinker(dex替换)</p>
<h3 id="dex插入"><a href="#dex插入" class="headerlink" title="dex插入"></a>dex插入</h3><p>增量Dex</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><img src="/2019/08/12/Android/Android热修复技术选型/dex插入.png">
<ul>
<li>Hook ClassLoader.pathList.dexElements[]</li>
<li>将补丁的dex插入到数组的最前端。</li>
<li>ClassLoader的findClass是通过遍历dexElements[]中的dex来寻找类的。所以会优先查找到修复的类。从而达到修复的效果。</li>
</ul>
<h5 id="VM规则判断"><a href="#VM规则判断" class="headerlink" title="VM规则判断"></a>VM规则判断</h5><p>Vm的判定规则：“当一个类中引用了另外一个类，则一般要求两个类来自同一个Dex文件”。</p>
<p><code>CLASS_ISPREVERIFIED</code> 是触发Vm判定规则的前提。</p>
<img src="/2019/08/12/Android/Android热修复技术选型/VM规则判断.png">
<p>增量方案为解决这个问题，需要进行“打桩”。</p>
<p>打桩的目的就是防止类被打上 <code>CLASS_ISPREVERIFIED</code> 标签。</p>
<p>打桩，就是在所有类中分别引用另外一个独立Dex文件(为了打桩特意封装的)中的类。通常做法是在每一个类中增加构造器并引用另外一个dex中的类。</p>
<p>在类加载的最后阶段，虚拟机会对未打上 <code>CLASS_ISPREVERIFIED</code> 标签的类 再次进行 <strong>校验和优化</strong> ，如果在同一时间点加载大量类，那么就会出现严重的性能问题，如启动时白屏。</p>
<h4 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h4><ul>
<li>不需要考虑对dalvik虚拟机和art虚拟机做适配</li>
<li>代码是非侵入式的，对apk体积影响不大</li>
</ul>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>需要下次启动才修复</li>
<li><strong>性能损耗大</strong>，为了避免类被加上 <code>CLASS_ISPREVERIFIED</code>，使用插桩，单独放一个帮助类在独立的dex中让其他类调用。可能导致严重的性能问题，如启动时白屏。</li>
</ul>
<h3 id="dex替换"><a href="#dex替换" class="headerlink" title="dex替换"></a>dex替换</h3><p>全量Dex替换</p>
<h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><img src="/2019/08/12/Android/Android热修复技术选型/dex替换.png">
<p>为了避免dex插桩带来的性能损耗，dex替换采取另外的方式(整体替换dex)。</p>
<ul>
<li>提供dex差量包(只包含patch代码的dex)</li>
<li>将patch.dex与应用的classes.dex合并成一个完整的dex</li>
<li>加载完整dex得到dexFile对象作为参数构建一个Element对象</li>
<li>整体替换掉旧的dex-Elements数组</li>
</ul>
<h4 id="优点-5"><a href="#优点-5" class="headerlink" title="优点"></a>优点</h4><p>相比 dex插入，dex替换的优点</p>
<p>减少了dex插桩带来的性能损耗</p>
<h4 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h4><p>Dex合并内存消耗在<strong>虚拟机堆内存</strong>(vm heap)上，容易OOM，最后导致合并失败</p>
<h2 id="两种方案总结"><a href="#两种方案总结" class="headerlink" title="两种方案总结"></a>两种方案总结</h2><p>底层替换存在不同定制Rom的<strong>兼容性</strong>问题，同时<strong>不能做新增field</strong>的修复，但修复<strong>立即生效</strong>。</p>
<p>类加载方案在合成全量补丁的时候存在<strong>性能问题</strong>，修复需要<strong>重启</strong>应用(冷启动)，但是<strong>兼容性较好</strong>。</p>
<h1 id="Sophix-代码热修复-双剑合璧"><a href="#Sophix-代码热修复-双剑合璧" class="headerlink" title="Sophix 代码热修复-双剑合璧"></a>Sophix 代码热修复-双剑合璧</h1><p>Sophix对类文件修复 采用底层替换方案为主，类加载方案为次(兜底策略)的模式，将二者结合起来，并对二者另辟蹊径，加以突破。</p>
<h2 id="基于底层替换方案的突破"><a href="#基于底层替换方案的突破" class="headerlink" title="基于底层替换方案的突破"></a>基于底层替换方案的突破</h2><p>底层替换方案通过在运行时利用hook操作native指针实现“热”的特性。但这里有一个关键点，底层替换所操作的指针，实际上是 <code>ArtMethod</code> 。</p>
<p>在类被加载，类中的每个方法都会有对应的ArtMethod，它记录了<strong>方法包括所属类和内存地址信息</strong></p>
<p>Andfix正是通过篡改ArtMethod，将补丁方法ArtMethod的成员值逐一赋给旧方法，实现替换。</p>
<p>问题就出现在 <strong>逐一替换</strong> 上。因为Andfix的 <code>ArtMethod</code> 方法结构是根据Android开源代码写死的，面对国内厂商的定制，经常会导致两者ArtMethod方法结构不一致，这也是兼容问题产生的根本原因。</p>
<p>为了解决这个问题，Sophix采用了对旧ArtMethod进行 <strong>完整替换</strong>。</p>
<p>通过动态测量ArtMethod的size（通过c层的mempy(dest ,src ,size)方法），进行全量拷贝。这样做无论ArtMethod被修改成什么样，只需要统一执行拷贝，就可以完成替换，完全无视修改虚拟机导致的ArtMethod结构差异。</p>
<h2 id="另辟蹊径的冷启动修复"><a href="#另辟蹊径的冷启动修复" class="headerlink" title="另辟蹊径的冷启动修复"></a>另辟蹊径的冷启动修复</h2><p>底层替换虽能使修复即时生效，但由于类加载后，<strong>方法结构已固定</strong>，这就造成使用上会有诸多限制。</p>
<p>相反类加载方案的使用场景更为广泛。</p>
<p>Sophix使用类加载作为兜底方案。在热部署无法使用的情况下，自动降级为冷部署方案。</p>
<p>无论是冷部署还是热部署，都需要通过同一套补丁兼顾。</p>
<h3 id="Art虚拟机"><a href="#Art虚拟机" class="headerlink" title="Art虚拟机"></a>Art虚拟机</h3><p>在Art虚拟机下，默认支持多dex加载，虚拟机会优先加载命名为classes.dex的文件。</p>
<p>Sophix利用了这一点，将补丁文件命名为classes.dex，并对原有dex文件进行排序。这样一来，art虚拟机就会先加载补丁文件，后续加载的同类名的类会被忽略，最后将加载得到的dexFile把dexElements整体替换。</p>
<img src="/2019/08/12/Android/Android热修复技术选型/sophix-art.png">
<h3 id="Dalvik虚拟机"><a href="#Dalvik虚拟机" class="headerlink" title="Dalvik虚拟机"></a>Dalvik虚拟机</h3><p>Dalvik默认只加载classes.dex，其他dex则被忽略。</p>
<p>Sophix就需要一个全量dex。</p>
<p>tinker采用自主研发的dexDiff技术，从方法和指令的维度进行dex<strong>合成</strong>，但Dex合成过程发生在虚拟机堆内存上，修复的成功率极大的受到性能问题的影响。</p>
<p>为了解决这个问题，Sophix换了一种思路，从类的维度，对照补丁包中出现的类，在原有包中做<strong>删除</strong>操作。为了避免删除整个类信息而导致dex结构发生偏移，所以只对旧包中类的入口进行删除，实际上类的信息还在dex包中。这样一来，冷启动后，原有的类就不会被加载，相比Tinker的合成方案，Sophix的思路更为<strong>轻量化</strong>。<br><img src="/2019/08/12/Android/Android热修复技术选型/sophix-dalvik.png"></p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>至此，Sophix对类文件修复的基本原理描述完毕。</p>
<p>可以说Sophix吸取了百家之长，对问题的解决之法堪称巧妙，展现出底层技术的重要性，若没有对虚拟机等底层技术的深耕探索，在系统框架的纷繁规则面前，也只能至于庭前止步。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/6ae1e09ebbf5" target="_blank" rel="noopener">Android热修复技术，你会怎么选？</a></li>
<li><a href="https://www.jianshu.com/p/853dae4092d7" target="_blank" rel="noopener">两种热修复方案及Sophix原理</a></li>
<li><a href="http://mp.weixin.qq.com/s/uY5N_PSny7_CHOgUA99UjA?spm=a2c4g.11186623.2.13.16023a3cQhCyHh" target="_blank" rel="noopener">Android热修复技术选型——三大流派解析</a></li>
<li><a href="http://www.tinkerpatch.com/Docs/intro" target="_blank" rel="noopener">为什么使用 Tinker？</a></li>
<li><a href="https://help.aliyun.com/document_detail/51416.html?spm=a2c4g.11186623.6.543.6ed62ef2MAnXZM" target="_blank" rel="noopener">Sophix产品优势</a></li>
<li><a href="http://www.tinkerpatch.com/Price" target="_blank" rel="noopener">Tinker 价格</a></li>
<li><a href="https://help.aliyun.com/document_detail/57064.html?spm=a2c4g.11186623.3.2.7c44140cp41XQl" target="_blank" rel="noopener">Sophix 价格</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/Android/Dagger2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/10/Android/Dagger2/" itemprop="url">Dagger2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-10T20:25:53+08:00">
                2019-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Dagger2 是一个依赖注入框架</p>
<p>是Dagger的升级版，agger由Square公司开源；Dagger2 由 Google接手维护</p>
<p>是首个使用生成代码实现完整依赖注入的框架，极大减少了使用者的编码负担。</p>
<p>Dagger 得名于树状结构的依赖。能更准确地记住这是个依赖图，实际上是<strong>有向无环图</strong>，DAG（Directed Acyclic Graph）有向无环图，因此取名为 <strong>DAGger</strong></p>
<h1 id="为什么要依赖注入"><a href="#为什么要依赖注入" class="headerlink" title="为什么要依赖注入"></a>为什么要依赖注入</h1><p>因为依赖注入是实现控制反转(IOC)的最常用方式。更多关于IOC的信息，参考IOC文章。</p>
<h1 id="Dagger2-原理"><a href="#Dagger2-原理" class="headerlink" title="Dagger2 原理"></a>Dagger2 原理</h1><img src="/2019/08/10/Android/Dagger2/Dagger.png">
<h2 id="Inject"><a href="#Inject" class="headerlink" title="Inject"></a>Inject</h2><p>依赖提供者，注解依赖实例构造方法</p>
<p>依赖消费者，注解依赖实例对象</p>
<h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><p>通过Inject，目标类中所依赖的其他类与其他类的构造函数之间有了一种无形的联系。</p>
<p>但是要想使它们之间产生直接的关系，还得需要一个桥梁来把它们之间连接起来。那这个桥梁就是Component了</p>
<p>Component 是一个 <strong>桥梁</strong> ，一个 <strong>容器</strong> ，一个 <strong>注入器</strong> (Injector)</p>
<p>主要工作：把目标类依赖的实例注入到目标类中，来初始化目标类中的依赖</p>
<p>调用Component的 <code>injectXXX(Object)</code>方法开始注入。(injectXXX方法名字是官方推荐的命名)</p>
<p>Component工作流程：</p>
<ul>
<li>查找目标类中用Inject注解标注的属性，</li>
<li>查找该属性对应的用Inject标注的构造函数</li>
<li>初始化该属性的实例</li>
<li>把实例赋值给目标类的属性。</li>
</ul>
<p>因此我们也可以给Component叫另外一个名字</p>
<img src="/2019/08/10/Android/Dagger2/Component.png">
<h2 id="Module-和-Provides"><a href="#Module-和-Provides" class="headerlink" title="Module 和 Provides"></a>Module 和 Provides</h2><p><strong>解决第三方类库依赖</strong></p>
<p>无法把Inject注解加入第三方类库的类中。</p>
<p>把封装第三方类库的代码放入 Module 中。所以 <strong>Module其实是一个简单工厂模式，Module里面的方法基本都是创建类实例的方法</strong> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuleClass</span></span>&#123;</span><br><span class="line">	<span class="comment">//A是第三方类库中的一个类</span></span><br><span class="line">	<span class="function">A <span class="title">provideA</span><span class="params">()</span></span>&#123;</span><br><span class="line">	   <span class="keyword">return</span> A();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="配置依赖"><a href="#配置依赖" class="headerlink" title="配置依赖"></a>配置依赖</h1><pre><code>compile &apos;com.google.dagger:dagger:2.24&apos;
annotationProcessor &apos;com.google.dagger:dagger-compiler:2.24&apos;
compile &apos;com.google.dagger:dagger-android:2.24&apos;
compile &apos;com.google.dagger:dagger-android-support:2.24&apos; // if you use the support libraries
annotationProcessor &apos;com.google.dagger:dagger-android-processor:2.24&apos;
</code></pre><h1 id="简单依赖注入"><a href="#简单依赖注入" class="headerlink" title="简单依赖注入"></a>简单依赖注入</h1><p>实例：在MainActivity中创建User对象。</p>
<h2 id="Module-–-构建依赖（依赖提供者）"><a href="#Module-–-构建依赖（依赖提供者）" class="headerlink" title="Module – 构建依赖（依赖提供者）"></a>Module – 构建依赖（依赖提供者）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Module这是一个Module，@Provides这是一个提供依赖的方法</p>
<h2 id="Component-–-injector（连接-依赖提供者和依赖消费者）"><a href="#Component-–-injector（连接-依赖提供者和依赖消费者）" class="headerlink" title="Component – injector（连接 依赖提供者和依赖消费者）"></a>Component – injector（连接 依赖提供者和依赖消费者）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>inject方法需要一个真正消耗依赖的类型对象(而不可以写成其父类)作为参数。
因为dagger2在编译时生成依赖注入的代码，会到inject方法的参数类型中寻找可以注入的对象
dagger2会自动生成类实现该接口
</code></pre><h2 id="使用依赖注入"><a href="#使用依赖注入" class="headerlink" title="使用依赖注入"></a>使用依赖注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"> 	<span class="meta">@Inject</span></span><br><span class="line"> 	User mUser;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        </span><br><span class="line">        UserComponent userComponent = DaggerUserComponent.builder().userModule(<span class="keyword">new</span> UserModule()).build();</span><br><span class="line">        userComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        TextView viewById = (TextView) findViewById(R.id.textView);</span><br><span class="line">        viewById.setText(mUser.name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Inject标识被注入的对象User（注意User不能为private，否则会报错）</p>
<pre><code>Error:(12, 18) 错误: Dagger does not support injection into private fields
注: Generating a MembersInjector or Factory for com.example.test2.MainActivity. Prefer to run the dagger processor over that class instead.
</code></pre><p>通过类 <code>DaggerActivityComponent</code> 创建component，调用其inject方法完成注入</p>
<pre><code>DaggerUserComponent 是dagger2自动生成，实现了我们提供的 UserComponent 接口。
目录在build/generated/sources/apt/下 （可对生成的文件加断点调试，理解整个过程）
</code></pre><h1 id="Dagger2-调试"><a href="#Dagger2-调试" class="headerlink" title="Dagger2 调试"></a>Dagger2 调试</h1><p>Dagger2实现原理：<strong>注解 + 编译时处理</strong>，为了性能考虑，没有使用反射</p>
<p>build后生成的代码目录在 <code>build/generated/sources/apt/</code> 下，可对生成的文件加断点调试，理解整个过程</p>
<p>比如 DaggerUserComponent 是dagger2自动生成，实现了我们提供的 UserComponent 接口。</p>
<h1 id="构建依赖-依赖提供者-两种方法"><a href="#构建依赖-依赖提供者-两种方法" class="headerlink" title="构建依赖(依赖提供者)两种方法"></a>构建依赖(依赖提供者)两种方法</h1><h2 id="Inject-类构造方法"><a href="#Inject-类构造方法" class="headerlink" title="@Inject 类构造方法"></a>@Inject 类构造方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个类只能有一个构造方法有@inject注解。否则报错 <code>Types may only contain one @Inject constructor.</code></p>
<p>不够灵活，只能注解一个构造方法。</p>
<h2 id="Module-和-Provides-1"><a href="#Module-和-Provides-1" class="headerlink" title="@Module 和 @Provides"></a>@Module 和 @Provides</h2><p><strong>解决第三方类库类实例问题</strong></p>
<p><strong>工厂模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>两种方法必选其一，编译期才能生成构造User对象的方法。否则会报错（注入依赖失败）</p>
<pre><code>Error:(7, 10) 错误: com.example.test2.User cannot be provided without an @Inject constructor or from an @Provides- or @Produces-annotated method.
com.example.test2.MainActivity.user
[injected field of type: com.example.test2.User user]
</code></pre><p>@Inject 不够灵活。一个依赖提供者类只能有一个@Inject注解的构造方法，不能提供接口和三方库中类的依赖</p>
<p>@Module非常灵活，能提供接口和三方库中类的依赖</p>
<p>@Module优先级也高于@inject（@Module中找到了依赖就不会到@ Inject中找）</p>
<p>dagger会自动查找并注入依赖类的依赖（如果能找到依赖提供者），比如上面 ShoppingCar依赖的User</p>
<h1 id="注入依赖三种方法"><a href="#注入依赖三种方法" class="headerlink" title="注入依赖三种方法"></a>注入依赖三种方法</h1><h2 id="inject-配合Component接口实现类的inject方法。"><a href="#inject-配合Component接口实现类的inject方法。" class="headerlink" title="@inject 配合Component接口实现类的inject方法。"></a>@inject 配合Component接口实现类的inject方法。</h2><p>inject方法一调用就 <strong>马上生成依赖对象</strong></p>
<pre><code>@Inject
User mUser;//不可私有，否则注入失败

protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    UserComponent userComponent = DaggerUserComponent.builder().userModule(new UserModule()).build();
    userComponent.inject(this);
    viewById.setText(mUser.name);
}
</code></pre><h2 id="调用Component接口实现类的-返回依赖对象的方法"><a href="#调用Component接口实现类的-返回依赖对象的方法" class="headerlink" title="调用Component接口实现类的 返回依赖对象的方法"></a>调用Component接口实现类的 返回依赖对象的方法</h2><p><strong>使用时生成依赖对象</strong></p>
<p><strong>科学，推荐使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;<span class="comment">//如果User对象不需要直接注入到其他类中(即UserComponent是其他Component的依赖Component)可以不需要inject方法</span></span><br><span class="line">    <span class="function">User <span class="title">user</span><span class="params">()</span></span>;<span class="comment">//调用该方法返回User对象</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UserComponent userComponent = DaggerUserComponent.builder().userModule(<span class="keyword">new</span> UserModule()).build();</span><br><span class="line">viewById.setText(userComponent.user().name);</span><br></pre></td></tr></table></figure>
<h2 id="inject-Lazy泛型"><a href="#inject-Lazy泛型" class="headerlink" title="@inject Lazy泛型"></a>@inject Lazy泛型</h2><p><strong>使用时生成依赖对象</strong></p>
<pre><code>@Inject
Lazy&lt;User&gt; mUser;//不可私有，否则注入失败

protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    UserComponent userComponent = DaggerUserComponent.builder().userModule(new UserModule()).build();
    userComponent.inject(this);
    viewById.setText(mUser.get().name);//通过get方法得到User对象
}
</code></pre><h1 id="注入依赖的步骤"><a href="#注入依赖的步骤" class="headerlink" title="注入依赖的步骤"></a>注入依赖的步骤</h1><p>注入依赖的步骤，其实是一个递归的过程</p>
<ul>
<li>步骤1：查找Module中是否存在创建该类的方法。</li>
<li>步骤2：若Module中找到，查看该方法是否存在参数<ul>
<li>步骤2.1：若存在参数，则按从<strong>步骤1</strong>开始依次初始化每个参数</li>
<li>步骤2.2：若不存在参数，则直接初始化该类实例，一次依赖注入到此结束</li>
</ul>
</li>
<li>步骤3：若Module中未找到，则查找Inject注解的构造函数</li>
<li>步骤4：若找到Inject注解的构造函数，看构造函数是否存在参数<ul>
<li>步骤4.1：若存在参数，则从<strong>步骤1</strong>开始依次初始化每个参数</li>
<li>步骤4.2：若不存在参数，则直接初始化该类实例，一次依赖注入到此结束</li>
</ul>
</li>
<li>步骤5：若找不到Inject注解的构造函数，报错</li>
</ul>
<h1 id="Qualifier-限定符"><a href="#Qualifier-限定符" class="headerlink" title="@Qualifier 限定符"></a>@Qualifier 限定符</h1><p>解决 <strong>依赖迷失</strong> 问题(同一纬度/优先级 的 依赖提供者 依靠类型无法确定依赖唯一性)</p>
<p>即：当 <code>@Provides</code> 返回一种类型的方法有多个(两个及以上)，需要@Qualifier来区分。否则报错 。比如：String依赖无法确定唯一性，<code>java.lang.String is bound multiple times:</code></p>
<p>Module类 和 目标类 同时使用 @Qualifier 限定符，解决依赖迷失</p>
<p>@Qualifier 不能用于构造方法。否则报错 <code>@Qualifier annotations are not allowed on @Inject constructors.</code></p>
<h2 id="Named"><a href="#Named" class="headerlink" title="@Named"></a>@Named</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Named &#123;</span><br><span class="line">    <span class="comment">/** The name. */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义-Qualifier"><a href="#自定义-Qualifier" class="headerlink" title="自定义@Qualifier"></a>自定义@Qualifier</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserRole &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@UserRole</span>(<span class="string">"admin"</span>)</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideAdminUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"admin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserRole</span>(<span class="string">"teacher"</span>)</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideTeacherUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"teacher"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">目标类</span><br><span class="line"><span class="meta">@UserRole</span>(<span class="string">"admin"</span>)</span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line">User mAdminUser;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UserRole</span>(<span class="string">"teacher"</span>)</span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line">User mTeacherUser;</span><br></pre></td></tr></table></figure>
<h1 id="Component-划分方式"><a href="#Component-划分方式" class="headerlink" title="Component 划分方式"></a>Component 划分方式</h1><p>假如一个app中只有一个Component，那这个Component职责太多过于庞大，导致是很难维护、并且变化率是很高。所以需要划分为粒度小的Component。</p>
<p>划分粒度也不能太小了，定义过多的Component，管理、维护非常困难</p>
<p>合适划分的规则这样的：</p>
<ul>
<li>一个<strong>全局</strong>的Component(可以叫ApplicationComponent),负责管理整个app的全局类实例（全局类实例整个app都要用到的类的实例，这些类基本都是单例的）</li>
<li>每个<strong>页面</strong>对应一个Component。比如一个Activity页面定义一个Component，一个Fragment定义一个Component。有些页面之间的依赖的类是一样的，可以公用一个Component。</li>
</ul>
<h2 id="创建单例依赖的方法"><a href="#创建单例依赖的方法" class="headerlink" title="创建单例依赖的方法"></a>创建单例依赖的方法</h2><ol>
<li>在Module中定义创建全局类实例的方法（因为Module中找到了创建实例方法，就不会到Inject维度找了）</li>
<li>ApplicationComponent管理Module</li>
<li>保证ApplicationComponent只有一个实例（在app的Application中实例化ApplicationComponent）</li>
</ol>
<h1 id="Component-组织方式"><a href="#Component-组织方式" class="headerlink" title="Component 组织方式"></a>Component 组织方式</h1><p>按照上面的规则划分为不同的Component，全局类实例也创建了单例模式。问题来了其他的Component想要把全局的类实例注入到目标类中该怎么办呢？</p>
<p>这就涉及到<strong>类实例共享</strong>的问题了。</p>
<p>因为Component有管理创建类实例的能力，因此只要能很好的组织Component之间的关系，问题就好办了。</p>
<p>具体的组织方式分为以下3种：</p>
<h2 id="依赖方式"><a href="#依赖方式" class="headerlink" title="依赖方式"></a>依赖方式</h2><p>一个Component依赖于一个或多个Component</p>
<p>Component中的 <strong>dependencies</strong> 属性就是依赖方式的具体实现</p>
<h3 id="关键"><a href="#关键" class="headerlink" title="关键"></a>关键</h3><ul>
<li>高层Component 的 dependencies  属性 <strong>依赖</strong> 低层Component</li>
<li>低层Component 提供一个方法 返回依赖实例。(目的：<strong>显式暴露依赖</strong>)</li>
<li>使用：<ul>
<li>先初始化 低层Component</li>
<li>低层Component 作为参数初 始化高层Component</li>
<li>调用高层Component.inject() 注入 高层对象</li>
</ul>
</li>
</ul>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>高层Component只能使用低层Component显式暴露出来的依赖<ul>
<li>低层Component 需要写 抽象方法暴露依赖</li>
</ul>
</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>实例：MainActivity 依赖 User，User 依赖 ShoppingCart</p>
<p>低层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">ShoppingCart <span class="title">provideShoppingCart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShoppingCart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = ShoppingCartModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShoppingCartComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">//void inject(MainActivity mainActivity);//不需要直接注入到目标类中(即ShoppingCartComponent是其他Component的依赖Component)就不需要inject方法。有的话会报错找不到依赖</span></span><br><span class="line">    <span class="function">ShoppingCart <span class="title">offerShoppingCart</span><span class="params">()</span></span>;<span class="comment">//新增一个方法提供依赖对象。低层 Component 需要一个方法提供依赖对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>高层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">(ShoppingCart shoppingCart)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(shoppingCart);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = UserModule.class, dependencies = ShoppingCartComponent.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    User mUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        ShoppingCartComponent shoppingCartComponent = DaggerShoppingCartComponent.builder().shoppingCartModule(<span class="keyword">new</span> ShoppingCartModule()).build();</span><br><span class="line">        UserComponent userComponent = DaggerUserComponent.builder().userModule(<span class="keyword">new</span> UserModule()).shoppingCartComponent(shoppingCartComponent).build();</span><br><span class="line">        userComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        ((TextView) findViewById(R.id.text)).setText(mUser.name + <span class="string">" "</span> + mUser.mShoppingCart.total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Component接口的inject方法</strong> 参数类型必须是真实使用注入依赖的类对象。而且<strong>一个类对象只能对应一个inject方法</strong>。</p>
<pre><code>比如 UserComponent 的inject(MainActivity activity)，ShoppingCarComponent 的 inject(MainActivity activity) 就会报错，两个inject指向同一个对象
    Error:(7, 10) 错误: com.example.test2.User cannot be provided without an @Inject constructor or from an @Provides- or @Produces-annotated method.
    com.example.test2.MainActivity.user
    [injected field of type: com.example.test2.User user]
其实是有提供依赖的，真正的原因就是两个inject指向MainActivity activity这同一个对象。
app\build\generated\source\apt\目录下会生成 MainActivity_MembersInjector.java
</code></pre><p><strong>UserComponent必须初始化依赖的shoppingCartComponent和userModule，否则会报错</strong></p>
<pre><code>Caused by: java.lang.IllegalStateException: shoppingCartComponent must be set 
    at com.example.testdagger2. DaggerUserComponent$Builder.build(DaggerUserComponent.java:55)
</code></pre><h2 id="包含方式-继承方式"><a href="#包含方式-继承方式" class="headerlink" title="包含方式(继承方式)"></a>包含方式(继承方式)</h2><p>一个Component包含一个或多个Component的，被包含的Component还可以继续包含其他的Component。</p>
<p>这种方式特别像Activity与Fragment的关系。</p>
<p><strong>推荐使用，实际使用更加广泛</strong></p>
<p><strong>SubComponent</strong> 就是包含方式的具体实现。子Component，可以理解为 <strong>继承或者拓展</strong>(比较好理解)</p>
<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>@Subcomponent注解不会在编译后生成Dagger前缀的容器类，而是体现在父@Component的<strong>私有内部类</strong>，并且如何在父@Component中构建@Subcomponent都需要我们自己写(既然是继承关系，完全可以自动生成吧？)</li>
<li>父@Component的依赖是完全暴露<ul>
<li>不需要像依赖方式一样，在Component中显示声明暴露</li>
</ul>
</li>
</ul>
<h3 id="建造者模式-写法"><a href="#建造者模式-写法" class="headerlink" title="建造者模式 写法"></a>建造者模式 写法</h3><p>官方推荐写法</p>
<p>建造者模式套路(不熟悉的可以参照生成的Dagger前缀的容器类)：</p>
<ul>
<li>builder()生成Builder对象</li>
<li>传入@Module对象</li>
<li>调用Builder对象的build()方法生成@Component实例</li>
</ul>
<h4 id="关键-1"><a href="#关键-1" class="headerlink" title="关键"></a>关键</h4><ul>
<li>包含者Subcomponent，改造成 <strong>标准的建造者</strong><ul>
<li>定义一个内部接口。(标准的建造者。接口名一般是 Builder；)<ul>
<li>用@Subcomponent.Builder注解</li>
<li>接口提供方法构建 Subcomponent</li>
</ul>
</li>
</ul>
</li>
<li>被包含者Module 的 subcomponents 属性 把实例共享/暴露给 包含者Subcomponent<ul>
<li>目的：定义 <strong>继承关系</strong> 。把父Component的<strong>依赖全部暴露</strong>给Subcomponent </li>
</ul>
</li>
<li>被包含者Component 提供一个方法 返回 包含者的建造者Subcomponent.Builder<ul>
<li>目的：定义 <strong>继承关系</strong> 。</li>
<li>通过这个方法父Component可以生成自己的私有内部类Subcomponent</li>
</ul>
</li>
<li>使用：<ul>
<li>先初始化 被包含者Component</li>
<li>被包含者Component 使用包含者的建造者 构造 包含者Subcomponent</li>
<li>调用包含者Subcomponent.inject() 注入 包含者对象</li>
</ul>
</li>
</ul>
<h4 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h4><ul>
<li>父Component 在检测到 子Component.Builder 返回值方法</li>
<li>检测子Component类与其内部类的注解</li>
<li>如果是@Subcomponent注解，会在父Component的实现类里维护子Component类与其内部类的实现类</li>
<li>如果子Component使用了父Component的依赖，则检测父Module有没有注解开放“权限”。</li>
</ul>
<h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><p>实例：MainActivity 依赖 User，User 包含 ShoppingCart</p>
<p>被包含者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(subcomponents = UserComponent.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">ShoppingCart <span class="title">provideShoppingCart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShoppingCart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = ShoppingCartModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShoppingCartComponent</span> </span>&#123;</span><br><span class="line">    UserComponent.<span class="function">Builder <span class="title">buildUserComponent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>包含者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">(ShoppingCart shoppingCart)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(shoppingCart);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subcomponent</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="function">UserComponent <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    User mUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        ShoppingCartComponent shoppingCartComponent = DaggerShoppingCartComponent.builder().shoppingCartModule(<span class="keyword">new</span> ShoppingCartModule()).build();</span><br><span class="line">        UserComponent userComponent = shoppingCartComponent.buildUserComponent().build();</span><br><span class="line">        userComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        ((TextView) findViewById(R.id.text)).setText(mUser.name + <span class="string">" "</span> + mUser.mShoppingCart.total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="抽象工厂方法模式-写法"><a href="#抽象工厂方法模式-写法" class="headerlink" title="抽象工厂方法模式 写法"></a>抽象工厂方法模式 写法</h3><p>抽象工厂方法写法 则 相对简单粗暴</p>
<ul>
<li>包含者Subcomponent</li>
<li>被包含者Component 提供一个方法 返回 包含者Subcomponent<ul>
<li>抽象工厂方法</li>
<li>目的：定义 <strong>继承关系</strong></li>
</ul>
</li>
<li>使用：<ul>
<li>先初始化 被包含者Component</li>
<li>被包含者Component 利用抽象工厂方法 构造 包含者Subcomponent</li>
<li>调用包含者Subcomponent.inject() 注入 包含者对象</li>
</ul>
</li>
</ul>
<p>被包含者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">ShoppingCart <span class="title">provideShoppingCart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShoppingCart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(modules = ShoppingCartModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShoppingCartComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">UserComponent <span class="title">buildUserComponent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>包含者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">(ShoppingCart shoppingCart)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(shoppingCart);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subcomponent</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    User mUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        ShoppingCartComponent shoppingCartComponent = DaggerShoppingCartComponent.builder().shoppingCartModule(<span class="keyword">new</span> ShoppingCartModule()).build();</span><br><span class="line">        UserComponent userComponent = shoppingCartComponent.buildUserComponent();</span><br><span class="line">        userComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        ((TextView) findViewById(R.id.text)).setText(mUser.name + <span class="string">" "</span> + mUser.mShoppingCart.total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="两种写法-总结"><a href="#两种写法-总结" class="headerlink" title="两种写法 总结"></a>两种写法 总结</h3><p>建造者模式 写法</p>
<ul>
<li>官方推荐</li>
<li>继承关系的声明更加显式。有两处<ul>
<li>父Module 的 subcomponents 属性</li>
<li>父Component 提供一个方法 返回 建造者Subcomponent.Builder </li>
</ul>
</li>
</ul>
<p>抽象工厂方法模式 写法</p>
<ul>
<li>简单粗暴</li>
<li>继承关系的声明不那么显式。<ul>
<li>父Component 提供一个方法 返回 Subcomponent</li>
</ul>
</li>
</ul>
<h2 id="继承方式"><a href="#继承方式" class="headerlink" title="继承方式"></a>继承方式</h2><p>官网没有提到该方式，因为该方式不是解决类实例共享的问题，而是为了更好 <strong>管理维护</strong> Component，把一些Component共有的方法抽象到一个父类中，然后子Component继承。</p>
<p>属于 Java中继承的使用</p>
<h1 id="Scope"><a href="#Scope" class="headerlink" title="@Scope"></a>@Scope</h1><p>真正用处就在于 <strong>可读性和管理Component</strong>。并<strong>没有实现真正功能</strong>(单例，Activity生命周期绑定这些都靠Component组织方式来实现)</p>
<ul>
<li>可读性提高。<ul>
<li>如用 <code>@Singleton</code> 标注全局类，立马就能明白这类是全局单例类。</li>
</ul>
</li>
<li>更好的管理Component与Module之间的匹配关系<ul>
<li>编译器会检查 Component管理的Modules，若发现两者标注的Scope注解不一样，就会报错。</li>
</ul>
</li>
<li>更好的管理Component间的组织方式<ul>
<li>有必要用自定义的不同Scope注解标注Component，通过Scope命名更好的体现出Component之间的组织方式。</li>
</ul>
</li>
</ul>
<p>自定义Scope注解最好使用上，虽然不使用也是可以让项目运行起来的，但是加上好处多</p>
<h1 id="使用Dagger2的好处"><a href="#使用Dagger2的好处" class="headerlink" title="使用Dagger2的好处"></a>使用Dagger2的好处</h1><p>最后，可以总结一下 使用Dagger2的好处</p>
<h2 id="增加开发效率、省去重复的简单体力劳动"><a href="#增加开发效率、省去重复的简单体力劳动" class="headerlink" title="增加开发效率、省去重复的简单体力劳动"></a>增加开发效率、省去重复的简单体力劳动</h2><h2 id="更好的管理类实例"><a href="#更好的管理类实例" class="headerlink" title="更好的管理类实例"></a>更好的管理类实例</h2><p>ApplicationComponent管理整个app的全局类实例，生命周期与app的生命周期一样</p>
<p>每个页面对应自己的Component，页面Component管理着自己页面所依赖的所有类实例</p>
<p>因为Component，Module，整个app的类实例结构变的很清晰。</p>
<h2 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h2><p>通过工厂模式Module创建类实例，这样即使类的构造函数发生变化，只需要修改Module即可</p>
<p>解耦还有个好处，就是<strong>方便测试</strong>，若需要替换为网络测试类，只需要修改相应的Module即可</p>
<h1 id="Spring-IoC-和-Dagger2"><a href="#Spring-IoC-和-Dagger2" class="headerlink" title="Spring IoC 和 Dagger2"></a>Spring IoC 和 Dagger2</h1><h2 id="Spring-IoC"><a href="#Spring-IoC" class="headerlink" title="Spring IoC"></a>Spring IoC</h2><p>实现原理：<strong>注解 + 反射</strong>，涉及动态生成类</p>
<p>用起来<strong>非常好上手</strong></p>
<p>提供依赖的，用@Component注解，需要依赖的地方 用@Autowired注解，配置文件加上component-scan就差不多了。 </p>
<p>因为接口可能有多个实现，也有@qualifier提供过滤 </p>
<h2 id="Dagger2"><a href="#Dagger2" class="headerlink" title="Dagger2"></a>Dagger2</h2><p>实现原理：<strong>注解 + 编译时处理</strong>，为了性能考虑，没有使用反射</p>
<p><strong>不好上手</strong></p>
<p>提供依赖的类用@Module注解 能提供的依赖用@Provide注解,需要依赖的地方 用@Inject注解，<br>最终要靠手动调用@Compoent的inject方法完成依赖的注入。 </p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/google/dagger" target="_blank" rel="noopener">github</a></li>
<li><a href="http://www.tuicool.com/articles/viQz2uF" target="_blank" rel="noopener">使用dagger2进行依赖注入</a></li>
<li><a href="https://www.jianshu.com/p/b989e2cb88f6" target="_blank" rel="noopener">Android Dagger2 从零单排(四) Dependencies与SubComponent</a></li>
<li><a href="https://www.jianshu.com/p/cd2c1c9f68d4" target="_blank" rel="noopener">dagger2系列 - 基础框架篇</a> - 基础框架篇</li>
<li><a href="https://www.jianshu.com/p/1d42d2e6f4a5" target="_blank" rel="noopener">dagger2系列 - 重点概念讲解、融合篇</a> - 细节完善</li>
<li><a href="https://www.jianshu.com/p/65737ac39c44" target="_blank" rel="noopener">dagger2系列 - 终结篇</a> - 实践总结</li>
<li><a href="http://blog.csdn.net/wangkai0681080/article/details/50868355" target="_blank" rel="noopener">Dagger2 学习笔记</a> - spring ioc 和 Dagger2 使用对比</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/直播/ijkplayer/ijkplayer系列六-音视频同步/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/直播/ijkplayer/ijkplayer系列六-音视频同步/" itemprop="url">ijkplayer系列六-音视频同步</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-08T14:22:14+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="音视频同步"><a href="#音视频同步" class="headerlink" title="音视频同步"></a>音视频同步</h1><p>对于播放器来说，音视频同步是一个关键点，同时也是一个难点，同步效果的好坏，直接决定着播放器的质量。</p>
<p>通常音视频同步的解决方案就是选择一个<strong>参考时钟</strong>，播放时读取音视频帧上的时间戳，同时参考当前时钟的时间来安排播放。如下图所示：</p>
<img src="/2019/08/08/直播/ijkplayer/ijkplayer系列六-音视频同步/音视频同步示意图.png">
<p>如果音视频帧的播放时间大于当前参考时钟上的时间，则不急于播放该帧，直到参考时钟达到该帧的时间戳；如果音视频帧的时间戳小于当前参考时钟上的时间，则需要“尽快”播放该帧或丢弃，以便播放进度追上参考时钟。</p>
<h2 id="参考时钟的选择"><a href="#参考时钟的选择" class="headerlink" title="参考时钟的选择"></a>参考时钟的选择</h2><p>有多种方式：</p>
<ul>
<li>选取视频时间戳作为参考时钟源</li>
<li>选取音频时间戳作为参考时钟源</li>
<li>选取外部时间作为参考时钟源</li>
</ul>
<p>考虑人对视频、和音频的敏感度，在存在音频的情况下，<strong>优先选择音频</strong>作为主时钟源。</p>
<p>ijkplayer在<strong>默认</strong>情况下是使用<strong>音频</strong>作为参考时钟源</p>
<h2 id="保存播放音频帧时间"><a href="#保存播放音频帧时间" class="headerlink" title="保存播放音频帧时间"></a>保存播放音频帧时间</h2><p>每播放一帧音频都将这一帧的播放时间保存在 <code>Video_State</code> 这个结构体的 <code>audio_clock</code> 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">audio_decode_frame</span><span class="params">(FFPlayer *ffp)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!(af = frame_queue_peek_readable(&amp;is-&gt;sampq)))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* update the audio clock with the pts */</span></span><br><span class="line">    <span class="keyword">if</span> (!isnan(af-&gt;pts))</span><br><span class="line">        is-&gt;audio_clock = af-&gt;pts + (<span class="keyword">double</span>) af-&gt;frame-&gt;nb_samples / af-&gt;frame-&gt;sample_rate;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        is-&gt;audio_clock = NAN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理保存的音频帧时间"><a href="#处理保存的音频帧时间" class="headerlink" title="处理保存的音频帧时间"></a>处理保存的音频帧时间</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sdl_audio_callback</span><span class="params">(<span class="keyword">void</span> *opaque, Uint8 *stream, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    audio_size = audio_decode_frame(ffp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!isnan(is-&gt;audio_clock)) &#123;</span><br><span class="line">        set_clock_at(&amp;is-&gt;audclk, </span><br><span class="line">                     is-&gt;audio_clock - (<span class="keyword">double</span>)(is-&gt;audio_write_buf_size) / is-&gt;audio_tgt.bytes_per_sec - SDL_AoutGetLatencySeconds(ffp-&gt;aout), </span><br><span class="line">                     is-&gt;audio_clock_serial, </span><br><span class="line">                     ffp-&gt;audio_callback_time / <span class="number">1000000.0</span>);</span><br><span class="line">        sync_clock_to_slave(&amp;is-&gt;extclk, &amp;is-&gt;audclk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>set_clock_at</code> 的第二个参数就是处理后的当前音频帧播放的秒数</p>
<h2 id="视频渲染同步"><a href="#视频渲染同步" class="headerlink" title="视频渲染同步"></a>视频渲染同步</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">video_refresh_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FFPlayer *ffp = arg;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    <span class="keyword">double</span> remaining_time = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!is-&gt;abort_request) &#123;</span><br><span class="line">        <span class="keyword">if</span> (remaining_time &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">            av_usleep((<span class="keyword">int</span>)(<span class="keyword">int64_t</span>)(remaining_time * <span class="number">1000000.0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//REFRESH_RATE = 0.01</span></span><br><span class="line">        remaining_time = REFRESH_RATE;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;show_mode != SHOW_MODE_NONE </span><br><span class="line">            &amp;&amp; (!is-&gt;paused || is-&gt;force_refresh))</span><br><span class="line">            video_refresh(ffp, &amp;remaining_time);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>remaining_time</code> 是视频渲染线程需要同步时间(也就是sleep时间)，单位是us。通过 <code>video_refresh()</code> 计算出来。</p>
<h3 id="计算同步时间"><a href="#计算同步时间" class="headerlink" title="计算同步时间"></a>计算同步时间</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">video_refresh</span><span class="params">(FFPlayer *opaque, <span class="keyword">double</span> *remaining_time)</span></span>&#123;</span><br><span class="line">    FFPlayer *ffp = opaque;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    <span class="keyword">double</span> time;</span><br><span class="line"></span><br><span class="line">    Frame *sp, *sp2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is-&gt;paused </span><br><span class="line">        &amp;&amp; get_master_sync_type(is) == AV_SYNC_EXTERNAL_CLOCK </span><br><span class="line">        &amp;&amp; is-&gt;realtime) &#123;</span><br><span class="line">        check_external_clock_speed(is);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;display_disable </span><br><span class="line">        &amp;&amp; is-&gt;show_mode != SHOW_MODE_VIDEO </span><br><span class="line">        &amp;&amp; is-&gt;audio_st) &#123;</span><br><span class="line">        time = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;force_refresh </span><br><span class="line">            || is-&gt;last_vis_time + ffp-&gt;rdftspeed &lt; time) &#123;</span><br><span class="line">            video_display2(ffp);</span><br><span class="line">            is-&gt;last_vis_time = time;</span><br><span class="line">        &#125;</span><br><span class="line">        *remaining_time = FFMIN(*remaining_time, is-&gt;last_vis_time + ffp-&gt;rdftspeed - time);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;video_st) &#123;</span><br><span class="line">retry:</span><br><span class="line">        <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// nothing to do, no picture to display in the queue</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">double</span> last_duration, duration, delay;</span><br><span class="line">            Frame *vp, *lastvp;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* dequeue the picture */</span></span><br><span class="line">            lastvp = frame_queue_peek_last(&amp;is-&gt;pictq);</span><br><span class="line">            vp = frame_queue_peek(&amp;is-&gt;pictq);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 跳帧处理。</span></span><br><span class="line">            <span class="keyword">if</span> (vp-&gt;serial != is-&gt;videoq.serial) &#123;</span><br><span class="line">                frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastvp-&gt;serial != vp-&gt;serial) &#123;</span><br><span class="line">                is-&gt;frame_timer = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (is-&gt;paused)</span><br><span class="line">                <span class="keyword">goto</span> display;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* compute nominal last_duration */</span></span><br><span class="line">            <span class="comment">// 计算此帧的播放时长</span></span><br><span class="line">            last_duration = vp_duration(is, lastvp, vp);</span><br><span class="line">            <span class="comment">// 计算当前需要delay的时间。</span></span><br><span class="line">            delay = compute_target_delay(ffp, last_duration, is);</span><br><span class="line">            </span><br><span class="line">            time= av_gettime_relative()/<span class="number">1000000.0</span>;</span><br><span class="line">            av_gettime_relative(), is-&gt;frame_timer, delay);</span><br><span class="line">            <span class="keyword">if</span> (isnan(is-&gt;frame_timer) || time &lt; is-&gt;frame_timer) &#123;</span><br><span class="line">                is-&gt;frame_timer = time;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (time &lt; is-&gt;frame_timer + delay) &#123;</span><br><span class="line">                <span class="comment">// 计算出真正需要 sleep 的时间，然后跳到display 渲染此帧</span></span><br><span class="line">                *remaining_time = FFMIN(is-&gt;frame_timer + delay - time, *remaining_time);</span><br><span class="line">                <span class="keyword">goto</span> display;</span><br><span class="line">            &#125;</span><br><span class="line">            is-&gt;frame_timer += delay;</span><br><span class="line">            <span class="keyword">if</span> (delay &gt; <span class="number">0</span> &amp;&amp; time - is-&gt;frame_timer &gt; AV_SYNC_THRESHOLD_MAX) &#123;</span><br><span class="line">                is-&gt;frame_timer = time;</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_LockMutex(is-&gt;pictq.mutex);</span><br><span class="line">            <span class="keyword">if</span> (!isnan(vp-&gt;pts)) &#123;</span><br><span class="line">                <span class="comment">// 修改 Clock ，下次同步计算处理</span></span><br><span class="line">                update_video_pts(is, vp-&gt;pts, vp-&gt;pos, vp-&gt;serial);</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_UnlockMutex(is-&gt;pictq.mutex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                Frame *nextvp = frame_queue_peek_next(&amp;is-&gt;pictq);</span><br><span class="line">                duration = vp_duration(is, vp, nextvp);</span><br><span class="line">                <span class="keyword">if</span>(!is-&gt;step &amp;&amp; (ffp-&gt;framedrop &gt; <span class="number">0</span> || (ffp-&gt;framedrop &amp;&amp; get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) &amp;&amp; time &gt; is-&gt;frame_timer + duration) &#123;</span><br><span class="line">                    frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">                    <span class="keyword">goto</span> retry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 字幕处理    </span></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">            is-&gt;force_refresh = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            SDL_LockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;step) &#123;</span><br><span class="line">                is-&gt;step = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!is-&gt;paused)</span><br><span class="line">                    stream_update_pause_l(ffp);</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_UnlockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">display:</span><br><span class="line">        <span class="comment">/* display picture */</span></span><br><span class="line">        <span class="keyword">if</span> (!ffp-&gt;display_disable </span><br><span class="line">            &amp;&amp; is-&gt;force_refresh </span><br><span class="line">            &amp;&amp; is-&gt;show_mode == SHOW_MODE_VIDEO </span><br><span class="line">            &amp;&amp; is-&gt;pictq.rindex_shown) &#123;</span><br><span class="line">            <span class="comment">// 渲染视频</span></span><br><span class="line">            video_display2(ffp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
<li><a href="https://www.jianshu.com/p/96217ec4356e" target="_blank" rel="noopener">ijkplayer 音视频同步流程分析</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/直播/ijkplayer/ijkplayer系列五-视频解码与播放/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/直播/ijkplayer/ijkplayer系列五-视频解码与播放/" itemprop="url">ijkplayer系列五-视频解码与播放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-08T10:22:14+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/直播/" itemprop="url" rel="index">
                    <span itemprop="name">直播</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="解码线程"><a href="#解码线程" class="headerlink" title="解码线程"></a>解码线程</h1><p>从数据读取线程分析那篇文章我们可以看到，ijkplayer的视频解码线程的入口函数是<code>video_thread()/ff_ffplayer.c</code></p>
<h2 id="video-thread"><a href="#video-thread" class="headerlink" title="video_thread"></a><code>video_thread</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">video_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FFPlayer *ffp = (FFPlayer *)arg;</span><br><span class="line">    <span class="keyword">int</span>       ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;node_vdec) &#123;</span><br><span class="line">        ret = ffpipenode_run_sync(ffp-&gt;node_vdec);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ffpipenode_run_sync()/ff_ffpipenode.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffpipenode_run_sync</span><span class="params">(IJKFF_Pipenode *node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;func_run_sync(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用的实际是 <code>ffp-&gt;node_vdec-&gt;func_run_sync(node);</code></p>
<p>又是直接运行的ffplayer结构体里面的函数，肯定和音频播放一样，在之前初始化的时候给这个函数指针赋值过，那么我们回过头看看到底在哪里为它赋值的:</p>
<p>我们还是看到之前初始化的<code>ijkmp_android_create()</code>调用<code>ffpipeline_create_from_android()</code>，然后里面有一句:</p>
<p><code>pipeline-&gt;func_open_video_decoder = func_open_video_decoder;</code></p>
<p>然后我们再返回看到在<code>stream_component_open()/ff_ffplayer.c</code>里面有一句:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">decoder_init(&amp;is-&gt;viddec, avctx, &amp;is-&gt;videoq, is-&gt;continue_read_thread);</span><br><span class="line">ffp-&gt;node_vdec = ffpipeline_open_video_decoder(ffp-&gt;pipeline, ffp);</span><br></pre></td></tr></table></figure>
<p>点进去<code>ffpipeline_open_video_decoder(ffp-&gt;pipeline, ffp);</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IJKFF_Pipenode* <span class="title">ffpipeline_open_video_decoder</span><span class="params">(IJKFF_Pipeline *pipeline, FFPlayer *ffp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pipeline-&gt;func_open_video_decoder(pipeline, ffp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合上面的分析，在<code>stream_component_open()/ff_ffplayer.c</code>里面其实运行了<code>func_open_video_decoder()/ffpipeline_android.c</code>，然后把返回值赋值给<code>ffp-&gt;node_vdec</code>;继续跟着流程到<code>func_open_video_decoder()</code>。由于这里跳转比较麻烦，我就直接上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func_open_video_decoder()</span><br><span class="line">&#123;</span><br><span class="line">        |(调用)</span><br><span class="line">    <span class="comment">//(这里其实有个判断，是用硬解码还是软解，我们只分析硬解码)</span></span><br><span class="line">    node = ffpipenode_create_video_decoder_from_android_mediacodec(ffp, pipeline, opaque-&gt;weak_vout);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">        |(执行)</span><br><span class="line">    <span class="comment">//alloc一个IJKFF_Pipenode </span></span><br><span class="line">    IJKFF_Pipenode *node =  ffpipenode_alloc(<span class="keyword">sizeof</span>(IJKFF_Pipenode_Opaque));</span><br><span class="line">    node-&gt;func_destroy  = func_destroy;</span><br><span class="line">    node-&gt;func_run_sync = func_run_sync;</span><br><span class="line">    node-&gt;func_flush    = func_flush;</span><br><span class="line">    reutnr node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终 <code>ffp-&gt;node_vdec =node</code></p>
<p>现在终于找到赋值的地方了，前面调用的<code>ffp-&gt;node_vdec-&gt;func_run_sync(node);</code>现在看来就是调用的<code>func_run_sync()</code>函数</p>
<h3 id="func-run-sync"><a href="#func-run-sync" class="headerlink" title="func_run_sync"></a><code>func_run_sync</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">func_run_sync</span><span class="params">(IJKFF_Pipenode *node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IJKFF_Pipenode_Opaque *opaque   = node-&gt;opaque;</span><br><span class="line">    FFPlayer              *ffp      = opaque-&gt;ffp;</span><br><span class="line">    VideoState            *is       = ffp-&gt;is;</span><br><span class="line">    Decoder               *d        = &amp;is-&gt;viddec;</span><br><span class="line">    PacketQueue           *q        = d-&gt;<span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    opaque-&gt;enqueue_thread = SDL_CreateThreadEx(&amp;opaque-&gt;_enqueue_thread, enqueue_thread_func, node, <span class="string">"amediacodec_input_thread"</span>);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (!q-&gt;abort_request) &#123;</span><br><span class="line">      	<span class="comment">//...</span></span><br><span class="line">        ret = drain_output_buffer(env, node, timeUs, &amp;dequeue_count, frame, &amp;got_frame);</span><br><span class="line">  		<span class="comment">//...</span></span><br><span class="line">		ret = ffp_queue_picture(ffp, frame, pts, duration, av_frame_get_pkt_pos(frame), is-&gt;viddec.pkt_serial);</span><br><span class="line">     <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">	fail:</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="线程enqueue-thread-func"><a href="#线程enqueue-thread-func" class="headerlink" title="线程enqueue_thread_func"></a>线程<code>enqueue_thread_func</code></h4><p>在视频解码流程里面又创建了一个线程:</p>
<p><code>opaque-&gt;enqueue_thread = SDL_CreateThreadEx(&amp;opaque-&gt;_enqueue_thread, enqueue_thread_func, node, &quot;amediacodec_input_thread&quot;);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">从命名来看，是一个input_thread，我们先来看看这个线程:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">enqueue_thread_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IJKFF_Pipenode        *node     = arg;</span><br><span class="line">    IJKFF_Pipenode_Opaque *opaque   = node-&gt;opaque;</span><br><span class="line">    FFPlayer              *ffp      = opaque-&gt;ffp;</span><br><span class="line">    VideoState            *is       = ffp-&gt;is;</span><br><span class="line">    Decoder               *d        = &amp;is-&gt;viddec;</span><br><span class="line">    PacketQueue           *q        = d-&gt;<span class="built_in">queue</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (!q-&gt;abort_request) &#123;</span><br><span class="line">        ret = feed_input_buffer(env, node, AMC_INPUT_TIMEOUT_US, &amp;dequeue_count);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点进去<code>feed_input_buffer()/ffpipenode_android_mediacodec_vdec.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">staticint <span class="title">feed_input_buffer</span><span class="params">(JNIEnv *env, IJKFF_Pipenode *node, <span class="keyword">int64_t</span> timeUs, <span class="keyword">int</span>*enqueue_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ffp_packet_queue_get_or_buffering(ffp, d-&gt;<span class="built_in">queue</span>, &amp;pkt,&amp;d-&gt;pkt_serial, &amp;d-&gt;finished) &lt; <span class="number">0</span>) &#123; <span class="comment">//取得数据包</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        input_buffer_ptr= SDL_AMediaCodec_getInputBuffer(opaque-&gt;acodec, input_buffer_index,&amp;input_buffer_size); <span class="comment">//得到硬解码应该输入的buffer的地址</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="built_in">memcpy</span>(input_buffer_ptr,d-&gt;pkt_temp.data, copy_size);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        amc_ret= SDL_AMediaCodec_queueInputBuffer(opaque-&gt;acodec, input_buffer_index, <span class="number">0</span>,copy_size, time_stamp, <span class="number">0</span>); </span><br><span class="line"><span class="comment">//送到AMediaCodec解码器</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，这一步原来就是用硬解码器解码。这个<code>input_thread</code>也就只是把每一帧数据送到解码器去解码而已。</p>
<h4 id="drain-output-buffer-l"><a href="#drain-output-buffer-l" class="headerlink" title="drain_output_buffer_l"></a><code>drain_output_buffer_l</code></h4><p>从硬解码器中获得解码后的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">drain_output_buffer_l</span><span class="params">(JNIEnv *env, IJKFF_Pipenode *node, <span class="keyword">int64_t</span> timeUs,<span class="keyword">int</span> *dequeue_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//从硬解码器中获得解码后的数据</span></span><br><span class="line">	output_buffer_index= SDL_AMediaCodec_dequeueOutputBuffer(opaque-&gt;acodec, &amp;bufferInfo,timeUs); </span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ffp-queue-picture"><a href="#ffp-queue-picture" class="headerlink" title="ffp_queue_picture"></a><code>ffp_queue_picture</code></h4><p>把数据插入到显示队列 <code>ijkplayer-&gt;ffplayer-&gt;is-&gt;pictq</code> 中</p>
<h1 id="显示线程"><a href="#显示线程" class="headerlink" title="显示线程"></a>显示线程</h1><p>显示线程从 <code>is-&gt;pictq</code> 读取数据，然后直接推送给硬件设备，完成渲染。</p>
<p>前面关于启动流程的分析我们知道，IjkMediaPlayer.prepareAsync <code>stream_open</code>中创建了视频显示进程</p>
<p><code>is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, &quot;ff_vout&quot;);</code></p>
<h2 id="video-refresh-thread-ff-ffplayer-c"><a href="#video-refresh-thread-ff-ffplayer-c" class="headerlink" title="video_refresh_thread()/ff_ffplayer.c"></a><code>video_refresh_thread()/ff_ffplayer.c</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">video_refresh_thread(<span class="keyword">void</span> *arg)</span><br><span class="line">              |(调用)</span><br><span class="line">video_refresh(ffp, &amp;remaining_time);</span><br><span class="line">              |(调用)</span><br><span class="line"> video_display2(ffp);</span><br><span class="line">              |(调用)</span><br><span class="line">video_image_display2(ffp);</span><br></pre></td></tr></table></figure>
<h3 id="video-image-display2"><a href="#video-image-display2" class="headerlink" title="video_image_display2"></a><code>video_image_display2</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">video_image_display2</span><span class="params">(FFPlayer *ffp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    Frame *vp;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//从队列中取出数据</span></span><br><span class="line">	<span class="comment">//然后调用SDL_VoutDisplayYUVOverlay()完成渲染。</span></span><br><span class="line">    vp = frame_queue_peek(&amp;is-&gt;pictq);</span><br><span class="line">    <span class="keyword">if</span> (vp-&gt;bmp) &#123;</span><br><span class="line">        SDL_VoutDisplayYUVOverlay(ffp-&gt;vout, vp-&gt;bmp);</span><br><span class="line">        ffp-&gt;stat.vfps = SDL_SpeedSamplerAdd(&amp;ffp-&gt;vfps_sampler, FFP_SHOW_VFPS_FFPLAY, <span class="string">"vfps[ffplay]"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ffp-&gt;first_video_frame_rendered) &#123;</span><br><span class="line">            ffp-&gt;first_video_frame_rendered = <span class="number">1</span>;</span><br><span class="line">            ffp_notify_msg1(ffp, FFP_MSG_VIDEO_RENDERING_START);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SDL-VoutDisplayYUVOverlay"><a href="#SDL-VoutDisplayYUVOverlay" class="headerlink" title="SDL_VoutDisplayYUVOverlay"></a><code>SDL_VoutDisplayYUVOverlay</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SDL_VoutDisplayYUVOverlay</span><span class="params">(SDL_Vout *vout, SDL_VoutOverlay *overlay)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (vout &amp;&amp; overlay &amp;&amp; vout-&gt;display_overlay)</span><br><span class="line">        <span class="keyword">return</span> vout-&gt;display_overlay(vout, overlay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在初始化的时候，在 <code>ijkmp_android_create()</code>里面调用的<code>SDL_VoutAndroid_CreateForAndroidSurface();</code> 赋值的：</p>
<p><code>vout-&gt;display_overlay = func_display_overlay;</code></p>
<p>所以其实调用了 <code>func_display_overlay()</code> 完成渲染。从pictq列表中获取视频frame数据，然后再写入nativewindows的视频缓冲中进行渲染。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">github</a></li>
<li><a href="https://www.jianshu.com/p/5345ab4cf979" target="_blank" rel="noopener">ijkplayer 源码分析（上）</a> 王英豪，基于k0.8.8版本</li>
<li><a href="https://cloud.tencent.com/developer/article/1032547" target="_blank" rel="noopener">ijkplayer框架深入剖析</a> 金山云团队，基于k0.7.6版本</li>
<li><a href="https://www.jianshu.com/p/7d9b86919682" target="_blank" rel="noopener">ijkplayer视频播放器源码分析(android)</a> 尸情化异，基于k0.5.1版本，系列专栏5篇：使用，初始化，数据读取，音频解码播放，视频解码播放</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/07/编程思想/DIP IOC DI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/07/编程思想/DIP IOC DI/" itemprop="url">DIP IOC DI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-07T10:58:53+08:00">
                2019-08-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程思想/" itemprop="url" rel="index">
                    <span itemprop="name">编程思想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DIP-依赖倒置原则"><a href="#DIP-依赖倒置原则" class="headerlink" title="DIP 依赖倒置原则"></a>DIP 依赖倒置原则</h1><p>Dependence Inversion Principle</p>
<p>实际开发，经常出现高层模块(复杂业务模块；调用者)依赖底层模块(基本原子操作；被调用者)，高层模块往往复杂而多变，改动带来新风险。</p>
<p>这类问题的解决方案就是 <strong>依赖倒置原则</strong></p>
<ul>
<li>高层模块不应该直接依赖底层模块,两者都应该依赖抽象.</li>
<li>抽象不应依赖细节.</li>
<li>细节应该依赖抽象.</li>
</ul>
<p><strong>本质</strong> 就是在高层模块(调用者)定义一个 <strong>中间件(抽象层)</strong>，底层模块(被调用者) 实现中间件(实现了依赖倒置)；也就是我们常说的 <strong>面向抽象(接口)编程</strong> </p>
<h1 id="IOC和DI-控制反转和依赖注入"><a href="#IOC和DI-控制反转和依赖注入" class="headerlink" title="IOC和DI 控制反转和依赖注入"></a>IOC和DI 控制反转和依赖注入</h1><p>Inversion of Control</p>
<p>Dependency Injection</p>
<p>示例：用户注册模块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span></span>&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//存储的具体实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">storeUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="title">implments</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userDao=<span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">storeUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//用户信息校验通过</span></span><br><span class="line">        userDao.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码已经尽可能的遵循DIP原则</p>
<p>在UserServiceImpl中,通过new来创建UserDao对象(即 UserDao对象的控制权实际在UserServiceImpl中，两者耦合)</p>
<p>解决方案：增加一个中间件(容器)，负责创建和存储所有注册对象(控制权转移，解耦)，运行时按需从容器中取对象</p>
<p><strong>控制反转是DIP原则的升级</strong>,旨在解决对象依赖问题</p>
<p>控制反转是一种思维方式的变化,<strong>依赖注入</strong>则是该思想的<strong>具体实践</strong>.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>控制反转和依赖倒置皆提现了<strong>常规线性思维的转变</strong></p>
<p>倒置”一词其实反映的是逆常规思维(从抽象到具体)。常规思维是线性的,人认识事物的本质是从具体到抽象。即:将类与类直接打交道改编为抽象与抽象打交道,也就是所谓的面向抽象(抽象类或接口)编程.</p>
<p><strong>控制反转是DIP原则的升级</strong>,旨在解决对象依赖这问题</p>
<p>控制反转是一种思维方式的变化,<strong>依赖注入</strong>则是该思想的<strong>具体实践</strong>.</p>
<p>实现控制反转通常有<strong>两种方式</strong>:依赖查找和依赖注入.</p>
<ul>
<li><strong>依赖查找</strong>:容器提供回调接口和上下文给组件,需要组件自己实现查找合适的对象的过程,此类以<strong>EJB</strong>为代表.</li>
<li><strong>依赖注入</strong>:组件不做任何定位查询,只需向容器提供普通的java方法,然后容器根据这些方法自行决定依赖关系.此类以<strong>Spring</strong>为代表.<ul>
<li>自动注入,更为自动和简单</li>
<li>基本能够实现对原有代码的无侵入</li>
</ul>
</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/c899300f98fa" target="_blank" rel="noopener">白话设计——浅谈DIP和IOC</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">308</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
