<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/java基础/异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/26/java基础/异常/" itemprop="url">异常</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-26T15:55:53+08:00">
                2019-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="异常声明"><a href="#异常声明" class="headerlink" title="异常声明"></a>异常声明</h1><p>属于方法说明的一部分，紧跟在参数列表之后</p>
<p><code>void method() throws IOException {}</code></p>
<p>子类在覆盖方法时，不能添加父类方法没有的异常声明（只能保持或者减少）。</p>
<h1 id="Throwable-方法汇总"><a href="#Throwable-方法汇总" class="headerlink" title="Throwable 方法汇总"></a>Throwable 方法汇总</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">getMessage()</span><br><span class="line">getLocalizedMessage()</span><br><span class="line">toString()</span><br><span class="line"></span><br><span class="line">getCause()</span><br><span class="line">initCause(Throwable cause)</span><br><span class="line"></span><br><span class="line">printStackTrace()</span><br><span class="line">getStackTrace()</span><br><span class="line">fillInStackTrace()</span><br><span class="line">setStackTrace(StackTraceElement[] stackTrace)</span><br><span class="line"></span><br><span class="line">addSuppressed(Throwable exception)</span><br><span class="line">getSuppressed()</span><br></pre></td></tr></table></figure>
<h2 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h2><p><code>throw new RuntimeException(&quot;My Exception&quot;);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getMessage(): My Exception</span><br><span class="line">getLocalizedMessage(): My Exception</span><br><span class="line">toString(): java.lang. RuntimeException: My Exception</span><br><span class="line"></span><br><span class="line">printStackTrace(): </span><br><span class="line">	java.lang. RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:<span class="number">9</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getLocalizedMessage()</code>和 <code>getMessage()</code> 返回构造方法传入的参数信息</li>
<li>toString() 返回异常完整类名和 <code>getMessage()</code>的信息</li>
<li>printStackTrace() 打印 <code>toString()</code>信息和异常堆栈</li>
</ul>
<h1 id="printStackTrace"><a href="#printStackTrace" class="headerlink" title="printStackTrace()"></a>printStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">(PrintStreamOrWriter s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Guard against malicious overrides of Throwable.equals by</span></span><br><span class="line">    <span class="comment">// using a Set with identity equality semantics.</span></span><br><span class="line">    Set&lt;Throwable&gt; dejaVu =</span><br><span class="line">        Collections.newSetFromMap(<span class="keyword">new</span> IdentityHashMap&lt;Throwable, Boolean&gt;());</span><br><span class="line">    dejaVu.add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (s.lock()) &#123;</span><br><span class="line">        <span class="comment">// Print our stack trace</span></span><br><span class="line">        s.println(<span class="keyword">this</span>);</span><br><span class="line">        StackTraceElement[] trace = getOurStackTrace();</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement traceElement : trace)</span><br><span class="line">            s.println(<span class="string">"\tat "</span> + traceElement);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print suppressed exceptions, if any</span></span><br><span class="line">        <span class="keyword">for</span> (Throwable se : getSuppressed())</span><br><span class="line">            se.printEnclosedStackTrace(s, trace, SUPPRESSED_CAPTION, <span class="string">"\t"</span>, dejaVu);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print cause, if any</span></span><br><span class="line">        Throwable ourCause = getCause();</span><br><span class="line">        <span class="keyword">if</span> (ourCause != <span class="keyword">null</span>)</span><br><span class="line">            ourCause.printEnclosedStackTrace(s, trace, CAUSE_CAPTION, <span class="string">""</span>, dejaVu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 自身 堆栈</li>
<li><strong>递归</strong> 打印 <strong>抑制(suppressed)异常链</strong> 堆栈<ul>
<li>第一行前缀 <code>Suppressed by:</code>在异常完整类名和构造参数之前 </li>
</ul>
</li>
<li><strong>递归</strong> 打印 <strong>cause</strong> 堆栈<ul>
<li>第一行前缀 <code>Caused by:</code>在异常完整类名和构造参数之前     </li>
</ul>
</li>
</ul>
<p>printEnclosedStackTrace() 是 <strong>递归方法</strong></p>
<h1 id="getOurStackTrace"><a href="#getOurStackTrace" class="headerlink" title="getOurStackTrace()"></a>getOurStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> StackTraceElement[] getOurStackTrace() &#123;</span><br><span class="line">    <span class="keyword">return</span> stackTrace;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>倒序</strong>记录着方法调用帧：后调用的在最前面/最顶上</p>
<ul>
<li>栈顶元素（元素0），是方法调用序列中最后一个方法调用</li>
<li>栈底元素（最后一个元素）是调用序列中的第一个方法调用</li>
</ul>
<h1 id="getStackTrace"><a href="#getStackTrace" class="headerlink" title="getStackTrace()"></a>getStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StackTraceElement[] getStackTrace() &#123;</span><br><span class="line">    <span class="keyword">return</span> getOurStackTrace().clone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="StackTraceElement"><a href="#StackTraceElement" class="headerlink" title="StackTraceElement"></a>StackTraceElement</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StackTraceElement</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Normally initialized by VM (public constructor added in 1.5)</span></span><br><span class="line">    <span class="keyword">private</span> String declaringClass; <span class="comment">//完整类名</span></span><br><span class="line">    <span class="keyword">private</span> String methodName; <span class="comment">//方法名。不带签名(参数和返回值)</span></span><br><span class="line">    <span class="keyword">private</span> String fileName; <span class="comment">//类文件名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>    lineNumber; <span class="comment">//行号；-2表示该方法是Native方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="重新抛出异常和异常链"><a href="#重新抛出异常和异常链" class="headerlink" title="重新抛出异常和异常链"></a>重新抛出异常和异常链</h1><h2 id="抛出原异常对象"><a href="#抛出原异常对象" class="headerlink" title="抛出原异常对象"></a>抛出原异常对象</h2><p>有时我们在捕获到异常后，可能在捕获的地方不适合处理该异常，我们需要将它重新抛出</p>
<p>这样就会存在一个问题，抛出的的异常携带的信息，是原来异常抛出点的调用栈信息，而非新抛出点的信息（新抛出点的调用信息就被掩盖了）。</p>
<p>可以使用 <code>fillInStackTrace()</code> 更新新抛出点信息到这个异常调用栈中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:9)</span><br><span class="line">	</span><br><span class="line">使用 fillInStackTrace() 后：</span><br><span class="line">java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:11)</span><br></pre></td></tr></table></figure>
<p>单纯的更新了抛出异常的所在函数</p>
<p><strong>不推荐使用</strong></p>
<h2 id="抛出新异常对象"><a href="#抛出新异常对象" class="headerlink" title="抛出新异常对象"></a>抛出新异常对象</h2><p>新建异常对象时传入原来的异常对象，或者调用 <code>initCause(Throwable cause)</code>传入原异常对象。</p>
<p>这样原来的异常对象作为 <code>cause</code> 保持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:14) //新异常抛出处</span><br><span class="line">Caused by: java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:12) //老异常抛出处</span><br></pre></td></tr></table></figure>
<h2 id="异常抑制"><a href="#异常抑制" class="headerlink" title="异常抑制"></a>异常抑制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"try"</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// throw new RuntimeException("finally");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: try</span><br><span class="line">	at Test.main(Test.java:10)</span><br><span class="line">	</span><br><span class="line">finally 也抛出异常：</span><br><span class="line">java.lang.RuntimeException: finally</span><br><span class="line">	at Test.main(Test.java:12)</span><br></pre></td></tr></table></figure>
<p>finally 抑制了上一个异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Exception exception = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"try"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    exception = e;</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"finally"</span>);</span><br><span class="line">    <span class="keyword">if</span>(exception!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        e.addSuppressed(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: finally</span><br><span class="line">	at Test.main(Test.java:15)</span><br><span class="line">	Suppressed: java.lang.RuntimeException: try</span><br><span class="line">		at Test.main(Test.java:11)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/24/CocosCreator/CocosCreator新手上路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/24/CocosCreator/CocosCreator新手上路/" itemprop="url">CocosCreator新手上路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-24T18:30:53+08:00">
                2019-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/游戏/" itemprop="url" rel="index">
                    <span itemprop="name">游戏</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于-Cocos-Creator"><a href="#关于-Cocos-Creator" class="headerlink" title="关于 Cocos Creator"></a>关于 Cocos Creator</h1><p>是一个完整的游戏开发解决方案</p>
<p>包括了</p>
<ul>
<li>cocos2d-x 引擎的 JavaScript 实现（不需要学习一个新的引擎）</li>
<li>快速开发游戏所需要的各种图形界面工具</li>
</ul>
<h1 id="安装-Cocos-Creator"><a href="#安装-Cocos-Creator" class="headerlink" title="安装 Cocos Creator"></a>安装 Cocos Creator</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>访问 <a href="https://www.cocos.com/creator/" target="_blank" rel="noopener">Cocos Creator 产品首页</a> 上的下载链接获得 Cocos Creator 的安装包</p>
<p>兼容已有旧项目，选择 <a href="http://cocos2d-x.org/filedown/CocosCreator_v2.1.0_mac" target="_blank" rel="noopener">2.1.0版本</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Mac安装"><a href="#Mac安装" class="headerlink" title="Mac安装"></a>Mac安装</h3><p>操作系统要求：最低版本是 OS X 10.9</p>
<p>双击 DMG 文件，然后将 <code>CocosCreator.app</code> 拖拽到 <code>应用程序</code> 文件夹快捷方式</p>
<h1 id="安装配置原生开发环境"><a href="#安装配置原生开发环境" class="headerlink" title="安装配置原生开发环境"></a>安装配置原生开发环境</h1><p>如果只想开发 Web 平台的游戏，完成上面的步骤就足够了。</p>
<p>如果希望发布游戏到原生平台，就需要安装配置原生开发环境。</p>
<p>Cocos Creator 使用基于 cocos2d-x 引擎的 JSB 技术实现跨平台发布原生应用。</p>
<p>在使用 Cocos Creator 打包发布到原生平台之前，我们需要先配置好 cocos2d-x 相关的开发环境</p>
<h2 id="Android-平台相关依赖"><a href="#Android-平台相关依赖" class="headerlink" title="Android 平台相关依赖"></a>Android 平台相关依赖</h2><h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><h3 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h3><h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><h3 id="NDK"><a href="#NDK" class="headerlink" title="NDK"></a>NDK</h3><h2 id="C-编译环境"><a href="#C-编译环境" class="headerlink" title="C++ 编译环境"></a>C++ 编译环境</h2><p>Cocos2d-x 自带的编译工具 Cocos Console 需要以下运行环境：</p>
<ul>
<li><p>Python 2.7.5+，<a href="https://www.python.org/downloads/" target="_blank" rel="noopener">下载页</a>，注意不要下载 Python 3.x 版本。</p>
</li>
<li><p>Windows 下需要安装 Visual Studio 2015 或 2017 社区版，<a href="https://www.visualstudio.com/downloads/download-visual-studio-vs" target="_blank" rel="noopener">下载页</a></p>
</li>
<li>Mac 下需要安装 Xcode 和命令行工具，<a href="https://developer.apple.com/xcode/download/" target="_blank" rel="noopener">下载页</a></li>
</ul>
<h2 id="配置原生发布环境路径"><a href="#配置原生发布环境路径" class="headerlink" title="配置原生发布环境路径"></a>配置原生发布环境路径</h2><p>CocosCreator -&gt; <code>设置</code>，打开设置窗口</p>
<p>我们在这里需要配置以下两个路径：</p>
<p><code>NDK</code> 路径，选择 Android SDK Location 路径下的 ndk-bundle 文件夹（NDK 是其根目录），不需要编译 Android 平台的话这里可以跳过。</p>
<p><code>Android SDK</code> 路径，选择刚才在 SDK Manager 中记下的 Android SDK Location 路径（Android SDK 的目录下应该包含 build-tools、platforms 等文件夹），不需要编译 Android 平台的话这里可以跳过。<br>配置完成后点击 保存 按钮，保存并关闭窗口。</p>
<p>注意：这里的配置会在编译 原生工程 的时候生效。如果没有生效（一些 Mac 机器有可能出现这个情况），可能需要您尝试到 系统环境变量 设置这些值：COCOS_CONSOLE_ROOT, NDK_ROOT, ANDROID_SDK_ROOT。</p>
<h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>在 <code>Dashboard</code> 中，打开 <code>新建项目</code> 选项卡，选中 <code>Hello World</code> 项目模板。</p>
<h2 id="打开场景，开始工作"><a href="#打开场景，开始工作" class="headerlink" title="打开场景，开始工作"></a>打开场景，开始工作</h2><p>Cocos Creator 的工作流程是以数据驱动和场景为核心的，初次打开一个项目时，默认不会打开任何场景，要看到 Hello World 模板中的内容，我们需要先打开场景资源文件。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/open_scene.png">
<p>在 <code>资源管理器</code> 中双击箭头所指的 <code>helloworld</code> 场景文件</p>
<h2 id="预览场景"><a href="#预览场景" class="headerlink" title="预览场景"></a>预览场景</h2><p>点击编辑器窗口正上方的 <code>预览游戏</code> 按钮。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/preview_button.png">
<p>Cocos Creator 会使用您的默认浏览器运行当前游戏场景。点击预览窗口左上角的下拉菜单，可以选择不同设备屏幕的预览效果。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/preview.png">
<h2 id="修改欢迎文字"><a href="#修改欢迎文字" class="headerlink" title="修改欢迎文字"></a>修改欢迎文字</h2><p>首先在 <code>层级管理器</code> 中选中 <code>Canvas</code> 节点，我们的 HelloWorld 组件脚本就挂在这个节点上。</p>
<p>接下来在 <code>属性检查器</code> 面板下方找到 <code>HelloWorld</code>组件属性，然后将 <code>Text</code> 属性里的文本改成 你好，世界！</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/change_text.png">
<p>再次运行预览，可以看到欢迎文字已经更新了</p>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ProjectName（项目文件夹）</span><br><span class="line">	├──assets </span><br><span class="line">		├──Scene		├──Scene.meta		├──Script		├──Script.meta		├──Texture		├──Texture.meta</span><br><span class="line">	├──build</span><br><span class="line">	├──library</span><br><span class="line">	├──local</span><br><span class="line">	├──settings</span><br><span class="line">	├──temp</span><br><span class="line">	└──project.json</span><br></pre></td></tr></table></figure>
<h2 id="assets-资源文件夹"><a href="#assets-资源文件夹" class="headerlink" title="assets 资源文件夹"></a>assets 资源文件夹</h2><p>游戏中所有本地资源、脚本和第三方库文件 </p>
<p>显示在 <strong>资源管理器</strong> 中</p>
<p>每个文件在导入后都会生成一个同名 <code>.meta</code> 文件，用于存储该文件作为资源导入后的信息和与其他资源的<strong>关联</strong>。</p>
<h2 id="library-资源库"><a href="#library-资源库" class="headerlink" title="library 资源库"></a>library 资源库</h2><p><code>assets</code> 中的资源导入后<strong>自动生成</strong>的。将文件结构和资源格式处理成最终游戏发布时需要的形式。</p>
<p>不需要进入版本控制的</p>
<p>丢失或损坏的时候，删除整个 <code>library</code> 文件夹再打开项目，就会重新生成资源库</p>
<h2 id="local-本地设置"><a href="#local-本地设置" class="headerlink" title="local 本地设置"></a>local 本地设置</h2><p>该项目的本地设置：包括编辑器面板布局，窗口大小，位置等信息。</p>
<p>按照您的习惯设置编辑器布局，这些就会自动保存在这个文件夹</p>
<p>不需要进入版本控制</p>
<h2 id="settings-项目设置"><a href="#settings-项目设置" class="headerlink" title="settings 项目设置"></a>settings 项目设置</h2><p>项目相关的设置：<code>构建发布</code> 菜单里的包名、场景和平台选择等。</p>
<p>需要进行版本控制</p>
<h2 id="project-json"><a href="#project-json" class="headerlink" title="project.json"></a>project.json</h2><p><code>project.json</code> 文件和 <code>assets</code> 文件夹一起，作为验证 Cocos Creator 项目合法性的标志。只有包括了这两个内容的文件夹才能作为 Cocos Creator 项目打开。</p>
<p>目前只用来规定当前使用的引擎类型和插件存储位置，不需要用户关心其内容。</p>
<p>需要进行版本控制</p>
<h2 id="build-构建目标"><a href="#build-构建目标" class="headerlink" title="build 构建目标"></a>build 构建目标</h2><p>在使用主菜单中的 <code>项目</code> -&gt; <code>构建发布...</code> 使用<strong>默认发布路径</strong>发布项目后，编辑器会在项目路径下创建 build 目录，并存放所有目标平台的构建工程。</p>
<p>不进入版本控制</p>
<ul>
<li>每次构建项目后资源 id 可能会变化</li>
<li>体积很大</li>
</ul>
<h1 id="打包发布原生平台"><a href="#打包发布原生平台" class="headerlink" title="打包发布原生平台"></a>打包发布原生平台</h1><p>点击菜单栏的 <code>项目</code> -&gt; <code>构建发布</code>，打开构建发布面板。</p>
<h2 id="构建原生工程"><a href="#构建原生工程" class="headerlink" title="构建原生工程"></a>构建原生工程</h2><p>选择发布平台，设置初始场景，点击右下角的 <code>构建</code> 按钮，开始构建流程。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/build.png">
<p>进度条到达 100% 后请继续等待 <strong>控制台</strong> 面板(在主面板底部)中的工程构建结束</p>
<p>编译成功</p>
<p>控制台面板日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Building /Users/liyungui/StudioProjects/cocos_helloworld</span><br><span class="line">Destination /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link</span><br><span class="line">Delete /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link/res/**/*,/Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link/src/*/</span><br><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Creating native cocos project to /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link</span><br><span class="line">Start building assets</span><br><span class="line">Finish building assets</span><br><span class="line">Start building plugin scripts</span><br><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Built to &quot;/Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link&quot; successfully</span><br></pre></td></tr></table></figure>
<p>构建结束后，我们得到的是一个标准的 cocos2d-x 工程</p>
<p>接下来我们可以选择通过 Cocos Creator 编辑器的进程进行编译，以及运行桌面预览，或手动在相应平台的 IDE 中打开构建好的原生工程，进行进一步的预览、调试和发布。</p>
<h2 id="编译原生工程"><a href="#编译原生工程" class="headerlink" title="编译原生工程"></a>编译原生工程</h2><h3 id="通过编辑器编译"><a href="#通过编辑器编译" class="headerlink" title="通过编辑器编译"></a>通过编辑器编译</h3><p>点击下方的 <code>编译</code> 按钮，进入编译流程，如果模板选择了 default 的源码版引擎，这个编译的过程将会花费比较久的时间。</p>
<p>编译成功</p>
<p>控制台面板日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Start to compile native project. Please wait...</span><br><span class="line">The log file path [ /Users/liyungui/.CocosCreator/logs/native.log ]</span><br><span class="line">Compile native project successfully.</span><br></pre></td></tr></table></figure>
<p>注意：首次编译 Android 平台，建议通过 Android Studio 打开工程，根据提示下载缺失的工具，再进行编译运行。</p>
<h2 id="运行预览原生工程"><a href="#运行预览原生工程" class="headerlink" title="运行预览原生工程"></a>运行预览原生工程</h2><h3 id="通过编辑器运行预览"><a href="#通过编辑器运行预览" class="headerlink" title="通过编辑器运行预览"></a>通过编辑器运行预览</h3><p>点击右下角的 <code>运行</code> 按钮，通过默认方式预览原生平台的游戏。</p>
<p>点击运行后，视平台不同可能还会继续进行一部分编译工作，请耐心等待或通过日志文件查看进展。</p>
<p>其中 Mac/Windows 平台直接在桌面运行预览，iOS 平台会调用模拟器运行预览，Android 平台必须通过 USB 连接真机，并且在真机上开启 USB 调试后才可以运行预览。</p>
<p>运行成功后，logcat日志 过滤 tag: jswrapper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-07-24 19:02:18.986 6156-6195/? D/jswrapper: Initializing V8, version: 6.0.286.52</span><br><span class="line">2019-07-24 19:02:20.081 6156-6195/? D/jswrapper: JS: Enable batch GL commands optimization!</span><br><span class="line">2019-07-24 19:02:20.960 6156-6195/? D/jswrapper: glGetIntegerv: pname: 0x8b4c</span><br><span class="line">2019-07-24 19:02:21.004 6156-6195/? D/jswrapper: JS: Cocos Creator v2.1.0</span><br><span class="line">2019-07-24 19:02:21.078 6156-6195/? D/jswrapper: JS: LoadScene 2dL3kvpAxJu6GJ7RdqJG5J: 70.58299999999986ms</span><br><span class="line">2019-07-24 19:02:21.082 6156-6195/? D/jswrapper: JS: Success to load scene: db://assets/Scene/helloworld.fire</span><br></pre></td></tr></table></figure>
<h2 id="使用原生工程"><a href="#使用原生工程" class="headerlink" title="使用原生工程"></a>使用原生工程</h2><p>点击发布路径旁边的 <code>打开</code>按钮，就会在操作系统的文件管理器中打开构建发布路径。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/open_project.png">
<p>这个路径中的 <code>jsb-default</code> 或 <code>jsb-link</code> （根据选择模板不同）里就包含了所有原生构建工程。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/native_projects.jpg">
<p>接下来您只要使用原生平台对应的 IDE （如 Xcode、Android Studio、Visual Studio）打开这些工程，就可以进行进一步的编译、预览、发布操作了。</p>
<p>注意：在 MIUI 10 系统上运行 debug 模式构建的工程可能会弹出 “Detected problems with API compatibility” 的提示框，这是 MIUI 10 系统自身引入的问题，使用 release 模式构建即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/19/Android/UI性能优化/卡顿分析-正确评测流畅度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/19/Android/UI性能优化/卡顿分析-正确评测流畅度/" itemprop="url">卡顿分析-正确评测流畅度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-19T18:05:53+08:00">
                2019-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用FPS评测应用流畅度不科学"><a href="#使用FPS评测应用流畅度不科学" class="headerlink" title="使用FPS评测应用流畅度不科学"></a>使用FPS评测应用流畅度不科学</h1><p>说到应用的流畅度，都会想到FPS</p>
<p>FPS(Frames Per Second) 每秒帧数</p>
<p>Android系统获取FPS的原理是：SurfaceFLinger类把系统所有进程当前需要显示的信息合成一帧，提交到屏幕上进行显示。FPS就是1秒内SurfaceFLinger提交到屏幕的帧数。</p>
<p>用FPS评测应用是否卡顿存在两个问题。</p>
<ul>
<li>有的时候FPS很低，APP看起来却很流畅；<ul>
<li>当前界面在1秒内只需要10帧的显示需求，FPS只要高于10就可以了，如果屏幕根本没有绘制需求，那FPS的值就是0</li>
</ul>
</li>
<li>APP停止操作之后，FPS还是在一直变化</li>
</ul>
<h1 id="VSYNC信号"><a href="#VSYNC信号" class="headerlink" title="VSYNC信号"></a>VSYNC信号</h1><p>Android渲染机制是每隔16ms发出VSYNC信号，触发对UI的渲染，16ms没完成绘制就会卡顿。</p>
<p>VSync机制就像是一台固定转速的发动机(60转/s)。每一转会带动着去做一些UI相关的事情，但不是每一转都会有工作去做。有时候某一转因为工作量比较重超过了16.6ms，那么这台发动机这秒内就不是60转了，转速降低。我们把这个转速叫做流畅度。流畅度越小说明当前程序越卡顿。</p>
<h1 id="Choreographer帧率检测原理"><a href="#Choreographer帧率检测原理" class="headerlink" title="Choreographer帧率检测原理"></a>Choreographer帧率检测原理</h1><p>Choreographer中（英[ˌkɒrɪ’ɒɡrəfə(r)] 美[ˌkɒrɪ’ɒɡrəfə(r)]）编舞者</p>
<p>我们有时候会看到这样的log，系统帮助我们打印出了跳帧数。这个日志来自于<code>Choreographer.doFrame</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">02-07 19:47:04.337 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 60 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:11.685 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 85 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:12.545 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:14.893 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:23.049 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:23.929 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:24.961 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 61 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:25.817 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:26.433 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br></pre></td></tr></table></figure>
<p>阈值默认是30，跳帧超过30帧则打印警告日志，所以上面的log并不是经常看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SKIPPED_FRAME_WARNING_LIMIT =SystemProperties.getInt( <span class="string">"debug.choreographer.skipwarning"</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p>如果我们用反射的方法把SKIPPED_FRAME_WARNING_LIMIT的值设置成1，这样只要有丢帧，就会有上面的log输出。我们只要捕获这个log提取出skippedFrames 就可以知道界面是否卡顿</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Field field = Choreographer.class.getDeclaredField(<span class="string">"SKIPPED_FRAME_WARNING_LIMIT"</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    field.set(Choreographer.class,<span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="检测帧率"><a href="#检测帧率" class="headerlink" title="检测帧率"></a>检测帧率</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FrameCallback</span> </span>&#123;  </span><br><span class="line">  <span class="comment">//当新的一帧被绘制的时候被调用。  </span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义FrameCallback。记录下每一帧开始渲染的时间，在下一帧被处理时，判断上一帧在渲染过程中是否出现掉帧。</p>
<p>在需要检测的Activity中调用 SMFrameCallback.getInstance().start()即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SMFrameCallback</span> <span class="keyword">implements</span> <span class="title">Choreographer</span>.<span class="title">FrameCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  SMFrameCallback sInstance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String TAG=<span class="string">"SMFrameCallback"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> deviceRefreshRateMs=<span class="number">16.6f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">long</span> lastFrameTimeNanos=<span class="number">0</span>;<span class="comment">//纳秒为单位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">long</span> currentFrameTimeNanos=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Choreographer.getInstance().postFrameCallback(SMFrameCallback.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SMFrameCallback <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> SMFrameCallback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(lastFrameTimeNanos==<span class="number">0</span>)&#123;</span><br><span class="line">            lastFrameTimeNanos=frameTimeNanos;</span><br><span class="line">            Choreographer.getInstance().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        currentFrameTimeNanos=frameTimeNanos;</span><br><span class="line">        <span class="keyword">float</span> value=(currentFrameTimeNanos-lastFrameTimeNanos)/<span class="number">1000000.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> skipFrameCount = skipFrameCount(lastFrameTimeNanos, currentFrameTimeNanos, deviceRefreshRateMs);</span><br><span class="line">        Log.e(TAG,<span class="string">"两次绘制时间间隔value="</span>+value+<span class="string">"  frameTimeNanos="</span>+frameTimeNanos+<span class="string">"  currentFrameTimeNanos="</span>+currentFrameTimeNanos+<span class="string">"  skipFrameCount="</span>+skipFrameCount+<span class="string">""</span>);</span><br><span class="line">        lastFrameTimeNanos=currentFrameTimeNanos;</span><br><span class="line">        Choreographer.getInstance().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *计算跳过多少帧</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> devicefreshRate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">int</span> <span class="title">skipFrameCount</span><span class="params">(<span class="keyword">long</span> start,<span class="keyword">long</span> end,<span class="keyword">float</span> devicefreshRate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count =<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> diffNs=end-start;</span><br><span class="line">        <span class="keyword">long</span> diffMs = Math.round(diffNs / <span class="number">1000000.0f</span>);</span><br><span class="line">        <span class="keyword">long</span> dev=Math.round(devicefreshRate);</span><br><span class="line">        <span class="keyword">if</span>(diffMs&gt;dev)&#123;</span><br><span class="line">            <span class="keyword">long</span> skipCount=diffMs/dev;</span><br><span class="line">            count=(<span class="keyword">int</span>)skipCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有跳帧的时候输出的日志是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">02-07 20:21:53.909 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7177466379568  currentFrameTimeNanos=7177466379568  skipFrameCount=0</span><br><span class="line">02-07 20:21:53.925 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7177483046234  currentFrameTimeNanos=7177483046234  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.133 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=200.0  frameTimeNanos=7177683046226  currentFrameTimeNanos=7177683046226  skipFrameCount=11</span><br><span class="line">02-07 20:21:54.745 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=616.6666  frameTimeNanos=7178299712868  currentFrameTimeNanos=7178299712868  skipFrameCount=36</span><br><span class="line">02-07 20:21:54.757 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178316379534  currentFrameTimeNanos=7178316379534  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.773 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178333046200  currentFrameTimeNanos=7178333046200  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.789 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178349712866  currentFrameTimeNanos=7178349712866  skipFrameCount=0</span><br></pre></td></tr></table></figure>
<p>看到两次绘制的时间间隔相差616.6666毫秒，跳过了36帧，这个卡顿用户是能够明显感知的。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/d126640eccb1" target="_blank" rel="noopener">Android性能优化第（十 一）篇—卡顿分析，正确评测流畅度</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/17/java基础/Timer设计缺陷分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/17/java基础/Timer设计缺陷分析/" itemprop="url">Timer设计缺陷分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-17T14:41:53+08:00">
                2019-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>APP模块中使用Timer需要实现一个10秒一次的心跳</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mHeartBeatTimer = <span class="keyword">new</span> Timer();</span><br><span class="line">mHeartBeatTimerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//直接在Timer线程进行API请求，未开启线程</span></span><br><span class="line"> 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			ExceptionUtil.handle(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">mHeartBeatTimer.schedule(mHeartBeatTimerTask, <span class="number">0</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>上线后发现存在心跳丢失问题。</p>
<p>排查bugly发现没有任何异常和崩溃，初步怀疑是Timer的问题。</p>
<h1 id="Timer缺陷"><a href="#Timer缺陷" class="headerlink" title="Timer缺陷"></a>Timer缺陷</h1><p>下面来自《Java并发编程实战》：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.Timer在执行所有定时任务时只会创建一个线程。</span><br><span class="line">	如果某个任务的执行时间长度大于其周期时间长度，那么就会导致这一次的任务还在执行，而下一个周期的任务已经需要开始执行了，</span><br><span class="line">	当然在一个线程内这两个任务只能顺序执行，有两种情况：对于之前需要执行但还没有执行的任务，</span><br><span class="line">		scheduleAtFixedRate，任务快速调用。当前任务执行完马上执行那些任务（按顺序来），</span><br><span class="line">		schedule，任务丢失。干脆把那些任务丢掉，不去执行它们。</span><br><span class="line">2.如果TimerTask抛出了一个未检出的异常，那么Timer线程就会被终止掉，</span><br><span class="line">之前已经被调度但尚未执行的TimerTask就不会再执行了，新的任务也不能被调度了。</span><br></pre></td></tr></table></figure>
<h1 id="Timer源码分析"><a href="#Timer源码分析" class="headerlink" title="Timer源码分析"></a>Timer源码分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">	<span class="comment">//任务队列。</span></span><br><span class="line">	<span class="comment">//内部是一个数组，按任务执行时间排序</span></span><br><span class="line">	<span class="comment">//存放Timer的TimerTask；Timer生产，TimerThread消费</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> TaskQueue queue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line">	<span class="comment">//Thread子类。run()中死循环 检查和执行 任务队列的任务</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> TimerThread thread = <span class="keyword">new</span> TimerThread(queue);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//构造方法。设置线程名称和Daemon，开启线程</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name, <span class="keyword">boolean</span> isDaemon)</span> </span>&#123;</span><br><span class="line">        thread.setName(name);</span><br><span class="line">        thread.setDaemon(isDaemon);</span><br><span class="line">        thread.start();<span class="comment">//开启</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, Date firstTime, <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//period设置为负值</span></span><br><span class="line">        sched(task, firstTime.getTime(), -period);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleAtFixedRate</span><span class="params">(TimerTask task, Date firstTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Non-positive period."</span>);</span><br><span class="line">        sched(task, firstTime.getTime(), period);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sched</span><span class="params">(TimerTask task, <span class="keyword">long</span> time, <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal execution time."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制period最大值</span></span><br><span class="line">        <span class="keyword">if</span> (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>))</span><br><span class="line">            period &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!thread.newTasksMayBeScheduled)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Timer already cancelled."</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//设置task属性</span></span><br><span class="line">            <span class="keyword">synchronized</span>(task.lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (task.state != TimerTask.VIRGIN)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">"Task already scheduled or cancelled"</span>);</span><br><span class="line">                task.nextExecutionTime = time;</span><br><span class="line">                task.period = period;</span><br><span class="line">                task.state = TimerTask.SCHEDULED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//将task加入队列</span></span><br><span class="line">            queue.add(task);</span><br><span class="line">            <span class="keyword">if</span> (queue.getMin() == task)</span><br><span class="line">                queue.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	<span class="comment">//用来标识是否可以添加新任务</span></span><br><span class="line">    <span class="keyword">boolean</span> newTasksMayBeScheduled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> TaskQueue queue;</span><br><span class="line"></span><br><span class="line">    TimerThread(TaskQueue queue) &#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mainLoop();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Someone killed this Thread, behave as if Timer cancelled</span></span><br><span class="line">            <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">                newTasksMayBeScheduled = <span class="keyword">false</span>;</span><br><span class="line">                queue.clear();  <span class="comment">// Eliminate obsolete references</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimerTask task;</span><br><span class="line">                <span class="keyword">boolean</span> taskFired;<span class="comment">//任务是否过期(执行时间&lt;=现在时间)</span></span><br><span class="line">                <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">                    <span class="comment">// 死循环，等待任务队列非空</span></span><br><span class="line">                    <span class="keyword">while</span> (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)</span><br><span class="line">                        queue.wait();</span><br><span class="line">                    <span class="keyword">if</span> (queue.isEmpty())</span><br><span class="line">                        <span class="keyword">break</span>; <span class="comment">// 任务队列为空，且不可添加新任务，结束TimerThread线程</span></span><br><span class="line">                    <span class="comment">// 任务队列非空，检查和执行第一个任务</span></span><br><span class="line">                    <span class="keyword">long</span> currentTime, executionTime;</span><br><span class="line">                    task = queue.getMin();</span><br><span class="line">                    <span class="keyword">synchronized</span>(task.lock) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (task.state == TimerTask.CANCELLED) &#123;</span><br><span class="line">                            queue.removeMin();</span><br><span class="line">                            <span class="keyword">continue</span>;  <span class="comment">// 该任务已取消，直接从队列中移除，等待下一任务</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        currentTime = System.currentTimeMillis();</span><br><span class="line">                        executionTime = task.nextExecutionTime;</span><br><span class="line">                        <span class="comment">//任务已过期</span></span><br><span class="line">                        <span class="keyword">if</span> (taskFired = (executionTime&lt;=currentTime)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (task.period == <span class="number">0</span>) &#123; <span class="comment">// 不需要重复执行，直接移除</span></span><br><span class="line">                                queue.removeMin();</span><br><span class="line">                                task.state = TimerTask.EXECUTED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 需要重复执行，修改task下一次执行时间，并刷新任务队列排序</span></span><br><span class="line">                                queue.rescheduleMin(</span><br><span class="line">                                  task.period&lt;<span class="number">0</span> ? currentTime - task.period</span><br><span class="line">                                                : executionTime + task.period);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!taskFired) <span class="comment">// Task hasn't yet fired; wait</span></span><br><span class="line">                        queue.wait(executionTime - currentTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (taskFired)  <span class="comment">// 任务已过期，立即执行</span></span><br><span class="line">                    task.run();</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;<span class="comment">//捕获异常</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Timer在执行定时任务时只创建一个线程，如果任务耗时超过了两个任务的间隔时间，会发生一些缺陷<ul>
<li>schedule <strong>Timer任务丢失</strong>    <ul>
<li>period&lt;0，下一次执行时间 = currentTime - task.period；</li>
<li>任务被重置。从现在开始，period周期间隔后执行一次任务。</li>
<li>那么之前预想在period这个间隔内存在的任务执行就没了，也就是 <strong>任务丢失</strong> 问题</li>
</ul>
</li>
<li>scheduleAtFixedRate <strong>Timer任务快速调用</strong><ul>
<li>period&gt;0，下一次执行时间 = executionTime + task.period；</li>
<li>下一次任务还是按原来的算。从原来应该的执行时间开始，period周期间隔后执行一次任务。</li>
<li>如果这时executionTime + task.period还先于currentTime，那么下一个任务就会马上执行，也就是 <strong>任务快速调用</strong> 问题。</li>
</ul>
</li>
</ul>
</li>
<li><p>TimerTask异常导致 <strong>Timer线程异常结束</strong></p>
<ul>
<li>TimerThread run方法的死循环只捕获了 <strong>InterruptedException</strong>  异常<ul>
<li>当前线程可以被中断，被操作系统挂到一边休息，然后又回来继续执行</li>
<li>其它异常，那么整个循环就挂掉，导致线程结束</li>
</ul>
</li>
</ul>
</li>
<li><p>Timer执行周期任务时 <strong>依赖系统时间</strong> ,修改系统时间容易导致任务被挂起（如果当前时间小于执行时间）</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用Timer实现定时发心跳包可能会有问题</p>
<p>如果Timer线程在执行过程中被中断了，那么调用schedule的就很有可能导致心跳包没有发出去，而调用scheduleAtFixedRate的又可能会导致Timer线程没有占用CPU时心跳包没发出去，某一时刻又快速地发送好几个心跳包。</p>
<p>因此在Android中如果需要一个严格准时的定时操作，一般使用 <strong>AlarmManager</strong> 实现。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.csdn.net/u012619640/article/details/50749715" target="_blank" rel="noopener">Java中的Timer源码分析及缺陷</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/Android/View.post不靠谱/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/10/Android/View.post不靠谱/" itemprop="url">View.post不靠谱</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T18:36:53+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>有时候，我们会用 View.post() 方法，来将一个 Runnable 发送到主线程去执行。这一切，看似很美好，它最终会通过一个 Handler.post() 方法去执行，又避免我们重新定义一个 Handler 对象。</p>
<p>但是，在 Android 7.0（Api level 24） 上，View.post() 将不再那么靠谱了，你post() 出去的 Runnable ，可能永远也不会有机会得到执行。</p>
<h1 id="post-在-7-0-的差异"><a href="#post-在-7-0-的差异" class="headerlink" title="post 在 7.0 的差异"></a>post 在 7.0 的差异</h1><p>在 Api23 及以下，<code>executeAction()</code> 是会被<strong>循环调用</strong>（一个 VSync 的间隔），基本上其内的 mActions 中，只要有未执行的 Runnable 立刻就会被消费掉</p>
<p>在 Api24 及以上，<code>executeActions()</code> 只在 <code>dispatchAttachedToWindow()</code> 中才有机会被<strong>调用一次</strong>，而 <code>View.dispatchAttachedToWindow()</code> 只有在这个 View 通过 addView() 方法，或者原本写在页面布局的 xml 中（实际上也是调用的 addView()），加入到一个 ViewGroup 的时候，才会被调用到</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>View.post() 方法，在不同版本的差异，根本原因还是在于 Api23 和 Api24 中，<code>executeActions()</code> 方法的调用时机不同，导致 View 在没有 mAttachInfo 对象的时候，表现不一样了。</p>
<p>所以我们在使用的过程中需要慎用，区分出实际使用的场景，一般规范自己的代码即可：</p>
<ul>
<li>动态创建的 View ，如果视条件去决定是否加入到根布局中，则不要使用它来调用 post() 方法。</li>
<li>尽量避免使用 View.post() 方法，可以直接使用 Handler.post() 方法来替代。</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.cnblogs.com/plokmju/p/7481727.html" target="_blank" rel="noopener">View.post() 不靠谱的地方你知道吗？</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/Android/View 的可见性检查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/10/Android/View 的可见性检查/" itemprop="url">View 的可见性检查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T18:24:53+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/2019/07/10/Android/View%20的可见性检查/visibility.png">
<p>四种方法获取的结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">View5.getVisibility() = View.VISIBLE;</span><br><span class="line">View5.isShown() = <span class="keyword">true</span>; </span><br><span class="line">View5.getGlobalVisibleRect() = <span class="keyword">false</span>;</span><br><span class="line">View5.getLocalVisibleRect() =  <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<h1 id="View-getVisibility"><a href="#View-getVisibility" class="headerlink" title="View.getVisibility()"></a>View.getVisibility()</h1><p>最基本的检查View可见性的方法</p>
<p>如果这个方法返回的是View.INVISIBLE或者View.GONE，那么这个View肯定是对用户不可见的。</p>
<h1 id="View-isShown"><a href="#View-isShown" class="headerlink" title="View.isShown()"></a>View.isShown()</h1><ul>
<li>递归</li>
<li>检查View以及它的parentView的Visibility == View.VISIBLE，</li>
<li>检查parentView == null<ul>
<li>也就是说所有的parentView都不能为null。否则就说明这个View根本没有被addView过</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the visibility of this view and all of its ancestors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> True if this view and all of its ancestors are &#123;<span class="doctag">@link</span> #VISIBLE&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    View current = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((current.mViewFlags &amp; VISIBILITY_MASK) != VISIBLE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ViewParent parent = current.mParent;</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// We are not attached to the view root</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(parent <span class="keyword">instanceof</span> View)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        current = (View) parent;</span><br><span class="line">    &#125; <span class="keyword">while</span> (current != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="View-getGlobalVisibleRect"><a href="#View-getGlobalVisibleRect" class="headerlink" title="View.getGlobalVisibleRect()"></a>View.getGlobalVisibleRect()</h1><p>返回一个View是否可见的boolean值，同时还会将该View的可见区域left，top，right，bottom值保存在一个rect对象中</p>
<p>获得的rect坐标系的原点是屏幕的左上角</p>
<p>调用的是<code>getGlobalVisibleRect(Rect r, Point globalOffset)</code></p>
<h1 id="View-getLocalVisibleRect"><a href="#View-getLocalVisibleRect" class="headerlink" title="View.getLocalVisibleRect()"></a>View.getLocalVisibleRect()</h1><p>获得的rect坐标系的原点是View自己的左上角</p>
<p>其也会调用<code>getGlobalVisibleRect()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getLocalVisibleRect</span><span class="params">(Rect r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Point offset = mAttachInfo != <span class="keyword">null</span> ? mAttachInfo.mPoint : <span class="keyword">new</span> Point();</span><br><span class="line">    <span class="keyword">if</span> (getGlobalVisibleRect(r, offset)) &#123;</span><br><span class="line">        r.offset(-offset.x, -offset.y); <span class="comment">// make r local</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先获取View的offset point（相对屏幕或者ParentView的偏移坐标），</li>
<li>再调用getGlobalVisibleRect(Rect r, Point globalOffset)方法来获取可见区域</li>
<li>最后再把得到的GlobalVisibleRect和Offset坐标做一个加减法，转换坐标系原点</li>
</ul>
<p>View在屏幕中全部不可见时(图中view5)，两者的visibility都为false，且两者获取的rect值相同。由源码可以知道，getLocalVisibleRect()最终调用的是getGlobalVisibleRect()方法，并会减去View自身的便偏移坐标offset point，但只有当View可见时才会减去这个偏移坐标，要是不可见就直接返回了，所以此时两者获取出的rect值是相同的</p>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><ul>
<li><code>getGlobalVisibleRect()</code> <code>getLocalVisibleRect()</code>判断View的可见性时，一定要等View绘制完成后，再去调用这两个方法，否则无法得到对的结果，返回值的rect值都是0，visibility为false。这和获取View的宽高原理是一样的，如果View没有被绘制完成，那么View.getWidth和View.getHeight一定是等于0的</li>
<li><code>getGlobalVisibleRect()</code>只能检查出这个View在手机屏幕（或者说是相对它的父View）的位置，而不能检查出与其他兄弟View的相对位置:<br>比如有一个ViewGroup，下面有View1、View2这两个子View，View1和View2是平级关系。此时如果View2盖住了View1，那么用getGlobalVisibleRect方法检查View1的可见性，得到的返回值依然是true，得到的可见矩形区域rect也是没有任何变化的。</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/30b0ae304518" target="_blank" rel="noopener">View 的可见性检查还可以这样</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/04/Android/setVisibility不起作用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/04/Android/setVisibility不起作用/" itemprop="url">setVisibility不起作用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-04T17:40:53+08:00">
                2019-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="控件本身正在执行动画"><a href="#控件本身正在执行动画" class="headerlink" title="控件本身正在执行动画"></a>控件本身正在执行动画</h1><p>解决方案：view.clearAnimation()</p>
<h1 id="控件还在使用当中"><a href="#控件还在使用当中" class="headerlink" title="控件还在使用当中"></a>控件还在使用当中</h1><p>比如设置点击某个ViewGroup的子View后，让改ViewGroup 消失。就极有可能导致setVisibility 无效</p>
<p>解决方案：利用Handler.post()发送 setVisibility任务</p>
<h1 id="设备性能问题"><a href="#设备性能问题" class="headerlink" title="设备性能问题"></a>设备性能问题</h1><p>方案一：</p>
<p>利用Handler.post()发送 setVisibility任务</p>
<p>这个方法同样适用于<strong>动画不生效等其他UI异常</strong></p>
<p>方案二：重新加载，即重新构造。</p>
<p>setVisibility 后 调用view.invalidate()或者view.postinvalidate()；</p>
<p>如果也不行，直接调用自身的requestLayout或者其父容器的requestLayout()进行强制的界面即时刷新重构;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/24/java基础/线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/24/java基础/线程/" itemprop="url">线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-24T16:31:53+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="进程内某个线程OOM，其他线程还能运行吗"><a href="#进程内某个线程OOM，其他线程还能运行吗" class="headerlink" title="进程内某个线程OOM，其他线程还能运行吗"></a>进程内某个线程OOM，其他线程还能运行吗</h1><p><strong>能</strong></p>
<p><strong>堆进程内共享</strong></p>
<p>在多线程环境下，每个线程拥有一个栈和一个程序计数器。栈和程序计数器用来保存线程的执行历史和线程的执行状态，是线程私有的资源。其他的资源（比如堆、地址空间、全局变量）是由同一个进程内的多个线程共享。</p>
<p>一个线程抛出OOM异常后，它所占据的内存资源会全部被释放掉，从而不会影响其他线程的运行！</p>
<h1 id="主线程异常退出，子线程还能运行么？"><a href="#主线程异常退出，子线程还能运行么？" class="headerlink" title="主线程异常退出，子线程还能运行么？"></a>主线程异常退出，子线程还能运行么？</h1><p><strong>能</strong></p>
<p>线程不像进程，一个进程中的线程之间是没有父子之分的，都是平级关系。即线程都是一样的, 退出了一个不会影响另外一个。</p>
<p>只有一个例外情况，如果这些子线程都是<strong>守护线程</strong>，那么子线程会随着主线程结束而结束。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/22/Android/Crash防护/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/Android/Crash防护/" itemprop="url">Crash防护</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T11:26:53+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="捕获所有异常"><a href="#捕获所有异常" class="headerlink" title="捕获所有异常"></a>捕获所有异常</h1><p>虽然强行捕获所有运行时异常，会导致各种UI上的奇葩问题发生，但可以最大程度的保证APP正常运行，很多时候我们希望即使主线程抛出异常也不影响app的正常使用</p>
<p><strong>核心：保证主线程Looper继续Loop</strong></p>
<h2 id="try-catch机制的性能损耗"><a href="#try-catch机制的性能损耗" class="headerlink" title="try-catch机制的性能损耗"></a>try-catch机制的性能损耗</h2><p>研究方式：</p>
<h3 id="函数耗时"><a href="#函数耗时" class="headerlink" title="函数耗时"></a>函数耗时</h3><p>写两个一样逻辑的函数，一个包含try-catch代码块，一个不包含，分别循环调用百万次，通过System.nanoTime()来比较两个函数百万次调用的耗时；</p>
<p>测试发现基本无区别</p>
<h3 id="反编译字节码"><a href="#反编译字节码" class="headerlink" title="反编译字节码"></a>反编译字节码</h3><p>反编译出指令发现加了try-catch块的代码跟没有加的代码运行时的指令是完全一致的</p>
<p>如果程序运行过程中不产生异常的话，try catch 几乎是不会对运行产生任何影响的。只是在产生异常的时候jvm会追溯异常栈。这部分耗时就相对较高了。</p>
<h2 id="异常类型"><a href="#异常类型" class="headerlink" title="异常类型"></a>异常类型</h2><p>Android的View绘制，事件分发，Activity启动，Activity的生命周期回调等等都是一个个的Message，系统会把这些Message插入到主线程中唯一的queue中，所有的消息都排队等待Looper将其取出，并在主线程执行</p>
<ul>
<li>一般线程异常。</li>
<li>UI主线程异常。<ul>
<li>View导致Choreographer异常。<ul>
<li>可能黑白屏。关闭当前异常的界面</li>
</ul>
</li>
<li>Activity异常。<ul>
<li>生命周期异常。可能黑白屏。关闭当前异常的界面</li>
</ul>
</li>
<li>四大组件生命周期异常。</li>
</ul>
</li>
</ul>
<h2 id="一般线程-默认的线程未捕获异常Handler"><a href="#一般线程-默认的线程未捕获异常Handler" class="headerlink" title="一般线程-默认的线程未捕获异常Handler"></a>一般线程-默认的线程未捕获异常Handler</h2><p><strong>Thread.UncaughtExceptionHandler</strong> 接口，处理 未捕获的异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread thread, Throwable ex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android中，应用进程fork出来后会为虚拟机中的每个线程设置一个默认的 UncaughtExceptionHandler – <strong>UncaughtHandler</strong></p>
<p><strong>Thread.setDefaultUncaughtExceptionHandler(new UncaughtHandler());</strong></p>
<p><strong>UncaughtHandler</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RuntimeInit.java中的zygoteInit函数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ............</span><br><span class="line">    commonInit();</span><br><span class="line">    ............</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commonInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...........</span><br><span class="line">    <span class="comment">/* set default handler; this applies to all threads in the VM */</span></span><br><span class="line">    Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> UncaughtHandler());</span><br><span class="line">    ...........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="思路：自定义UncaughtExceptionHandler"><a href="#思路：自定义UncaughtExceptionHandler" class="headerlink" title="思路：自定义UncaughtExceptionHandler"></a>思路：自定义UncaughtExceptionHandler</h3><p>我们可以给应用设置我们自定义的UncaughtExceptionHandler</p>
<p>如果自定义UncaughtExceptionHandler捕获异常后不做任何处理：</p>
<ul>
<li>子线程发生未捕获异常，不会Crash。子线程被终止，主线程还在运行</li>
<li><strong>主线程</strong>发生未捕获异常，会<strong>ANR</strong>。主线程被终止</li>
</ul>
<h2 id="UI主线程-消息循环机制"><a href="#UI主线程-消息循环机制" class="headerlink" title="UI主线程-消息循环机制"></a>UI主线程-消息循环机制</h2><p><strong>Android 消息循环机制：Handler和Looper</strong></p>
<p>Android应用启动流程可知，进程创建完成之后，Android应用程序框架层就会在这个进程中 执行 主线程的入口方法 <strong>ActivityThread.main()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityThread .java</span></span><br><span class="line"><span class="comment">//主线程的入口方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">     <span class="comment">//创建主线程的Looper和MessageQueue</span></span><br><span class="line">     Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个ActivityThread实例，然后调用它的attach函数，</span></span><br><span class="line">    <span class="comment">//ActivityManagerService通过Binder进程间通信机制通知ActivityThread，启动应用首页</span></span><br><span class="line">     ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">     thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">         sMainThreadHandler = thread.getHandler();</span><br><span class="line">     &#125;</span><br><span class="line">    .......</span><br><span class="line">   <span class="comment">//开启主线程的消息循环。</span></span><br><span class="line">     Looper.loop();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="思路：捕获每个消息循环的异常"><a href="#思路：捕获每个消息循环的异常" class="headerlink" title="思路：捕获每个消息循环的异常"></a>思路：捕获每个消息循环的异常</h3><ul>
<li>通过Handler往主线程的queue中添加一个Runnable </li>
<li>该Runnable是while死循环</li>
<li>while死循环中调用Looper.loop()<ul>
<li>使主线程又开始不断的读取queue中的Message并执行，也就是<strong>主线程并不会被阻塞</strong>。</li>
<li>又可以保证<strong>以后</strong>主线程的<strong>所有异常</strong>都会从我们手动调用的Looper.loop()处抛出</li>
</ul>
</li>
</ul>
<p>Android应用的主线程是阻塞在ActivityThread.main()中的Looper.loop()的for(;;)循环里，后来for循环取到我们的runnable之后，程序的流程就阻塞在了我们的runnable里面了。</p>
<p>必须通过Handler往主线程的queue中添加一个Runnable，而不能在主线程中直接开启while循环，原因还是会阻塞主线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Handler(Looper.getMainLooper()).post(</span><br><span class="line">	<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">//主线程异常拦截</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Looper.loop();<span class="comment">//主线程的异常会从这里抛出</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                                            </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">   </span><br><span class="line">sUncaughtExceptionHandler = Thread.getDefaultUncaughtExceptionHandler();</span><br><span class="line"> <span class="comment">//所有线程异常拦截，由于主线程的异常都被我们catch住了，所以下面的代码拦截到的都是子线程的异常</span></span><br><span class="line">Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> Thread.UncaughtExceptionHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="View导致Choreographer异常-关闭页面"><a href="#View导致Choreographer异常-关闭页面" class="headerlink" title="View导致Choreographer异常-关闭页面"></a>View导致Choreographer异常-关闭页面</h2><p>可能会黑白屏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DefenseCore.java</span></span><br><span class="line"><span class="comment">//遍历错误堆栈，如果是Choreographer.doFrame()，可能会黑白屏</span></span><br><span class="line">StackTraceElement[] elements = error.getStackTrace();</span><br><span class="line"><span class="keyword">if</span> (elements == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = elements.length - <span class="number">1</span>; i &gt; -<span class="number">1</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elements.length - i &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    StackTraceElement element = elements[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"android.view.Choreographer"</span>.equals(element.getClassName())</span><br><span class="line">            &amp;&amp; <span class="string">"Choreographer.java"</span>.equals(element.getFileName())</span><br><span class="line">            &amp;&amp; <span class="string">"doFrame"</span>.equals(element.getMethodName())) &#123;</span><br><span class="line">        dispatcher.mayBeBlackScreen(e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Activity异常"><a href="#Activity异常" class="headerlink" title="Activity异常"></a>Activity异常</h2><h3 id="反射替换ActivityThread的Instrumentation"><a href="#反射替换ActivityThread的Instrumentation" class="headerlink" title="反射替换ActivityThread的Instrumentation"></a>反射替换ActivityThread的Instrumentation</h3><p>Android framework 通过<strong>Instrumentation</strong>来调用Activity的所有生命周期方法，通过反射替换ActivityThread的成员变量<strong>mInstrumentation</strong>来尝试修复Activity生命周期回调中的崩溃。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HookInstrumentation.java</span></span><br><span class="line"><span class="comment">// 先获取到当前的ActivityThread对象</span></span><br><span class="line">Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到原始的 mInstrumentation字段</span></span><br><span class="line">Field mInstrumentationField = activityThreadClass.getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">mInstrumentationField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">mOriginInstrumentation = (Instrumentation) mInstrumentationField.get(currentActivityThread);</span><br><span class="line">mCustomInstrumentation = <span class="keyword">new</span> DefenseInstrumentation(mOriginInstrumentation);</span><br><span class="line">mCustomInstrumentation.setExceptionDispatcher(mExceptionDispatcher);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建代理Instrumentation对象</span></span><br><span class="line">Instrumentation evilInstrumentation = mCustomInstrumentation;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 偷梁换柱</span></span><br><span class="line">mInstrumentationField.set(currentActivityThread, evilInstrumentation);</span><br></pre></td></tr></table></figure>
<h3 id="反射为ActivityThread的Handler增加callback"><a href="#反射为ActivityThread的Handler增加callback" class="headerlink" title="反射为ActivityThread的Handler增加callback"></a>反射为ActivityThread的Handler增加callback</h3><p>反射ActivityThread的<strong>mH</strong>，给该<strong>Handler</strong>添加回调方法，因为在ActivityThread中该handler未实现callback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HookH.java</span></span><br><span class="line"><span class="comment">// 先获取到当前的ActivityThread对象</span></span><br><span class="line">Class activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Object activityThread = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>).invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到原始的 mH字段</span></span><br><span class="line">Field mhField = activityThreadClass.getDeclaredField(<span class="string">"mH"</span>);</span><br><span class="line">mhField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">mHHandler = (Handler) mhField.get(activityThread);</span><br><span class="line">Field callbackField = Handler.class.getDeclaredField(<span class="string">"mCallback"</span>);</span><br><span class="line">callbackField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//设置mCallback</span></span><br><span class="line">callbackField.set(mHHandler, mCallback);</span><br></pre></td></tr></table></figure>
<h2 id="Service和BroadcastReceiver异常"><a href="#Service和BroadcastReceiver异常" class="headerlink" title="Service和BroadcastReceiver异常"></a>Service和BroadcastReceiver异常</h2><p>Android framework 在调用四大组件生命周期的时候，如果出现了异常，会回调<strong>Instrumentation.onException()</strong>方法</p>
<p>通过Instrumentation的方法onException返回true来尝试修复Service和BroadcastReceiver生命周期回调中的崩溃。同时手动执行framework未完成的代码，防止生命周期不完整引起的ANR</p>
<h1 id="重启恢复"><a href="#重启恢复" class="headerlink" title="重启恢复"></a>重启恢复</h1><p>不对未捕获异常进行try-catch的话，那就只能让程序按照系统默认的处理杀掉进程。然后重启进程 恢复crash之前的Activity栈，达到比直接退出应用程序稍微好点的体验。实际使用时屏幕还是会有一个白屏闪烁，用户还是能够感知到APP崩溃了。有点鸡肋。</p>
<p>在启动每个Activity都记录起Activity的class对象以及所需要的Intent对象，应用崩溃后重启进程再通过这些缓存起来的Intent对象一次性把所有的Activity都启动起来。</p>
<p>但如果是启动过程中必现的BUG，这种方式会导致无限循环重启进程、恢复Activity。所以在一分钟内闪退两次就杀掉进程不再重启。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/01b69d91a3a8" target="_blank" rel="noopener">Android开发之打造永不崩溃的APP——Crash防护</a></li>
<li><a href="https://www.jianshu.com/p/76bff59b5418?utm_source=oschina-app" target="_blank" rel="noopener">如何优雅的避免android(安卓)运行时崩溃</a></li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/6747696" target="_blank" rel="noopener">Android应用程序进程启动过程的源代码分析</a></li>
<li><a href="https://blog.csdn.net/singwhatiwanna/article/details/50775201" target="_blank" rel="noopener">Android中MotionEvent的来源和ViewRootImpl</a></li>
<li><a href="https://github.com/android-notes/Cockroach" target="_blank" rel="noopener">GitHub Cockroach</a></li>
<li><a href="https://www.jianshu.com/p/76bff59b5418?utm_source=oschina-app" target="_blank" rel="noopener">DefenseCrash</a>  <strong>比较全面，View，Activity</strong><ul>
<li><a href="https://github.com/xuuhaoo/DefenseCrash" target="_blank" rel="noopener">DefenseCrash GitHub</a></li>
</ul>
</li>
<li><a href="https://blog.csdn.net/luweicheng24/article/details/88831327" target="_blank" rel="noopener">CrashDefend</a><ul>
<li><a href="https://github.com/luweicheng24/CrashDefend" target="_blank" rel="noopener">CrashDefend GitHub</a></li>
</ul>
</li>
<li><a href="https://juejin.im/post/5a38e9da51882506a463beb9" target="_blank" rel="noopener">GodBlessYou</a> <strong>koltin，修复Service和BroadcastReceiver中的Crash</strong><ul>
<li><a href="https://github.com/ximsfei/GodBlessYou" target="_blank" rel="noopener">GodBlessYou GitHub</a></li>
</ul>
</li>
<li><a href="https://www.javaworld.com/article/2076868/how-the-java-virtual-machine-handles-exceptions.html" target="_blank" rel="noopener">How the Java virtual machine handles exceptions</a></li>
<li><a href="https://github.com/Sunzxyong/Recovery" target="_blank" rel="noopener">Recovery GitHub</a></li>
<li><a href="https://blog.csdn.net/u010412719/article/details/50043865" target="_blank" rel="noopener">从字节码的角度来看try-catch-finally和return的执行顺序</a></li>
<li><a href="https://www.jianshu.com/p/0a12a85809df" target="_blank" rel="noopener">浅谈Android的编舞者Choreographer</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/16/Android/AOP实现点击防抖的gradle插件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/16/Android/AOP实现点击防抖的gradle插件/" itemprop="url">AOP实现点击防抖的gradle插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-16T18:10:53+08:00">
                2019-06-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="为什么使用AOP"><a href="#为什么使用AOP" class="headerlink" title="为什么使用AOP"></a>为什么使用AOP</h1><p>对旧代码零入侵</p>
<h1 id="为什么选择-ASM-实现-AOP"><a href="#为什么选择-ASM-实现-AOP" class="headerlink" title="为什么选择 ASM 实现 AOP"></a>为什么选择 ASM 实现 AOP</h1><p>因为ASM的语法更通俗易懂，并且与gradle的联动效果更好，能够非常方便的修改字节码</p>
<p>AspectJ在这些维度的比较上实在显得笨重。</p>
<h1 id="支持的点击事件"><a href="#支持的点击事件" class="headerlink" title="支持的点击事件"></a>支持的点击事件</h1><ul>
<li>View.OnClickListener</li>
<li>AdapterView.OnItemClickListener</li>
</ul>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>常规的集成</p>
<p>不需要配置混淆规则，因为纯字节码操作，没任何反射</p>
<h2 id="设置防抖间隔时间"><a href="#设置防抖间隔时间" class="headerlink" title="设置防抖间隔时间"></a>设置防抖间隔时间</h2><p>默认 300 milliseconds</p>
<p><code>DebouncedPredictor.FROZEN_WINDOW_MILLIS = 400L</code></p>
<h2 id="忽略某些点击方法"><a href="#忽略某些点击方法" class="headerlink" title="忽略某些点击方法"></a>忽略某些点击方法</h2><p>推荐 在 gradle 中配置，会自动 添加 <code>@Debounce</code>注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">debounce &#123;</span><br><span class="line">  // enable log</span><br><span class="line">  loggable = true</span><br><span class="line">  // java bytecode descriptor: [class: [methods]]</span><br><span class="line">  exclusion = [&quot;com/smartdengg/clickdebounce/ClickProxy&quot;: [&apos;onClick(Landroid/view/View;)V&apos;,</span><br><span class="line">                                                           &apos;onItemClick(Landroid/widget/AdapterView;Landroid/view/View;IJ)V&apos;]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>某些匿名内部类不太好在 gradle中配置，手动 添加 <code>@Debounce</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Debounced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><p><a href="https://github.com/SmartDengg/click-debounce" target="_blank" rel="noopener">click-debounce</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">214</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
