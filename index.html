<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="随心而动，随刃而行">
<meta property="og:type" content="website">
<meta property="og:title" content="风">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="风">
<meta property="og:description" content="随心而动，随刃而行">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="风">
<meta name="twitter:description" content="随心而动，随刃而行">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>风</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/编程思想/状态机机制--位运算的巧妙使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/26/编程思想/状态机机制--位运算的巧妙使用/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-26T19:42:24+08:00">
                2019-07-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="位运算在android源码中的使用"><a href="#位运算在android源码中的使用" class="headerlink" title="位运算在android源码中的使用"></a>位运算在android源码中的使用</h1><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><pre><code>1|2|4|8分别对应的二进制数：
    1 ： 0001
    2 ： 0010
    4 ： 0100
    8 ： 1000
</code></pre><h2 id="位运算应用口诀"><a href="#位运算应用口诀" class="headerlink" title="位运算应用口诀"></a>位运算应用口诀</h2><p>清零取反要用与，某位置一可用或</p>
<p>若要取反和交换，轻轻松松用异或</p>
<h2 id="添加多个标志位-–-或"><a href="#添加多个标志位-–-或" class="headerlink" title="添加多个标志位 – 或"></a>添加多个标志位 – 或</h2><pre><code>mIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED | Intent.FLAG_ACTIVITY_SINGLE_TOP );  
</code></pre><h2 id="判断某个标志位-–-与"><a href="#判断某个标志位-–-与" class="headerlink" title="判断某个标志位 – 与"></a>判断某个标志位 – 与</h2><pre><code>// 返回是否可点击  
return (((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE));  

if ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == 0)｛//intent.getFlags()不包含NEW_TASK  
...  
｝
</code></pre><h2 id="清除某个标志位-–-与-标志位"><a href="#清除某个标志位-–-与-标志位" class="headerlink" title="清除某个标志位 – 与~标志位"></a>清除某个标志位 – 与~标志位</h2><p>View.java</p>
<pre><code>private static final int PRESSED                = 0x00004000;
int mPrivateFlags ;

public void setPressed(boolean pressed) {
    if (pressed) {
        mPrivateFlags |= PRESSED;     // 添加PRESSED状态
    } else {
        mPrivateFlags &amp;= ~PRESSED;    // 取消PRESSED状态
    }
    refreshDrawableState();
    dispatchSetPressed(pressed);
}
</code></pre><h1 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h1><p>定义十六进制状态常量，和模式状态集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_1 = <span class="number">0x0001</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_2 = <span class="number">0x0002</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_3 = <span class="number">0x0004</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_4 = <span class="number">0x0008</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_5 = <span class="number">0x0010</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_6 = <span class="number">0x0020</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_7 = <span class="number">0x0040</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> STATUS_8 = <span class="number">0x0080</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_A = STATUS_1 | STATUS_2 | STATUS_3;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_B = STATUS_1 | STATUS_4 | STATUS_5 | STATUS_6;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_C = STATUS_1 | STATUS_7 | STATUS_8;</span><br></pre></td></tr></table></figure>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>一个分享对话框，可以分享到 微信好友，微信朋友圈，app好友，app社群</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre><code> private static final int BASE = 0x1;

/**
 * 展示微信好友
 */
public static final int WECHAT_CONTACTS = BASE;

/**
 * 展示微信朋友圈
 */
public static final int WECHAT_MOMENTS = BASE &lt;&lt; 1;

/**
 * 展示好友
 */
public static final int APP_CONTACTS = BASE &lt;&lt; 2;

/**
 * 展示社群
 */
public static final int APP_COMMUNITY = BASE &lt;&lt; 3;

public void show(int flag) {
    if ((WECHAT_CONTACTS &amp; flag) == 0) {
        wechatContacts.setVisibility(View.GONE);
    } else {
        wechatContacts.setVisibility(View.VISIBLE);
    }

    if ((WECHAT_MOMENTS &amp; flag) == 0) {
        wechatMoments.setVisibility(View.GONE);
    } else {
        wechatMoments.setVisibility(View.VISIBLE);
    }

    if ((APP_CONTACTS &amp; flag) == 0) {
        appContacts.setVisibility(View.GONE);
    } else {
        appContacts.setVisibility(View.VISIBLE);
    }

    if ((APP_COMMUNITY &amp; flag) == 0) {
        appCommunity.setVisibility(View.GONE);
    } else {
        appCommunity.setVisibility(View.VISIBLE);
    }

    dialog.show();
}
</code></pre><h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="http://blog.csdn.net/zzp16/article/details/7956768" target="_blank" rel="noopener">Android中巧妙的位运算</a></li>
<li><a href="https://juejin.im/post/5d1a148e6fb9a07ea6488ba3#heading-5" target="_blank" rel="noopener">Android 状态管理最佳实践</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/java基础/java虚拟机/深入理解java虚拟机面试精华总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/26/java基础/java虚拟机/深入理解java虚拟机面试精华总结/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-26T19:42:24+08:00">
                2019-07-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="jvm_1.jpg" alt=""></p>
<h1 id="一、运行时数据区-Runtime-Data-Area"><a href="#一、运行时数据区-Runtime-Data-Area" class="headerlink" title="一、运行时数据区 Runtime Data Area"></a>一、运行时数据区 Runtime Data Area</h1><p><img src="jvm_2.jpg" alt=""></p>
<p><strong>1. 程序计数器</strong></p>
<p>任一时刻，一个CPU的内核只会执行一条线程中的指令，因此，为了能够使得每个线程都在线程切换后能够恢复切换之前的程序执行位置，每个线程都需要有自己独立的程序计数器，不能互相被干扰，否则就会影响到程序的正常执行次序</p>
<p>如果线程执行的是非native方法，则程序计数器中保存的是当前需要执行的指令的地址；如果线程执行的是native方法，则程序计数器中的值是undefined。</p>
<p>所占空间的大小不会随程序的执行而发生改变，因此，对于程序计数器是不会发生内存溢出现象(OutOfMemory)</p>
<p><strong>2. Java栈</strong></p>
<p>就是我们常常所说的栈。</p>
<p>为执行Java方法(字节码)服务的，是Java方法执行的内存模型</p>
<p>每个线程正在执行的方法可能不同，因此每个线程都会有一个自己的Java栈，互不干扰。</p>
<p><img src="jvm_3.jpg" alt=""></p>
<p>Java栈中存放的是一个个的栈帧，每个栈帧对应一个被调用的方法</p>
<p>当线程执行一个方法时，就会随之创建一个对应的栈帧，并将建立的栈帧压栈。当方法执行完毕之后，便会将栈帧出栈。</p>
<p>规定了两种异常：</p>
<ul>
<li>线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常。</li>
<li>虚拟机扩展时无法申请到足够的内存，将抛出OutOfMemoryError异常(堆和方法区也会抛出OOM)</li>
</ul>
<p><strong>3. 本地方法栈</strong></p>
<p>为执行本地方法（Native Method）服务的</p>
<p>VM规范并没有对本地方法栈的具体实现方法以及数据结构作强制规定，虚拟机可以自由实现它。</p>
<p>HotSopt虚拟机直接就把本地方法栈和Java栈合二为一。</p>
<p>会抛出StackOverflowError和OutOfMemoryErroy异常</p>
<p><strong>4.堆</strong></p>
<p>C语言中，堆是程序员唯一可以管理的内存区域。程序员可以通过malloc函数和free函数在堆上申请和释放空间</p>
<p>Java中的堆是用来存储<strong>对象实例以及数组</strong>（当然，数组引用是存放在Java栈中）。</p>
<p>Java<strong>垃圾收集器</strong>管理的主要区域</p>
<p>Java堆细分为新生代和老年代(为了更好的管理内存)</p>
<p><strong>5.方法区</strong></p>
<p>存储了每个<strong>类的信息(类名称、方法信息、字段信息、接口信息)、静态变量、常量、运行时常量池以及编译器编译后的代码</strong>等</p>
<p>运行时常量池：</p>
<ul>
<li>加载 Class文件常量池<ul>
<li>储编译期间生成的字面常量和符号引用</li>
</ul>
</li>
<li>运行期间放入的<ul>
<li>比如String的intern方法，就能将常量放入运行时常量池</li>
</ul>
</li>
</ul>
<p>JVM规范中，<strong>不强制要求实现垃圾回收</strong>。</p>
<p>很多人习惯将方法区称为“永久代”，是因为HotSpot虚拟机以<strong>永久代</strong>来实现方法区，从而JVM的垃圾收集器可以像管理堆区一样管理这部分区域，从而不需要专门为这部分设计垃圾回收机制。</p>
<p>不过自从JDK7之后，Hotspot虚拟机便将运行时常量池从永久代移除了。</p>
<h1 id="二、对象"><a href="#二、对象" class="headerlink" title="二、对象"></a>二、对象</h1><p>hotspot虚拟机为例</p>
<p><strong>2.1 对象的创建</strong></p>
<p><strong>1.检查</strong> </p>
<p>检查new指令的参数能否在常量池中定位到一个类的符号引用</p>
<p>检查这个符号引用代表的类是否已经被加载、解析和初始化过。如果没有，执行相应的类加载过程</p>
<p><strong>2.分配内存</strong> </p>
<p>为新生对象分配内存</p>
<p>假设Java堆中内存是绝对规整的，所有用过的内存放在一遍，空闲的内存放在另一边，中间放着一个指针作为分界点的指示器，那所分配内存就仅仅是把那个指针指向空闲空间那边挪动一段与对象大小相等的距离，这个分配方式叫做“<strong>指针碰撞</strong>”</p>
<p>如果Java堆中的内存并不是规整的，已使用的内存和空闲的内存相互交错，那就没办法简单地进行指针碰撞了，虚拟机就必须维护一个列表，记录上哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录，这种分配方式成为“<strong>空闲列表</strong>”</p>
<p>选择那种分配方式由Java堆是否规整决定，而Java堆是否规整又由所采用的垃圾收集器是否带有压缩整理功能决定。</p>
<p><strong>3. Init</strong></p>
<p>执行new指令之后会接着执行Init方法，进行初始化，这样一个对象才算产生出来</p>
<p><strong>2.2 对象的内存布局</strong></p>
<p>对象在内存中储存的布局可以分为3块区域：</p>
<ul>
<li>对象头。包括两部分：<ul>
<li>对象自身的运行时数据，如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳</li>
<li>类型指针，即对象指向它的类元数据的指针，虚拟机通过这个来确定对象是哪个类的实例</li>
</ul>
</li>
<li>实例数据</li>
<li>对齐填充</li>
</ul>
<p><strong>2.3 对象的访问定位</strong></p>
<ul>
<li>使用句柄访问<ul>
<li>reference存储的是对象的句柄地址(Java堆中有句柄池)</li>
<li>句柄中包含了对象实例数据与类型数据各自的具体地址</li>
<li>优势:对象被移动(垃圾收集时移动对象是非常普遍的行为)时只会改变句柄中的实例数据指针，而reference本身不需要修改</li>
</ul>
</li>
<li>使用直接指针访问<br>  -refreence存储的直接就是对象的地址<ul>
<li>Java堆对象的布局必须考虑如何访问类型数据的相关信息</li>
<li>优势：速度更快，节省了一次指针定位的时间开销</li>
</ul>
</li>
</ul>
<h1 id="三、OutOfMemoryError-异常"><a href="#三、OutOfMemoryError-异常" class="headerlink" title="三、OutOfMemoryError 异常"></a>三、OutOfMemoryError 异常</h1><p>3.1 Java堆溢出</p>
<p>检查虚拟机的堆参数（-Xmx与-Xms），与机器物理内存对比看是否还可以调大</p>
<p>3.2 虚拟机栈和本地方法栈溢出</p>
<p>3.3 方法区和运行时常量池溢出</p>
<p>由于常量池分配在永久代中，可以通过-XX:PermSize和-XX:MaxPermSize限制方法区大小，从而间接限制其中常量池的容量。</p>
<h1 id="四、垃圾收集"><a href="#四、垃圾收集" class="headerlink" title="四、垃圾收集"></a>四、垃圾收集</h1><p><strong>1.判断对象存活</strong></p>
<p><strong>4.1.1 引用计数器法</strong></p>
<p>给对象添加一个引用计数器，每当由一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不可能再被使用的</p>
<p><strong>4.1.2 可达性分析算法</strong></p>
<p>通过一系列的“GC Roots”对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径成为引用链，当一个对象到GC ROOTS没有任何引用链相连时，则证明此对象时不可用的</p>
<p>Java语言中GC Roots对象包括下面几种：</p>
<p>1.虚拟机栈（栈帧中的<strong>本地变量</strong>表）中引用的对象</p>
<p>2.本地方法栈<strong>JNI</strong>（Native方法）引用的对象</p>
<p>3.方法区中<strong>类静态成员</strong>引用的对象</p>
<p>4.方法区中<strong>常量</strong>引用的对象</p>
<p><strong>2.对象引用</strong></p>
<ul>
<li><p>强引用</p>
<ul>
<li>Object obj </li>
<li>垃圾收集器永远不会回收掉被强引用引用的对象</li>
</ul>
</li>
<li><p>软引用</p>
<ul>
<li>SoftReference<object> sf = new SoftReference<object>(obj);</object></object></li>
<li><p>用于缓存数据。内存不足自动回收，如果这次回收还没有足够的内存才会抛出内存溢出异常</p>
<pre><code>Object obj = new Object();
SoftReference&lt;Object&gt; sf = new SoftReference&lt;Object&gt;(obj);
obj = null;
sf.get();//有时候会返回null
</code></pre></li>
</ul>
</li>
<li><p>弱引用</p>
<ul>
<li>WeakReference<object> wf</object></li>
<li><p>用于监控对象是否已经被垃圾回收器标记为即将回收的垃圾。无论当前内存是否足够都会回收掉只被弱引用关联的对象</p>
<pre><code>Object obj = new Object();
WeakReference&lt;Object&gt; wf = new WeakReference&lt;Object&gt;(obj);
obj = null;
wf.get();//有时候会返回null
wf.isEnQueued();//返回是否被垃圾回收器标记为即将回收的垃圾
</code></pre></li>
</ul>
</li>
<li><p>虚引用</p>
<ul>
<li>PhantomReference<object> pf = new PhantomReference<object>(obj);</object></object></li>
<li><p>用于检测对象是否已经从内存中删除。能在这个对象被收集器回收时收到一个系统通知</p>
<pre><code>Object obj = new Object();
PhantomReference&lt;Object&gt; pf = new PhantomReference&lt;Object&gt;(obj);
obj=null;
pf.get();//永远返回null
pf.isEnQueued();//返回是否从内存中已经删除
</code></pre></li>
</ul>
</li>
</ul>
<p><strong>3.Finalize方法</strong></p>
<p>任何一个对象的finalize()方法都只会被系统自动调用一次，如果对象面临下一次回收，它的finalize()方法不会被再次执行</p>
<p><strong>4.3.1 回收方法区</strong></p>
<p>永久代的垃圾收集主要回收两部分内容：废弃常量和无用的类</p>
<p>废弃常量：假如一个字符串abc已经进入了常量池中，如果当前系统没有任何一个String对象abc，也就是没有任何Stirng对象引用常量池的abc常量，也没有其他地方引用的这个字面量，这个时候发生内存回收这个常量就会被清理出常量池</p>
<p>无用的类：</p>
<p>1.该类所有的实例都已经被回收，就是Java堆中不存在该类的任何实例</p>
<p>2.加载该类的ClassLoader已经被回收</p>
<p>3.该类对用的java.lang.Class对象没有在任何地方被引用，无法再任何地方通过反射访问该类的方法</p>
<p><strong>4.垃圾收集算法</strong></p>
<p><strong>4.4.1 标记—清除算法</strong></p>
<p>算法分为标记和清除两个阶段：首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象、</p>
<p>不足:一个是效率问题，标记和清除两个过程的效率都不高；另一个是空间问题，标记清楚之后会产生大量不连续的内存碎片，空间碎片太多可能会导致以后再程序运行过程中需要分配较大的对象时，无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作</p>
<p><strong>4.4.2 复制算法</strong></p>
<p>他将可用内存按照容量划分为大小相等的两块，每次只使用其中的一块。当这块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。这样使得每次都是对整个半区进行内存回收，内存分配时也就不用考虑内存碎片等复杂情况，只要移动堆顶指针，按顺序分配内存即可</p>
<p>不足：将内存缩小为了原来的一半</p>
<p>实际中我们并不需要按照1:1比例来划分内存空间，而是将内存分为一块较大的Eden空间和两块较小的Survivor空间，每次使用Eden和其中一块Survivor</p>
<p>当另一个Survivor空间没有足够空间存放上一次新生代收集下来的存活对象时，这些对象将直接通过分配担保机制进入老年代</p>
<p><strong>4.4.3 标记整理算法</strong></p>
<p>让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存</p>
<p><strong>4.4.4 分代收集算法</strong></p>
<p>只是根据对象存活周期的不同将内存划分为几块。一般是把java堆分为新生代和老年代，这样就可以根据各个年代的特点采用最适当的收集算法。在新生代中，每次垃圾收集时都发现有大批对象死去，只有少量存活，那就选用复制算法，只需要付出少量存活对象的复制成本就可以完成收集。而老年代中因为对象存活率高、没有额外空间对它进行分配担保，就必须使用标记清理或者标记整理算法来进行回收</p>
<p>5.垃圾收集器</p>
<p>a)Serial收集器：</p>
<p>这个收集器是一个单线程的收集器，但它的单线程的意义不仅仅说明它会只使用一个COU或一条收集线程去完成垃圾收集工作，更重要的是它在进行垃圾收集时，必须暂停其他所有的工作线程，直到它手机结束</p>
<p>b)ParNew 收集器：</p>
<p>Serial收集器的多线程版本，除了使用了多线程进行收集之外，其余行为和Serial收集器一样</p>
<p>并行：指多条垃圾收集线程并行工作，但此时用户线程仍然处于等待状态</p>
<p>并发：指用户线程与垃圾收集线程同时执行（不一定是并行的，可能会交替执行），用户程序在继续执行，而垃圾收集程序运行于另一个CPU上</p>
<p>c)Parallel Scavenge </p>
<p>收集器是一个新生代收集器，它是使用复制算法的收集器，又是并行的多线程收集器。</p>
<p>吞吐量：就是CPU用于运行用户代码的时间与CPU总消耗时间的比值。即吞吐量=运行用户代码时间/（运行用户代码时间+垃圾收集时间）</p>
<p>d)Serial Old 收集器：</p>
<p>是Serial收集器的老年代版本,是一个单线程收集器，使用标记整理算法</p>
<p>e)Parallel Old 收集器：</p>
<p>Parallel Old是Paraller Seavenge收集器的老年代版本，使用多线程和标记整理算法</p>
<p>f)CMS收集器：</p>
<p>CMS收集器是基于标记清除算法实现的，整个过程分为4个步骤：</p>
<p>1.初始标记2.并发标记3.重新标记4.并发清除</p>
<p>优点：并发收集、低停顿</p>
<p>缺点：</p>
<p>1.CMS收集器对CPU资源非常敏感，CMS默认启动的回收线程数是（CPU数量+3）/4，</p>
<p>2.CMS收集器无法处理浮动垃圾，可能出现Failure失败而导致一次Full G场地产生</p>
<p>3.CMS是基于标记清除算法实现的</p>
<p>g)G1收集器：</p>
<p>它是一款面向服务器应用的垃圾收集器</p>
<p>1.并行与并发：利用多CPU缩短STOP-The-World停顿的时间</p>
<p>2.分代收集</p>
<p>3.空间整合：不会产生内存碎片</p>
<p>4.可预测的停顿</p>
<p>运作方式：初始标记，并发标记，最终标记，筛选回收</p>
<p><strong>6.内存分配与回收策略</strong></p>
<p>4.6.1 对象优先在Eden分配：</p>
<p>大多数情况对象在新生代Eden区分配，当Eden区没有足够空间进行分配时，虚拟机将发起一次Minor GC</p>
<p>4.6.2 大对象直接进入老年代：</p>
<p>所谓大对象就是指需要大量连续内存空间的Java对象，最典型的大对象就是那种很长的字符串以及数组。这样做的目的是避免Eden区及两个Servivor之间发生大量的内存复制</p>
<p>4.6.3长期存活的对象将进入老年代</p>
<p>如果对象在Eden区出生并且尽力过一次Minor GC后仍然存活，并且能够被Servivor容纳，将被移动到Servivor空间中，并且把对象年龄设置成为1.对象在Servivor区中每熬过一次Minor GC，年龄就增加1岁，当它的年龄增加到一定程度（默认15岁），就将会被晋级到老年代中</p>
<p>4.6.4动态对象年龄判定</p>
<p>为了更好地适应不同程序的内存状况，虚拟机并不是永远地要求对象的年龄必须达到了MaxTenuringThreshold才能晋级到老年代，如果在Servivor空间中相同年龄所有对象的大小总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进入到老年代，无须登到MaxTenuringThreshold中要求的年龄</p>
<p>4.6.4 空间分配担保：</p>
<p>在发生Minor GC 之前，虚拟机会检查老年代最大可 用的连续空间是否大于新生代所有对象总空间，如果这个条件成立，那么Minor DC可以确保是安全的。如果不成立，则虚拟机会查看HandlePromotionFailure设置值是否允许担保失败。如果允许那么会继续检查老年代最大可用的连续空间是否大于晋级到老年代对象的平均大小，如果大于，将尝试进行一次Minor GC，尽管这次MinorGC 是有风险的：如果小于，或者HandlePromotionFailure设置不允许冒险，那这时也要改为进行一次Full GC</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/java基础/异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/26/java基础/异常/" itemprop="url">异常</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-26T15:55:53+08:00">
                2019-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="异常声明"><a href="#异常声明" class="headerlink" title="异常声明"></a>异常声明</h1><p>属于方法说明的一部分，紧跟在参数列表之后</p>
<p><code>void method() throws IOException {}</code></p>
<p>子类在覆盖方法时，不能添加父类方法没有的异常声明（只能保持或者减少）。</p>
<h1 id="Throwable-方法汇总"><a href="#Throwable-方法汇总" class="headerlink" title="Throwable 方法汇总"></a>Throwable 方法汇总</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">getMessage()</span><br><span class="line">getLocalizedMessage()</span><br><span class="line">toString()</span><br><span class="line"></span><br><span class="line">getCause()</span><br><span class="line">initCause(Throwable cause)</span><br><span class="line"></span><br><span class="line">printStackTrace()</span><br><span class="line">getStackTrace()</span><br><span class="line">fillInStackTrace()</span><br><span class="line">setStackTrace(StackTraceElement[] stackTrace)</span><br><span class="line"></span><br><span class="line">addSuppressed(Throwable exception)</span><br><span class="line">getSuppressed()</span><br></pre></td></tr></table></figure>
<h2 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h2><p><code>throw new RuntimeException(&quot;My Exception&quot;);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getMessage(): My Exception</span><br><span class="line">getLocalizedMessage(): My Exception</span><br><span class="line">toString(): java.lang. RuntimeException: My Exception</span><br><span class="line"></span><br><span class="line">printStackTrace(): </span><br><span class="line">	java.lang. RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:<span class="number">9</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getLocalizedMessage()</code>和 <code>getMessage()</code> 返回构造方法传入的参数信息</li>
<li>toString() 返回异常完整类名和 <code>getMessage()</code>的信息</li>
<li>printStackTrace() 打印 <code>toString()</code>信息和异常堆栈</li>
</ul>
<h1 id="printStackTrace"><a href="#printStackTrace" class="headerlink" title="printStackTrace()"></a>printStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">(PrintStreamOrWriter s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Guard against malicious overrides of Throwable.equals by</span></span><br><span class="line">    <span class="comment">// using a Set with identity equality semantics.</span></span><br><span class="line">    Set&lt;Throwable&gt; dejaVu =</span><br><span class="line">        Collections.newSetFromMap(<span class="keyword">new</span> IdentityHashMap&lt;Throwable, Boolean&gt;());</span><br><span class="line">    dejaVu.add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (s.lock()) &#123;</span><br><span class="line">        <span class="comment">// Print our stack trace</span></span><br><span class="line">        s.println(<span class="keyword">this</span>);</span><br><span class="line">        StackTraceElement[] trace = getOurStackTrace();</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement traceElement : trace)</span><br><span class="line">            s.println(<span class="string">"\tat "</span> + traceElement);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print suppressed exceptions, if any</span></span><br><span class="line">        <span class="keyword">for</span> (Throwable se : getSuppressed())</span><br><span class="line">            se.printEnclosedStackTrace(s, trace, SUPPRESSED_CAPTION, <span class="string">"\t"</span>, dejaVu);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print cause, if any</span></span><br><span class="line">        Throwable ourCause = getCause();</span><br><span class="line">        <span class="keyword">if</span> (ourCause != <span class="keyword">null</span>)</span><br><span class="line">            ourCause.printEnclosedStackTrace(s, trace, CAUSE_CAPTION, <span class="string">""</span>, dejaVu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 自身 堆栈</li>
<li><strong>递归</strong> 打印 <strong>抑制(suppressed)异常链</strong> 堆栈<ul>
<li>第一行前缀 <code>Suppressed by:</code>在异常完整类名和构造参数之前 </li>
</ul>
</li>
<li><strong>递归</strong> 打印 <strong>cause</strong> 堆栈<ul>
<li>第一行前缀 <code>Caused by:</code>在异常完整类名和构造参数之前     </li>
</ul>
</li>
</ul>
<p>printEnclosedStackTrace() 是 <strong>递归方法</strong></p>
<h1 id="getOurStackTrace"><a href="#getOurStackTrace" class="headerlink" title="getOurStackTrace()"></a>getOurStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> StackTraceElement[] getOurStackTrace() &#123;</span><br><span class="line">    <span class="keyword">return</span> stackTrace;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>倒序</strong>记录着方法调用帧：后调用的在最前面/最顶上</p>
<ul>
<li>栈顶元素（元素0），是方法调用序列中最后一个方法调用</li>
<li>栈底元素（最后一个元素）是调用序列中的第一个方法调用</li>
</ul>
<h1 id="getStackTrace"><a href="#getStackTrace" class="headerlink" title="getStackTrace()"></a>getStackTrace()</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StackTraceElement[] getStackTrace() &#123;</span><br><span class="line">    <span class="keyword">return</span> getOurStackTrace().clone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="StackTraceElement"><a href="#StackTraceElement" class="headerlink" title="StackTraceElement"></a>StackTraceElement</h1><h1 id="重新抛出异常和异常链"><a href="#重新抛出异常和异常链" class="headerlink" title="重新抛出异常和异常链"></a>重新抛出异常和异常链</h1><h2 id="抛出原异常对象"><a href="#抛出原异常对象" class="headerlink" title="抛出原异常对象"></a>抛出原异常对象</h2><p>有时我们在捕获到异常后，可能在捕获的地方不适合处理该异常，我们需要将它重新抛出</p>
<p>这样就会存在一个问题，抛出的的异常携带的信息，是原来异常抛出点的调用栈信息，而非新抛出点的信息（新抛出点的调用信息就被掩盖了）。</p>
<p>可以使用 <code>fillInStackTrace()</code> 更新新抛出点信息到这个异常调用栈中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:9)</span><br><span class="line">	</span><br><span class="line">使用 fillInStackTrace() 后：</span><br><span class="line">java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:11)</span><br></pre></td></tr></table></figure>
<p>单纯的更新了抛出异常的所在函数</p>
<p><strong>不推荐使用</strong></p>
<h2 id="抛出新异常对象"><a href="#抛出新异常对象" class="headerlink" title="抛出新异常对象"></a>抛出新异常对象</h2><p>新建异常对象时传入原来的异常对象，或者调用 <code>initCause(Throwable cause)</code>传入原异常对象。</p>
<p>这样原来的异常对象作为 <code>cause</code> 保持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:14) //新异常抛出处</span><br><span class="line">Caused by: java.lang.RuntimeException: My Exception</span><br><span class="line">	at Test.main(Test.java:12) //老异常抛出处</span><br></pre></td></tr></table></figure>
<h2 id="异常抑制"><a href="#异常抑制" class="headerlink" title="异常抑制"></a>异常抑制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"try"</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// throw new RuntimeException("finally");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: try</span><br><span class="line">	at Test.main(Test.java:10)</span><br><span class="line">	</span><br><span class="line">finally 也抛出异常：</span><br><span class="line">java.lang.RuntimeException: finally</span><br><span class="line">	at Test.main(Test.java:12)</span><br></pre></td></tr></table></figure>
<p>finally 抑制了上一个异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Exception exception = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"try"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    exception = e;</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"finally"</span>);</span><br><span class="line">    <span class="keyword">if</span>(exception!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        e.addSuppressed(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: finally</span><br><span class="line">	at Test.main(Test.java:15)</span><br><span class="line">	Suppressed: java.lang.RuntimeException: try</span><br><span class="line">		at Test.main(Test.java:11)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/24/CocosCreator/CocosCreator新手上路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/24/CocosCreator/CocosCreator新手上路/" itemprop="url">CocosCreator新手上路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-24T18:30:53+08:00">
                2019-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/游戏/" itemprop="url" rel="index">
                    <span itemprop="name">游戏</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于-Cocos-Creator"><a href="#关于-Cocos-Creator" class="headerlink" title="关于 Cocos Creator"></a>关于 Cocos Creator</h1><p>是一个完整的游戏开发解决方案</p>
<p>包括了</p>
<ul>
<li>cocos2d-x 引擎的 JavaScript 实现（不需要学习一个新的引擎）</li>
<li>快速开发游戏所需要的各种图形界面工具</li>
</ul>
<h1 id="安装-Cocos-Creator"><a href="#安装-Cocos-Creator" class="headerlink" title="安装 Cocos Creator"></a>安装 Cocos Creator</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>访问 <a href="https://www.cocos.com/creator/" target="_blank" rel="noopener">Cocos Creator 产品首页</a> 上的下载链接获得 Cocos Creator 的安装包</p>
<p>兼容已有旧项目，选择 <a href="http://cocos2d-x.org/filedown/CocosCreator_v2.1.0_mac" target="_blank" rel="noopener">2.1.0版本</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Mac安装"><a href="#Mac安装" class="headerlink" title="Mac安装"></a>Mac安装</h3><p>操作系统要求：最低版本是 OS X 10.9</p>
<p>双击 DMG 文件，然后将 <code>CocosCreator.app</code> 拖拽到 <code>应用程序</code> 文件夹快捷方式</p>
<h1 id="安装配置原生开发环境"><a href="#安装配置原生开发环境" class="headerlink" title="安装配置原生开发环境"></a>安装配置原生开发环境</h1><p>如果只想开发 Web 平台的游戏，完成上面的步骤就足够了。</p>
<p>如果希望发布游戏到原生平台，就需要安装配置原生开发环境。</p>
<p>Cocos Creator 使用基于 cocos2d-x 引擎的 JSB 技术实现跨平台发布原生应用。</p>
<p>在使用 Cocos Creator 打包发布到原生平台之前，我们需要先配置好 cocos2d-x 相关的开发环境</p>
<h2 id="Android-平台相关依赖"><a href="#Android-平台相关依赖" class="headerlink" title="Android 平台相关依赖"></a>Android 平台相关依赖</h2><h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><h3 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h3><h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><h3 id="NDK"><a href="#NDK" class="headerlink" title="NDK"></a>NDK</h3><h2 id="C-编译环境"><a href="#C-编译环境" class="headerlink" title="C++ 编译环境"></a>C++ 编译环境</h2><p>Cocos2d-x 自带的编译工具 Cocos Console 需要以下运行环境：</p>
<ul>
<li><p>Python 2.7.5+，<a href="https://www.python.org/downloads/" target="_blank" rel="noopener">下载页</a>，注意不要下载 Python 3.x 版本。</p>
</li>
<li><p>Windows 下需要安装 Visual Studio 2015 或 2017 社区版，<a href="https://www.visualstudio.com/downloads/download-visual-studio-vs" target="_blank" rel="noopener">下载页</a></p>
</li>
<li>Mac 下需要安装 Xcode 和命令行工具，<a href="https://developer.apple.com/xcode/download/" target="_blank" rel="noopener">下载页</a></li>
</ul>
<h2 id="配置原生发布环境路径"><a href="#配置原生发布环境路径" class="headerlink" title="配置原生发布环境路径"></a>配置原生发布环境路径</h2><p>CocosCreator -&gt; <code>设置</code>，打开设置窗口</p>
<p>我们在这里需要配置以下两个路径：</p>
<p><code>NDK</code> 路径，选择 Android SDK Location 路径下的 ndk-bundle 文件夹（NDK 是其根目录），不需要编译 Android 平台的话这里可以跳过。</p>
<p><code>Android SDK</code> 路径，选择刚才在 SDK Manager 中记下的 Android SDK Location 路径（Android SDK 的目录下应该包含 build-tools、platforms 等文件夹），不需要编译 Android 平台的话这里可以跳过。<br>配置完成后点击 保存 按钮，保存并关闭窗口。</p>
<p>注意：这里的配置会在编译 原生工程 的时候生效。如果没有生效（一些 Mac 机器有可能出现这个情况），可能需要您尝试到 系统环境变量 设置这些值：COCOS_CONSOLE_ROOT, NDK_ROOT, ANDROID_SDK_ROOT。</p>
<h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>在 <code>Dashboard</code> 中，打开 <code>新建项目</code> 选项卡，选中 <code>Hello World</code> 项目模板。</p>
<h2 id="打开场景，开始工作"><a href="#打开场景，开始工作" class="headerlink" title="打开场景，开始工作"></a>打开场景，开始工作</h2><p>Cocos Creator 的工作流程是以数据驱动和场景为核心的，初次打开一个项目时，默认不会打开任何场景，要看到 Hello World 模板中的内容，我们需要先打开场景资源文件。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/open_scene.png">
<p>在 <code>资源管理器</code> 中双击箭头所指的 <code>helloworld</code> 场景文件</p>
<h2 id="预览场景"><a href="#预览场景" class="headerlink" title="预览场景"></a>预览场景</h2><p>点击编辑器窗口正上方的 <code>预览游戏</code> 按钮。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/preview_button.png">
<p>Cocos Creator 会使用您的默认浏览器运行当前游戏场景。点击预览窗口左上角的下拉菜单，可以选择不同设备屏幕的预览效果。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/preview.png">
<h2 id="修改欢迎文字"><a href="#修改欢迎文字" class="headerlink" title="修改欢迎文字"></a>修改欢迎文字</h2><p>首先在 <code>层级管理器</code> 中选中 <code>Canvas</code> 节点，我们的 HelloWorld 组件脚本就挂在这个节点上。</p>
<p>接下来在 <code>属性检查器</code> 面板下方找到 <code>HelloWorld</code>组件属性，然后将 <code>Text</code> 属性里的文本改成 你好，世界！</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/change_text.png">
<p>再次运行预览，可以看到欢迎文字已经更新了</p>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ProjectName（项目文件夹）</span><br><span class="line">	├──assets </span><br><span class="line">		├──Scene		├──Scene.meta		├──Script		├──Script.meta		├──Texture		├──Texture.meta</span><br><span class="line">	├──build</span><br><span class="line">	├──library</span><br><span class="line">	├──local</span><br><span class="line">	├──settings</span><br><span class="line">	├──temp</span><br><span class="line">	└──project.json</span><br></pre></td></tr></table></figure>
<h2 id="assets-资源文件夹"><a href="#assets-资源文件夹" class="headerlink" title="assets 资源文件夹"></a>assets 资源文件夹</h2><p>游戏中所有本地资源、脚本和第三方库文件 </p>
<p>显示在 <strong>资源管理器</strong> 中</p>
<p>每个文件在导入后都会生成一个同名 <code>.meta</code> 文件，用于存储该文件作为资源导入后的信息和与其他资源的<strong>关联</strong>。</p>
<h2 id="library-资源库"><a href="#library-资源库" class="headerlink" title="library 资源库"></a>library 资源库</h2><p><code>assets</code> 中的资源导入后<strong>自动生成</strong>的。将文件结构和资源格式处理成最终游戏发布时需要的形式。</p>
<p>不需要进入版本控制的</p>
<p>丢失或损坏的时候，删除整个 <code>library</code> 文件夹再打开项目，就会重新生成资源库</p>
<h2 id="local-本地设置"><a href="#local-本地设置" class="headerlink" title="local 本地设置"></a>local 本地设置</h2><p>该项目的本地设置：包括编辑器面板布局，窗口大小，位置等信息。</p>
<p>按照您的习惯设置编辑器布局，这些就会自动保存在这个文件夹</p>
<p>不需要进入版本控制</p>
<h2 id="settings-项目设置"><a href="#settings-项目设置" class="headerlink" title="settings 项目设置"></a>settings 项目设置</h2><p>项目相关的设置：<code>构建发布</code> 菜单里的包名、场景和平台选择等。</p>
<p>需要进行版本控制</p>
<h2 id="project-json"><a href="#project-json" class="headerlink" title="project.json"></a>project.json</h2><p><code>project.json</code> 文件和 <code>assets</code> 文件夹一起，作为验证 Cocos Creator 项目合法性的标志。只有包括了这两个内容的文件夹才能作为 Cocos Creator 项目打开。</p>
<p>目前只用来规定当前使用的引擎类型和插件存储位置，不需要用户关心其内容。</p>
<p>需要进行版本控制</p>
<h2 id="build-构建目标"><a href="#build-构建目标" class="headerlink" title="build 构建目标"></a>build 构建目标</h2><p>在使用主菜单中的 <code>项目</code> -&gt; <code>构建发布...</code> 使用<strong>默认发布路径</strong>发布项目后，编辑器会在项目路径下创建 build 目录，并存放所有目标平台的构建工程。</p>
<p>不进入版本控制</p>
<ul>
<li>每次构建项目后资源 id 可能会变化</li>
<li>体积很大</li>
</ul>
<h1 id="打包发布原生平台"><a href="#打包发布原生平台" class="headerlink" title="打包发布原生平台"></a>打包发布原生平台</h1><p>点击菜单栏的 <code>项目</code> -&gt; <code>构建发布</code>，打开构建发布面板。</p>
<h2 id="构建原生工程"><a href="#构建原生工程" class="headerlink" title="构建原生工程"></a>构建原生工程</h2><p>选择发布平台，设置初始场景，点击右下角的 <code>构建</code> 按钮，开始构建流程。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/build.png">
<p>进度条到达 100% 后请继续等待 <strong>控制台</strong> 面板(在主面板底部)中的工程构建结束</p>
<p>编译成功</p>
<p>控制台面板日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Building /Users/liyungui/StudioProjects/cocos_helloworld</span><br><span class="line">Destination /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link</span><br><span class="line">Delete /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link/res/**/*,/Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link/src/*/</span><br><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Creating native cocos project to /Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link</span><br><span class="line">Start building assets</span><br><span class="line">Finish building assets</span><br><span class="line">Start building plugin scripts</span><br><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Built to &quot;/Users/liyungui/StudioProjects/cocos_helloworld/build/jsb-link&quot; successfully</span><br></pre></td></tr></table></figure>
<p>构建结束后，我们得到的是一个标准的 cocos2d-x 工程</p>
<p>接下来我们可以选择通过 Cocos Creator 编辑器的进程进行编译，以及运行桌面预览，或手动在相应平台的 IDE 中打开构建好的原生工程，进行进一步的预览、调试和发布。</p>
<h2 id="编译原生工程"><a href="#编译原生工程" class="headerlink" title="编译原生工程"></a>编译原生工程</h2><h3 id="通过编辑器编译"><a href="#通过编辑器编译" class="headerlink" title="通过编辑器编译"></a>通过编辑器编译</h3><p>点击下方的 <code>编译</code> 按钮，进入编译流程，如果模板选择了 default 的源码版引擎，这个编译的过程将会花费比较久的时间。</p>
<p>编译成功</p>
<p>控制台面板日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Checked Python Version [2.7.10]</span><br><span class="line">Start to compile native project. Please wait...</span><br><span class="line">The log file path [ /Users/liyungui/.CocosCreator/logs/native.log ]</span><br><span class="line">Compile native project successfully.</span><br></pre></td></tr></table></figure>
<p>注意：首次编译 Android 平台，建议通过 Android Studio 打开工程，根据提示下载缺失的工具，再进行编译运行。</p>
<h2 id="运行预览原生工程"><a href="#运行预览原生工程" class="headerlink" title="运行预览原生工程"></a>运行预览原生工程</h2><h3 id="通过编辑器运行预览"><a href="#通过编辑器运行预览" class="headerlink" title="通过编辑器运行预览"></a>通过编辑器运行预览</h3><p>点击右下角的 <code>运行</code> 按钮，通过默认方式预览原生平台的游戏。</p>
<p>点击运行后，视平台不同可能还会继续进行一部分编译工作，请耐心等待或通过日志文件查看进展。</p>
<p>其中 Mac/Windows 平台直接在桌面运行预览，iOS 平台会调用模拟器运行预览，Android 平台必须通过 USB 连接真机，并且在真机上开启 USB 调试后才可以运行预览。</p>
<p>运行成功后，logcat日志 过滤 tag: jswrapper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-07-24 19:02:18.986 6156-6195/? D/jswrapper: Initializing V8, version: 6.0.286.52</span><br><span class="line">2019-07-24 19:02:20.081 6156-6195/? D/jswrapper: JS: Enable batch GL commands optimization!</span><br><span class="line">2019-07-24 19:02:20.960 6156-6195/? D/jswrapper: glGetIntegerv: pname: 0x8b4c</span><br><span class="line">2019-07-24 19:02:21.004 6156-6195/? D/jswrapper: JS: Cocos Creator v2.1.0</span><br><span class="line">2019-07-24 19:02:21.078 6156-6195/? D/jswrapper: JS: LoadScene 2dL3kvpAxJu6GJ7RdqJG5J: 70.58299999999986ms</span><br><span class="line">2019-07-24 19:02:21.082 6156-6195/? D/jswrapper: JS: Success to load scene: db://assets/Scene/helloworld.fire</span><br></pre></td></tr></table></figure>
<h2 id="使用原生工程"><a href="#使用原生工程" class="headerlink" title="使用原生工程"></a>使用原生工程</h2><p>点击发布路径旁边的 <code>打开</code>按钮，就会在操作系统的文件管理器中打开构建发布路径。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/open_project.png">
<p>这个路径中的 <code>jsb-default</code> 或 <code>jsb-link</code> （根据选择模板不同）里就包含了所有原生构建工程。</p>
<img src="/2019/07/24/CocosCreator/CocosCreator新手上路/native_projects.jpg">
<p>接下来您只要使用原生平台对应的 IDE （如 Xcode、Android Studio、Visual Studio）打开这些工程，就可以进行进一步的编译、预览、发布操作了。</p>
<p>注意：在 MIUI 10 系统上运行 debug 模式构建的工程可能会弹出 “Detected problems with API compatibility” 的提示框，这是 MIUI 10 系统自身引入的问题，使用 release 模式构建即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/19/Android/UI性能优化/卡顿分析-正确评测流畅度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/19/Android/UI性能优化/卡顿分析-正确评测流畅度/" itemprop="url">卡顿分析-正确评测流畅度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-19T18:05:53+08:00">
                2019-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用FPS评测应用流畅度不科学"><a href="#使用FPS评测应用流畅度不科学" class="headerlink" title="使用FPS评测应用流畅度不科学"></a>使用FPS评测应用流畅度不科学</h1><p>说到应用的流畅度，都会想到FPS</p>
<p>FPS(Frames Per Second) 每秒帧数</p>
<p>Android系统获取FPS的原理是：SurfaceFLinger类把系统所有进程当前需要显示的信息合成一帧，提交到屏幕上进行显示。FPS就是1秒内SurfaceFLinger提交到屏幕的帧数。</p>
<p>用FPS评测应用是否卡顿存在两个问题。</p>
<ul>
<li>有的时候FPS很低，APP看起来却很流畅；<ul>
<li>当前界面在1秒内只需要10帧的显示需求，FPS只要高于10就可以了，如果屏幕根本没有绘制需求，那FPS的值就是0</li>
</ul>
</li>
<li>APP停止操作之后，FPS还是在一直变化</li>
</ul>
<h1 id="VSYNC信号"><a href="#VSYNC信号" class="headerlink" title="VSYNC信号"></a>VSYNC信号</h1><p>Android渲染机制是每隔16ms发出VSYNC信号，触发对UI的渲染，16ms没完成绘制就会卡顿。</p>
<p>VSync机制就像是一台固定转速的发动机(60转/s)。每一转会带动着去做一些UI相关的事情，但不是每一转都会有工作去做。有时候某一转因为工作量比较重超过了16.6ms，那么这台发动机这秒内就不是60转了，转速降低。我们把这个转速叫做流畅度。流畅度越小说明当前程序越卡顿。</p>
<h1 id="Choreographer帧率检测原理"><a href="#Choreographer帧率检测原理" class="headerlink" title="Choreographer帧率检测原理"></a>Choreographer帧率检测原理</h1><p>Choreographer中（英[ˌkɒrɪ’ɒɡrəfə(r)] 美[ˌkɒrɪ’ɒɡrəfə(r)]）编舞者</p>
<p>我们有时候会看到这样的log，系统帮助我们打印出了跳帧数。这个日志来自于<code>Choreographer.doFrame</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">02-07 19:47:04.337 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 60 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:11.685 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 85 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:12.545 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:14.893 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:23.049 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:23.929 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 37 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:24.961 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 61 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:25.817 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br><span class="line">02-07 19:47:26.433 17601-17601/zhangwan.wj.com.choreographertest I/Choreographer: Skipped 36 frames!  The application may be doing too much work on its main thread.</span><br></pre></td></tr></table></figure>
<p>阈值默认是30，跳帧超过30帧则打印警告日志，所以上面的log并不是经常看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SKIPPED_FRAME_WARNING_LIMIT =SystemProperties.getInt( <span class="string">"debug.choreographer.skipwarning"</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p>如果我们用反射的方法把SKIPPED_FRAME_WARNING_LIMIT的值设置成1，这样只要有丢帧，就会有上面的log输出。我们只要捕获这个log提取出skippedFrames 就可以知道界面是否卡顿</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Field field = Choreographer.class.getDeclaredField(<span class="string">"SKIPPED_FRAME_WARNING_LIMIT"</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    field.set(Choreographer.class,<span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="检测帧率"><a href="#检测帧率" class="headerlink" title="检测帧率"></a>检测帧率</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FrameCallback</span> </span>&#123;  </span><br><span class="line">  <span class="comment">//当新的一帧被绘制的时候被调用。  </span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义FrameCallback。记录下每一帧开始渲染的时间，在下一帧被处理时，判断上一帧在渲染过程中是否出现掉帧。</p>
<p>在需要检测的Activity中调用 SMFrameCallback.getInstance().start()即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SMFrameCallback</span> <span class="keyword">implements</span> <span class="title">Choreographer</span>.<span class="title">FrameCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  SMFrameCallback sInstance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String TAG=<span class="string">"SMFrameCallback"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> deviceRefreshRateMs=<span class="number">16.6f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">long</span> lastFrameTimeNanos=<span class="number">0</span>;<span class="comment">//纳秒为单位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">long</span> currentFrameTimeNanos=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Choreographer.getInstance().postFrameCallback(SMFrameCallback.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SMFrameCallback <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> SMFrameCallback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(lastFrameTimeNanos==<span class="number">0</span>)&#123;</span><br><span class="line">            lastFrameTimeNanos=frameTimeNanos;</span><br><span class="line">            Choreographer.getInstance().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        currentFrameTimeNanos=frameTimeNanos;</span><br><span class="line">        <span class="keyword">float</span> value=(currentFrameTimeNanos-lastFrameTimeNanos)/<span class="number">1000000.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> skipFrameCount = skipFrameCount(lastFrameTimeNanos, currentFrameTimeNanos, deviceRefreshRateMs);</span><br><span class="line">        Log.e(TAG,<span class="string">"两次绘制时间间隔value="</span>+value+<span class="string">"  frameTimeNanos="</span>+frameTimeNanos+<span class="string">"  currentFrameTimeNanos="</span>+currentFrameTimeNanos+<span class="string">"  skipFrameCount="</span>+skipFrameCount+<span class="string">""</span>);</span><br><span class="line">        lastFrameTimeNanos=currentFrameTimeNanos;</span><br><span class="line">        Choreographer.getInstance().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *计算跳过多少帧</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> devicefreshRate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">int</span> <span class="title">skipFrameCount</span><span class="params">(<span class="keyword">long</span> start,<span class="keyword">long</span> end,<span class="keyword">float</span> devicefreshRate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count =<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> diffNs=end-start;</span><br><span class="line">        <span class="keyword">long</span> diffMs = Math.round(diffNs / <span class="number">1000000.0f</span>);</span><br><span class="line">        <span class="keyword">long</span> dev=Math.round(devicefreshRate);</span><br><span class="line">        <span class="keyword">if</span>(diffMs&gt;dev)&#123;</span><br><span class="line">            <span class="keyword">long</span> skipCount=diffMs/dev;</span><br><span class="line">            count=(<span class="keyword">int</span>)skipCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有跳帧的时候输出的日志是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">02-07 20:21:53.909 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7177466379568  currentFrameTimeNanos=7177466379568  skipFrameCount=0</span><br><span class="line">02-07 20:21:53.925 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7177483046234  currentFrameTimeNanos=7177483046234  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.133 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=200.0  frameTimeNanos=7177683046226  currentFrameTimeNanos=7177683046226  skipFrameCount=11</span><br><span class="line">02-07 20:21:54.745 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=616.6666  frameTimeNanos=7178299712868  currentFrameTimeNanos=7178299712868  skipFrameCount=36</span><br><span class="line">02-07 20:21:54.757 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178316379534  currentFrameTimeNanos=7178316379534  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.773 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178333046200  currentFrameTimeNanos=7178333046200  skipFrameCount=0</span><br><span class="line">02-07 20:21:54.789 9530-9530/zhangwan.wj.com.choreographertest E/SMFrameCallback: 两次绘制时间间隔value=16.666666  frameTimeNanos=7178349712866  currentFrameTimeNanos=7178349712866  skipFrameCount=0</span><br></pre></td></tr></table></figure>
<p>看到两次绘制的时间间隔相差616.6666毫秒，跳过了36帧，这个卡顿用户是能够明显感知的。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/d126640eccb1" target="_blank" rel="noopener">Android性能优化第（十 一）篇—卡顿分析，正确评测流畅度</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/17/java基础/Timer设计缺陷分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/17/java基础/Timer设计缺陷分析/" itemprop="url">Timer设计缺陷分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-17T14:41:53+08:00">
                2019-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>APP模块中使用Timer需要实现一个10秒一次的心跳</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mHeartBeatTimer = <span class="keyword">new</span> Timer();</span><br><span class="line">mHeartBeatTimerTask = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//直接在Timer线程进行API请求，未开启线程</span></span><br><span class="line"> 		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			ExceptionUtil.handle(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">mHeartBeatTimer.schedule(mHeartBeatTimerTask, <span class="number">0</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>上线后发现存在心跳丢失问题。</p>
<p>排查bugly发现没有任何异常和崩溃，初步怀疑是Timer的问题。</p>
<h1 id="Timer缺陷"><a href="#Timer缺陷" class="headerlink" title="Timer缺陷"></a>Timer缺陷</h1><p>下面来自《Java并发编程实战》：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.Timer在执行所有定时任务时只会创建一个线程。</span><br><span class="line">	如果某个任务的执行时间长度大于其周期时间长度，那么就会导致这一次的任务还在执行，而下一个周期的任务已经需要开始执行了，</span><br><span class="line">	当然在一个线程内这两个任务只能顺序执行，有两种情况：对于之前需要执行但还没有执行的任务，</span><br><span class="line">		scheduleAtFixedRate，任务快速调用。当前任务执行完马上执行那些任务（按顺序来），</span><br><span class="line">		schedule，任务丢失。干脆把那些任务丢掉，不去执行它们。</span><br><span class="line">2.如果TimerTask抛出了一个未检出的异常，那么Timer线程就会被终止掉，</span><br><span class="line">之前已经被调度但尚未执行的TimerTask就不会再执行了，新的任务也不能被调度了。</span><br></pre></td></tr></table></figure>
<h1 id="Timer源码分析"><a href="#Timer源码分析" class="headerlink" title="Timer源码分析"></a>Timer源码分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">	<span class="comment">//任务队列。</span></span><br><span class="line">	<span class="comment">//内部是一个数组，按任务执行时间排序</span></span><br><span class="line">	<span class="comment">//存放Timer的TimerTask；Timer生产，TimerThread消费</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> TaskQueue queue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line">	<span class="comment">//Thread子类。run()中死循环 检查和执行 任务队列的任务</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> TimerThread thread = <span class="keyword">new</span> TimerThread(queue);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//构造方法。设置线程名称和Daemon，开启线程</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name, <span class="keyword">boolean</span> isDaemon)</span> </span>&#123;</span><br><span class="line">        thread.setName(name);</span><br><span class="line">        thread.setDaemon(isDaemon);</span><br><span class="line">        thread.start();<span class="comment">//开启</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, Date firstTime, <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//period设置为负值</span></span><br><span class="line">        sched(task, firstTime.getTime(), -period);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleAtFixedRate</span><span class="params">(TimerTask task, Date firstTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Non-positive period."</span>);</span><br><span class="line">        sched(task, firstTime.getTime(), period);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sched</span><span class="params">(TimerTask task, <span class="keyword">long</span> time, <span class="keyword">long</span> period)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal execution time."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制period最大值</span></span><br><span class="line">        <span class="keyword">if</span> (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>))</span><br><span class="line">            period &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!thread.newTasksMayBeScheduled)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Timer already cancelled."</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//设置task属性</span></span><br><span class="line">            <span class="keyword">synchronized</span>(task.lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (task.state != TimerTask.VIRGIN)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">"Task already scheduled or cancelled"</span>);</span><br><span class="line">                task.nextExecutionTime = time;</span><br><span class="line">                task.period = period;</span><br><span class="line">                task.state = TimerTask.SCHEDULED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//将task加入队列</span></span><br><span class="line">            queue.add(task);</span><br><span class="line">            <span class="keyword">if</span> (queue.getMin() == task)</span><br><span class="line">                queue.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	<span class="comment">//用来标识是否可以添加新任务</span></span><br><span class="line">    <span class="keyword">boolean</span> newTasksMayBeScheduled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> TaskQueue queue;</span><br><span class="line"></span><br><span class="line">    TimerThread(TaskQueue queue) &#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mainLoop();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Someone killed this Thread, behave as if Timer cancelled</span></span><br><span class="line">            <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">                newTasksMayBeScheduled = <span class="keyword">false</span>;</span><br><span class="line">                queue.clear();  <span class="comment">// Eliminate obsolete references</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimerTask task;</span><br><span class="line">                <span class="keyword">boolean</span> taskFired;<span class="comment">//任务是否过期(执行时间&lt;=现在时间)</span></span><br><span class="line">                <span class="keyword">synchronized</span>(queue) &#123;</span><br><span class="line">                    <span class="comment">// 死循环，等待任务队列非空</span></span><br><span class="line">                    <span class="keyword">while</span> (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)</span><br><span class="line">                        queue.wait();</span><br><span class="line">                    <span class="keyword">if</span> (queue.isEmpty())</span><br><span class="line">                        <span class="keyword">break</span>; <span class="comment">// 任务队列为空，且不可添加新任务，结束TimerThread线程</span></span><br><span class="line">                    <span class="comment">// 任务队列非空，检查和执行第一个任务</span></span><br><span class="line">                    <span class="keyword">long</span> currentTime, executionTime;</span><br><span class="line">                    task = queue.getMin();</span><br><span class="line">                    <span class="keyword">synchronized</span>(task.lock) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (task.state == TimerTask.CANCELLED) &#123;</span><br><span class="line">                            queue.removeMin();</span><br><span class="line">                            <span class="keyword">continue</span>;  <span class="comment">// 该任务已取消，直接从队列中移除，等待下一任务</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        currentTime = System.currentTimeMillis();</span><br><span class="line">                        executionTime = task.nextExecutionTime;</span><br><span class="line">                        <span class="comment">//任务已过期</span></span><br><span class="line">                        <span class="keyword">if</span> (taskFired = (executionTime&lt;=currentTime)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (task.period == <span class="number">0</span>) &#123; <span class="comment">// 不需要重复执行，直接移除</span></span><br><span class="line">                                queue.removeMin();</span><br><span class="line">                                task.state = TimerTask.EXECUTED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 需要重复执行，修改task下一次执行时间，并刷新任务队列排序</span></span><br><span class="line">                                queue.rescheduleMin(</span><br><span class="line">                                  task.period&lt;<span class="number">0</span> ? currentTime - task.period</span><br><span class="line">                                                : executionTime + task.period);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!taskFired) <span class="comment">// Task hasn't yet fired; wait</span></span><br><span class="line">                        queue.wait(executionTime - currentTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (taskFired)  <span class="comment">// 任务已过期，立即执行</span></span><br><span class="line">                    task.run();</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;<span class="comment">//捕获异常</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Timer在执行定时任务时只创建一个线程，如果任务耗时超过了两个任务的间隔时间，会发生一些缺陷<ul>
<li>schedule <strong>Timer任务丢失</strong>    <ul>
<li>period&lt;0，下一次执行时间 = currentTime - task.period；</li>
<li>任务被重置。从现在开始，period周期间隔后执行一次任务。</li>
<li>那么之前预想在period这个间隔内存在的任务执行就没了，也就是 <strong>任务丢失</strong> 问题</li>
</ul>
</li>
<li>scheduleAtFixedRate <strong>Timer任务快速调用</strong><ul>
<li>period&gt;0，下一次执行时间 = executionTime + task.period；</li>
<li>下一次任务还是按原来的算。从原来应该的执行时间开始，period周期间隔后执行一次任务。</li>
<li>如果这时executionTime + task.period还先于currentTime，那么下一个任务就会马上执行，也就是 <strong>任务快速调用</strong> 问题。</li>
</ul>
</li>
</ul>
</li>
<li><p>TimerTask异常导致 <strong>Timer线程异常结束</strong></p>
<ul>
<li>TimerThread run方法的死循环只捕获了 <strong>InterruptedException</strong>  异常<ul>
<li>当前线程可以被中断，被操作系统挂到一边休息，然后又回来继续执行</li>
<li>其它异常，那么整个循环就挂掉，导致线程结束</li>
</ul>
</li>
</ul>
</li>
<li><p>Timer执行周期任务时 <strong>依赖系统时间</strong> ,修改系统时间容易导致任务被挂起（如果当前时间小于执行时间）</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用Timer实现定时发心跳包可能会有问题</p>
<p>如果Timer线程在执行过程中被中断了，那么调用schedule的就很有可能导致心跳包没有发出去，而调用scheduleAtFixedRate的又可能会导致Timer线程没有占用CPU时心跳包没发出去，某一时刻又快速地发送好几个心跳包。</p>
<p>因此在Android中如果需要一个严格准时的定时操作，一般使用 <strong>AlarmManager</strong> 实现。</p>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://blog.csdn.net/u012619640/article/details/50749715" target="_blank" rel="noopener">Java中的Timer源码分析及缺陷</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/Android/View.post不靠谱/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/10/Android/View.post不靠谱/" itemprop="url">View.post不靠谱</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T18:36:53+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>有时候，我们会用 View.post() 方法，来将一个 Runnable 发送到主线程去执行。这一切，看似很美好，它最终会通过一个 Handler.post() 方法去执行，又避免我们重新定义一个 Handler 对象。</p>
<p>但是，在 Android 7.0（Api level 24） 上，View.post() 将不再那么靠谱了，你post() 出去的 Runnable ，可能永远也不会有机会得到执行。</p>
<h1 id="post-在-7-0-的差异"><a href="#post-在-7-0-的差异" class="headerlink" title="post 在 7.0 的差异"></a>post 在 7.0 的差异</h1><p>在 Api23 及以下，<code>executeAction()</code> 是会被<strong>循环调用</strong>（一个 VSync 的间隔），基本上其内的 mActions 中，只要有未执行的 Runnable 立刻就会被消费掉</p>
<p>在 Api24 及以上，<code>executeActions()</code> 只在 <code>dispatchAttachedToWindow()</code> 中才有机会被<strong>调用一次</strong>，而 <code>View.dispatchAttachedToWindow()</code> 只有在这个 View 通过 addView() 方法，或者原本写在页面布局的 xml 中（实际上也是调用的 addView()），加入到一个 ViewGroup 的时候，才会被调用到</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>View.post() 方法，在不同版本的差异，根本原因还是在于 Api23 和 Api24 中，<code>executeActions()</code> 方法的调用时机不同，导致 View 在没有 mAttachInfo 对象的时候，表现不一样了。</p>
<p>所以我们在使用的过程中需要慎用，区分出实际使用的场景，一般规范自己的代码即可：</p>
<ul>
<li>动态创建的 View ，如果视条件去决定是否加入到根布局中，则不要使用它来调用 post() 方法。</li>
<li>尽量避免使用 View.post() 方法，可以直接使用 Handler.post() 方法来替代。</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.cnblogs.com/plokmju/p/7481727.html" target="_blank" rel="noopener">View.post() 不靠谱的地方你知道吗？</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/Android/View 的可见性检查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/10/Android/View 的可见性检查/" itemprop="url">View 的可见性检查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T18:24:53+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/2019/07/10/Android/View%20的可见性检查/visibility.png">
<p>四种方法获取的结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">View5.getVisibility() = View.VISIBLE;</span><br><span class="line">View5.isShown() = <span class="keyword">true</span>; </span><br><span class="line">View5.getGlobalVisibleRect() = <span class="keyword">false</span>;</span><br><span class="line">View5.getLocalVisibleRect() =  <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<h1 id="View-getVisibility"><a href="#View-getVisibility" class="headerlink" title="View.getVisibility()"></a>View.getVisibility()</h1><p>最基本的检查View可见性的方法</p>
<p>如果这个方法返回的是View.INVISIBLE或者View.GONE，那么这个View肯定是对用户不可见的。</p>
<h1 id="View-isShown"><a href="#View-isShown" class="headerlink" title="View.isShown()"></a>View.isShown()</h1><ul>
<li>递归</li>
<li>检查View以及它的parentView的Visibility == View.VISIBLE，</li>
<li>检查parentView == null<ul>
<li>也就是说所有的parentView都不能为null。否则就说明这个View根本没有被addView过</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the visibility of this view and all of its ancestors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> True if this view and all of its ancestors are &#123;<span class="doctag">@link</span> #VISIBLE&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    View current = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((current.mViewFlags &amp; VISIBILITY_MASK) != VISIBLE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ViewParent parent = current.mParent;</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// We are not attached to the view root</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(parent <span class="keyword">instanceof</span> View)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        current = (View) parent;</span><br><span class="line">    &#125; <span class="keyword">while</span> (current != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="View-getGlobalVisibleRect"><a href="#View-getGlobalVisibleRect" class="headerlink" title="View.getGlobalVisibleRect()"></a>View.getGlobalVisibleRect()</h1><p>返回一个View是否可见的boolean值，同时还会将该View的可见区域left，top，right，bottom值保存在一个rect对象中</p>
<p>获得的rect坐标系的原点是屏幕的左上角</p>
<p>调用的是<code>getGlobalVisibleRect(Rect r, Point globalOffset)</code></p>
<h1 id="View-getLocalVisibleRect"><a href="#View-getLocalVisibleRect" class="headerlink" title="View.getLocalVisibleRect()"></a>View.getLocalVisibleRect()</h1><p>获得的rect坐标系的原点是View自己的左上角</p>
<p>其也会调用<code>getGlobalVisibleRect()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getLocalVisibleRect</span><span class="params">(Rect r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Point offset = mAttachInfo != <span class="keyword">null</span> ? mAttachInfo.mPoint : <span class="keyword">new</span> Point();</span><br><span class="line">    <span class="keyword">if</span> (getGlobalVisibleRect(r, offset)) &#123;</span><br><span class="line">        r.offset(-offset.x, -offset.y); <span class="comment">// make r local</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先获取View的offset point（相对屏幕或者ParentView的偏移坐标），</li>
<li>再调用getGlobalVisibleRect(Rect r, Point globalOffset)方法来获取可见区域</li>
<li>最后再把得到的GlobalVisibleRect和Offset坐标做一个加减法，转换坐标系原点</li>
</ul>
<p>View在屏幕中全部不可见时(图中view5)，两者的visibility都为false，且两者获取的rect值相同。由源码可以知道，getLocalVisibleRect()最终调用的是getGlobalVisibleRect()方法，并会减去View自身的便偏移坐标offset point，但只有当View可见时才会减去这个偏移坐标，要是不可见就直接返回了，所以此时两者获取出的rect值是相同的</p>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><ul>
<li><code>getGlobalVisibleRect()</code> <code>getLocalVisibleRect()</code>判断View的可见性时，一定要等View绘制完成后，再去调用这两个方法，否则无法得到对的结果，返回值的rect值都是0，visibility为false。这和获取View的宽高原理是一样的，如果View没有被绘制完成，那么View.getWidth和View.getHeight一定是等于0的</li>
<li><code>getGlobalVisibleRect()</code>只能检查出这个View在手机屏幕（或者说是相对它的父View）的位置，而不能检查出与其他兄弟View的相对位置:<br>比如有一个ViewGroup，下面有View1、View2这两个子View，View1和View2是平级关系。此时如果View2盖住了View1，那么用getGlobalVisibleRect方法检查View1的可见性，得到的返回值依然是true，得到的可见矩形区域rect也是没有任何变化的。</li>
</ul>
<h1 id="参考-amp-扩展"><a href="#参考-amp-扩展" class="headerlink" title="参考&amp;扩展"></a>参考&amp;扩展</h1><ul>
<li><a href="https://www.jianshu.com/p/30b0ae304518" target="_blank" rel="noopener">View 的可见性检查还可以这样</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/04/Android/setVisibility不起作用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/04/Android/setVisibility不起作用/" itemprop="url">setVisibility不起作用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-04T17:40:53+08:00">
                2019-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="控件本身正在执行动画"><a href="#控件本身正在执行动画" class="headerlink" title="控件本身正在执行动画"></a>控件本身正在执行动画</h1><p>解决方案：view.clearAnimation()</p>
<h1 id="控件还在使用当中"><a href="#控件还在使用当中" class="headerlink" title="控件还在使用当中"></a>控件还在使用当中</h1><p>比如设置点击某个ViewGroup的子View后，让改ViewGroup 消失。就极有可能导致setVisibility 无效</p>
<p>解决方案：利用Handler.post()发送 setVisibility任务</p>
<h1 id="设备性能问题"><a href="#设备性能问题" class="headerlink" title="设备性能问题"></a>设备性能问题</h1><p>方案一：</p>
<p>利用Handler.post()发送 setVisibility任务</p>
<p>这个方法同样适用于<strong>动画不生效等其他UI异常</strong></p>
<p>方案二：重新加载，即重新构造。</p>
<p>setVisibility 后 调用view.invalidate()或者view.postinvalidate()；</p>
<p>如果也不行，直接调用自身的requestLayout或者其父容器的requestLayout()进行强制的界面即时刷新重构;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/24/java基础/线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/24/java基础/线程/" itemprop="url">线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-24T16:31:53+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="进程内某个线程OOM，其他线程还能运行吗"><a href="#进程内某个线程OOM，其他线程还能运行吗" class="headerlink" title="进程内某个线程OOM，其他线程还能运行吗"></a>进程内某个线程OOM，其他线程还能运行吗</h1><p><strong>能</strong></p>
<p><strong>堆进程内共享</strong></p>
<p>在多线程环境下，每个线程拥有一个栈和一个程序计数器。栈和程序计数器用来保存线程的执行历史和线程的执行状态，是线程私有的资源。其他的资源（比如堆、地址空间、全局变量）是由同一个进程内的多个线程共享。</p>
<p>一个线程抛出OOM异常后，它所占据的内存资源会全部被释放掉，从而不会影响其他线程的运行！</p>
<h1 id="主线程异常退出，子线程还能运行么？"><a href="#主线程异常退出，子线程还能运行么？" class="headerlink" title="主线程异常退出，子线程还能运行么？"></a>主线程异常退出，子线程还能运行么？</h1><p><strong>能</strong></p>
<p>线程不像进程，一个进程中的线程之间是没有父子之分的，都是平级关系。即线程都是一样的, 退出了一个不会影响另外一个。</p>
<p>只有一个例外情况，如果这些子线程都是<strong>守护线程</strong>，那么子线程会随着主线程结束而结束。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="风" />
            
              <p class="site-author-name" itemprop="name">风</p>
              <p class="site-description motion-element" itemprop="description">随心而动，随刃而行</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">195</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
